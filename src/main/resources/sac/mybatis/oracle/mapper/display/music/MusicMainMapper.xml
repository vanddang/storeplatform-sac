<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="MusicMain">

    <!-- Music Main -->
    <select id="getMusicMainList" parameterType="MusicContentsSacReq" resultType="ProductBasicInfo">
        SELECT /* MusicMainMapper.xml, getMusicMainList, SAC 전시, 2014-02-05 */
               A.TENANT_ID
             , A.MENU_ID
             , A.PROD_ID
             , A.PART_PROD_ID
             , A.TOP_MENU_ID
             , A.META_CLSF_CD
             , A.CONTENTS_TYPE_CD
             , A.TOTAL_COUNT
          FROM (SELECT F.TENANT_ID
                     , C.MENU_ID
                     , I.PROD_ID
                     , I.PART_PROD_ID
                     , C.TOP_MENU_ID
                     , D.META_CLSF_CD
                     , D.CONTENTS_TYPE_CD
                     , COUNT(I.PART_PROD_ID) OVER () AS TOTAL_COUNT
                     <if test='filteredBy == "top"'>
                     /* TOP Music */
                     , ROW_NUMBER() OVER(ORDER BY A.NOW_RANK ASC, E.PROD_NM) AS RNUM
                     </if>
                     <if test='filteredBy == "recent" || filteredBy == "genre"'>
                     /* 최신음악, 장르별 */
                         /* 인기도 */
                         <if test='orderedBy == "popular"'>
                     , ROW_NUMBER() OVER(ORDER BY A.NOW_RANK ASC, G.ISSUE_DAY, E.PROD_NM) AS RNUM
                         </if>
                         /* 아티스트명 */
                         <if test='orderedBy == "artist"'>
                     , ROW_NUMBER() OVER(ORDER BY E.ARTIST1_NM, E.PROD_NM) AS RNUM
                         </if>
                         /* 곡명 */
                         <if test='orderedBy == "title"'>
                     , ROW_NUMBER() OVER(ORDER BY E.PROD_NM, E.ARTIST1_NM) AS RNUM
                         </if>
                         /* Default */
                         <if test='orderedBy == null || orderedBy == ""'>
                     , ROW_NUMBER() OVER(ORDER BY A.NOW_RANK ASC, G.ISSUE_DAY, E.PROD_NM) AS RNUM
                         </if>
                     </if>
                     <if test='filteredBy == "ring" || filteredBy == "bell"'>
                     /* 컬러링, 벨소리 */
                     , ROW_NUMBER() OVER(ORDER BY A.RANK_CHG_CNT ASC) AS RNUM
                     </if>
                  FROM TB_DP_MUSIC_CHART A  /* 에피소드 */
                     , TB_DP_MENU_CATEGORY_PROD_MAPG B
                     , TB_DP_MENU_CATEGORY C
                     , TB_DP_PROD D
                     , TB_DP_PROD_DESC E
                     , TB_DP_TENANT_PROD F
                     , UV_TB_DP_MULTIMDA_PROD G
                     , (SELECT DISTINCT SD.PROD_ID
                          FROM TB_DP_SPRT_DEVICE SD
                             , TB_CM_DEVICE CD
                         WHERE SD.DEVICE_MODEL_CD = CD.DEVICE_MODEL_CD
                           AND (SD.DEVICE_MODEL_CD = #{deviceModelCd} OR SD.DEVICE_MODEL_CD = #{anyDeviceModelCd})
                           AND CD.USE_YN = 'Y'
                           AND CD.MUSIC_SPRT_YN = 'Y'
                       ) H
                     , TB_DP_PROD_RSHP I
                 WHERE A.CHART_CLSF_CD = #{chartClsfCd}
                   AND A.RANK_START_DAY = #{stdDt}
                   AND A.PROD_ID = B.PROD_ID
                   AND B.USE_YN = 'Y'
                   AND B.MENU_ID = C.MENU_ID
                   AND C.USE_YN = 'Y'
                   AND C.MENU_ID LIKE CONCAT(#{menuId}, '%')
                   AND B.PROD_ID = D.PROD_ID
                   AND D.CONTENTS_TYPE_CD = 'PD002502'
                   AND D.META_CLSF_CD = 'CT25'
                   AND D.PROD_ID = E.PROD_ID
                   AND E.LANG_CD = #{langCd}
                   AND E.PROD_ID = F.PROD_ID
                   AND F.TENANT_ID = #{tenantId}
                   AND F.EXPO_YN = 'Y'
                   AND F.PROD_STATUS_CD = 'PD000403' 
                   AND A.PROD_ID = G.PROD_ID
                   AND A.PROD_ID = H.PROD_ID
                   AND H.PROD_ID = I.PART_PROD_ID
                   AND I.PROD_RSHP_CD = 'DP010802'
                ) A
          WHERE RNUM BETWEEN #{offset} AND (#{offset}+#{count}-1)
          ORDER BY RNUM
    </select>
    
    <select id="getMusicMetaInfo" parameterType="Map" resultType="MetaInfo">
        SELECT /* MusicMainMapper.xml, getMusicMetaInfo, SAC 전시, 2014-03-06 */
               F.ARTIST1_ID AS ARTIST_ID
		     , E.PROD_ID
		     , E.PART_PROD_ID
		     , D.MENU_ID
		     , B.MENU_NM
		     , B.MENU_DESC
		     , A.TOP_MENU_ID
		     , C.MENU_NM AS TOP_MENU_NM
		     , C.MENU_DESC AS TOP_MENU_DESC
		     , G.OUTSD_CONTENTS_ID
		     , F.PROD_NM
		     , F.PROD_DTL_DESC
		     , F.PROD_BASE_DESC
		     , H.PROD_AMT
		     , I.META_CLSF_CD
		     , I.PROD_GRD_CD
		     , F.ARTIST1_NM
		     , F.ARTIST2_NM
		     , F.ARTIST3_NM
		     , G.CHNL_COMP_NM
		     , G.AGENCY_NM
		     , G.ISSUE_DAY
		     , 'Y' AS MP3_SPRT_YN
		     , NVL(G.BELL_SPRT_YN, 'N') AS BELL_SPRT_YN
		     , NVL(G.COLOR_SPRT_YN, 'N') AS COLOR_SPRT_YN
		     , CONCAT(J.FILE_PATH, J.FILE_NM) AS FILE_PATH
		     , J.FILE_NM
		     , J.FILE_SIZE
		     , I.CONTENTS_TYPE_CD
		     , K.PROD_STATUS_CD
		  FROM TB_DP_MENU_CATEGORY A
		     , TB_DP_MENU_CATEGORY_DESC B  /* 서브메뉴 */
		     , TB_DP_MENU_CATEGORY_DESC C  /* 탑메뉴 */
		     , TB_DP_MENU_CATEGORY_PROD_MAPG D
		     , TB_DP_PROD_RSHP E
		     , TB_DP_PROD_DESC F
		     , UV_TB_DP_MULTIMDA_PROD G
		     , TB_DP_TENANT_PROD_PRICE H
		     , TB_DP_PROD I
		     , TB_DP_PROD_IMG J
		     , TB_DP_TENANT_PROD K
		 WHERE A.TOP_MENU_ID = #{productBasicInfo.topMenuId}
		   AND A.USE_YN = 'Y'
		   AND A.MENU_ID = B.MENU_ID
		   AND B.LANG_CD = #{tenantHeader.langCd}
		   AND A.TOP_MENU_ID = C.MENU_ID
		   AND C.LANG_CD = #{tenantHeader.langCd}
		   AND D.PROD_ID = #{productBasicInfo.partProdId}
		   AND D.USE_YN = 'Y'
		   AND A.MENU_ID = D.MENU_ID
		   AND D.PROD_ID = E.PART_PROD_ID
		   AND E.PROD_RSHP_CD = 'DP010802'
		   AND E.PART_PROD_ID = F.PROD_ID
		   AND F.LANG_CD = #{tenantHeader.langCd}
		   AND F.PROD_ID = G.PROD_ID
		   AND H.TENANT_ID = #{tenantHeader.tenantId}
		   AND H.PROD_ID = G.PROD_ID
		   AND SYSDATE BETWEEN APPLY_START_DT AND APPLY_END_DT
		   AND H.PROD_ID = I.PROD_ID
		   AND E.PROD_ID = J.PROD_ID
		   AND J.IMG_CD = #{imageCd}
		   AND J.PROD_ID = K.PROD_ID
		   AND K.TENANT_ID = #{tenantHeader.tenantId}
		   AND ROWNUM = 1
    </select>

</mapper>
