<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Shopping">

    <!-- 쇼핑/인기 추천 상품 리스트 조회-->
    <select id="getFeatureProductList" parameterType="Map" resultType="ProductBasicInfo">
       /* ShoppingMapper.xml.getFeatureProductList,쇼핑/인기 추천 상품 리스트 조회, 김형식/SK플래닛 , 2014-01-07 */
        SELECT *
         FROM ( 
             SELECT 
                    rownum AS RNUM        
                   ,COUNT(CATALOG_ID) OVER() AS TOTALCOUNT      
                   ,CATALOG_ID AS catalogId
                   ,BRAND_ID AS brandId
                   ,MENU_ID AS menuId
                   ,TENANT_ID AS tenentId
                   ,PROD_ID as prodId
                   ,PART_PROD_ID as partProdId 
                   ,EXPO_ORD as expoOrd
                   ,'PD002501' as contentsTypeCd
             FROM (
                  SELECT  * 
                   FROM (
                          SELECT 
                                B.CATALOG_ID 
                               ,C.CATALOG_NM 
                               ,A.BRAND_ID  
                               ,D.MENU_ID  
                               ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC) as NO
                               ,K.TENANT_ID 
                               ,H.PROD_ID 
                               ,H.PART_PROD_ID  
                               ,M.EXPO_ORD
                               ,I.REG_DT   
                          FROM 
                                  TB_DP_SHPG_BRAND A
                                 ,TB_DP_SHPG_CATALOG B
                                 ,TB_DP_SHPG_CATALOG_DESC C
                                 ,TB_DP_MENU_SHPG_MAPG D
                                 ,TB_DP_MENU_CATEGORY E
                                 ,TB_DP_MENU_CATEGORY_DESC F 
                                 ,TB_DP_PROD_CATALOG_MAPG G 
                                 ,TB_DP_PROD_RSHP H
                                 ,TB_DP_SHPG_PROD I
                                 ,TB_DP_PROD J
                                 ,TB_DP_TENANT_PROD K
                                 ,TB_DP_TENANT_PROD_PRICE L
                                ,(
                                    SELECT  TDLP.TENANT_ID
                                          , TDLP.LIST_ID
                                          , TDLP.MENU_ID
                                          , TDLP.PROD_ID
                                          , TDLP.EXPO_ORD
                                          , TDLP.PRCHS_QTY  
                                          , TDLP.DWLD_QTY                                      
                                      FROM  
                                            TB_DP_LIST_PROD TDLP
                                           ,TB_DP_LIST TDL
                                     WHERE 1=1
                                       AND  TDLP.TENANT_ID = TDL.TENANT_ID
                                       AND  TDLP.LIST_ID   = TDL.LIST_ID
                                       AND  TDLP.TENANT_ID = #{tenantHeader.tenantId}    /* 테넌트ID */
                                       AND  TDLP.LIST_ID   = #{req.listId}     /* ADM000000014 : 쇼핑 추천, RNK000000006 쇼핑 인기 */
                                       AND  TDLP.EXPO_YN = 'Y'             /* Y : 노출 (노출여부) */
                                       AND  TDL.EXPO_YN  = 'Y'             /* Y : 노출 (노출여부) */
                                       AND  TO_CHAR(TDLP.STD_DT, 'YYYYMMDDHH24MISS') = #{stdDt}
                                       AND  SYSDATE BETWEEN TDLP.EXPO_START_DT AND TDLP.EXPO_END_DT                            
                                  ) M                                
                                 ,(SELECT 
                                        B1.PROD_ID
                                      , B1.SPRC_DC_RATE
                                      , B1.SPRC_PRICE
                                   FROM  TB_DP_PROD_RSHP A1
                                        ,TB_DP_SPRC_PROD B1
                                   WHERE 1=1
                                     AND A1.PART_PROD_ID = B1.PROD_ID
                                     AND B1.EXPO_YN ='Y'
                                     AND B1.CPN_ID IS NOT NULL
                                     AND SYSDATE BETWEEN  B1.SPRC_APPLY_START_DT AND B1.SPRC_APPLY_END_DT 
                                  )N
                        WHERE 1=1
                        AND A.BRAND_ID = B.BRAND_ID
                        AND B.CATALOG_ID = C.CATALOG_ID
                        AND C.CATALOG_ID = D.CATALOG_ID     
                        AND D.MENU_ID = E.MENU_ID
                        AND D.MENU_ID = F.MENU_ID
                        AND B.CATALOG_ID = G.CATALOG_ID
                        AND G.PROD_ID = H.PROD_ID
                        AND H.PART_PROD_ID = I.PROD_ID
                        AND I.PROD_ID = J.PROD_ID
                        AND I.PROD_ID = K.PROD_ID
                        AND I.PROD_ID = L.PROD_ID
                        AND K.TENANT_ID = M.TENANT_ID 
                        <if test='req.listId =="ADM000000014"'>
                        AND B.CATALOG_ID = M.PROD_ID   
                        </if>
                        <if test='req.listId =="RNK000000006"'>
                        AND I.PROD_ID = M.PROD_ID   
                        </if>                        
                        AND I.PROD_ID = N.PROD_ID(+)     
                        AND H.PROD_RSHP_CD =#{prodRshpCd}    /*채널-에피소드 상품 관계*/
                        AND NVL(B.CHNL_CNT, 0) > 0                  
                        AND C.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND F.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                        AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                        AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND NVL(I.B2B_PROD_YN, 'N') != 'Y'
                        AND K.PROD_STATUS_CD = #{prodStatusCd}  /* PD000403 : 판매중 */
                        AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                        AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                        AND K.TENANT_ID = #{tenantHeader.tenantId}       /* INPUT 테넌트ID */
                        <if test="req.prodCharge != null">
                        AND J.PROD_CHRG_YN =#{req.prodCharge}
                        </if>
                        <if test="req.prodGradeCd != null">
                        AND J.PROD_GRD_CD =#{req.prodGradeCd}
                        </if>   
                        AND EXISTS (
                            SELECT 1 
                            FROM  TB_DP_SPRT_DEVICE DV  
                                 ,TB_CM_DEVICE CM
                            WHERE 1=1
                              AND DV.DEVICE_MODEL_CD = CM.DEVICE_MODEL_CD
                              AND CM.SCL_SHPG_SPRT_YN = 'Y'  /*쇼핑 상품 단말 지원 여부*/
                              AND DV.DEVICE_MODEL_CD  = #{req.deviceModelCd} 
                              AND PROD_ID = I.PROD_ID
                            )                      
                   ) 
                 WHERE NO =1
                 ORDER BY EXPO_ORD ASC, CATALOG_NM ASC
               ) 
        ) WHERE RNUM BETWEEN #{req.offset} AND #{req.count}
    </select>    
    
    <!-- 최신 상품 리스트 조회-->
    <select id="getNewProductList" parameterType="Map" resultType="ProductBasicInfo">
       /* ShoppingMapper.xml.getNewProductList,최신 상품 리스트 조회, 김형식/SK플래닛 , 2014-01-07 */
        SELECT *
         FROM ( 
             SELECT 
                    rownum AS RNUM        
                   ,COUNT(CATALOG_ID) OVER() AS TOTALCOUNT      
                   ,CATALOG_ID AS catalogId
                   ,BRAND_ID AS brandId
                   ,MENU_ID AS menuId
                   ,TENANT_ID AS tenentId
                   ,PROD_ID as prodId
                   ,PART_PROD_ID as partProdId 
                   ,'PD002501' as contentsTypeCd
             FROM (
                  SELECT  * 
                   FROM (
                          SELECT 
                                 B.CATALOG_ID 
                               ,C.CATALOG_NM 
                               ,A.BRAND_ID  
                               ,D.MENU_ID  
                               ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC) as NO
                               ,K.TENANT_ID 
                               ,H.PROD_ID 
                               ,H.PART_PROD_ID  
                               ,I.REG_DT   
                          FROM 
                                  TB_DP_SHPG_BRAND A
                                 ,TB_DP_SHPG_CATALOG B
                                 ,TB_DP_SHPG_CATALOG_DESC C
                                 ,TB_DP_MENU_SHPG_MAPG D
                                 ,TB_DP_MENU_CATEGORY E
                                 ,TB_DP_MENU_CATEGORY_DESC F 
                                 ,TB_DP_PROD_CATALOG_MAPG G 
                                 ,TB_DP_PROD_RSHP H
                                 ,TB_DP_SHPG_PROD I
                                 ,TB_DP_PROD J
                                 ,TB_DP_TENANT_PROD K
                                 ,TB_DP_TENANT_PROD_PRICE L
                                 ,(SELECT  PROD_ID
                                          ,PRCHS_CNT
                                     FROM TB_DP_TENANT_PROD_STATS 
                                    WHERE TENANT_ID = #{tenantHeader.tenantId}    /* INPUT 테넌트ID */
                                   ) M
                                 ,(SELECT 
                                        B1.PROD_ID
                                      , B1.SPRC_DC_RATE
                                      , B1.SPRC_PRICE
                                   FROM  TB_DP_PROD_RSHP A1
                                        ,TB_DP_SPRC_PROD B1
                                   WHERE 1=1
                                     AND A1.PART_PROD_ID = B1.PROD_ID
                                     AND B1.EXPO_YN ='Y'
                                     AND B1.CPN_ID IS NOT NULL
                                     AND SYSDATE BETWEEN  B1.SPRC_APPLY_START_DT AND B1.SPRC_APPLY_END_DT 
                                  )N
                        WHERE 1=1
                        AND A.BRAND_ID = B.BRAND_ID
                        AND B.CATALOG_ID = C.CATALOG_ID
                        AND C.CATALOG_ID = D.CATALOG_ID     
                        AND D.MENU_ID = E.MENU_ID
                        AND D.MENU_ID = F.MENU_ID
                        AND B.CATALOG_ID = G.CATALOG_ID
                        AND G.PROD_ID = H.PROD_ID
                        AND H.PART_PROD_ID = I.PROD_ID
                        AND I.PROD_ID = J.PROD_ID
                        AND I.PROD_ID = K.PROD_ID
                        AND I.PROD_ID = L.PROD_ID
                        AND I.PROD_ID = M.PROD_ID(+)                           
                        AND I.PROD_ID = N.PROD_ID(+)  
                        AND H.PROD_RSHP_CD =#{prodRshpCd}    /*채널-에피소드 상품 관계*/ 
                        AND NVL(B.CHNL_CNT, 0) > 0          
                        AND C.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND F.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                        AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                        AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND NVL(I.B2B_PROD_YN, 'N') != 'Y'
                        AND K.PROD_STATUS_CD = #{prodStatusCd}  /* PD000403 : 판매중 */
                        AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                        AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                        AND K.TENANT_ID = #{tenantHeader.tenantId}        /* INPUT 테넌트ID */
                        <if test="req.prodCharge != null">
                        AND J.PROD_CHRG_YN =#{req.prodCharge}
                        </if>
                        <if test="req.prodGradeCd != null">
                        AND J.PROD_GRD_CD =#{req.prodGradeCd}
                        </if>   
                        AND  EXISTS (
                            SELECT 1 
                            FROM  TB_DP_SPRT_DEVICE DV  
                                 ,TB_CM_DEVICE CM
                            WHERE 1=1
                              AND DV.DEVICE_MODEL_CD = CM.DEVICE_MODEL_CD
                              AND CM.SCL_SHPG_SPRT_YN = 'Y'  /*쇼핑 상품 단말 지원 여부*/
                              AND DV.DEVICE_MODEL_CD  = #{req.deviceModelCd} 
                              AND PROD_ID = I.PROD_ID
                            )                        
                   ) 
                 WHERE NO =1
                 ORDER BY REG_DT DESC, CATALOG_NM ASC
               ) 
        ) WHERE RNUM BETWEEN #{req.offset} AND #{req.count}
    </select>        
    
    <!-- 쇼핑 세부카테고리  상품 조회-->
    <select id="getSubProductList" parameterType="Map" resultType="ProductBasicInfo">
       /* ShoppingMapper.xml.getSubProductList,쇼핑 세부카테고리 상품 조회, 김형식/SK플래닛 , 2014-01-07 */
        SELECT *
         FROM ( 
             SELECT 
                    rownum AS RNUM        
                   ,COUNT(CATALOG_ID) OVER() AS TOTALCOUNT      
                   ,CATALOG_ID AS catalogId
                   ,BRAND_ID AS brandId
                   ,MENU_ID AS menuId
                   ,TENANT_ID AS tenentId
                   ,PROD_ID as prodId
                   ,PART_PROD_ID as partProdId 
                   ,'PD002501' as contentsTypeCd
             FROM (
                  SELECT  * 
                   FROM (
                          SELECT 
                                B.CATALOG_ID 
                               ,C.CATALOG_NM 
                               ,A.BRAND_ID  
                               ,D.MENU_ID  
                               ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC) as NO
                               ,K.TENANT_ID 
                               ,H.PROD_ID 
                               ,H.PART_PROD_ID  
                               ,I.REG_DT 
				               <if test='req.orderedBy == "recent"'>                 
				               ,'1' EXPO_ORD
				               </if>
				               <if test='req.orderedBy == "download"'>                 
				               ,M.EXPO_ORD
				               </if>                                                                                                                                                   
                          FROM 
                                  TB_DP_SHPG_BRAND A
                                 ,TB_DP_SHPG_CATALOG B
                                 ,TB_DP_SHPG_CATALOG_DESC C
                                 ,TB_DP_MENU_SHPG_MAPG D
                                 ,TB_DP_MENU_CATEGORY E
                                 ,TB_DP_MENU_CATEGORY_DESC F 
                                 ,TB_DP_PROD_CATALOG_MAPG G 
                                 ,TB_DP_PROD_RSHP H
                                 ,TB_DP_SHPG_PROD I
                                 ,TB_DP_PROD J
                                 ,TB_DP_TENANT_PROD K
                                 ,TB_DP_TENANT_PROD_PRICE L

                                 <if test='req.orderedBy == "recent"'>
                                 ,(SELECT  PROD_ID
                                          ,PRCHS_CNT
                                     FROM TB_DP_TENANT_PROD_STATS 
                                    WHERE TENANT_ID = #{tenantHeader.tenantId}    /* INPUT 테넌트ID */
                                   ) M
                                 </if>
                                 <if test='req.orderedBy == "download"'>
                                ,(
                                    SELECT  TDLP.TENANT_ID
                                          , TDLP.LIST_ID
                                          , TDLP.MENU_ID
                                          , TDLP.PROD_ID
                                          , TDLP.EXPO_ORD
                                          , TDLP.PRCHS_QTY  
                                          , TDLP.DWLD_QTY                                      
                                      FROM  
                                            TB_DP_LIST_PROD TDLP
                                           ,TB_DP_LIST TDL
                                     WHERE 1=1
                                       AND  TDLP.TENANT_ID = TDL.TENANT_ID
                                       AND  TDLP.LIST_ID   = TDL.LIST_ID
                                       AND  TDLP.TENANT_ID = #{tenantHeader.tenantId}   /* 테넌트ID */
                                       AND  TDLP.LIST_ID   = #{req.listId}     /* RNK000000006 쇼핑 인기 */
                                       AND  TDLP.EXPO_YN = 'Y'             /* Y : 노출 (노출여부) */
                                       AND  TDL.EXPO_YN  = 'Y'             /* Y : 노출 (노출여부) */
                                       AND  TO_CHAR(TDLP.STD_DT, 'YYYYMMDDHH24MISS') = #{stdDt}
                                       AND  SYSDATE BETWEEN TDLP.EXPO_START_DT AND TDLP.EXPO_END_DT                            
                                  ) M                                  
                                 </if>
                                 ,(SELECT 
                                        B1.PROD_ID
                                      , B1.SPRC_DC_RATE
                                      , B1.SPRC_PRICE
                                   FROM  TB_DP_PROD_RSHP A1
                                        ,TB_DP_SPRC_PROD B1
                                   WHERE 1=1
                                     AND A1.PART_PROD_ID = B1.PROD_ID
                                     AND B1.EXPO_YN ='Y'
                                     AND B1.CPN_ID IS NOT NULL
                                     AND SYSDATE BETWEEN  B1.SPRC_APPLY_START_DT AND B1.SPRC_APPLY_END_DT 
                                  )N
                        WHERE 1=1
                        AND A.BRAND_ID = B.BRAND_ID
                        AND B.CATALOG_ID = C.CATALOG_ID
                        AND C.CATALOG_ID = D.CATALOG_ID     
                        AND D.MENU_ID = E.MENU_ID
                        AND D.MENU_ID = F.MENU_ID
                        AND D.MENU_ID = #{req.menuId}           /*INPUT 메뉴ID*/  
                        AND B.CATALOG_ID = G.CATALOG_ID
                        AND G.PROD_ID = H.PROD_ID
                        AND H.PART_PROD_ID = I.PROD_ID
                        AND I.PROD_ID = J.PROD_ID
                        AND I.PROD_ID = K.PROD_ID
                        AND I.PROD_ID = L.PROD_ID
                         <if test='req.orderedBy == "recent"'>
                        AND I.PROD_ID = M.PROD_ID(+)        
                        </if>                                           
                        <if test='req.orderedBy == "download"'>
                        AND K.TENANT_ID = M.TENANT_ID 
                        AND I.PROD_ID = M.PROD_ID                             
                        </if>                   
                        AND I.PROD_ID = N.PROD_ID(+)       
                        AND H.PROD_RSHP_CD =#{prodRshpCd}    /*채널-에피소드 상품 관계*/   
                        AND NVL(B.CHNL_CNT, 0) > 0        
                        AND C.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND F.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                        AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                        AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND NVL(I.B2B_PROD_YN, 'N') != 'Y'
                        AND K.PROD_STATUS_CD = #{prodStatusCd}  /* PD000403 : 판매중 */
                        AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                        AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                        AND K.TENANT_ID = #{tenantHeader.tenantId}       /* INPUT 테넌트ID */
                        <if test="req.prodCharge != null">
                        AND J.PROD_CHRG_YN =#{req.prodCharge}
                        </if>
                        <if test="req.prodGradeCd != null">
                        AND J.PROD_GRD_CD =#{req.prodGradeCd}
                        </if>   
                        AND  EXISTS (
                            SELECT 1 
                            FROM  TB_DP_SPRT_DEVICE DV  
                                 ,TB_CM_DEVICE CM
                            WHERE 1=1
                              AND DV.DEVICE_MODEL_CD = CM.DEVICE_MODEL_CD
                              AND CM.SCL_SHPG_SPRT_YN = 'Y'  /*쇼핑 상품 단말 지원 여부*/
                              AND DV.DEVICE_MODEL_CD  =  #{req.deviceModelCd}  
                              AND PROD_ID =I.PROD_ID
                            )                           
                   ) 
                 WHERE NO =1
               <if test='req.orderedBy == "recent"'>                 
               ORDER BY REG_DT DESC, CATALOG_NM ASC
               </if>
               <if test='req.orderedBy == "download"'>                 
               ORDER BY EXPO_ORD ASC, CATALOG_NM ASC
               </if>                   
               )
        ) WHERE RNUM BETWEEN #{req.offset} AND #{req.count}
    </select>            
    
    <!-- 특가 상품 리스트 조회-->
    <select id="getSecialPriceProductList"  parameterType="ShoppingReq" resultType="Shopping">
       /* ShoppingMapper.xml.getSecialPriceProductList,특가 상품 리스트 조회, 김형식/SK플래닛 , 2014-02-04 */
       SELECT *
         FROM ( 
             SELECT 
                    ROW_NUMBER()OVER(ORDER BY REG_DT DESC, CATALOG_NM ) AS RNUM        
                   ,COUNT(CATALOG_ID) OVER() AS TOTALCOUNT      
                   ,CATALOG_ID AS catalogId
                   ,PROD_NET_AMT AS prodNetAmt
                   ,PROD_AMT AS prodAmt
                   ,DC_RATE AS dcRate
                   ,DC_AMT AS dcAmt
                   ,DLV_PROD_YN AS dlvProdYn
                   ,BRAND_ID AS brandId
                   ,BRAND_NM AS brandName
                   ,MENU_ID AS menuId
                   ,MENU_NM AS menuName
                   ,TOP_MENU_ID as upMenuId
                   ,(SELECT MENU_NM
                        FROM TB_DP_MENU_CATEGORY_DESC
                       WHERE MENU_ID = TOP_MENU_ID
                         AND LANG_CD = 'ko'
                         AND ROWNUM = 1
                     ) AS upMenuName                        
                   ,NO AS no
                   ,NEW_YN AS newYn
                   ,REG_DT AS regDt
                   ,TENANT_ID AS tenentId
                   ,PROD_ID as prodId
                   ,PART_PROD_ID as partProdId
                   ,PROD_NM AS catalogName
                   ,PRCHS_CNT as prchsQty
                   ,PROD_GRD_CD as prodGrdCd
                  -- ,APPLY_START_DT as applyStartDt     
                  -- ,APPLY_END_DT as applyEndDt    
                   ,SPRC_APPLY_START_DT as applyStartDt   
                   ,SPRC_APPLY_END_DT as applyEndDt 
                   ,DECODE(PROD_CASE_CD
                     , 'DP006301', 'giftcard'
                     , 'DP006302', 'exchange'
                     , 'DP006303', 'delivery' ) AS prodCaseCd
                   ,FILE_PATH ||FILE_NM as filePos
                   ,'specialSale' AS specialSale
   	               ,(CASE WHEN ( ( MTH_PRCHS_CNT >= MM_PROD_MAX_SALE_QTY ) OR
		                             ( DLY_PRCHS_CNT >= DLY_PROD_MAX_SALE_QTY ) ) THEN 'Y' ELSE 'N'
		               END ) AS soldOut                   
             FROM (
                  SELECT  * 
                   FROM (
                          SELECT 
                                B.CATALOG_ID 
                               ,C.CATALOG_NM 
                               ,NVL(L.PROD_NET_AMT, 0) AS PROD_NET_AMT 
                               ,NVL(L.PROD_AMT, 0) AS PROD_AMT 
                               ,NVL(N.SPRC_DC_RATE, L.DC_RATE) AS DC_RATE
                               ,NVL(N.SPRC_PRICE, L.PROD_AMT) AS DC_AMT
                               ,A.BRAND_ID  
                               ,A.BRAND_NM  
                               ,D.MENU_ID  
                               ,F.MENU_NM   
                               ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC) as NO
                               ,CASE WHEN (SYSDATE - 7)    <![CDATA[ <= ]]>  I.REG_DT THEN 'Y' ELSE 'N' END AS NEW_YN  
                               ,I.REG_DT 
                               ,K.TENANT_ID 
                               ,H.PROD_ID 
                               ,H.PART_PROD_ID  
                               ,I.DLV_PROD_YN
                               ,NVL(M.PRCHS_CNT, 0)  PRCHS_CNT
                               ,J.PROD_GRD_CD   
                               ,L.APPLY_START_DT     
                               ,L.APPLY_END_DT    
                               ,I.PROD_CASE_CD  
                               ,E.TOP_MENU_ID     
                               ,PI.FILE_PATH
                               ,PI.FILE_NM
			                   , NVL( ( SELECT SUM( TSPP.PRCHS_CNT )
			                             FROM TB_DP_SPRC_PROD_PRCHS_MANG TSPP
			                            WHERE TO_CHAR(TSPP.PRCHS_DT,'YYYYMMDD') BETWEEN CONCAT( TO_CHAR( SYSDATE, 'YYYYMM' ), '01' )
			                                                    AND TO_CHAR( LAST_DAY( SYSDATE ),'YYYYMMDD')
			                              AND TSPP.PROD_ID = H.PART_PROD_ID )
			                       , 0 ) AS MTH_PRCHS_CNT
			                   , NVL( ( SELECT TSPP.PRCHS_CNT
			                             FROM TB_DP_SPRC_PROD_PRCHS_MANG TSPP
			                            WHERE TO_CHAR(TSPP.PRCHS_DT,'YYYYMMDD') = TO_CHAR( SYSDATE, 'YYYYMMDD' )
			                              AND TSPP.PROD_ID = H.PART_PROD_ID )
			                       , 0 ) AS DLY_PRCHS_CNT 
			                   ,N.MM_PROD_MAX_SALE_QTY
			                   ,N.DLY_PROD_MAX_SALE_QTY
			                   ,N.SPRC_APPLY_START_DT
			                   ,N.SPRC_APPLY_END_DT
			                   ,N.EXPO_ORD   
			                   ,O.PROD_NM 
			                                             
                          FROM 
                                  TB_DP_SHPG_BRAND A
                                 ,TB_DP_SHPG_CATALOG B
                                 ,TB_DP_SHPG_CATALOG_DESC C
                                 ,TB_DP_MENU_SHPG_MAPG D
                                 ,TB_DP_MENU_CATEGORY E
                                 ,TB_DP_MENU_CATEGORY_DESC F 
                                 ,TB_DP_PROD_CATALOG_MAPG G 
                                 ,TB_DP_PROD_RSHP H
                                 ,TB_DP_SHPG_PROD I
                                 ,TB_DP_PROD J
                                 ,TB_DP_TENANT_PROD K
                                 ,TB_DP_TENANT_PROD_PRICE L
                                 ,TB_DP_PROD_IMG          PI
                                 ,(SELECT  PROD_ID
                                          ,PRCHS_CNT
                                     FROM TB_DP_TENANT_PROD_STATS 
                                    WHERE TENANT_ID = #{tenantId}    /* INPUT 테넌트ID */
                                   ) M
                                 ,TB_DP_SPRC_PROD N
                                 ,TB_DP_PROD_DESC O
                        WHERE 1=1
                        AND A.BRAND_ID = B.BRAND_ID
                        AND B.CATALOG_ID = C.CATALOG_ID
                        AND C.CATALOG_ID = D.CATALOG_ID     
                        AND D.MENU_ID = E.MENU_ID
                        AND D.MENU_ID = F.MENU_ID
                        AND B.CATALOG_ID = G.CATALOG_ID
                        AND G.PROD_ID = H.PROD_ID
                        AND H.PART_PROD_ID = I.PROD_ID
                        AND I.PROD_ID = J.PROD_ID
                        AND I.PROD_ID = K.PROD_ID
                        AND I.PROD_ID = L.PROD_ID
                        AND I.PROD_ID = M.PROD_ID(+)                           
                        AND I.PROD_ID = N.PROD_ID
                        AND I.PROD_ID = O.PROD_ID
                        AND N.EXPO_YN ='Y'
                        AND N.CPN_ID IS NOT NULL
                      
                        AND B.CATALOG_ID = PI.PROD_ID       
                        AND H.PROD_RSHP_CD ='DP010802'    /*채널-에피소드 상품 관계*/
                        AND NVL(B.CHNL_CNT, 0) > 0          
                        AND C.LANG_CD= #{langCd}          /* ko : 한국어 */
                        AND O.LANG_CD= #{langCd}          /* ko : 한국어 */
                        AND F.LANG_CD= #{langCd}          /* ko : 한국어 */
                        AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                        AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                        AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND NVL(I.B2B_PROD_YN, 'N') != 'Y'
                        AND K.PROD_STATUS_CD = 'PD000403'  /* PD000403 : 판매중 */
                        AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                       -- AND SYSDATE BETWEEN  N.SPRC_APPLY_START_DT AND N.SPRC_APPLY_END_DT 
                       -- AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                        AND K.TENANT_ID = #{tenantId}       /* INPUT 테넌트ID */
                        <if test="prodCharge != null">
                        AND J.PROD_CHRG_YN =#{prodCharge}
                        </if>
                        <if test="prodGradeCd != null">
                        AND J.PROD_GRD_CD =#{prodGradeCd}
                        </if>   
                        AND EXISTS (
                            SELECT 1 
                            FROM  TB_DP_SPRT_DEVICE DV  
                                 ,TB_CM_DEVICE CM
                            WHERE 1=1
                              AND DV.DEVICE_MODEL_CD = CM.DEVICE_MODEL_CD
                              AND CM.SCL_SHPG_SPRT_YN = 'Y'  /*쇼핑 상품 단말 지원 여부*/
                              AND DV.DEVICE_MODEL_CD  = #{deviceModelCd} 
                              AND PROD_ID = I.PROD_ID
                            )                        
                   ) 
                 WHERE NO =1
                 ORDER BY EXPO_ORD , PROD_NM 
               )
        ) WHERE RNUM BETWEEN #{offset} AND #{count}
    </select>            
    
    <!-- 기획전 상품 조회-->
    <select id="getSpecialSalesList" parameterType="ShoppingReq" resultType="Shopping">
       /* ShoppingMapper.xml.getSpecialSalesList,기획전 상품 조회, 김형식/SK플래닛 , 2014-02-03 */
      SELECT * FROM ( 
           SELECT 
                 KK.*
                ,COUNT(planId) OVER() AS TOTALCOUNT
                ,ROWNUM AS RNUM   
            FROM(      
                SELECT PLAN_ID as planId
                      ,PLAN_NM as PlanName
                      ,SUB_TITL_NM as subTitleName
                      ,LINK_URL as linkUrl
                      ,PLAN_START_DT as planStartDt
                      ,PLAN_END_DT as planEndDt
                      ,PRZWNER_ANNO_DT przwnerAnnoDt
                      ,PLAN_GIFT_NM as planGiftName
                      ,FN_GETIMAGE(PLAN_ID, #{imageCd}) filePos
                 FROM TB_DP_PLAN_INFO_MANG
                WHERE TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN PLAN_START_DT AND PLAN_END_DT
                  AND PLAN_STATUS_CD = 'DP006501'
                  AND DP_YN = 'Y'
                <if test="planId != null">
                  AND PLAN_ID = #{planId}
                </if>                  
                <if test='orderedBy == "recent"'>  
                 order by REG_DT DESC , PLAN_NM
                </if>
                <if test='orderedBy == "closingTime"'>  
                 order by PLAN_END_DT , PLAN_NM
                </if>               
            )KK
     ) WHERE RNUM BETWEEN #{offset} AND #{count}
    </select> 
    
    <!-- 특정 기획전에 대한 상품 리스트 조회-->
    <select id="getSpecialSalesProductList" parameterType="Map" resultType="ProductBasicInfo">
       /* ShoppingMapper.xml.getSpecialSalesProductList,특정 기획전에 대한 상품 리스트 조회, 김형식/SK플래닛 , 2014-02-04 */
        SELECT *
         FROM ( 
             SELECT 
                    rownum AS RNUM        
                   ,COUNT(CATALOG_ID) OVER() AS TOTALCOUNT      
                   ,CATALOG_ID AS catalogId
                   ,BRAND_ID AS brandId
                   ,MENU_ID AS menuId
                   ,TENANT_ID AS tenentId
                   ,PROD_ID as prodId
                   ,PART_PROD_ID as partProdId 
                   ,EXPO_ORD as expoOrd
                   ,'PD002501' as contentsTypeCd
             FROM (
                  SELECT  * 
                   FROM (
                          SELECT 
                                B.CATALOG_ID 
                               ,C.CATALOG_NM 
                               ,A.BRAND_ID  
                               ,D.MENU_ID  
                               ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC) as NO
                               ,K.TENANT_ID 
                               ,H.PROD_ID 
                               ,H.PART_PROD_ID  
                               ,M.EXPO_ORD
                               ,I.REG_DT   
                          FROM 
                                  TB_DP_SHPG_BRAND A
                                 ,TB_DP_SHPG_CATALOG B
                                 ,TB_DP_SHPG_CATALOG_DESC C
                                 ,TB_DP_MENU_SHPG_MAPG D
                                 ,TB_DP_MENU_CATEGORY E
                                 ,TB_DP_MENU_CATEGORY_DESC F 
                                 ,TB_DP_PROD_CATALOG_MAPG G 
                                 ,TB_DP_PROD_RSHP H
                                 ,TB_DP_SHPG_PROD I
                                 ,TB_DP_PROD J
                                 ,TB_DP_TENANT_PROD K
                                 ,TB_DP_TENANT_PROD_PRICE L
                                 ,TB_DP_PLAN_CATALOG_MANG M
                                 ,(SELECT 
                                        B1.PROD_ID
                                      , B1.SPRC_DC_RATE
                                      , B1.SPRC_PRICE
                                   FROM  TB_DP_PROD_RSHP A1
                                        ,TB_DP_SPRC_PROD B1
                                   WHERE 1=1
                                     AND A1.PART_PROD_ID = B1.PROD_ID
                                     AND B1.EXPO_YN ='Y'
                                     AND B1.CPN_ID IS NOT NULL
                                     AND SYSDATE BETWEEN  B1.SPRC_APPLY_START_DT AND B1.SPRC_APPLY_END_DT 
                                  )N
                        WHERE 1=1
                        AND A.BRAND_ID = B.BRAND_ID
                        AND B.CATALOG_ID = C.CATALOG_ID
                        AND C.CATALOG_ID = D.CATALOG_ID     
                        AND D.MENU_ID = E.MENU_ID
                        AND D.MENU_ID = F.MENU_ID
                        AND B.CATALOG_ID = G.CATALOG_ID
                        AND G.PROD_ID = H.PROD_ID
                        AND H.PART_PROD_ID = I.PROD_ID
                        AND I.PROD_ID = J.PROD_ID
                        AND I.PROD_ID = K.PROD_ID
                        AND I.PROD_ID = L.PROD_ID
                        AND B.CATALOG_ID = M.CATALOG_ID
                        AND M.EXPO_YN ='Y'            /* Y : 기본(기본여부) */
                        AND M.PLAN_ID = #{req.planId}  
                        AND I.PROD_ID = N.PROD_ID(+)     
                        AND H.PROD_RSHP_CD =#{prodRshpCd}     /*채널-에피소드 상품 관계*/
                        AND NVL(B.CHNL_CNT, 0) > 0                  
                        AND C.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND F.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                        AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                        AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND NVL(I.B2B_PROD_YN, 'N') != 'Y'
                        AND K.PROD_STATUS_CD = #{prodStatusCd}  /* PD000403 : 판매중 */
                        AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                        AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                        AND K.TENANT_ID = #{tenantHeader.tenantId}       /* INPUT 테넌트ID */
                        <if test="req.prodCharge != null">
                        AND J.PROD_CHRG_YN =#{req.prodCharge}
                        </if>
                        <if test="req.prodGradeCd != null">
                        AND J.PROD_GRD_CD =#{req.prodGradeCd}
                        </if>   
                        AND EXISTS (
                            SELECT 1 
                            FROM  TB_DP_SPRT_DEVICE DV  
                                 ,TB_CM_DEVICE CM
                            WHERE 1=1
                              AND DV.DEVICE_MODEL_CD = CM.DEVICE_MODEL_CD
                              AND CM.SCL_SHPG_SPRT_YN = 'Y'  /*쇼핑 상품 단말 지원 여부*/
                              AND DV.DEVICE_MODEL_CD  = #{req.deviceModelCd} 
                              AND PROD_ID = I.PROD_ID
                            )                      
                   ) 
                 WHERE NO =1
                 ORDER BY EXPO_ORD ASC, CATALOG_NM ASC
               ) 
        ) WHERE RNUM BETWEEN #{req.offset} AND #{req.count}
    </select>    
        
    <!-- 브랜드샵 - 메인 메뉴 리스트 조회-->
    <select id="getShoppingBrandMenuList" parameterType="ShoppingReq" resultType="Shopping">
       /* ShoppingMapper.xml.getShoppingBrandMenuList,브랜드샵 - 메인 메뉴 리스트 조회, 김형식/SK플래닛 , 2014-01-30 */
        SELECT  
                A.MENU_ID as menuId
               ,B.MENU_NM as menuName
          FROM  TB_DP_MENU_CATEGORY A
               ,TB_DP_MENU_CATEGORY_DESC B
         WHERE A.UP_MENU_ID ='DP28'
           AND A.MENU_ID = B.MENU_ID
           AND B.LANG_CD =#{langCd}          /* ko : 한국어 */
           AND A.USE_YN = 'Y'
           AND A.MENU_ID > ='DP28008'
    </select> 
    
    <!-- 브랜드샵 - 메인 리스트 조회-->
    <select id="getBrandshopMainList" parameterType="ShoppingReq" resultType="Shopping">
       /* ShoppingMapper.xml.getBrandshopMainList,브랜드샵 - 메인 리스트 조회, 김형식/SK플래닛 , 2014-01-30 */
       SELECT * FROM (
           SELECT 
                     KK.*
                    ,COUNT(1) OVER() AS TOTALCOUNT
                    ,ROWNUM AS RNUM         
             FROM(
                SELECT 
                           BRAND_ID AS brandId
                         , BRAND_NM AS brandName
                         , MENU_ID AS menuId
                          <if test='menuId == null and brandId == null'> 
                         , '쇼핑 HOT' AS menuName
                         </if>
                         <if test='menuId != null or brandId !=null'>
                         , MENU_NM AS menuName
                         </if>
                         , TOP_MENU_ID as upMenuId
                         ,(SELECT MENU_NM
                              FROM TB_DP_MENU_CATEGORY_DESC
                             WHERE MENU_ID = TOP_MENU_ID
                               AND LANG_CD = #{langCd}          /* ko : 한국어 */
                               AND ROWNUM = 1
                           ) AS upMenuName                        
                         ,FN_GETIMAGE(BRAND_ID, #{imageCd}) filePos 
                 FROM (
                    SELECT *
                    FROM (
                        SELECT  
                              SB.BRAND_ID
                             ,SB.BRAND_NM
                             ,MC.MENU_ID
                             ,MCD.MENU_NM
                             ,MC.TOP_MENU_ID
                             ,(SELECT COUNT(CT.CATALOG_ID) FROM TB_DP_SHPG_CATALOG CT WHERE CT.BRAND_ID = SB.BRAND_ID AND NVL(CT.CHNL_CNT, 0) > 0) AS CNT
                        FROM  TB_DP_SHPG_BRAND SB
                             ,TB_DP_MENU_CATEGORY MC
                             ,TB_DP_MENU_CATEGORY_DESC MCD
                              <if test='menuId == null and brandId == null' > 
                             ,TB_DP_RECOM_PROD_MANG PM
                             </if>
                        WHERE SB.MENU_ID = MC.MENU_ID
                          AND SB.MENU_ID = MCD.MENU_ID
     
                          <if test="brandId != null">
                          AND SB.BRAND_ID = #{brandId}
                          </if>       
                          <if test='menuId == null and brandId == null'> 
                          AND SB.BRAND_ID = PM.BRAND_ID
                          </if>
                          AND MC.USE_YN ='Y'
                           <if test='menuId != null'> 
                          AND MC.MENU_ID = #{menuId} 
                          </if>
                          AND MCD.LANG_CD =#{langCd}
                   )WHERE CNT>0
                    ORDER BY MENU_ID , BRAND_NM
                )
            )KK
        )WHERE RNUM BETWEEN #{offset} AND #{count}
    </select>     
    
    <!-- 특정 브랜드샵 상품 리스트 조회-->
    <select id="getBrandshopProductList" parameterType="Map" resultType="ProductBasicInfo">
       /* ShoppingMapper.xml.getBrandshopProductList,특정 브랜드샵 상품 리스트 조회, 김형식/SK플래닛 , 2014-02-04 */
        SELECT *
         FROM ( 
             SELECT 
                    rownum AS RNUM        
                   ,COUNT(CATALOG_ID) OVER() AS TOTALCOUNT      
                   ,CATALOG_ID AS catalogId
                   ,BRAND_ID AS brandId
                   ,MENU_ID AS menuId
                   ,TENANT_ID AS tenentId
                   ,PROD_ID as prodId
                   ,PART_PROD_ID as partProdId 
                   ,'PD002501' as contentsTypeCd
             FROM (
                  SELECT  * 
                   FROM (
                          SELECT 
                                 B.CATALOG_ID 
                               ,C.CATALOG_NM 
                               ,A.BRAND_ID  
                               ,D.MENU_ID  
                               ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC) as NO
                               ,K.TENANT_ID 
                               ,H.PROD_ID 
                               ,H.PART_PROD_ID  
                               ,I.REG_DT   
                          FROM 
                                  TB_DP_SHPG_BRAND A
                                 ,TB_DP_SHPG_CATALOG B
                                 ,TB_DP_SHPG_CATALOG_DESC C
                                 ,TB_DP_MENU_SHPG_MAPG D
                                 ,TB_DP_MENU_CATEGORY E
                                 ,TB_DP_MENU_CATEGORY_DESC F 
                                 ,TB_DP_PROD_CATALOG_MAPG G 
                                 ,TB_DP_PROD_RSHP H
                                 ,TB_DP_SHPG_PROD I
                                 ,TB_DP_PROD J
                                 ,TB_DP_TENANT_PROD K
                                 ,TB_DP_TENANT_PROD_PRICE L
                                 ,(SELECT  PROD_ID
                                          ,PRCHS_CNT
                                     FROM TB_DP_TENANT_PROD_STATS 
                                    WHERE TENANT_ID = #{tenantHeader.tenantId}    /* INPUT 테넌트ID */
                                   ) M
                                 ,(SELECT 
                                        B1.PROD_ID
                                      , B1.SPRC_DC_RATE
                                      , B1.SPRC_PRICE
                                   FROM  TB_DP_PROD_RSHP A1
                                        ,TB_DP_SPRC_PROD B1
                                   WHERE 1=1
                                     AND A1.PART_PROD_ID = B1.PROD_ID
                                     AND B1.EXPO_YN ='Y'
                                     AND B1.CPN_ID IS NOT NULL
                                     AND SYSDATE BETWEEN  B1.SPRC_APPLY_START_DT AND B1.SPRC_APPLY_END_DT 
                                  )N
                        WHERE 1=1
                        AND A.BRAND_ID = B.BRAND_ID
                        AND B.CATALOG_ID = C.CATALOG_ID
                        AND C.CATALOG_ID = D.CATALOG_ID     
                        AND D.MENU_ID = E.MENU_ID
                        AND D.MENU_ID = F.MENU_ID
                        AND B.CATALOG_ID = G.CATALOG_ID
                        AND G.PROD_ID = H.PROD_ID
                        AND H.PART_PROD_ID = I.PROD_ID
                        AND I.PROD_ID = J.PROD_ID
                        AND I.PROD_ID = K.PROD_ID
                        AND I.PROD_ID = L.PROD_ID
                        AND I.PROD_ID = M.PROD_ID(+)                           
                        AND I.PROD_ID = N.PROD_ID(+)  
                        AND H.PROD_RSHP_CD = #{prodRshpCd}    /*채널-에피소드 상품 관계*/ 
                        AND NVL(B.CHNL_CNT, 0) > 0          
                        AND C.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND F.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                        AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                        AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND NVL(I.B2B_PROD_YN, 'N') != 'Y'
                        AND K.PROD_STATUS_CD = #{prodStatusCd}  /* PD000403 : 판매중 */
                        AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                        AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                        AND K.TENANT_ID = #{tenantHeader.tenantId}  /* INPUT 테넌트ID */
                        AND A.BRAND_ID = #{req.brandId}        /* INPUT 테넌트ID */
                        <if test="req.prodCharge != null">
                        AND J.PROD_CHRG_YN =#{req.prodCharge}
                        </if>
                        <if test="req.prodGradeCd != null">
                        AND J.PROD_GRD_CD =#{req.prodGradeCd}
                        </if>   
                        AND EXISTS (
                            SELECT 1 
                            FROM  TB_DP_SPRT_DEVICE DV  
                                 ,TB_CM_DEVICE CM
                            WHERE 1=1
                              AND DV.DEVICE_MODEL_CD = CM.DEVICE_MODEL_CD
                              AND CM.SCL_SHPG_SPRT_YN = 'Y'  /*쇼핑 상품 단말 지원 여부*/
                              AND DV.DEVICE_MODEL_CD  = #{req.deviceModelCd} 
                              AND PROD_ID =I.PROD_ID
                            )                        
                   ) 
                 WHERE NO =1
                 ORDER BY REG_DT DESC, CATALOG_NM ASC
               ) 
        ) WHERE RNUM BETWEEN #{req.offset} AND #{req.count}
    </select>     

    <!-- 쇼핑테마  리스트 조회-->
    <select id="getThemeList" parameterType="ShoppingReq" resultType="Shopping">
       /* ShoppingMapper.xml.getThemeList,쇼핑테마  리스트 조회, 김형식/SK플래닛 , 2014-02-03 */
       SELECT * FROM (
           SELECT 
                     KK.*
                    ,COUNT(1) OVER() AS TOTALCOUNT
                    ,ROWNUM AS RNUM         
             FROM(       
                SELECT THEME_ID as themeId
                     , THEME_NM as themeName
                     , LINK_URL as linkUrl
                     , FN_GETIMAGE(THEME_ID, #{imageCd}) filePos
                  FROM TB_DP_THEME_INFO
                 WHERE EXPO_YN = 'Y'
                   AND THEME_STATUS_CD = 'DP006501'
                   AND TENANT_ID =#{tenantId}       /* INPUT 테넌트ID */
                  <if test="themeId != null">
                   AND THEME_ID = #{themeId}
                  </if>                           
                 ORDER BY THEME_ID DESC    
            )KK
        )WHERE RNUM BETWEEN #{offset} AND #{count}               
    </select>     
    
    <!-- 특정 테마 리스트상품 리스트 조회-->
    <select id="getThemeProductList" parameterType="Map" resultType="ProductBasicInfo">
       /* ShoppingMapper.xml.getThemeProductList,특정 테마 리스트상품 리스트 조회, 김형식/SK플래닛 , 2014-02-04 */
        SELECT *
         FROM ( 
             SELECT 
                    rownum AS RNUM        
                   ,COUNT(CATALOG_ID) OVER() AS TOTALCOUNT      
                   ,CATALOG_ID AS catalogId
                   ,BRAND_ID AS brandId
                   ,MENU_ID AS menuId
                   ,TENANT_ID AS tenentId
                   ,PROD_ID as prodId
                   ,PART_PROD_ID as partProdId 
                   ,EXPO_ORD as expoOrd
                   ,'PD002501' as contentsTypeCd
             FROM (
                  SELECT  * 
                   FROM (
                          SELECT 
                                B.CATALOG_ID 
                               ,C.CATALOG_NM 
                               ,A.BRAND_ID  
                               ,D.MENU_ID  
                               ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC) as NO
                               ,K.TENANT_ID 
                               ,H.PROD_ID 
                               ,H.PART_PROD_ID  
                               ,M.EXPO_ORD
                               ,I.REG_DT   
                          FROM 
                                  TB_DP_SHPG_BRAND A
                                 ,TB_DP_SHPG_CATALOG B
                                 ,TB_DP_SHPG_CATALOG_DESC C
                                 ,TB_DP_MENU_SHPG_MAPG D
                                 ,TB_DP_MENU_CATEGORY E
                                 ,TB_DP_MENU_CATEGORY_DESC F 
                                 ,TB_DP_PROD_CATALOG_MAPG G 
                                 ,TB_DP_PROD_RSHP H
                                 ,TB_DP_SHPG_PROD I
                                 ,TB_DP_PROD J
                                 ,TB_DP_TENANT_PROD K
                                 ,TB_DP_TENANT_PROD_PRICE L
                                 ,TB_DP_THEME_CATALOG M
                                 ,(SELECT 
                                        B1.PROD_ID
                                      , B1.SPRC_DC_RATE
                                      , B1.SPRC_PRICE
                                   FROM  TB_DP_PROD_RSHP A1
                                        ,TB_DP_SPRC_PROD B1
                                   WHERE 1=1
                                     AND A1.PART_PROD_ID = B1.PROD_ID
                                     AND B1.EXPO_YN ='Y'
                                     AND B1.CPN_ID IS NOT NULL
                                     AND SYSDATE BETWEEN  B1.SPRC_APPLY_START_DT AND B1.SPRC_APPLY_END_DT 
                                  )N
                        WHERE 1=1
                        AND A.BRAND_ID = B.BRAND_ID
                        AND B.CATALOG_ID = C.CATALOG_ID
                        AND C.CATALOG_ID = D.CATALOG_ID     
                        AND D.MENU_ID = E.MENU_ID
                        AND D.MENU_ID = F.MENU_ID
                        AND B.CATALOG_ID = G.CATALOG_ID
                        AND G.PROD_ID = H.PROD_ID
                        AND H.PART_PROD_ID = I.PROD_ID
                        AND I.PROD_ID = J.PROD_ID
                        AND I.PROD_ID = K.PROD_ID
                        AND I.PROD_ID = L.PROD_ID
                        AND B.CATALOG_ID = M.CATALOG_ID
                        AND M.EXPO_YN ='Y'            /* Y : 기본(기본여부) */
                        AND M.TENANT_ID = #{tenantHeader.tenantId}       /* INPUT 테넌트ID */
                        AND M.THEME_ID = #{req.themeId}  
                        AND I.PROD_ID = N.PROD_ID(+)     
                        AND H.PROD_RSHP_CD =#{prodRshpCd}     /*채널-에피소드 상품 관계*/
                        AND NVL(B.CHNL_CNT, 0) > 0                  
                        AND C.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND F.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                        AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                        AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND NVL(I.B2B_PROD_YN, 'N') != 'Y'
                        AND K.PROD_STATUS_CD = #{prodStatusCd}  /* PD000403 : 판매중 */
                        AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                        AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                        AND K.TENANT_ID = #{tenantHeader.tenantId}       /* INPUT 테넌트ID */
                        <if test="req.prodCharge != null">
                        AND J.PROD_CHRG_YN =#{req.prodCharge}
                        </if>
                        <if test="req.prodGradeCd != null">
                        AND J.PROD_GRD_CD =#{req.prodGradeCd}
                        </if>   
                        AND EXISTS (
                            SELECT 1 
                            FROM  TB_DP_SPRT_DEVICE DV  
                                 ,TB_CM_DEVICE CM
                            WHERE 1=1
                              AND DV.DEVICE_MODEL_CD = CM.DEVICE_MODEL_CD
                              AND CM.SCL_SHPG_SPRT_YN = 'Y'  /*쇼핑 상품 단말 지원 여부*/
                              AND DV.DEVICE_MODEL_CD  = #{req.deviceModelCd} 
                              AND PROD_ID = I.PROD_ID
                            )                      
                   ) 
                 WHERE NO =1
                 ORDER BY EXPO_ORD ASC, CATALOG_NM ASC
               ) 
        ) WHERE RNUM BETWEEN #{req.offset} AND #{req.count}
    </select>    
    
    <!-- 특정 카탈로그에 대한 다른 상품 리스트 조회-->
    <select id="getCatagoryAnotherProductList" parameterType="Map" resultType="ProductBasicInfo">
       /* ShoppingMapper.xml.getCatagoryAnotherProductList,특정 카탈로그에 대한 다른 상품 리스트 조회, 김형식/SK플래닛 , 2014-02-04 */
        SELECT *
         FROM ( 
             SELECT 
                    rownum AS RNUM        
                   ,COUNT(CATALOG_ID) OVER() AS TOTALCOUNT      
                   ,CATALOG_ID AS catalogId
                   ,BRAND_ID AS brandId
                   ,MENU_ID AS menuId
                   ,TENANT_ID AS tenentId
                   ,PROD_ID as prodId
                   ,PART_PROD_ID as partProdId 
                   ,'PD002501' as contentsTypeCd
             FROM (
                  SELECT  * 
                   FROM (
                          SELECT 
                                B.CATALOG_ID 
                               ,C.CATALOG_NM 
                               ,A.BRAND_ID  
                               ,D.MENU_ID  
                               ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC) as NO
                               ,K.TENANT_ID 
                               ,H.PROD_ID 
                               ,H.PART_PROD_ID  
                               ,I.REG_DT 
                               <if test='req.orderedBy == "recent"'>                 
                               ,'1' EXPO_ORD
                               </if>
                               <if test='req.orderedBy == "download"'>                 
                               ,M.EXPO_ORD
                               </if>                                                                                                                                                   
                          FROM 
                                  TB_DP_SHPG_BRAND A
                                 ,TB_DP_SHPG_CATALOG B
                                 ,TB_DP_SHPG_CATALOG_DESC C
                                 ,TB_DP_MENU_SHPG_MAPG D
                                 ,TB_DP_MENU_CATEGORY E
                                 ,TB_DP_MENU_CATEGORY_DESC F 
                                 ,TB_DP_PROD_CATALOG_MAPG G 
                                 ,TB_DP_PROD_RSHP H
                                 ,TB_DP_SHPG_PROD I
                                 ,TB_DP_PROD J
                                 ,TB_DP_TENANT_PROD K
                                 ,TB_DP_TENANT_PROD_PRICE L

                                 <if test='req.orderedBy == "recent"'>
                                 ,(SELECT  PROD_ID
                                          ,PRCHS_CNT
                                     FROM TB_DP_TENANT_PROD_STATS 
                                    WHERE TENANT_ID = #{tenantHeader.tenantId}    /* INPUT 테넌트ID */
                                   ) M
                                 </if>
                                 <if test='req.orderedBy == "download"'>
                                ,(
                                    SELECT  TDLP.TENANT_ID
                                          , TDLP.LIST_ID
                                          , TDLP.MENU_ID
                                          , TDLP.PROD_ID
                                          , TDLP.EXPO_ORD
                                          , TDLP.PRCHS_QTY  
                                          , TDLP.DWLD_QTY                                      
                                      FROM  
                                            TB_DP_LIST_PROD TDLP
                                           ,TB_DP_LIST TDL
                                     WHERE 1=1
                                       AND  TDLP.TENANT_ID = TDL.TENANT_ID
                                       AND  TDLP.LIST_ID   = TDL.LIST_ID
                                       AND  TDLP.TENANT_ID = #{tenantHeader.tenantId}   /* 테넌트ID */
                                       AND  TDLP.LIST_ID   = #{req.listId}     /* RNK000000006 쇼핑 인기 */
                                       AND  TDLP.EXPO_YN = 'Y'             /* Y : 노출 (노출여부) */
                                       AND  TDL.EXPO_YN  = 'Y'             /* Y : 노출 (노출여부) */
                                       AND  TO_CHAR(TDLP.STD_DT, 'YYYYMMDDHH24MISS') = #{stdDt}
                                       AND  SYSDATE BETWEEN TDLP.EXPO_START_DT AND TDLP.EXPO_END_DT                            
                                  ) M                                  
                                 </if>
                                 ,(SELECT 
                                        B1.PROD_ID
                                      , B1.SPRC_DC_RATE
                                      , B1.SPRC_PRICE
                                   FROM  TB_DP_PROD_RSHP A1
                                        ,TB_DP_SPRC_PROD B1
                                   WHERE 1=1
                                     AND A1.PART_PROD_ID = B1.PROD_ID
                                     AND B1.EXPO_YN ='Y'
                                     AND B1.CPN_ID IS NOT NULL
                                     AND SYSDATE BETWEEN  B1.SPRC_APPLY_START_DT AND B1.SPRC_APPLY_END_DT 
                                  )N
                        WHERE 1=1
                        AND A.BRAND_ID = B.BRAND_ID
                        AND B.CATALOG_ID = C.CATALOG_ID
                        AND C.CATALOG_ID = D.CATALOG_ID     
                        AND D.MENU_ID = E.MENU_ID
                        AND D.MENU_ID = F.MENU_ID
                        AND D.MENU_ID = #{req.menuId}           /*INPUT 메뉴ID*/
                        AND B.CATALOG_ID = G.CATALOG_ID
                        AND C.CATALOG_ID <![CDATA[<>]]> #{req.exceptProdId} 
                        AND G.PROD_ID = H.PROD_ID
                        AND H.PART_PROD_ID = I.PROD_ID
                        AND I.PROD_ID = J.PROD_ID
                        AND I.PROD_ID = K.PROD_ID
                        AND I.PROD_ID = L.PROD_ID
                         <if test='req.orderedBy == "recent"'>
                        AND I.PROD_ID = M.PROD_ID(+)        
                        </if>                                           
                        <if test='req.orderedBy == "download"'>
                        AND K.TENANT_ID = M.TENANT_ID 
                        AND I.PROD_ID = M.PROD_ID                             
                        </if>                   
                        AND I.PROD_ID = N.PROD_ID(+)       
                        AND H.PROD_RSHP_CD =#{prodRshpCd}    /*채널-에피소드 상품 관계*/   
                        AND NVL(B.CHNL_CNT, 0) > 0        
                        AND C.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND F.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                        AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                        AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND NVL(I.B2B_PROD_YN, 'N') != 'Y'
                        AND K.PROD_STATUS_CD = #{prodStatusCd}  /* PD000403 : 판매중 */
                        AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                        AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                        AND K.TENANT_ID = #{tenantHeader.tenantId}       /* INPUT 테넌트ID */
                        <if test="req.prodCharge != null">
                        AND J.PROD_CHRG_YN =#{req.prodCharge}
                        </if>
                        <if test="req.prodGradeCd != null">
                        AND J.PROD_GRD_CD =#{req.prodGradeCd}
                        </if>   
                        AND EXISTS (
                            SELECT 1 
                            FROM  TB_DP_SPRT_DEVICE DV  
                                 ,TB_CM_DEVICE CM
                            WHERE 1=1
                              AND DV.DEVICE_MODEL_CD = CM.DEVICE_MODEL_CD
                              AND CM.SCL_SHPG_SPRT_YN = 'Y'  /*쇼핑 상품 단말 지원 여부*/
                              AND DV.DEVICE_MODEL_CD  =  #{req.deviceModelCd}  
                              AND PROD_ID = I.PROD_ID
                            )                           
                   ) 
                 WHERE NO =1
               <if test='req.orderedBy == "recent"'>                 
               ORDER BY REG_DT DESC, CATALOG_NM ASC
               </if>
               <if test='req.orderedBy == "download"'>                 
               ORDER BY EXPO_ORD ASC, CATALOG_NM ASC
               </if>                   
               )
        ) WHERE RNUM BETWEEN #{req.offset} AND #{req.count}
    </select>        
     
   <!-- 특정 브랜드에 대한 다른 상품 리스트 조회-->
    <select id="getBrandAnotherProductList" parameterType="Map" resultType="ProductBasicInfo">
       /* ShoppingMapper.xml.getBrandAnotherProductList,특정 브랜드에 대한 다른 상품 리스트, 김형식/SK플래닛 , 2014-02-04 */
        SELECT *
         FROM ( 
             SELECT 
                    rownum AS RNUM        
                   ,COUNT(CATALOG_ID) OVER() AS TOTALCOUNT      
                   ,CATALOG_ID AS catalogId
                   ,BRAND_ID AS brandId
                   ,MENU_ID AS menuId
                   ,TENANT_ID AS tenentId
                   ,PROD_ID as prodId
                   ,PART_PROD_ID as partProdId 
                   ,'PD002501' as contentsTypeCd
             FROM (
                  SELECT  * 
                   FROM (
                          SELECT 
                                B.CATALOG_ID 
                               ,C.CATALOG_NM 
                               ,A.BRAND_ID  
                               ,D.MENU_ID  
                               ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC) as NO
                               ,K.TENANT_ID 
                               ,H.PROD_ID 
                               ,H.PART_PROD_ID  
                               ,I.REG_DT 
                               <if test='req.orderedBy == "recent"'>                 
                               ,'1' EXPO_ORD
                               </if>
                               <if test='req.orderedBy == "download"'>                 
                               ,M.EXPO_ORD
                               </if>                                                                                                                                                   
                          FROM 
                                  TB_DP_SHPG_BRAND A
                                 ,TB_DP_SHPG_CATALOG B
                                 ,TB_DP_SHPG_CATALOG_DESC C
                                 ,TB_DP_MENU_SHPG_MAPG D
                                 ,TB_DP_MENU_CATEGORY E
                                 ,TB_DP_MENU_CATEGORY_DESC F 
                                 ,TB_DP_PROD_CATALOG_MAPG G 
                                 ,TB_DP_PROD_RSHP H
                                 ,TB_DP_SHPG_PROD I
                                 ,TB_DP_PROD J
                                 ,TB_DP_TENANT_PROD K
                                 ,TB_DP_TENANT_PROD_PRICE L

                                 <if test='req.orderedBy == "recent"'>
                                 ,(SELECT  PROD_ID
                                          ,PRCHS_CNT
                                     FROM TB_DP_TENANT_PROD_STATS 
                                    WHERE TENANT_ID = #{tenantHeader.tenantId}    /* INPUT 테넌트ID */
                                   ) M
                                 </if>
                                 <if test='req.orderedBy == "download"'>
                                ,(
                                    SELECT  TDLP.TENANT_ID
                                          , TDLP.LIST_ID
                                          , TDLP.MENU_ID
                                          , TDLP.PROD_ID
                                          , TDLP.EXPO_ORD
                                          , TDLP.PRCHS_QTY  
                                          , TDLP.DWLD_QTY                                      
                                      FROM  
                                            TB_DP_LIST_PROD TDLP
                                           ,TB_DP_LIST TDL
                                     WHERE 1=1
                                       AND  TDLP.TENANT_ID = TDL.TENANT_ID
                                       AND  TDLP.LIST_ID   = TDL.LIST_ID
                                       AND  TDLP.TENANT_ID = #{tenantHeader.tenantId}   /* 테넌트ID */
                                       AND  TDLP.LIST_ID   = #{req.listId}     /* RNK000000006 쇼핑 인기 */
                                       AND  TDLP.EXPO_YN = 'Y'             /* Y : 노출 (노출여부) */
                                       AND  TDL.EXPO_YN  = 'Y'             /* Y : 노출 (노출여부) */
                                       AND  TO_CHAR(TDLP.STD_DT, 'YYYYMMDDHH24MISS') = #{stdDt}
                                       AND  SYSDATE BETWEEN TDLP.EXPO_START_DT AND TDLP.EXPO_END_DT                            
                                  ) M                                  
                                 </if>
                                 ,(SELECT 
                                        B1.PROD_ID
                                      , B1.SPRC_DC_RATE
                                      , B1.SPRC_PRICE
                                   FROM  TB_DP_PROD_RSHP A1
                                        ,TB_DP_SPRC_PROD B1
                                   WHERE 1=1
                                     AND A1.PART_PROD_ID = B1.PROD_ID
                                     AND B1.EXPO_YN ='Y'
                                     AND B1.CPN_ID IS NOT NULL
                                     AND SYSDATE BETWEEN  B1.SPRC_APPLY_START_DT AND B1.SPRC_APPLY_END_DT 
                                  )N
                        WHERE 1=1
                        AND A.BRAND_ID = B.BRAND_ID
                        AND B.CATALOG_ID = C.CATALOG_ID
                        AND C.CATALOG_ID = D.CATALOG_ID     
                        AND D.MENU_ID = E.MENU_ID
                        AND D.MENU_ID = F.MENU_ID
                        AND A.BRAND_ID = #{req.brandId}           /*INPUT 브랜드ID*/
                        AND B.CATALOG_ID = G.CATALOG_ID
                        AND C.CATALOG_ID <![CDATA[<>]]> #{req.exceptProdId}  /*INPUT 제외상품ID*/
                        AND G.PROD_ID = H.PROD_ID
                        AND H.PART_PROD_ID = I.PROD_ID
                        AND I.PROD_ID = J.PROD_ID
                        AND I.PROD_ID = K.PROD_ID
                        AND I.PROD_ID = L.PROD_ID
                         <if test='req.orderedBy == "recent"'>
                        AND I.PROD_ID = M.PROD_ID(+)        
                        </if>                                           
                        <if test='req.orderedBy == "download"'>
                        AND K.TENANT_ID = M.TENANT_ID 
                        AND I.PROD_ID = M.PROD_ID                             
                        </if>                   
                        AND I.PROD_ID = N.PROD_ID(+)       
                        AND H.PROD_RSHP_CD =#{prodRshpCd}    /*채널-에피소드 상품 관계*/   
                        AND NVL(B.CHNL_CNT, 0) > 0        
                        AND C.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND F.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                        AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                        AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND NVL(I.B2B_PROD_YN, 'N') != 'Y'
                        AND K.PROD_STATUS_CD = #{prodStatusCd}  /* PD000403 : 판매중 */
                        AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                        AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                        AND K.TENANT_ID = #{tenantHeader.tenantId}       /* INPUT 테넌트ID */
                        <if test="req.prodCharge != null">
                        AND J.PROD_CHRG_YN =#{req.prodCharge}
                        </if>
                        <if test="req.prodGradeCd != null">
                        AND J.PROD_GRD_CD =#{req.prodGradeCd}
                        </if>   
                        AND EXISTS (
                            SELECT 1 
                            FROM  TB_DP_SPRT_DEVICE DV  
                                 ,TB_CM_DEVICE CM
                            WHERE 1=1
                              AND DV.DEVICE_MODEL_CD = CM.DEVICE_MODEL_CD
                              AND CM.SCL_SHPG_SPRT_YN = 'Y'  /*쇼핑 상품 단말 지원 여부*/
                              AND DV.DEVICE_MODEL_CD  =  #{req.deviceModelCd}  
                              AND PROD_ID = I.PROD_ID
                            )                           
                   ) 
                 WHERE NO =1
               <if test='req.orderedBy == "recent"'>                 
               ORDER BY REG_DT DESC, CATALOG_NM ASC
               </if>
               <if test='req.orderedBy == "download"'>                 
               ORDER BY EXPO_ORD ASC, CATALOG_NM ASC
               </if>                   
               )
        ) WHERE RNUM BETWEEN #{req.offset} AND #{req.count}
    </select>         
</mapper>
