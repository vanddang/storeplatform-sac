<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Shopping">
    <!-- 쇼핑/인기 추천 상품 리스트 조회-->
    <select id="getFeatureProductList" parameterType="Map" resultType="ProductBasicInfo">
       /* ShoppingMapper.xml.getFeatureProductList,쇼핑/인기 추천 상품 리스트 조회,  김형식/SK플래닛  , 2014-01-07 */
        SELECT *
         FROM ( 
             SELECT 
                    rownum AS RNUM        
                   ,COUNT(CATALOG_ID) OVER() AS TOTALCOUNT      
                   ,CATALOG_ID AS catalogId
                   ,BRAND_ID AS brandId
                   ,MENU_ID AS menuId
                   ,TENANT_ID AS tenentId
                   ,PROD_ID as prodId
                   ,PART_PROD_ID as partProdId 
                   ,EXPO_ORD as expoOrd
                   ,#{channelContentTypeCd}  as contentsTypeCd
             FROM (
                  SELECT  * 
                   FROM (
                          SELECT 
                                B.CATALOG_ID 
                               ,C.CATALOG_NM 
                               ,A.BRAND_ID  
                               ,D.MENU_ID  
                               ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC) as NO
                               ,K.TENANT_ID 
                               ,H.PROD_ID 
                               ,H.PART_PROD_ID  
                               ,M.EXPO_ORD_ALWAYS_YN
                               ,M.EXPO_ORD
                               ,M.EXPO_ORD_SUB
                               ,I.REG_DT   
                          FROM 
                                  TB_DP_SHPG_BRAND A
                                 ,TB_DP_SHPG_CATALOG B
                                 ,TB_DP_SHPG_CATALOG_DESC C
                                 ,TB_DP_MENU_SHPG_MAPG D
                                 ,TB_DP_MENU_CATEGORY E
                                 ,TB_DP_MENU_CATEGORY_DESC F 
                                 ,TB_DP_PROD_CATALOG_MAPG G 
                                 ,TB_DP_PROD_RSHP H
                                 ,TB_DP_SHPG_PROD I
                                 ,TB_DP_PROD J
                                 ,TB_DP_TENANT_PROD K
                                 ,TB_DP_TENANT_PROD_PRICE L
                                ,(
                                    SELECT  TDLP.TENANT_ID
                                          , TDLP.LIST_ID
                                          , TDLP.MENU_ID
                                          , TDLP.PROD_ID
                                          , TDLP.EXPO_ORD_ALWAYS_YN
                                          , TDLP.EXPO_ORD
                                          , TDLP.EXPO_ORD_SUB
                                          , TDLP.PRCHS_QTY  
                                          , TDLP.DWLD_QTY                                      
                                      FROM  
                                            TB_DP_LIST_PROD TDLP
                                           ,TB_DP_LIST TDL
                                     WHERE 1=1
                                       AND  TDLP.TENANT_ID = TDL.TENANT_ID
                                       AND  TDLP.LIST_ID   = TDL.LIST_ID
                                       AND  TDLP.TENANT_ID = #{tenantHeader.tenantId}    /* 테넌트ID */
                                       AND  TDLP.LIST_ID   = #{req.listId}     /* ADM000000014 : 쇼핑 추천, RNK000000006 쇼핑 인기 */
                                       AND  TDLP.EXPO_YN = 'Y'             /* Y : 노출 (노출여부) */
                                       AND  TDL.EXPO_YN  = 'Y'             /* Y : 노출 (노출여부) */
                                       AND  TDLP.STD_DT = TO_DATE(#{stdDt}, 'YYYYMMDDHH24MISS')  
                                       AND  SYSDATE BETWEEN TDLP.EXPO_START_DT AND TDLP.EXPO_END_DT                            
                                  ) M                                
                                 ,(SELECT /*+ ORDERED */
                                        B1.PROD_ID
                                      , B1.SPRC_DC_RATE
                                      , B1.SPRC_PRICE
                                   FROM  TB_DP_PROD_RSHP A1
                                        ,TB_DP_SPRC_PROD B1
                                   WHERE 1=1
                                     AND A1.PART_PROD_ID = B1.PROD_ID
                                     AND B1.EXPO_YN ='Y'
                                     AND B1.CPN_ID IS NOT NULL
                                     AND SYSDATE BETWEEN  B1.SPRC_APPLY_START_DT AND B1.SPRC_APPLY_END_DT 
                                  )N
                        WHERE 1=1
                        AND A.BRAND_ID = B.BRAND_ID
                        AND B.CATALOG_ID = C.CATALOG_ID
                        AND C.CATALOG_ID = D.CATALOG_ID     
                        AND D.MENU_ID = E.MENU_ID
                        AND D.MENU_ID = F.MENU_ID
                        AND B.CATALOG_ID = G.CATALOG_ID
                        AND G.PROD_ID = H.PROD_ID
                        AND H.PROD_ID <![CDATA[ <> ]]> H.PART_PROD_ID
                        AND H.PART_PROD_ID = I.PROD_ID
                        AND I.PROD_ID = J.PROD_ID
                        AND I.PROD_ID = K.PROD_ID
                        AND I.PROD_ID = L.PROD_ID
                        AND K.TENANT_ID = M.TENANT_ID
                        AND K.TENANT_ID = L.TENANT_ID 
                        AND B.CATALOG_ID = M.PROD_ID   
                        AND I.PROD_ID = N.PROD_ID(+)     
                        AND H.PROD_RSHP_CD =#{prodRshpCd}    /*채널-에피소드 상품 관계*/
                        AND NVL(B.CHNL_CNT, 0) > 0                  
                        AND C.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND F.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                        AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                        AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND NVL(I.B2B_PROD_YN, 'N') <![CDATA[ <> ]]> 'Y'
                        AND K.PROD_STATUS_CD = #{prodStatusCd}  /* PD000403 : 판매중 */
                        AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                        AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                        AND K.TENANT_ID = #{tenantHeader.tenantId}       /* INPUT 테넌트ID */
                        <if test="req.prodCharge != null">
                        AND J.PROD_CHRG_YN =#{req.prodCharge}
                        </if>
                        <if test="req.arrayProdGradeCd != null">
                        AND J.PROD_GRD_CD  IN
                                      <foreach collection="req.arrayProdGradeCd" item="req.prodGradeCd" separator="," open="(" close=")">
                                        #{req.prodGradeCd}
                                      </foreach>                        
                        </if>   
                        AND EXISTS (
                            SELECT /*+ NL_SJ */ 1 
                            FROM  TB_DP_SPRT_DEVICE DV  
                            WHERE 1=1
                              AND (DV.DEVICE_MODEL_CD  = #{deviceHeader.model} OR DV.DEVICE_MODEL_CD = #{req.virtualDeviceModelNo}) 
                              AND PROD_ID = I.PROD_ID
                            )                      
                   ) 
                 WHERE NO =1
                 ORDER BY 
                      EXPO_ORD_ALWAYS_YN DESC
                    , EXPO_ORD   
                    , EXPO_ORD_SUB 
                    , CATALOG_NM ASC
               ) 
        ) WHERE RNUM BETWEEN #{req.offset} AND #{req.count}
    </select>    
    
    <!-- 최신 상품 리스트 조회-->
    <select id="getNewProductList" parameterType="Map" resultType="ProductBasicInfo">
       /* ShoppingMapper.xml.getNewProductList,최신 상품 리스트 조회, 김형식/SK플래닛  , 2014-01-07 */
        SELECT *
         FROM ( 
             SELECT 
                    rownum AS RNUM        
                   ,COUNT(CATALOG_ID) OVER() AS TOTALCOUNT      
                   ,CATALOG_ID AS catalogId
                   ,BRAND_ID AS brandId
                   ,MENU_ID AS menuId
                   ,TENANT_ID AS tenentId
                   ,PROD_ID as prodId
                   ,PART_PROD_ID as partProdId 
                   ,#{channelContentTypeCd} as contentsTypeCd
             FROM (
                  SELECT  * 
                   FROM (
                          SELECT /*+ LEADING(A B D) USE_NL(A B D)*/
                                B.CATALOG_ID 
                             --,C.CATALOG_NM                      --REMOVED BY 2014.10.10
                               ,A.BRAND_ID  
                               ,D.MENU_ID  
                               ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC) as NO
                               ,K.TENANT_ID 
                               ,H.PROD_ID 
                               ,H.PART_PROD_ID  
                             --,I.REG_DT                          --REMOVED BY 2014.10.10     
                          FROM 
                                  TB_DP_SHPG_BRAND A
                                 ,TB_DP_SHPG_CATALOG B
                              -- ,TB_DP_SHPG_CATALOG_DESC C       --REMOVED BY 2014.10.10
                                 ,TB_DP_MENU_SHPG_MAPG D
                              -- ,TB_DP_MENU_CATEGORY E           --REMOVED BY 2014.10.10
                              -- ,TB_DP_MENU_CATEGORY_DESC F      --REMOVED BY 2014.10.10
                                 ,TB_DP_PROD_CATALOG_MAPG G 
                                 ,TB_DP_PROD_RSHP H
                                 ,TB_DP_SHPG_PROD I
                                 ,TB_DP_PROD J
                                 ,TB_DP_TENANT_PROD K
                                 ,TB_DP_TENANT_PROD_PRICE L
                                 ,(SELECT /*+ NO_MERGE LEADING(B1) */
                                        B1.PROD_ID
                                      , B1.SPRC_DC_RATE
                                      , B1.SPRC_PRICE
                                   FROM  TB_DP_PROD_RSHP A1
                                        ,TB_DP_SPRC_PROD B1
                                   WHERE 1=1
                                     AND A1.PART_PROD_ID = B1.PROD_ID
                                     AND B1.EXPO_YN ='Y'
                                     AND B1.CPN_ID IS NOT NULL
                                     AND SYSDATE BETWEEN  B1.SPRC_APPLY_START_DT AND B1.SPRC_APPLY_END_DT 
                                  )N
                        WHERE 1=1
                        AND A.BRAND_ID = B.BRAND_ID
                        AND B.CATALOG_ID = D.CATALOG_ID               --Modified by 2014.10.10
                      --AND C.CATALOG_ID = D.CATALOG_ID               --REMOVED BY 2014.10.10  
                      --AND D.MENU_ID = E.MENU_ID                     --REMOVED BY 2014.10.10
                      --AND D.MENU_ID = F.MENU_ID                     --REMOVED BY 2014.10.10
                        AND B.CATALOG_ID = G.CATALOG_ID
                        AND G.PROD_ID = H.PROD_ID
                        AND H.PROD_ID <![CDATA[ <> ]]> H.PART_PROD_ID
                        AND H.PART_PROD_ID = I.PROD_ID
                        AND I.PROD_ID = J.PROD_ID
                        AND I.PROD_ID = K.PROD_ID
                        AND I.PROD_ID = L.PROD_ID
                        AND I.PROD_ID = N.PROD_ID(+)  
                        AND K.TENANT_ID = L.TENANT_ID 
                         <if test="req.partProdId != null">
                         AND I.PROD_ID = #{req.partProdId}
                         </if>                        
                        AND H.PROD_RSHP_CD =#{prodRshpCd}    /*채널-에피소드 상품 관계*/ 
                        AND NVL(B.CHNL_CNT, 0) > 0          

                        AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                      --AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */           --REMOVED BY 2014.10.10
                        AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND NVL(I.B2B_PROD_YN, 'N') <![CDATA[ <> ]]> 'Y'
                        AND K.PROD_STATUS_CD = #{prodStatusCd}  /* PD000403 : 판매중 */
                        AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                        AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                        AND K.TENANT_ID = #{tenantHeader.tenantId}        /* INPUT 테넌트ID */
                        <if test="req.prodCharge != null">
                        AND J.PROD_CHRG_YN =#{req.prodCharge}
                        </if>
                        <if test="req.arrayProdGradeCd != null">
                        AND J.PROD_GRD_CD  IN
                                      <foreach collection="req.arrayProdGradeCd" item="req.prodGradeCd" separator="," open="(" close=")">
                                        #{req.prodGradeCd}
                                      </foreach>                        
                        </if>      
                        AND  EXISTS ( --Modified by 2014.10.10
                                SELECT  /*+ UNNEST NL_SJ INDEX(H (DEVICE_MODEL_CD, PROD_ID)) */ 1  
                              FROM  TB_DP_SPRT_DEVICE DV  
                             WHERE PROD_ID = I.PROD_ID
                               AND (DV.DEVICE_MODEL_CD  = #{deviceHeader.model} OR DV.DEVICE_MODEL_CD = #{req.virtualDeviceModelNo}) 
                            )     
                        AND EXISTS (                                                           --Added by 2014.10.10
                            SELECT /*+ NL_SJ INDEX(C (CATALOG_ID,LANG_CD)) */ 1
                              FROM TB_DP_SHPG_CATALOG_DESC C
                            WHERE C.CATALOG_ID = B.CATALOG_ID
                              AND C.LANG_CD= #{tenantHeader.langCd} )
                        AND EXISTS (                                                           --Added by 2014.10.10
                            SELECT /*+ NL_SJ */ 1
                              FROM TB_DP_MENU_CATEGORY E,
                                   TB_DP_MENU_CATEGORY_DESC F
                            WHERE F.MENU_ID = D.MENU_ID
                              AND F.MENU_ID = E.MENU_ID
                              AND F.LANG_CD= #{tenantHeader.langCd}
                              AND E.USE_YN='Y' )                                                                             
                   ) 
                 WHERE NO =1
                 ORDER BY DBMS_RANDOM.VALUE
               ) 
        ) WHERE RNUM BETWEEN #{req.offset} AND #{req.count}
    </select>        
    
    <!-- 쇼핑 세부카테고리  상품 조회-->
    <select id="getSubProductList" parameterType="Map" resultType="ProductBasicInfo">
       /* ShoppingMapper.xml.getSubProductList,쇼핑 세부카테고리 상품 조회, 김형식/SK플래닛  , 2014-01-07 */
        SELECT *
         FROM ( 
             SELECT 
                    rownum AS RNUM        
                   ,COUNT(CATALOG_ID) OVER() AS TOTALCOUNT      
                   ,CATALOG_ID AS catalogId
                   ,BRAND_ID AS brandId
                   ,MENU_ID AS menuId
                   ,TENANT_ID AS tenentId
                   ,PROD_ID as prodId
                   ,PART_PROD_ID as partProdId 
                   ,#{channelContentTypeCd} as contentsTypeCd
             FROM (
                  SELECT  * 
                   FROM (
                          SELECT 
                                B.CATALOG_ID 
                               ,C.CATALOG_NM 
                               ,A.BRAND_ID  
                               ,D.MENU_ID  
                               ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC) as NO
                               ,K.TENANT_ID 
                               ,H.PROD_ID 
                               ,H.PART_PROD_ID 
                               <if test='req.orderedBy == "recent"'>
                               ,NVL((
                                    SELECT 
                                         MAX(SP.REG_DT)
                                    FROM 
                                         TB_DP_PROD_CATALOG_MAPG CM
                                        ,TB_DP_SHPG_PROD SP
                                    WHERE CM.CATALOG_ID =B.CATALOG_ID
                                      AND CM.PROD_ID = SP.PROD_ID
                                      AND CM.USE_YN ='Y'
                                      AND CM.BASE_YN ='Y'
                               ),I.REG_DT) AS REG_DT
                               ,'1' EXPO_ORD
                               </if>
                               <if test='req.orderedBy == "popular"'>                 
                               ,NVL(M.EXPO_ORD_ALWAYS_YN,'A') AS EXPO_ORD_ALWAYS_YN
                               ,M.EXPO_ORD
                               ,M.EXPO_ORD_SUB   
                               </if>                                                                                                                                                   
                          FROM 
                                  TB_DP_SHPG_BRAND A
                                 ,TB_DP_SHPG_CATALOG B
                                 ,TB_DP_SHPG_CATALOG_DESC C
                                 ,TB_DP_MENU_SHPG_MAPG D
                                 ,TB_DP_MENU_CATEGORY E
                                 ,TB_DP_MENU_CATEGORY_DESC F 
                                 ,TB_DP_PROD_CATALOG_MAPG G 
                                 ,TB_DP_PROD_RSHP H
                                 ,TB_DP_SHPG_PROD I
                                 ,TB_DP_PROD J
                                 ,TB_DP_TENANT_PROD K
                                 ,TB_DP_TENANT_PROD_PRICE L
                                 <if test='req.orderedBy == "popular"'>
                                ,(
                                    SELECT  TDLP.TENANT_ID
                                          , TDLP.LIST_ID
                                          , TDLP.MENU_ID
                                          , TDLP.PROD_ID
                                          , TDLP.EXPO_ORD_ALWAYS_YN
                                          , TDLP.EXPO_ORD
                                          , TDLP.EXPO_ORD_SUB
                                          , TDLP.PRCHS_QTY  
                                          , TDLP.DWLD_QTY                                      
                                      FROM  
                                            TB_DP_LIST_PROD TDLP
                                           ,TB_DP_LIST TDL
                                     WHERE 1=1
                                       AND  TDLP.TENANT_ID = TDL.TENANT_ID
                                       AND  TDLP.LIST_ID   = TDL.LIST_ID
                                       AND  TDLP.TENANT_ID = #{tenantHeader.tenantId}   /* 테넌트ID */
                                       AND  TDLP.LIST_ID   = #{req.listId}     /* RNK000000101 쇼핑 카탈로그 인기 */
                                       AND  TDLP.EXPO_YN = 'Y'             /* Y : 노출 (노출여부) */
                                       AND  TDL.EXPO_YN  = 'Y'             /* Y : 노출 (노출여부) */
                                       AND  TDLP.STD_DT = TO_DATE(#{stdDt}, 'YYYYMMDDHH24MISS') 
                                       AND  SYSDATE BETWEEN TDLP.EXPO_START_DT AND TDLP.EXPO_END_DT                            
                                  ) M                                  
                                 </if>
                                 ,(SELECT /*+ ORDERED */
                                        B1.PROD_ID
                                      , B1.SPRC_DC_RATE
                                      , B1.SPRC_PRICE
                                   FROM  TB_DP_PROD_RSHP A1
                                        ,TB_DP_SPRC_PROD B1
                                   WHERE 1=1
                                     AND A1.PART_PROD_ID = B1.PROD_ID
                                     AND B1.EXPO_YN ='Y'
                                     AND B1.CPN_ID IS NOT NULL
                                     AND SYSDATE BETWEEN  B1.SPRC_APPLY_START_DT AND B1.SPRC_APPLY_END_DT 
                                  )N
                        WHERE 1=1
                        AND A.BRAND_ID = B.BRAND_ID
                        AND B.CATALOG_ID = C.CATALOG_ID
                        AND C.CATALOG_ID = D.CATALOG_ID     
                        AND D.MENU_ID = E.MENU_ID
                        AND D.MENU_ID = F.MENU_ID
                        AND D.MENU_ID = #{req.menuId}           /*INPUT 메뉴ID*/  
                        AND B.CATALOG_ID = G.CATALOG_ID
                        AND G.PROD_ID = H.PROD_ID
                        AND H.PROD_ID <![CDATA[ <> ]]> H.PART_PROD_ID
                        AND H.PART_PROD_ID = I.PROD_ID
                        AND I.PROD_ID = J.PROD_ID
                        AND I.PROD_ID = K.PROD_ID
                        AND I.PROD_ID = L.PROD_ID
                        AND K.TENANT_ID = L.TENANT_ID 
                        <if test='req.orderedBy == "popular"'>
                        AND B.CATALOG_ID = M.PROD_ID(+)                             
                        </if>                   
                        AND I.PROD_ID = N.PROD_ID(+)       
                        AND H.PROD_RSHP_CD =#{prodRshpCd}    /*채널-에피소드 상품 관계*/   
                        AND NVL(B.CHNL_CNT, 0) > 0        
                        AND C.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND F.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                        AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                        AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND NVL(I.B2B_PROD_YN, 'N') <![CDATA[ <> ]]> 'Y'
                        AND K.PROD_STATUS_CD = #{prodStatusCd}  /* PD000403 : 판매중 */
                        AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                        AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                        AND K.TENANT_ID = #{tenantHeader.tenantId}       /* INPUT 테넌트ID */
                        <if test="req.prodCharge != null">
                        AND J.PROD_CHRG_YN =#{req.prodCharge}
                        </if>
                         <if test="req.arrayProdGradeCd != null">
                        AND J.PROD_GRD_CD  IN
                                      <foreach collection="req.arrayProdGradeCd" item="req.prodGradeCd" separator="," open="(" close=")">
                                        #{req.prodGradeCd}
                                      </foreach>                        
                        </if>   
                        AND  EXISTS (
                            SELECT /*+ UNNEST NL_SJ INDEX(H (DEVICE_MODEL_CD, PROD_ID)) */  1                  --ADDED BY 2014.10.13 
                            FROM  TB_DP_SPRT_DEVICE DV  
                            WHERE 1=1
                              AND (DV.DEVICE_MODEL_CD  = #{deviceHeader.model} OR DV.DEVICE_MODEL_CD = #{req.virtualDeviceModelNo}) 
                              AND PROD_ID = I.PROD_ID
                            )                           
                   ) 
                 WHERE NO =1
               <if test='req.orderedBy == "recent"'>                 
               ORDER BY 
                     REG_DT DESC
                   , CATALOG_NM ASC
               </if>
               <if test='req.orderedBy == "popular"'>                 
               ORDER BY 
                      EXPO_ORD_ALWAYS_YN DESC
                    , EXPO_ORD   
                    , EXPO_ORD_SUB 
                    , CATALOG_NM ASC               
               </if>                   
               )
        ) WHERE RNUM BETWEEN #{req.offset} AND #{req.count}
    </select>            
    
   <!-- 특가 상품 리스트 조회-->
    <select id="getSpecialPriceProductList"  parameterType="ShoppingReq" resultType="MetaInfo">
       /* ShoppingMapper.xml.getSpecialPriceProductList,특가 상품 리스트 조회, 김형식/SK플래닛  , 2014-02-04 */
       SELECT *
         FROM ( 
             SELECT 
                    ROW_NUMBER()OVER(ORDER BY REG_DT DESC, CATALOG_NM ) AS RNUM        
                   ,COUNT(CATALOG_ID) OVER() AS TOTALCOUNT      
                   ,CATALOG_ID 
                   ,PROD_NET_AMT
                   ,PROD_AMT 
                   ,DC_RATE 
                   ,DC_AMT 
                   ,DLV_PROD_YN
                   ,BRAND_ID 
                   ,BRAND_NM 
                   ,MENU_ID 
                   ,MENU_NM 
                   ,TOP_MENU_ID 
                   ,META_CLSF_CD
                   ,(SELECT MENU_NM
                        FROM TB_DP_MENU_CATEGORY_DESC
                       WHERE MENU_ID = TOP_MENU_ID
                         AND LANG_CD = #{langCd}          /* ko : 한국어 */
                         AND ROWNUM = 1
                     ) AS TOP_MENU_NM                        
                   ,NO AS no
                   ,NEW_YN 
                   ,REG_DT 
                   ,TENANT_ID
                   ,PROD_ID 
                   ,PART_PROD_ID 
                   ,PROD_NM AS catalogNm
                   ,PRCHS_CNT 
                   ,PROD_GRD_CD as prodGrdCd
                   ,TO_CHAR(SPRC_APPLY_START_DT,'YYYYMMDDHH24MISS') as applyStartDt   
                   ,TO_CHAR(SPRC_APPLY_END_DT,'YYYYMMDDHH24MISS') as applyEndDt 
                   ,PROD_CASE_CD  
                   ,CONCAT(FILE_PATH,FILE_NM) AS FILE_PATH
                   ,'Y' AS specialSale
                   ,(CASE WHEN ( ( MTH_PRCHS_CNT >= MM_PROD_MAX_SALE_QTY ) OR
                                 ( DLY_PRCHS_CNT >= DLY_PROD_MAX_SALE_QTY )
                                  OR 
                                 ( SOLD_OUT_YN ='Y' ) 
                                ) 
                     THEN 'Y' ELSE 'N'
                     END ) AS soldOut     
                   ,CONTENTS_TYPE_CD  
                   ,EXPO_ORD            
             FROM (
                  SELECT  * 
                   FROM (
                          SELECT 
                                B.CATALOG_ID 
                               ,C.CATALOG_NM 
                               ,NVL(L.PROD_NET_AMT, 0) AS PROD_NET_AMT 
                               ,NVL(N.SPRC_PRICE, NVL(L.PROD_AMT, 0)) AS PROD_AMT 
                               ,NVL(N.SPRC_DC_RATE, NVL(L.DC_RATE,0)) AS DC_RATE
                               ,NVL(N.SPRC_DC_PRICE, NVL(L.DC_AMT, 0)) AS DC_AMT
                               ,A.BRAND_ID  
                               ,A.BRAND_NM  
                               ,D.MENU_ID  
                               ,F.MENU_NM   
                               ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC) as NO
                               ,CASE WHEN (SYSDATE - 7)    <![CDATA[ <= ]]>  I.REG_DT THEN 'Y' ELSE 'N' END AS NEW_YN  
                               ,I.REG_DT 
                               ,K.TENANT_ID 
                               ,H.PROD_ID 
                               ,H.PART_PROD_ID  
                               ,I.DLV_PROD_YN
                               ,CASE WHEN NVL(M.PRCHS_CNT, 0) <![CDATA[ < ]]> 0 THEN 0 ELSE NVL(M.PRCHS_CNT, 0) END AS PRCHS_CNT 
                               ,J.PROD_GRD_CD   
                               ,L.APPLY_START_DT     
                               ,L.APPLY_END_DT    
                               ,(CASE WHEN I.PROD_CASE_CD='DP006301' THEN 'giftcard' 
                                      WHEN I.PROD_CASE_CD='DP006302' THEN 'exchange' 
                                      WHEN I.PROD_CASE_CD='DP006303' THEN 'delivery' 
                                 END) AS PROD_CASE_CD                                 
                               ,E.TOP_MENU_ID
                               ,J.META_CLSF_CD       
                               ,PI.FILE_PATH
                               ,PI.FILE_NM
                               , NVL( ( SELECT SUM( TSPP.PRCHS_CNT )
                                         FROM TB_DP_SPRC_PROD_PRCHS_MANG TSPP
                                        WHERE TO_CHAR(TSPP.PRCHS_DT,'YYYYMMDD') BETWEEN CONCAT( TO_CHAR( SYSDATE, 'YYYYMM' ), '01' )
                                                                AND TO_CHAR( LAST_DAY( SYSDATE ),'YYYYMMDD')
                                          AND TSPP.PROD_ID = H.PART_PROD_ID )
                                   , 0 ) AS MTH_PRCHS_CNT
                               , NVL( ( SELECT TSPP.PRCHS_CNT
                                         FROM TB_DP_SPRC_PROD_PRCHS_MANG TSPP
                                        WHERE TO_CHAR(TSPP.PRCHS_DT,'YYYYMMDD') = TO_CHAR( SYSDATE, 'YYYYMMDD' )
                                          AND TSPP.PROD_ID = H.PART_PROD_ID )
                                   , 0 ) AS DLY_PRCHS_CNT 
                               ,N.MM_PROD_MAX_SALE_QTY
                               ,N.DLY_PROD_MAX_SALE_QTY
                               ,N.SPRC_APPLY_START_DT
                               ,N.SPRC_APPLY_END_DT
                               ,N.EXPO_ORD   
                               ,N.SOLD_OUT_YN
                               ,O.PROD_NM 
                               ,J.CONTENTS_TYPE_CD 
                          FROM 
                                  TB_DP_SHPG_BRAND A
                                 ,TB_DP_SHPG_CATALOG B
                                 ,TB_DP_SHPG_CATALOG_DESC C
                                 ,TB_DP_MENU_SHPG_MAPG D
                                 ,TB_DP_MENU_CATEGORY E
                                 ,TB_DP_MENU_CATEGORY_DESC F 
                                 ,TB_DP_PROD_CATALOG_MAPG G 
                                 ,TB_DP_PROD_RSHP H
                                 ,TB_DP_SHPG_PROD I
                                 ,TB_DP_PROD J
                                 ,TB_DP_TENANT_PROD K
                                 ,TB_DP_TENANT_PROD_PRICE L
                                 ,TB_DP_PROD_IMG          PI
                                 ,(SELECT  PROD_ID
                                          ,PRCHS_CNT
                                     FROM TB_DP_TENANT_PROD_STATS 
                                    WHERE TENANT_ID = #{tenantId}    /* INPUT 테넌트ID */
                                   ) M
                                 ,TB_DP_SPRC_PROD N
                                 ,TB_DP_PROD_DESC O
                        WHERE 1=1
                        AND A.BRAND_ID = B.BRAND_ID
                        AND B.CATALOG_ID = C.CATALOG_ID
                        AND C.CATALOG_ID = D.CATALOG_ID     
                        AND D.MENU_ID = E.MENU_ID
                        AND D.MENU_ID = F.MENU_ID
                        AND B.CATALOG_ID = G.CATALOG_ID
                        AND G.PROD_ID = H.PROD_ID
                        AND H.PROD_ID <![CDATA[ <> ]]> H.PART_PROD_ID
                        AND H.PART_PROD_ID = I.PROD_ID
                        AND I.PROD_ID = J.PROD_ID
                        AND I.PROD_ID = K.PROD_ID
                        AND I.PROD_ID = L.PROD_ID
                        AND C.CATALOG_ID = M.PROD_ID(+)                           
                        AND I.PROD_ID = N.PROD_ID
                        AND I.PROD_ID = O.PROD_ID
                        AND K.TENANT_ID = L.TENANT_ID 
                        AND N.EXPO_YN ='Y'
                        AND N.CPN_ID IS NOT NULL
                        AND PI.IMG_CD(+) = #{imageCd}
                        AND B.CATALOG_ID = PI.PROD_ID       
                        AND H.PROD_RSHP_CD ='DP010802'    /*채널-에피소드 상품 관계*/
                        AND NVL(B.CHNL_CNT, 0) > 0          
                        AND C.LANG_CD= #{langCd}          /* ko : 한국어 */
                        AND O.LANG_CD= #{langCd}          /* ko : 한국어 */
                        AND F.LANG_CD= #{langCd}          /* ko : 한국어 */
                        AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                        AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                        AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND NVL(I.B2B_PROD_YN, 'N') <![CDATA[ <> ]]> 'Y'
                        AND K.PROD_STATUS_CD = 'PD000403'  /* PD000403 : 판매중 */
                        AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                        AND SYSDATE BETWEEN  N.SPRC_APPLY_START_DT AND N.SPRC_APPLY_END_DT 
                        AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                        AND K.TENANT_ID = #{tenantId}       /* INPUT 테넌트ID */
                        <if test="prodCharge != null">
                        AND J.PROD_CHRG_YN =#{prodCharge}
                        </if>
                        <if test="arrayProdGradeCd != null">
                        AND J.PROD_GRD_CD  IN
                                      <foreach collection="arrayProdGradeCd" item="prodGradeCd" separator="," open="(" close=")">
                                        #{prodGradeCd}
                                      </foreach>                        
                        </if>   

                        AND EXISTS (
                            SELECT 1 
                            FROM  TB_DP_SPRT_DEVICE DV  
                            WHERE 1=1
                              AND (DV.DEVICE_MODEL_CD  = #{deviceModelCd} OR DV.DEVICE_MODEL_CD = #{virtualDeviceModelNo}) 
                              AND PROD_ID = I.PROD_ID
                            )                        
                   ) 
                 WHERE NO =1
               )
                ORDER BY EXPO_ORD , PROD_NM 
        ) WHERE RNUM BETWEEN #{offset} AND #{count}
    </select>                 
    
    <!-- 기획전 상품 조회-->
    <select id="getSpecialSalesList" parameterType="ShoppingReq" resultType="MetaInfo">
       /* ShoppingMapper.xml.getSpecialSalesList,기획전 상품 조회, 김형식/SK플래닛  , 2014-02-03 */
      SELECT * FROM ( 
           SELECT 
                 KK.*
                ,COUNT(PLAN_ID) OVER() AS TOTALCOUNT
                ,ROWNUM AS RNUM   
            FROM(      
                SELECT PLAN_ID
                      ,PLAN_NM as prodNm
                      ,SUB_TITL_NM
                      ,LINK_URL
                      ,TO_CHAR(PLAN_START_DT,'YYYYMMDDHH24MISS') AS PLAN_START_DT
                      ,TO_CHAR(PLAN_END_DT,'YYYYMMDDHH24MISS') AS PLAN_END_DT
                      ,TO_CHAR(PRZWNER_ANNO_DT, 'YYYYMMDDHH24MISS') AS PRZWNER_ANNO_DT
                      ,PLAN_GIFT_NM
                      ,(SELECT CONCAT(FILE_PATH,FILE_NM) FROM TB_DP_PROD_IMG
                         WHERE PROD_ID = PLAN_ID AND IMG_CD =#{bannerImgCd}
                       )bannerFilePath
                      ,(SELECT CONCAT(FILE_PATH,FILE_NM) FROM TB_DP_PROD_IMG
                         WHERE PROD_ID = PLAN_ID AND IMG_CD =#{promotionImgCd}
                       )FILE_PATH                      
                 FROM TB_DP_PLAN_INFO_MANG KK
                WHERE SYSDATE BETWEEN PLAN_START_DT AND PLAN_END_DT
                  AND PLAN_STATUS_CD = 'DP006501'
                  AND DP_YN = 'Y'
                <if test="planId != null">
                  AND PLAN_ID = #{planId}
                </if>                  
                  AND EXISTS (
                         SELECT
                                  'X'
                           FROM 
                                    TB_DP_SHPG_BRAND A
                                   ,TB_DP_SHPG_CATALOG B
                                   ,TB_DP_SHPG_CATALOG_DESC C
                                   ,TB_DP_MENU_SHPG_MAPG D
                                   ,TB_DP_MENU_CATEGORY E
                                   ,TB_DP_MENU_CATEGORY_DESC F 
                                   ,TB_DP_PROD_CATALOG_MAPG G 
                                   ,TB_DP_PROD_RSHP H
                                   ,TB_DP_SHPG_PROD I
                                   ,TB_DP_PROD J
                                   ,TB_DP_TENANT_PROD K
                                   ,TB_DP_TENANT_PROD K1
                                   ,TB_DP_TENANT_PROD_PRICE L
                                   ,TB_DP_PLAN_CATALOG_MANG M
                          WHERE 1=1
                          AND A.BRAND_ID = B.BRAND_ID
                          AND B.CATALOG_ID = C.CATALOG_ID
                          AND C.CATALOG_ID = D.CATALOG_ID     
                          AND D.MENU_ID = E.MENU_ID
                          AND D.MENU_ID = F.MENU_ID
                          AND B.CATALOG_ID = G.CATALOG_ID
                          AND G.PROD_ID = H.PROD_ID
                          AND H.PROD_ID <![CDATA[ <> ]]> H.PART_PROD_ID
                          AND H.PART_PROD_ID = I.PROD_ID
                          AND I.PROD_ID = J.PROD_ID
                          AND I.PROD_ID = K.PROD_ID
                          AND I.PROD_ID = L.PROD_ID
                          AND G.PROD_ID = K1.PROD_ID
                          AND K.TENANT_ID = K1.TENANT_ID
                          AND K.TENANT_ID = L.TENANT_ID 
                          AND H.PROD_RSHP_CD ='DP010802'    /*채널-에피소드 상품 관계*/ 
                          AND NVL(B.CHNL_CNT, 0) > 0          
                          AND C.LANG_CD= #{langCd}          /* ko : 한국어 */
                          AND F.LANG_CD= #{langCd}         /* ko : 한국어 */
                          AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                          AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                          AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                          AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                          AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                          AND NVL(I.B2B_PROD_YN, 'N') <![CDATA[ <> ]]> 'Y'
                          AND K1.PROD_STATUS_CD = 'PD000403'  /* PD000403 : 판매중 */
                          AND K1.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */                                
                          AND K.PROD_STATUS_CD = 'PD000403'  /* PD000403 : 판매중 */
                          AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                          AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                          AND K.TENANT_ID = #{tenantId}        /* INPUT 테넌트ID */
                          AND M.EXPO_YN ='Y'            /* Y : 기본(기본여부) */
                          AND M.PLAN_ID = KK.PLAN_ID 
                          AND B.CATALOG_ID = M.CATALOG_ID                      
                          AND  EXISTS (
                              SELECT 1 
                                FROM  TB_DP_SPRT_DEVICE DV  
                               WHERE PROD_ID = I.PROD_ID
                                 AND DV.DEVICE_MODEL_CD  = #{deviceModelCd} 
                               UNION ALL
                              SELECT 1 
                                FROM  TB_DP_SPRT_DEVICE DV  
                               WHERE PROD_ID = I.PROD_ID                             
                                 AND DV.DEVICE_MODEL_CD = #{virtualDeviceModelNo} 
                               )
                         )                 
                <if test='orderedBy == "recent"'>  
                 order by REG_DT DESC , PLAN_NM
                </if>
                <if test='orderedBy == "closingTime"'>  
                 order by PLAN_END_DT , PLAN_NM
                </if>      
                        
            )KK
     )  
     <if test="planId == null"> 
     WHERE RNUM BETWEEN #{offset} AND #{count}
     </if>
    </select> 
    
    <!-- 특정 기획전에 대한 상품 리스트 조회-->
    <select id="getSpecialSalesProductList" parameterType="Map" resultType="ProductBasicInfo">
       /* ShoppingMapper.xml.getSpecialSalesProductList,특정 기획전에 대한 상품 리스트 조회, 김형식/SK플래닛  , 2014-02-04 */
        SELECT *
         FROM ( 
             SELECT 
                    rownum AS RNUM        
                   ,COUNT(CATALOG_ID) OVER() AS TOTALCOUNT      
                   ,CATALOG_ID AS catalogId
                   ,BRAND_ID AS brandId
                   ,MENU_ID AS menuId
                   ,TENANT_ID AS tenentId
                   ,PROD_ID as prodId
                   ,PART_PROD_ID as partProdId 
                   ,EXPO_ORD as expoOrd
                   ,#{channelContentTypeCd} as contentsTypeCd
             FROM (
                  SELECT  * 
                   FROM (
                          SELECT 
                                B.CATALOG_ID 
                               ,C.CATALOG_NM 
                               ,A.BRAND_ID  
                               ,D.MENU_ID  
                               ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC) as NO
                               ,K.TENANT_ID 
                               ,H.PROD_ID 
                               ,H.PART_PROD_ID  
                               ,M.EXPO_ORD
                               ,I.REG_DT   
                          FROM 
                                  TB_DP_SHPG_BRAND A
                                 ,TB_DP_SHPG_CATALOG B
                                 ,TB_DP_SHPG_CATALOG_DESC C
                                 ,TB_DP_MENU_SHPG_MAPG D
                                 ,TB_DP_MENU_CATEGORY E
                                 ,TB_DP_MENU_CATEGORY_DESC F 
                                 ,TB_DP_PROD_CATALOG_MAPG G 
                                 ,TB_DP_PROD_RSHP H
                                 ,TB_DP_SHPG_PROD I
                                 ,TB_DP_PROD J
                                 ,TB_DP_TENANT_PROD K
                                 ,TB_DP_TENANT_PROD_PRICE L
                                 ,TB_DP_PLAN_CATALOG_MANG M
                                 ,(SELECT /*+ ORDERED */
                                        B1.PROD_ID
                                      , B1.SPRC_DC_RATE
                                      , B1.SPRC_PRICE
                                   FROM  TB_DP_PROD_RSHP A1
                                        ,TB_DP_SPRC_PROD B1
                                   WHERE 1=1
                                     AND A1.PART_PROD_ID = B1.PROD_ID
                                     AND B1.EXPO_YN ='Y'
                                     AND B1.CPN_ID IS NOT NULL
                                     AND SYSDATE BETWEEN  B1.SPRC_APPLY_START_DT AND B1.SPRC_APPLY_END_DT 
                                  )N
                        WHERE 1=1
                        AND A.BRAND_ID = B.BRAND_ID
                        AND B.CATALOG_ID = C.CATALOG_ID
                        AND C.CATALOG_ID = D.CATALOG_ID     
                        AND D.MENU_ID = E.MENU_ID
                        AND D.MENU_ID = F.MENU_ID
                        AND B.CATALOG_ID = G.CATALOG_ID
                        AND G.PROD_ID = H.PROD_ID
                        AND H.PROD_ID <![CDATA[ <> ]]> H.PART_PROD_ID
                        AND H.PART_PROD_ID = I.PROD_ID
                        AND I.PROD_ID = J.PROD_ID
                        AND I.PROD_ID = K.PROD_ID
                        AND I.PROD_ID = L.PROD_ID
                        AND B.CATALOG_ID = M.CATALOG_ID
                        AND K.TENANT_ID = L.TENANT_ID 
                        AND M.EXPO_YN ='Y'            /* Y : 기본(기본여부) */
                        AND M.PLAN_ID = #{req.planId}  
                        AND I.PROD_ID = N.PROD_ID(+)     
                        AND H.PROD_RSHP_CD =#{prodRshpCd}     /*채널-에피소드 상품 관계*/
                        AND NVL(B.CHNL_CNT, 0) > 0                  
                        AND C.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND F.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                        AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                        AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND NVL(I.B2B_PROD_YN, 'N') <![CDATA[ <> ]]> 'Y'
                        AND K.PROD_STATUS_CD = #{prodStatusCd}  /* PD000403 : 판매중 */
                        AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                        AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                        AND K.TENANT_ID = #{tenantHeader.tenantId}       /* INPUT 테넌트ID */
                        <if test="req.prodCharge != null">
                        AND J.PROD_CHRG_YN =#{req.prodCharge}
                        </if>
                        <if test="req.arrayProdGradeCd != null">
                        AND J.PROD_GRD_CD  IN
                                      <foreach collection="req.arrayProdGradeCd" item="req.prodGradeCd" separator="," open="(" close=")">
                                        #{req.prodGradeCd}
                                      </foreach>                        
                        </if>      
                        AND EXISTS (
                            SELECT /*+ UNNEST NL_SJ INDEX(H (DEVICE_MODEL_CD, PROD_ID)) */ 1 
                            FROM  TB_DP_SPRT_DEVICE DV  
                            WHERE 1=1
                              AND (DV.DEVICE_MODEL_CD  = #{deviceHeader.model} OR DV.DEVICE_MODEL_CD = #{req.virtualDeviceModelNo}) 
                              AND PROD_ID = I.PROD_ID
                            )                      
                   ) 
                 WHERE NO =1
                 ORDER BY EXPO_ORD ASC, CATALOG_NM ASC
               ) 
        ) WHERE RNUM BETWEEN #{req.offset} AND #{req.count}
    </select>    
        
    <!-- 브랜드샵 - 메인 메뉴 리스트 조회-->
    <select id="getShoppingBrandMenuList" parameterType="ShoppingReq" resultType="MetaInfo">
       /* ShoppingMapper.xml.getShoppingBrandMenuList,브랜드샵 - 메인 메뉴 리스트 조회, 김형식/SK플래닛  , 2014-01-30 */
        SELECT  
                A.MENU_ID 
               ,B.MENU_NM 
          FROM  TB_DP_MENU_CATEGORY A
               ,TB_DP_MENU_CATEGORY_DESC B
         WHERE A.UP_MENU_ID ='DP28'
           AND A.MENU_ID = B.MENU_ID
           AND B.LANG_CD =#{langCd}          /* ko : 한국어 */
           AND A.USE_YN = 'Y'
           AND A.MENU_ID > ='DP28008'
    </select> 
    
    <!-- 브랜드샵 - 메인 리스트 조회-->
    <select id="getBrandshopMainList" parameterType="ShoppingReq" resultType="MetaInfo">
       /* ShoppingMapper.xml.getBrandshopMainList,브랜드샵 - 메인 리스트 조회, 김형식/SK플래닛  , 2014-01-30 */
       SELECT * FROM (
           SELECT 
                     KK.*
                    ,COUNT(1) OVER() AS TOTALCOUNT
                    ,ROWNUM AS RNUM         
             FROM(
                SELECT 
                           BRAND_ID 
                         , BRAND_NM AS catalogNm
                         , MENU_ID 
                         , MENU_NM 
                         , TOP_MENU_ID 
                         ,(SELECT MENU_NM
                              FROM TB_DP_MENU_CATEGORY_DESC
                             WHERE MENU_ID = TOP_MENU_ID
                               AND LANG_CD = #{langCd}          /* ko : 한국어 */
                               AND ROWNUM = 1
                           ) AS TOP_MENU_NM                      
                         ,(SELECT CONCAT(FILE_PATH,FILE_NM) FROM TB_DP_PROD_IMG
                            WHERE PROD_ID = BRAND_ID AND IMG_CD =#{imageCd}
                          ) AS FILE_PATH
                 FROM (
                    SELECT *
                    FROM (
                        SELECT  
                              SB.BRAND_ID
                             ,SB.BRAND_NM
                             ,MC.MENU_ID
                             ,MCD.MENU_NM
                             ,MC.TOP_MENU_ID
                              <if test='menuId == null and brandId == null' > 
                             ,PM.DP_ORD
                             </if>                             
                        FROM  TB_DP_SHPG_BRAND SB
                             ,TB_DP_MENU_CATEGORY MC
                             ,TB_DP_MENU_CATEGORY_DESC MCD
                              <if test='menuId == null and brandId == null' > 
                             ,TB_DP_RECOM_PROD_MANG PM
                             </if>
                        WHERE SB.MENU_ID = MC.MENU_ID
                          AND SB.MENU_ID = MCD.MENU_ID
     
                          <if test="brandId != null">
                          AND SB.BRAND_ID = #{brandId}
                          </if>       
                          <if test='menuId == null and brandId == null'> 
                          AND SB.BRAND_ID = PM.BRAND_ID
                          </if>
                          AND MC.USE_YN ='Y'
                           <if test='menuId != null'> 
                          AND MC.MENU_ID = #{menuId} 
                          </if>
                          AND MCD.LANG_CD =#{langCd}
                          AND EXISTS (
                               SELECT
                                        'X'
                                 FROM 
                                          TB_DP_SHPG_BRAND A
                                         ,TB_DP_SHPG_CATALOG B
                                         ,TB_DP_SHPG_CATALOG_DESC C
                                         ,TB_DP_MENU_SHPG_MAPG D
                                         ,TB_DP_MENU_CATEGORY E
                                         ,TB_DP_MENU_CATEGORY_DESC F 
                                         ,TB_DP_PROD_CATALOG_MAPG G 
                                         ,TB_DP_PROD_RSHP H
                                         ,TB_DP_SHPG_PROD I
                                         ,TB_DP_PROD J
                                         ,TB_DP_TENANT_PROD K
                                         ,TB_DP_TENANT_PROD K1
                                         ,TB_DP_TENANT_PROD_PRICE L

                                WHERE 1=1
                                AND A.BRAND_ID = B.BRAND_ID
                                AND B.CATALOG_ID = C.CATALOG_ID
                                AND C.CATALOG_ID = D.CATALOG_ID     
                                AND D.MENU_ID = E.MENU_ID
                                AND D.MENU_ID = F.MENU_ID
                                AND B.CATALOG_ID = G.CATALOG_ID
                                AND G.PROD_ID = H.PROD_ID
                                AND H.PROD_ID <![CDATA[ <> ]]> H.PART_PROD_ID
                                AND H.PART_PROD_ID = I.PROD_ID
                                AND I.PROD_ID = J.PROD_ID
                                AND I.PROD_ID = K.PROD_ID
                                AND I.PROD_ID = L.PROD_ID
                                AND G.PROD_ID = K1.PROD_ID
                                AND K.TENANT_ID = K1.TENANT_ID
                                AND K.TENANT_ID = L.TENANT_ID 
                                AND H.PROD_RSHP_CD ='DP010802'    /*채널-에피소드 상품 관계*/ 
                                AND NVL(B.CHNL_CNT, 0) > 0          
                                AND C.LANG_CD= #{langCd}          /* ko : 한국어 */
                                AND F.LANG_CD= #{langCd}         /* ko : 한국어 */
                                AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                                AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                                AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                                AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                                AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                                AND NVL(I.B2B_PROD_YN, 'N') <![CDATA[ <> ]]> 'Y'
                                AND K1.PROD_STATUS_CD = 'PD000403'  /* PD000403 : 판매중 */
                                AND K1.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */                                
                                AND K.PROD_STATUS_CD = 'PD000403'  /* PD000403 : 판매중 */
                                AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                                AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                                AND K.TENANT_ID = #{tenantId}        /* INPUT 테넌트ID */
                                AND A.BRAND_ID =SB.BRAND_ID
                                AND  EXISTS (
                                    SELECT 1 
                                      FROM  TB_DP_SPRT_DEVICE DV  
                                     WHERE PROD_ID = I.PROD_ID
                                       AND DV.DEVICE_MODEL_CD  = #{deviceModelCd} 
                                     UNION ALL
                                    SELECT 1 
                                      FROM  TB_DP_SPRT_DEVICE DV  
                                     WHERE PROD_ID = I.PROD_ID                             
                                       AND DV.DEVICE_MODEL_CD = #{virtualDeviceModelNo} 
                                )
                          )
                     )
                    ORDER BY
                          <if test='menuId == null and brandId == null' > 
                           DP_ORD ,
                          </if>                          
                    MENU_ID , BRAND_NM
                )
            )KK
        )
        <if test='brandId == null'> 
        WHERE RNUM BETWEEN #{offset} AND #{count}
        </if>
    </select>     
  
     
    <!-- 브랜드샵 - 상세 조회-->
    <select id="getBrandshopDetail" parameterType="ShoppingReq" resultType="MetaInfo">
       /* ShoppingMapper.xml.getBrandshopDetail,브랜드샵 - 상세 조회, 김형식/SK플래닛  , 2014-11-10 */
       SELECT * FROM (
           SELECT 
                     KK.*
                    ,COUNT(1) OVER() AS TOTALCOUNT
                    ,ROWNUM AS RNUM         
             FROM(
                SELECT 
                           BRAND_ID 
                         , BRAND_NM AS catalogNm
                         , MENU_ID 
                         , MENU_NM 
                         , TOP_MENU_ID 
                         ,(SELECT MENU_NM
                              FROM TB_DP_MENU_CATEGORY_DESC
                             WHERE MENU_ID = TOP_MENU_ID
                               AND LANG_CD = #{langCd}          /* ko : 한국어 */
                               AND ROWNUM = 1
                           ) AS TOP_MENU_NM                      
                         ,(SELECT CONCAT(FILE_PATH,FILE_NM) FROM TB_DP_PROD_IMG
                            WHERE PROD_ID = BRAND_ID AND IMG_CD =#{imageCd}
                          ) AS FILE_PATH
                 FROM (
                    SELECT *
                    FROM (
                        SELECT  
                              SB.BRAND_ID
                             ,SB.BRAND_NM
                             ,MC.MENU_ID
                             ,MCD.MENU_NM
                             ,MC.TOP_MENU_ID
                        FROM  TB_DP_SHPG_BRAND SB
                             ,TB_DP_MENU_CATEGORY MC
                             ,TB_DP_MENU_CATEGORY_DESC MCD
                        WHERE SB.MENU_ID = MC.MENU_ID
                          AND SB.MENU_ID = MCD.MENU_ID
                          AND SB.BRAND_ID = #{brandId}
                          AND MC.USE_YN ='Y'
                          AND MCD.LANG_CD =#{langCd}
                     )
                    ORDER BY
                    MENU_ID , BRAND_NM
                )
            )KK
        )
    </select>         
    
    <!-- 특정 브랜드샵 상품 리스트 조회-->
    <select id="getBrandshopProductList" parameterType="Map" resultType="ProductBasicInfo">
       /* ShoppingMapper.xml.getBrandshopProductList,특정 브랜드샵 상품 리스트 조회, 김형식/SK플래닛  , 2014-02-04 */
        SELECT *
         FROM ( 
             SELECT 
                    rownum AS RNUM        
                   ,COUNT(CATALOG_ID) OVER() AS TOTALCOUNT      
                   ,CATALOG_ID AS catalogId
                   ,BRAND_ID AS brandId
                   ,MENU_ID AS menuId
                   ,TENANT_ID AS tenentId
                   ,PROD_ID as prodId
                   ,PART_PROD_ID as partProdId 
                   ,#{channelContentTypeCd} as contentsTypeCd
             FROM (
                  SELECT  * 
                   FROM (
                          SELECT 
                                 B.CATALOG_ID 
                               ,C.CATALOG_NM 
                               ,A.BRAND_ID  
                               ,D.MENU_ID  
                               ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC) as NO
                               ,K.TENANT_ID 
                               ,H.PROD_ID 
                               ,H.PART_PROD_ID
                               <if test='req.orderedBy == "recent"'>   
                               ,NVL((
                                    SELECT 
                                         MAX(SP.REG_DT)
                                    FROM 
                                         TB_DP_PROD_CATALOG_MAPG CM
                                        ,TB_DP_SHPG_PROD SP
                                    WHERE CM.CATALOG_ID =B.CATALOG_ID
                                      AND CM.PROD_ID = SP.PROD_ID
                                      AND CM.USE_YN ='Y'
                                      AND CM.BASE_YN ='Y'
                               ),I.REG_DT) AS REG_DT                                  
                               ,'1' EXPO_ORD
                               </if>
                               <if test='req.orderedBy == "popular"'>                 
                               ,NVL(M.EXPO_ORD_ALWAYS_YN,'A') AS EXPO_ORD_ALWAYS_YN
                               ,M.EXPO_ORD
                               ,M.EXPO_ORD_SUB   
                               </if>                                    
                          FROM 
                                  TB_DP_SHPG_BRAND A
                                 ,TB_DP_SHPG_CATALOG B
                                 ,TB_DP_SHPG_CATALOG_DESC C
                                 ,TB_DP_MENU_SHPG_MAPG D
                                 ,TB_DP_MENU_CATEGORY E
                                 ,TB_DP_MENU_CATEGORY_DESC F 
                                 ,TB_DP_PROD_CATALOG_MAPG G 
                                 ,TB_DP_PROD_RSHP H
                                 ,TB_DP_SHPG_PROD I
                                 ,TB_DP_PROD J
                                 ,TB_DP_TENANT_PROD K
                                 ,TB_DP_TENANT_PROD_PRICE L
                                 <if test='req.orderedBy == "popular"'>
                                ,(
                                    SELECT  TDLP.TENANT_ID
                                          , TDLP.LIST_ID
                                          , TDLP.MENU_ID
                                          , TDLP.PROD_ID
                                          , TDLP.EXPO_ORD_ALWAYS_YN
                                          , TDLP.EXPO_ORD
                                          , TDLP.EXPO_ORD_SUB
                                          , TDLP.PRCHS_QTY  
                                          , TDLP.DWLD_QTY                                      
                                      FROM  
                                            TB_DP_LIST_PROD TDLP
                                           ,TB_DP_LIST TDL
                                     WHERE 1=1
                                       AND  TDLP.TENANT_ID = TDL.TENANT_ID
                                       AND  TDLP.LIST_ID   = TDL.LIST_ID
                                       AND  TDLP.TENANT_ID = #{tenantHeader.tenantId}   /* 테넌트ID */
                                       AND  TDLP.LIST_ID   = #{req.listId}     /* RNK000000101 쇼핑 카탈로그 인기 */
                                       AND  TDLP.EXPO_YN = 'Y'             /* Y : 노출 (노출여부) */
                                       AND  TDL.EXPO_YN  = 'Y'             /* Y : 노출 (노출여부) */
                                       AND  TDLP.STD_DT = TO_DATE(#{stdDt}, 'YYYYMMDDHH24MISS') 
                                       AND  SYSDATE BETWEEN TDLP.EXPO_START_DT AND TDLP.EXPO_END_DT                            
                                  ) M                                  
                                 </if>                                 
                                 ,(SELECT /*+ ORDERED */
                                        B1.PROD_ID
                                      , B1.SPRC_DC_RATE
                                      , B1.SPRC_PRICE
                                   FROM  TB_DP_PROD_RSHP A1
                                        ,TB_DP_SPRC_PROD B1
                                   WHERE 1=1
                                     AND A1.PART_PROD_ID = B1.PROD_ID
                                     AND B1.EXPO_YN ='Y'
                                     AND B1.CPN_ID IS NOT NULL
                                     AND SYSDATE BETWEEN  B1.SPRC_APPLY_START_DT AND B1.SPRC_APPLY_END_DT 
                                  )N
                        WHERE 1=1
                        AND A.BRAND_ID = B.BRAND_ID
                        AND B.CATALOG_ID = C.CATALOG_ID
                        AND C.CATALOG_ID = D.CATALOG_ID     
                        AND D.MENU_ID = E.MENU_ID
                        AND D.MENU_ID = F.MENU_ID
                        AND B.CATALOG_ID = G.CATALOG_ID
                        AND G.PROD_ID = H.PROD_ID
                        AND H.PROD_ID <![CDATA[ <> ]]> H.PART_PROD_ID
                        AND H.PART_PROD_ID = I.PROD_ID
                        AND I.PROD_ID = J.PROD_ID
                        AND I.PROD_ID = K.PROD_ID
                        AND I.PROD_ID = L.PROD_ID
                        AND K.TENANT_ID = L.TENANT_ID 
                        <if test='req.orderedBy == "popular"'>
                        AND B.CATALOG_ID = M.PROD_ID(+)                             
                        </if>                        
                        AND I.PROD_ID = N.PROD_ID(+)  
                        AND H.PROD_RSHP_CD = #{prodRshpCd}    /*채널-에피소드 상품 관계*/ 
                        AND NVL(B.CHNL_CNT, 0) > 0          
                        AND C.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND F.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                        AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                        AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND NVL(I.B2B_PROD_YN, 'N') <![CDATA[ <> ]]> 'Y'
                        AND K.PROD_STATUS_CD = #{prodStatusCd}  /* PD000403 : 판매중 */
                        AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                        AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                        AND K.TENANT_ID = #{tenantHeader.tenantId}  /* INPUT 테넌트ID */
                        AND A.BRAND_ID = #{req.brandId}        /* INPUT 브랜드ID */
                        <if test="req.prodCharge != null">
                        AND J.PROD_CHRG_YN =#{req.prodCharge}
                        </if>
                        <if test="req.arrayProdGradeCd != null">
                        AND J.PROD_GRD_CD  IN
                                      <foreach collection="req.arrayProdGradeCd" item="req.prodGradeCd" separator="," open="(" close=")">
                                        #{req.prodGradeCd}
                                      </foreach>                        
                        </if>      
                        AND EXISTS (
                            SELECT /*+ UNNEST NL_SJ INDEX(H (DEVICE_MODEL_CD, PROD_ID)) */ 1    --ADDED BY 2014.10.14
                            FROM  TB_DP_SPRT_DEVICE DV  
                            WHERE 1=1
                              AND (DV.DEVICE_MODEL_CD  = #{deviceHeader.model} OR DV.DEVICE_MODEL_CD = #{req.virtualDeviceModelNo}) 
                              AND PROD_ID = I.PROD_ID
                            )                        
                   ) 
                 WHERE NO =1
               <if test='req.orderedBy == "recent"'>                 
               ORDER BY 
                      REG_DT DESC
                    , CATALOG_NM ASC
               </if>
               <if test='req.orderedBy == "popular"'>                 
               ORDER BY 
                      EXPO_ORD_ALWAYS_YN DESC
                    , EXPO_ORD   
                    , EXPO_ORD_SUB 
                    , CATALOG_NM ASC               
               </if>                     
               ) 
        ) WHERE RNUM BETWEEN #{req.offset} AND #{req.count}
    </select>     

    <!-- 쇼핑테마  리스트 조회-->
    <select id="getThemeList" parameterType="ShoppingReq" resultType="MetaInfo">
       /* ShoppingMapper.xml.getThemeList,쇼핑테마  리스트 조회, 김형식/SK플래닛  , 2014-02-03 */
       SELECT * FROM (
           SELECT 
                     KK.*
                    ,COUNT(1) OVER() AS TOTALCOUNT
                    ,ROWNUM AS RNUM         
             FROM(       
                SELECT LIST_ID as prodId
                     , LIST_NM as prodNm
                     , IMG_PATH AS FILE_PATH                     
                  FROM TB_DP_LIST
                 WHERE LIST_GRP_CD='TSP'
                   AND EXPO_YN = 'Y'
                   AND TENANT_ID =#{tenantId}       /* INPUT 테넌트ID */
                  <if test="themeId != null">
                   AND LIST_ID = #{themeId}
                  </if>                           
                 ORDER BY 
                      EXPO_ORD   
                    , EXPO_ORD_SUB                       
            )KK
        )
         <if test="themeId == null">
        WHERE RNUM BETWEEN #{offset} AND #{count}
        </if>               
    </select>     
    
    <!-- 특정 테마 리스트상품 리스트 조회-->
    <select id="getThemeProductList" parameterType="Map" resultType="ProductBasicInfo">
       /* ShoppingMapper.xml.getThemeProductList,특정 테마 리스트상품 리스트 조회, 김형식/SK플래닛  , 2014-02-04 */
        SELECT *
         FROM ( 
             SELECT 
                    rownum AS RNUM        
                   ,COUNT(CATALOG_ID) OVER() AS TOTALCOUNT      
                   ,CATALOG_ID AS catalogId
                   ,BRAND_ID AS brandId
                   ,MENU_ID AS menuId
                   ,TENANT_ID AS tenentId
                   ,PROD_ID as prodId
                   ,PART_PROD_ID as partProdId 
                   ,EXPO_ORD as expoOrd
                   ,#{channelContentTypeCd}  as contentsTypeCd
             FROM (
                  SELECT  * 
                   FROM (
                          SELECT 
                                B.CATALOG_ID 
                               ,C.CATALOG_NM 
                               ,A.BRAND_ID  
                               ,D.MENU_ID  
                               ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC) as NO
                               ,K.TENANT_ID 
                               ,H.PROD_ID 
                               ,H.PART_PROD_ID  
                               ,M.EXPO_ORD_ALWAYS_YN
                               ,M.EXPO_ORD
                               ,M.EXPO_ORD_SUB
                               ,I.REG_DT   
                          FROM 
                                  TB_DP_SHPG_BRAND A
                                 ,TB_DP_SHPG_CATALOG B
                                 ,TB_DP_SHPG_CATALOG_DESC C
                                 ,TB_DP_MENU_SHPG_MAPG D
                                 ,TB_DP_MENU_CATEGORY E
                                 ,TB_DP_MENU_CATEGORY_DESC F 
                                 ,TB_DP_PROD_CATALOG_MAPG G 
                                 ,TB_DP_PROD_RSHP H
                                 ,TB_DP_SHPG_PROD I
                                 ,TB_DP_PROD J
                                 ,TB_DP_TENANT_PROD K
                                 ,TB_DP_TENANT_PROD_PRICE L
                                ,(
                                    SELECT  TDLP.TENANT_ID
                                          , TDLP.LIST_ID
                                          , TDLP.MENU_ID
                                          , TDLP.PROD_ID
                                          , TDLP.EXPO_ORD_ALWAYS_YN
                                          , TDLP.EXPO_ORD
                                          , TDLP.EXPO_ORD_SUB
                                          , TDLP.PRCHS_QTY  
                                          , TDLP.DWLD_QTY                                      
                                      FROM  
                                            TB_DP_LIST_PROD TDLP
                                           ,TB_DP_LIST TDL
                                     WHERE 1=1
                                       AND  TDLP.TENANT_ID = TDL.TENANT_ID
                                       AND  TDLP.LIST_ID   = TDL.LIST_ID
                                       AND  TDLP.TENANT_ID = #{tenantHeader.tenantId}    /* 테넌트ID */
                                       AND  TDLP.LIST_ID   = #{req.themeId}     
                                       AND  TDLP.EXPO_YN = 'Y'             /* Y : 노출 (노출여부) */
                                       AND  TDL.EXPO_YN  = 'Y'             /* Y : 노출 (노출여부) */
                                       AND  TDLP.STD_DT = TO_DATE(#{stdDt}, 'YYYYMMDDHH24MISS')  
                                       AND  SYSDATE BETWEEN TDLP.EXPO_START_DT AND TDLP.EXPO_END_DT                            
                                  ) M                                
                                 ,(SELECT /*+ ORDERED */
                                        B1.PROD_ID
                                      , B1.SPRC_DC_RATE
                                      , B1.SPRC_PRICE
                                   FROM  TB_DP_PROD_RSHP A1
                                        ,TB_DP_SPRC_PROD B1
                                   WHERE 1=1
                                     AND A1.PART_PROD_ID = B1.PROD_ID
                                     AND B1.EXPO_YN ='Y'
                                     AND B1.CPN_ID IS NOT NULL
                                     AND SYSDATE BETWEEN  B1.SPRC_APPLY_START_DT AND B1.SPRC_APPLY_END_DT 
                                  )N
                        WHERE 1=1
                        AND A.BRAND_ID = B.BRAND_ID
                        AND B.CATALOG_ID = C.CATALOG_ID
                        AND C.CATALOG_ID = D.CATALOG_ID     
                        AND D.MENU_ID = E.MENU_ID
                        AND D.MENU_ID = F.MENU_ID
                        AND B.CATALOG_ID = G.CATALOG_ID
                        AND G.PROD_ID = H.PROD_ID
                        AND H.PROD_ID <![CDATA[ <> ]]> H.PART_PROD_ID
                        AND H.PART_PROD_ID = I.PROD_ID
                        AND I.PROD_ID = J.PROD_ID
                        AND I.PROD_ID = K.PROD_ID
                        AND I.PROD_ID = L.PROD_ID
                        AND K.TENANT_ID = M.TENANT_ID
                        AND K.TENANT_ID = L.TENANT_ID 
                        AND B.CATALOG_ID = M.PROD_ID   
                        AND I.PROD_ID = N.PROD_ID(+)     
                        AND H.PROD_RSHP_CD =#{prodRshpCd}    /*채널-에피소드 상품 관계*/
                        AND NVL(B.CHNL_CNT, 0) > 0                  
                        AND C.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND F.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                        AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                        AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND NVL(I.B2B_PROD_YN, 'N') <![CDATA[ <> ]]> 'Y'
                        AND K.PROD_STATUS_CD = #{prodStatusCd}  /* PD000403 : 판매중 */
                        AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                        AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                        AND K.TENANT_ID = #{tenantHeader.tenantId}       /* INPUT 테넌트ID */
                        <if test="req.prodCharge != null">
                        AND J.PROD_CHRG_YN =#{req.prodCharge}
                        </if>
                        <if test="req.arrayProdGradeCd != null">
                        AND J.PROD_GRD_CD  IN
                                      <foreach collection="req.arrayProdGradeCd" item="req.prodGradeCd" separator="," open="(" close=")">
                                        #{req.prodGradeCd}
                                      </foreach>                        
                        </if>   
                        AND EXISTS (
                            SELECT 1 
                            FROM  TB_DP_SPRT_DEVICE DV  
                            WHERE 1=1
                              AND (DV.DEVICE_MODEL_CD  = #{deviceHeader.model} OR DV.DEVICE_MODEL_CD = #{req.virtualDeviceModelNo}) 
                              AND PROD_ID = I.PROD_ID
                            )                      
                   ) 
                 WHERE NO =1
                 ORDER BY 
                      EXPO_ORD_ALWAYS_YN DESC
                    , EXPO_ORD   
                    , EXPO_ORD_SUB 
                    , CATALOG_NM ASC
               ) 
        ) WHERE RNUM BETWEEN #{req.offset} AND #{req.count}
    </select>    
    
    <!-- 특정 카탈로그에 대한 다른 상품 리스트 조회-->
    <select id="getCatagoryAnotherProductList" parameterType="Map" resultType="ProductBasicInfo">
       /* ShoppingMapper.xml.getCatagoryAnotherProductList,특정 카탈로그에 대한 다른 상품 리스트 조회, 김형식/SK플래닛  , 2014-02-04 */
        SELECT *
         FROM ( 
             SELECT 
                    rownum AS RNUM        
                   ,COUNT(CATALOG_ID) OVER() AS TOTALCOUNT      
                   ,CATALOG_ID AS catalogId
                   ,BRAND_ID AS brandId
                   ,MENU_ID AS menuId
                   ,TENANT_ID AS tenentId
                   ,PROD_ID as prodId
                   ,PART_PROD_ID as partProdId 
                   ,#{channelContentTypeCd} as contentsTypeCd
             FROM (
                  SELECT  * 
                   FROM (
                          SELECT /*+ LEADING(E F D C B A) USE_MERGE(M N) USE_NL(A B C D F G) INDEX(D (MENU_ID)) */ --ADDED BY 2014.10.14 
                                B.CATALOG_ID 
                               ,C.CATALOG_NM 
                               ,A.BRAND_ID  
                               ,D.MENU_ID  
                               ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC) as NO
                               ,K.TENANT_ID 
                               ,H.PROD_ID 
                               ,H.PART_PROD_ID
                               <if test='req.orderedBy == "recent"'>  
                               ,NVL((
                                    SELECT 
                                         MAX(SP.REG_DT)
                                    FROM 
                                         TB_DP_PROD_CATALOG_MAPG CM
                                        ,TB_DP_SHPG_PROD SP
                                    WHERE CM.CATALOG_ID =B.CATALOG_ID
                                      AND CM.PROD_ID = SP.PROD_ID
                                      AND CM.USE_YN ='Y'
                                      AND CM.BASE_YN ='Y'
                               ),I.REG_DT) AS REG_DT                                  
                               ,'1' EXPO_ORD
                               </if>
                               <if test='req.orderedBy == "popular"'>                 
                               ,NVL(M.EXPO_ORD_ALWAYS_YN,'A') AS EXPO_ORD_ALWAYS_YN
                               ,M.EXPO_ORD
                               ,M.EXPO_ORD_SUB    
                               </if>                                                                                                                                                   
                          FROM 
                                  TB_DP_SHPG_BRAND A
                                 ,TB_DP_SHPG_CATALOG B
                                 ,TB_DP_SHPG_CATALOG_DESC C
                                 ,TB_DP_MENU_SHPG_MAPG D
                                 ,TB_DP_MENU_CATEGORY E
                                 ,TB_DP_MENU_CATEGORY_DESC F 
                                 ,TB_DP_PROD_CATALOG_MAPG G 
                                 ,TB_DP_PROD_RSHP H
                                 ,TB_DP_SHPG_PROD I
                                 ,TB_DP_PROD J
                                 ,TB_DP_TENANT_PROD K
                                 ,TB_DP_TENANT_PROD_PRICE L
                                 <if test='req.orderedBy == "popular"'>
                                ,(
                                    SELECT  /*+ NO_MERGE */ --ADDED BY 2014.10.14
                                            TDLP.TENANT_ID
                                          , TDLP.LIST_ID
                                          , TDLP.MENU_ID
                                          , TDLP.PROD_ID
                                          , TDLP.EXPO_ORD_ALWAYS_YN
                                          , TDLP.EXPO_ORD
                                          , TDLP.EXPO_ORD_SUB
                                          , TDLP.PRCHS_QTY  
                                          , TDLP.DWLD_QTY                                      
                                      FROM  
                                            TB_DP_LIST_PROD TDLP
                                           ,TB_DP_LIST TDL
                                     WHERE 1=1
                                       AND  TDLP.TENANT_ID = TDL.TENANT_ID
                                       AND  TDLP.LIST_ID   = TDL.LIST_ID
                                       AND  TDLP.TENANT_ID = #{tenantHeader.tenantId}   /* 테넌트ID */
                                       AND  TDLP.LIST_ID   = #{req.listId}     /* RNK000000101 쇼핑 카탈로그 인기 */
                                       AND  TDLP.EXPO_YN = 'Y'             /* Y : 노출 (노출여부) */
                                       AND  TDL.EXPO_YN  = 'Y'             /* Y : 노출 (노출여부) */
                                       AND  TDLP.STD_DT = TO_DATE(#{stdDt}, 'YYYYMMDDHH24MISS') 
                                       AND  SYSDATE BETWEEN TDLP.EXPO_START_DT AND TDLP.EXPO_END_DT                            
                                  ) M                                  
                                 </if>
                                 ,(SELECT /*+ NO_MEGRE */ --ADDED BY 2014.10.14
                                        B1.PROD_ID
                                      , B1.SPRC_DC_RATE
                                      , B1.SPRC_PRICE
                                   FROM  TB_DP_PROD_RSHP A1
                                        ,TB_DP_SPRC_PROD B1
                                   WHERE 1=1
                                     AND A1.PART_PROD_ID = B1.PROD_ID
                                     AND B1.EXPO_YN ='Y'
                                     AND B1.CPN_ID IS NOT NULL
                                     AND SYSDATE BETWEEN  B1.SPRC_APPLY_START_DT AND B1.SPRC_APPLY_END_DT 
                                  )N
                        WHERE 1=1
                        AND A.BRAND_ID = B.BRAND_ID
                        AND B.CATALOG_ID = C.CATALOG_ID
                        AND C.CATALOG_ID = D.CATALOG_ID     
                        AND D.MENU_ID = E.MENU_ID
                        AND D.MENU_ID = F.MENU_ID
                        AND D.MENU_ID = #{req.menuId}           /*INPUT 메뉴ID*/
                        AND B.CATALOG_ID = G.CATALOG_ID
                        <if test="req.exceptId != null">
                        AND C.CATALOG_ID <![CDATA[<>]]> #{req.exceptId}
                        </if> 
                        AND G.PROD_ID = H.PROD_ID
                        AND H.PROD_ID <![CDATA[ <> ]]> H.PART_PROD_ID
                        AND H.PART_PROD_ID = I.PROD_ID
                        AND I.PROD_ID = J.PROD_ID
                        AND I.PROD_ID = K.PROD_ID
                        AND I.PROD_ID = L.PROD_ID
                        AND K.TENANT_ID = L.TENANT_ID
                        <if test='req.orderedBy == "popular"'>
                        AND B.CATALOG_ID = M.PROD_ID(+)                             
                        </if>                   
                        AND I.PROD_ID = N.PROD_ID(+)       
                        AND H.PROD_RSHP_CD =#{prodRshpCd}    /*채널-에피소드 상품 관계*/   
                        AND NVL(B.CHNL_CNT, 0) > 0        
                        AND C.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND F.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                        AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                        AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND NVL(I.B2B_PROD_YN, 'N') <![CDATA[ <> ]]> 'Y'
                        AND K.PROD_STATUS_CD = #{prodStatusCd}  /* PD000403 : 판매중 */
                        AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                        AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                        AND K.TENANT_ID = #{tenantHeader.tenantId}       /* INPUT 테넌트ID */
                        <if test="req.prodCharge != null">
                        AND J.PROD_CHRG_YN =#{req.prodCharge}
                        </if>
                        <if test="req.arrayProdGradeCd != null">
                        AND J.PROD_GRD_CD  IN
                                      <foreach collection="req.arrayProdGradeCd" item="req.prodGradeCd" separator="," open="(" close=")">
                                        #{req.prodGradeCd}
                                      </foreach>                        
                        </if>      
                        AND EXISTS (
                            SELECT /*+ UNNEST NL_SJ INDEX(DV (DEVICE_MODEL_CD, PROD_ID)) */ 1   --ADDED BY 2014.10.14
                            FROM  TB_DP_SPRT_DEVICE DV  
                            WHERE 1=1
                              AND (DV.DEVICE_MODEL_CD  = #{deviceHeader.model} OR DV.DEVICE_MODEL_CD = #{req.virtualDeviceModelNo}) 
                              AND PROD_ID = I.PROD_ID
                            )                           
                   ) 
                 WHERE NO =1
               <if test='req.orderedBy == "recent"'>                 
               ORDER BY 
                      REG_DT DESC
                    , CATALOG_NM ASC
               </if>
               <if test='req.orderedBy == "popular"'>                 
               ORDER BY 
                      EXPO_ORD_ALWAYS_YN DESC
                    , EXPO_ORD   
                    , EXPO_ORD_SUB 
                    , CATALOG_NM ASC                   
               </if>                   
               )
        ) WHERE RNUM BETWEEN #{req.offset} AND #{req.count}
    </select>        
     
   <!-- 특정 브랜드에 대한 다른 상품 리스트 조회-->
    <select id="getBrandAnotherProductList" parameterType="Map" resultType="ProductBasicInfo">
       /* ShoppingMapper.xml.getBrandAnotherProductList,특정 브랜드에 대한 다른 상품 리스트, 김형식/SK플래닛  , 2014-02-04 */
        SELECT *
         FROM ( 
             SELECT 
                    rownum AS RNUM        
                   ,COUNT(CATALOG_ID) OVER() AS TOTALCOUNT      
                   ,CATALOG_ID AS catalogId
                   ,BRAND_ID AS brandId
                   ,MENU_ID AS menuId
                   ,TENANT_ID AS tenentId
                   ,PROD_ID as prodId
                   ,PART_PROD_ID as partProdId 
                   ,#{channelContentTypeCd} as contentsTypeCd
             FROM (
                  SELECT  * 
                   FROM (
                          SELECT 
                                B.CATALOG_ID 
                               ,C.CATALOG_NM 
                               ,A.BRAND_ID  
                               ,D.MENU_ID  
                               ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC) as NO
                               ,K.TENANT_ID 
                               ,H.PROD_ID 
                               ,H.PART_PROD_ID  
                               <if test='req.orderedBy == "recent"'>    
                               ,NVL((
                                    SELECT 
                                         MAX(SP.REG_DT)
                                    FROM 
                                         TB_DP_PROD_CATALOG_MAPG CM
                                        ,TB_DP_SHPG_PROD SP
                                    WHERE CM.CATALOG_ID =B.CATALOG_ID
                                      AND CM.PROD_ID = SP.PROD_ID
                                      AND CM.USE_YN ='Y'
                                      AND CM.BASE_YN ='Y'
                               ),I.REG_DT) AS REG_DT                                  
                               ,'1' EXPO_ORD
                               </if>
                               <if test='req.orderedBy == "popular"'>                 
                               ,NVL(M.EXPO_ORD_ALWAYS_YN,'A') AS EXPO_ORD_ALWAYS_YN
                               ,M.EXPO_ORD
                               ,M.EXPO_ORD_SUB     
                               </if>                                                                                                                                                   
                          FROM 
                                  TB_DP_SHPG_BRAND A
                                 ,TB_DP_SHPG_CATALOG B
                                 ,TB_DP_SHPG_CATALOG_DESC C
                                 ,TB_DP_MENU_SHPG_MAPG D
                                 ,TB_DP_MENU_CATEGORY E
                                 ,TB_DP_MENU_CATEGORY_DESC F 
                                 ,TB_DP_PROD_CATALOG_MAPG G 
                                 ,TB_DP_PROD_RSHP H
                                 ,TB_DP_SHPG_PROD I
                                 ,TB_DP_PROD J
                                 ,TB_DP_TENANT_PROD K
                                 ,TB_DP_TENANT_PROD_PRICE L

                                 <if test='req.orderedBy == "popular"'>
                                ,(
                                    SELECT  TDLP.TENANT_ID
                                          , TDLP.LIST_ID
                                          , TDLP.MENU_ID
                                          , TDLP.PROD_ID
                                          , TDLP.EXPO_ORD_ALWAYS_YN
                                          , TDLP.EXPO_ORD
                                          , TDLP.EXPO_ORD_SUB
                                          , TDLP.PRCHS_QTY  
                                          , TDLP.DWLD_QTY                                      
                                      FROM  
                                            TB_DP_LIST_PROD TDLP
                                           ,TB_DP_LIST TDL
                                     WHERE 1=1
                                       AND  TDLP.TENANT_ID = TDL.TENANT_ID
                                       AND  TDLP.LIST_ID   = TDL.LIST_ID
                                       AND  TDLP.TENANT_ID = #{tenantHeader.tenantId}   /* 테넌트ID */
                                       AND  TDLP.LIST_ID   = #{req.listId}     /* RNK000000101 쇼핑 카탈로그 인기 */
                                       AND  TDLP.EXPO_YN = 'Y'             /* Y : 노출 (노출여부) */
                                       AND  TDL.EXPO_YN  = 'Y'             /* Y : 노출 (노출여부) */
                                       AND  TDLP.STD_DT = TO_DATE(#{stdDt}, 'YYYYMMDDHH24MISS') 
                                       AND  SYSDATE BETWEEN TDLP.EXPO_START_DT AND TDLP.EXPO_END_DT                            
                                  ) M                                  
                                 </if>
                                 ,(SELECT /*+ ORDERED */
                                        B1.PROD_ID
                                      , B1.SPRC_DC_RATE
                                      , B1.SPRC_PRICE
                                   FROM  TB_DP_PROD_RSHP A1
                                        ,TB_DP_SPRC_PROD B1
                                   WHERE 1=1
                                     AND A1.PART_PROD_ID = B1.PROD_ID
                                     AND B1.EXPO_YN ='Y'
                                     AND B1.CPN_ID IS NOT NULL
                                     AND SYSDATE BETWEEN  B1.SPRC_APPLY_START_DT AND B1.SPRC_APPLY_END_DT 
                                  )N
                        WHERE 1=1
                        AND A.BRAND_ID = B.BRAND_ID
                        AND B.CATALOG_ID = C.CATALOG_ID
                        AND C.CATALOG_ID = D.CATALOG_ID     
                        AND D.MENU_ID = E.MENU_ID
                        AND D.MENU_ID = F.MENU_ID
                        AND A.BRAND_ID = #{req.brandId}           /*INPUT 브랜드ID*/
                        AND B.CATALOG_ID = G.CATALOG_ID
                        <if test="req.exceptId != null">
                        AND C.CATALOG_ID <![CDATA[<>]]> #{req.exceptId}  /*INPUT 제외상품ID*/
                        </if>
                        AND G.PROD_ID = H.PROD_ID
                        AND H.PROD_ID <![CDATA[ <> ]]> H.PART_PROD_ID
                        AND H.PART_PROD_ID = I.PROD_ID
                        AND I.PROD_ID = J.PROD_ID
                        AND I.PROD_ID = K.PROD_ID
                        AND I.PROD_ID = L.PROD_ID
                        AND K.TENANT_ID = L.TENANT_ID
                        <if test='req.orderedBy == "popular"'>
                        AND B.CATALOG_ID = M.PROD_ID(+)                             
                        </if>                   
                        AND I.PROD_ID = N.PROD_ID(+)       
                        AND H.PROD_RSHP_CD =#{prodRshpCd}    /*채널-에피소드 상품 관계*/   
                        AND NVL(B.CHNL_CNT, 0) > 0        
                        AND C.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND F.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                        AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                        AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND NVL(I.B2B_PROD_YN, 'N') <![CDATA[ <> ]]> 'Y'
                        AND K.PROD_STATUS_CD = #{prodStatusCd}  /* PD000403 : 판매중 */
                        AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                        AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                        AND K.TENANT_ID = #{tenantHeader.tenantId}       /* INPUT 테넌트ID */
                        <if test="req.prodCharge != null">
                        AND J.PROD_CHRG_YN =#{req.prodCharge}
                        </if>
                        <if test="req.arrayProdGradeCd != null">
                        AND J.PROD_GRD_CD  IN
                                      <foreach collection="req.arrayProdGradeCd" item="req.prodGradeCd" separator="," open="(" close=")">
                                        #{req.prodGradeCd}
                                      </foreach>                        
                        </if>      
                        AND EXISTS (
                            SELECT /*+ UNNEST NL_SJ INDEX(H (DEVICE_MODEL_CD, PROD_ID)) */ 1 
                            FROM  TB_DP_SPRT_DEVICE DV  
                            WHERE 1=1
                              AND (DV.DEVICE_MODEL_CD  = #{deviceHeader.model} OR DV.DEVICE_MODEL_CD = #{req.virtualDeviceModelNo}) 
                              AND PROD_ID = I.PROD_ID
                            )                           
                   ) 
                 WHERE NO =1
               <if test='req.orderedBy == "recent"'>                 
               ORDER BY 
                      REG_DT DESC
                    , CATALOG_NM ASC
               </if>
               <if test='req.orderedBy == "popular"'>                 
               ORDER BY 
                      EXPO_ORD_ALWAYS_YN DESC
                    , EXPO_ORD   
                    , EXPO_ORD_SUB 
                    , CATALOG_NM ASC                 
               </if>                   
               )
        ) WHERE RNUM BETWEEN #{req.offset} AND #{req.count}
    </select>         

    <!-- 쇼핑상세(채널) 조회-->
    <select id="getShoppingChannelDetail" parameterType="Map" resultType="MetaInfo">
     /* ShoppingMapper.xml.getShoppingChannelDetail,쇼핑상세(채널) 조회, 김형식/SK플래닛  , 2014-02-04 */
          SELECT  * 
           FROM (
                  SELECT 
                         B.CATALOG_ID 
                         <if test="(req.specialProdId == null and req.type == 'catalog') or req.type == 'episode' ">
                        ,C.CATALOG_NM 
                        </if>
                        <if test="req.specialProdId != null and req.type == 'catalog'">
                        ,O.PROD_NM  as catalogNm
                        </if>
                        ,H.PROD_ID 
                        ,H.PART_PROD_ID                          
                        ,C.CATALOG_DESC as prodBaseDesc
                        ,A.BRAND_ID  
                        ,A.BRAND_NM  
                        ,D.MENU_ID   
                        ,F.MENU_NM 
                        ,J.TOP_MENU_ID 
                        ,(SELECT MENU_NM
                            FROM TB_DP_MENU_CATEGORY_DESC
                           WHERE MENU_ID = J.TOP_MENU_ID
                             AND LANG_CD = #{lang}
                             AND ROWNUM = 1
                         ) AS TOP_MENU_NM 
                        ,F.MENU_DESC                                   
                        ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID ORDER BY L.PROD_AMT ASC , ROUND(DBMS_RANDOM.VALUE(1, 100), 0)) as NO
                        ,CASE WHEN NVL(M.PRCHS_CNT, 0) <![CDATA[ < ]]> 0 THEN 0 ELSE NVL(M.PRCHS_CNT, 0) END AS PRCHS_CNT 
                        ,(CASE WHEN I.PROD_CASE_CD='DP006301' THEN 'giftcard' 
                               WHEN I.PROD_CASE_CD='DP006302' THEN 'exchange' 
                               WHEN I.PROD_CASE_CD='DP006303' THEN 'delivery' 
                          END) AS PROD_CASE_CD  
                        ,CONCAT(PI.FILE_PATH,PI.FILE_NM) as FILE_PATH
                        ,J.CONTENTS_TYPE_CD 
                        ,(SELECT SRC_CONTENT_ID 
                            FROM TB_DP_SHPG_PROD 
                           WHERE prod_id=H.PROD_ID 
                         ) AS SRC_CONTENT_ID
                        ,K.PROD_STATUS_CD
                        ,C.CATALOG_DTL_DESC AS prodDtlDesc
                  FROM 
                          TB_DP_SHPG_BRAND A
                         ,TB_DP_SHPG_CATALOG B
                         ,TB_DP_SHPG_CATALOG_DESC C
                         ,TB_DP_MENU_SHPG_MAPG D
                         ,TB_DP_MENU_CATEGORY E
                         ,TB_DP_MENU_CATEGORY_DESC F 
                         ,TB_DP_PROD_CATALOG_MAPG G 
                         ,TB_DP_PROD_RSHP H
                         ,TB_DP_SHPG_PROD I
                         ,TB_DP_PROD J
                         ,TB_DP_TENANT_PROD K
                         ,TB_DP_TENANT_PROD_PRICE L
                         ,TB_DP_PROD_IMG    PI
                         ,TB_DP_PROD_DESC O
                         ,(SELECT  PROD_ID
                                  ,PRCHS_CNT
                             FROM TB_DP_TENANT_PROD_STATS 
                            WHERE TENANT_ID = #{tenantHeader.tenantId}    /* INPUT 테넌트ID */
                           ) M
                WHERE 1=1
                AND A.BRAND_ID = B.BRAND_ID
                AND B.CATALOG_ID = C.CATALOG_ID
                AND C.CATALOG_ID = D.CATALOG_ID     
                AND D.MENU_ID = E.MENU_ID
                AND D.MENU_ID = F.MENU_ID
                AND B.CATALOG_ID = G.CATALOG_ID
                AND G.PROD_ID = H.PROD_ID
                AND H.PROD_ID <![CDATA[ <> ]]> H.PART_PROD_ID
                AND H.PART_PROD_ID = I.PROD_ID
                AND I.PROD_ID = J.PROD_ID
                AND I.PROD_ID = K.PROD_ID
                AND I.PROD_ID = L.PROD_ID
                AND I.PROD_ID = O.PROD_ID
                AND K.TENANT_ID = L.TENANT_ID
                AND C.CATALOG_ID = PI.PROD_ID
                AND PI.IMG_CD = #{imageCd}                
                AND C.CATALOG_ID = M.PROD_ID(+)                           
                AND H.PROD_RSHP_CD =#{prodRshpCd}    /*채널-에피소드 상품 관계*/ 
                <if test="req.includeProdStopStatus != null  ">
                AND NVL(B.CHNL_CNT, 0) <![CDATA[ > ]]> 0      
                AND K.PROD_STATUS_CD = 'PD000403'  /* PD000403 : 판매중 */
                </if>   
                AND C.LANG_CD= #{lang}          /* ko : 한국어 */
                AND F.LANG_CD= #{lang}          /* ko : 한국어 */
                AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                <if test="req.saleDtUseYn == null">
                AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                </if>
                AND K.TENANT_ID = #{tenantHeader.tenantId}        /* INPUT 테넌트ID */
                AND B.CATALOG_ID = #{req.productId}
                <if test="req.specialProdId != null and req.specialType=='episode'">
                AND I.PROD_ID = #{req.specialProdId}
                </if>
                <if test="req.specialProdId != null and req.specialType=='channel'">
                AND H.PROD_ID = #{req.specialProdId}
                </if>                
                AND EXISTS (
                            SELECT 1 
                            FROM  TB_DP_SPRT_DEVICE DV  
                            WHERE 1=1
                              AND (DV.DEVICE_MODEL_CD  = #{deviceHeader.model} OR DV.DEVICE_MODEL_CD = #{req.virtualDeviceModelNo}) 
                              AND PROD_ID = I.PROD_ID
                    )                                     
           ) 
           WHERE NO =1
    </select>    
  <!-- 쇼핑상세(에피소드) 조회-->
    <select id="getShoppingEpisodeDetail" parameterType="Map" resultType="MetaInfo">
     /* ShoppingMapper.xml.getShoppingEpisodeDetail,쇼핑상세(에피소드) 조회, 김형식/SK플래닛  , 2014-02-04 */
          SELECT  
                KK.*
               ,(CASE WHEN KK.SPECIAL_SALE_YN ='Y' THEN 
                         ( CASE WHEN ( ( KK.MTH_PRCHS_CNT >= KK.MTH_MAX_CNT ) OR
                                       ( KK.DLY_PRCHS_CNT >= KK.DLY_MAX_CNT )
                                       OR 
                                       ( KK.SOLD_OUT_YN ='Y' )                                         
                                     ) 
                            THEN 'Y'
                            ELSE  'N' END 
                          )
                ELSE 'N'
                END ) AS soldOut        
               ,KK.SPECIAL_SALE_YN AS specialSale
               ,TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') AS SYS_DATE
           FROM (
                  SELECT 
                         D.MENU_ID
                        ,J.TOP_MENU_ID 
                        ,H.PROD_ID                         
                        ,H.PART_PROD_ID 
                        ,J.SELLER_MBR_NO 
                        ,NVL(L.PROD_NET_AMT, 0) AS PROD_NET_AMT 
                        ,NVL(N.SPRC_PRICE, NVL(L.DC_AFT_PROD_AMT, 0)) AS PROD_AMT
                        ,NVL(N.SPRC_DC_RATE, NVL(L.DC_RATE,0)) AS DC_RATE
                        ,NVL(N.SPRC_DC_PRICE, NVL(L.DC_AMT, 0)) AS DC_AMT                        
                        ,J.PROD_GRD_CD
                        ,J.USE_PERIOD_UNIT_CD
                        ,J.USE_PERIOD
                        ,(CASE WHEN I.PROD_CASE_CD='DP006301' THEN 'giftcard' 
                               WHEN I.PROD_CASE_CD='DP006302' THEN 'exchange' 
                               WHEN I.PROD_CASE_CD='DP006303' THEN 'delivery' 
                          END) AS PROD_CASE_CD  
                        ,TO_CHAR(NVL( N.SPRC_APPLY_START_DT, L.APPLY_START_DT),'YYYYMMDDHH24MISS') AS APPLY_START_DT
                        ,TO_CHAR(NVL( N.SPRC_APPLY_END_DT , L.APPLY_END_DT ),'YYYYMMDDHH24MISS') AS APPLY_END_DT      
                        ,I.SALE_CNT 
                        ,NVL(N.MM_PROD_MAX_SALE_QTY, I.MM_MAX_SALE_QTY ) AS MTH_MAX_CNT     /* 월_최대_판매_수량 */
                        ,NVL(N.DLY_PROD_MAX_SALE_QTY, I.DAY_MAX_SALE_QTY ) AS DLY_MAX_CNT   /* 일_최대_판매_수량 */
                        ,NVL(N.PERMAN_MM_MAX_PRCHS_QTY, I.MM_MBR_MAX_PRCHS_QTY ) AS MTH_USR_MAX_CNT /* 월_회원_최대_구매_수량 */
                        ,NVL(N.PERMAN_DAY_MAX_PRCHS_QTY, I.DAY_MBR_MAX_PRCHS_QTY ) AS DLY_USR_MAX_CNT /* 일_회원_최대_구매_수량 */
                        ,NVL(N.ONCE_MAX_PRCHS_POSB_CNT, I.FIRST_MAX_PRCHS_QTY ) AS EACH_MAX_CNT  /* 1차_최대_구매_수량 */                                        
                        ,I.USE_PLAC                     /* 사용_장소 */
                        ,I.USE_LIMT_DESC                /* 사용_제한_설명 */
                        ,I.NOTICE_MATT                  /* 공지_사항 */
                        ,I.PRCHS_CANCEL_DRBK_REASON     /* 구매_취소_환불_사유 */
                        ,I.B2B_PROD_YN                  /* B2B_상품_여부 */
                        ,I.DLV_PROD_YN                  /* 배송_상품_여부 */
                        ,CASE WHEN N.PROD_ID IS NOT NULL THEN 'Y' ELSE 'N'END AS SPECIAL_SALE_YN
                        ,CASE WHEN N.PROD_ID IS NOT NULL THEN N.CPN_ID ELSE '' END AS SPECIAL_COUPON_ID
                        <if test="req.userKey != null">                        
                        ,(SELECT ( CASE WHEN COUNT( PD.NOTI_SEQ )=0 THEN 'feedback' END )
                            FROM TB_DP_PROD_NOTI PD
                           WHERE PD.PROD_ID = H.PART_PROD_ID
                         
                             AND PD.MBR_NO = #{req.userKey}
                         
                             AND PD.NOTI_TYPE_CD = 'DP000401'
                             AND PD.DEL_YN = 'N'                            
                             AND PD.TENANT_ID = #{tenantHeader.tenantId}        /* INPUT 테넌트ID */
                         )AS ALLOW
                         </if>
                        ,NVL( ( SELECT SUM( TSPP.PRCHS_CNT )
                                 FROM TB_DP_SPRC_PROD_PRCHS_MANG TSPP
                                WHERE TO_CHAR(TSPP.PRCHS_DT,'YYYYMMDD') BETWEEN CONCAT( TO_CHAR( SYSDATE, 'YYYYMM' ), '01' )
                                                        AND TO_CHAR( LAST_DAY( SYSDATE ),'YYYYMMDD')
                                  AND TSPP.PROD_ID = H.PART_PROD_ID )
                           , 0 ) AS MTH_PRCHS_CNT
                        ,NVL( ( SELECT TSPP.PRCHS_CNT
                                 FROM TB_DP_SPRC_PROD_PRCHS_MANG TSPP
                                WHERE TO_CHAR(TSPP.PRCHS_DT,'YYYYMMDD') = TO_CHAR( SYSDATE, 'YYYYMMDD' )
                                  AND TSPP.PROD_ID = H.PART_PROD_ID )
                           , 0 ) AS DLY_PRCHS_CNT           
                        ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID 
                                           ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC 
                                          ,DECODE(I.PROD_CASE_CD ,'DP006303'
                                                    ,(SELECT 1 FROM TB_DP_TENANT_PROD WHERE TENANT_ID =#{tenantHeader.tenantId} AND PROD_ID = H.PART_PROD_ID AND PROD_STATUS_CD='PD000403')
                                                    ,ROUND(DBMS_RANDOM.VALUE(1, 100), 0)
                                                  )
                                           ) as NO 
                        ,(SELECT SRC_CONTENT_ID 
                            FROM TB_DP_SHPG_PROD 
                           WHERE prod_id=H.PROD_ID 
                         ) AS couponCode                        
                        ,I.SRC_CONTENT_ID AS itemCode
                        ,(CASE WHEN (SELECT EPSD_CNT FROM TB_DP_SHPG_PROD WHERE PROD_ID = H.PROD_ID)>0 
                                THEN (SELECT PROD_STATUS_CD FROM TB_DP_TENANT_PROD WHERE TENANT_ID=#{tenantHeader.tenantId} AND PROD_ID=H.PROD_ID) 
                          ELSE 'PD000404' END
                          ) PROD_STATUS_CD
                        ,O.PROD_NM as catalogNm
                        ,I.COUPON_SEND_TYPE
                        ,N.SOLD_OUT_YN
                  FROM 
                          TB_DP_SHPG_BRAND A
                         ,TB_DP_SHPG_CATALOG B
                         ,TB_DP_SHPG_CATALOG_DESC C
                         ,TB_DP_MENU_SHPG_MAPG D
                         ,TB_DP_MENU_CATEGORY E
                         ,TB_DP_MENU_CATEGORY_DESC F 
                         ,TB_DP_PROD_CATALOG_MAPG G 
                         ,TB_DP_PROD_RSHP H
                         ,TB_DP_SHPG_PROD I
                         ,TB_DP_PROD J
                         ,TB_DP_TENANT_PROD K
                         ,TB_DP_TENANT_PROD_PRICE L
                         ,TB_DP_PROD_DESC O
                         ,(SELECT /*+ ORDERED */
                                 B1.PROD_ID
                               , B1.SPRC_DC_RATE
                               , B1.SPRC_PRICE
                               , B1.SPRC_DC_PRICE
                               , B1.SPRC_APPLY_START_DT
                               , B1.SPRC_APPLY_END_DT
                               , B1.MM_PROD_MAX_SALE_QTY
                               , B1.DLY_PROD_MAX_SALE_QTY   
                               , B1.PERMAN_MM_MAX_PRCHS_QTY
                               , B1.PERMAN_DAY_MAX_PRCHS_QTY
                               , B1.ONCE_MAX_PRCHS_POSB_CNT  
                               , B1.CPN_ID 
                               , B1.SOLD_OUT_YN                                  
                           FROM  TB_DP_PROD_RSHP A1
                                ,TB_DP_SPRC_PROD B1
                           WHERE 1=1
                             AND A1.PART_PROD_ID = B1.PROD_ID
                            <if test="req.specialProdId != null and req.specialType=='episode'">
                            AND B1.PROD_ID  = #{req.specialProdId}
                            </if>
                            <if test="req.specialProdId != null and req.specialType=='channel'">
                            AND A1.PROD_ID = #{req.specialProdId}
                            </if>                                
                             AND B1.EXPO_YN ='Y'
                             AND B1.CPN_ID IS NOT NULL
                             AND SYSDATE BETWEEN  B1.SPRC_APPLY_START_DT AND B1.SPRC_APPLY_END_DT 
                          )N
                WHERE 1=1
                AND A.BRAND_ID = B.BRAND_ID
                AND B.CATALOG_ID = C.CATALOG_ID
                AND C.CATALOG_ID = D.CATALOG_ID     
                AND D.MENU_ID = E.MENU_ID
                AND D.MENU_ID = F.MENU_ID
                AND B.CATALOG_ID = G.CATALOG_ID
                AND G.PROD_ID = H.PROD_ID
                AND H.PROD_ID <![CDATA[ <> ]]> H.PART_PROD_ID
                AND H.PART_PROD_ID = I.PROD_ID
                AND I.PROD_ID = J.PROD_ID
                AND I.PROD_ID = K.PROD_ID
                AND I.PROD_ID = L.PROD_ID
                AND I.PROD_ID = O.PROD_ID
                AND K.TENANT_ID = L.TENANT_ID
                AND I.PROD_ID = N.PROD_ID(+)
                AND H.PROD_RSHP_CD =#{prodRshpCd}    /*채널-에피소드 상품 관계*/ 
                <if test="req.includeProdStopStatus != null ">
                AND NVL(B.CHNL_CNT, 0) <![CDATA[> ]]> 0
                AND K.PROD_STATUS_CD = 'PD000403'  /* PD000403 : 판매중 */       
                </if>  
                 
                AND C.LANG_CD= #{lang}          /* ko : 한국어 */
                AND F.LANG_CD= #{lang}          /* ko : 한국어 */
                AND O.LANG_CD= #{lang}          /* ko : 한국어 */
                AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                <if test="req.saleDtUseYn == null">
                AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                </if>
                AND K.TENANT_ID = #{tenantHeader.tenantId}        /* INPUT 테넌트ID */
                AND B.CATALOG_ID = #{req.productId}
                <if test="req.specialProdId != null and req.specialType=='episode'">
                AND I.PROD_ID = #{req.specialProdId}
                </if>
                <if test="req.specialProdId != null and req.specialType=='channel'">
                AND H.PROD_ID = #{req.specialProdId}
                </if>   
                AND EXISTS (
                            SELECT 1 
                            FROM  TB_DP_SPRT_DEVICE DV  
                            WHERE 1=1
                              AND (DV.DEVICE_MODEL_CD  = #{deviceHeader.model} OR DV.DEVICE_MODEL_CD = #{req.virtualDeviceModelNo}) 
                              AND PROD_ID = I.PROD_ID
                    )    
                     
           ) KK
           <if test="endRow != null">
           WHERE NO <![CDATA[ <= ]]> #{endRow}   <!-- 배송상품 단품건으로 처리 -->
           </if>
    </select>   
    
   <!-- 쇼핑상세(옵션) 조회-->
    <select id="getShoppingOption" parameterType="Map" resultType="MetaInfo">
     /* ShoppingMapper.xml.getShoppingOption,쇼핑상세(옵션) 조회, 김형식/SK플래닛  , 2014-02-04 */
         SELECT 
                A.CHNL_PROD_ID AS prodId
               ,A.EPSD_PROD_ID AS partProdId
               ,A.OPT1_NM as prodNm
               ,A.EXPO_ORD as expoOrd
               ,(CASE WHEN  A.EXPO_ORD = 1 THEN A.OPT1_NM ELSE A.OPT2_NM END) AS optPdNm
               ,(CASE WHEN  A.EXPO_ORD = 1 THEN 'Y' ELSE 'N' END) AS subYn
               ,C.CONTENTS_TYPE_CD AS contentTypeCd  
               ,NVL((SELECT SP.SPRC_DC_RATE
                      FROM TB_DP_SPRC_PROD SP
                     WHERE SP.EXPO_YN = 'Y'
                       AND SP.CPN_ID IS NOT NULL
                       AND SYSDATE BETWEEN  SPRC_APPLY_START_DT AND SPRC_APPLY_END_DT
                       AND SP.PROD_ID = B.PROD_ID
                    ), NVL(D.DC_RATE,0)) AS DC_RATE
               ,NVL((SELECT SP.SPRC_PRICE
                      FROM TB_DP_SPRC_PROD SP
                     WHERE SP.EXPO_YN = 'Y'
                       AND SP.CPN_ID IS NOT NULL
                       AND SYSDATE BETWEEN  SPRC_APPLY_START_DT AND SPRC_APPLY_END_DT
                       AND SP.PROD_ID = B.PROD_ID
                    ), NVL(D.PROD_AMT,0)) AS PROD_AMT    
               ,NVL((SELECT SP.SPRC_DC_PRICE
                      FROM TB_DP_SPRC_PROD SP
                     WHERE SP.EXPO_YN = 'Y'
                       AND SP.CPN_ID IS NOT NULL
                       AND SYSDATE BETWEEN  SPRC_APPLY_START_DT AND SPRC_APPLY_END_DT
                       AND SP.PROD_ID = B.PROD_ID
                    ), NVL(D.DC_AMT,0)) AS DC_AMT                       
               ,D.PROD_NET_AMT
               ,D.DC_AFT_PROD_AMT
               ,B.FIRST_MAX_PRCHS_QTY 
               ,(CASE WHEN  C.CONTENTS_TYPE_CD = 'PD002502' THEN E.PROD_STATUS_CD ELSE '' END) AS PROD_STATUS_CD
               ,(CASE WHEN  C.CONTENTS_TYPE_CD = 'PD002502' THEN B.SRC_CONTENT_ID ELSE '' END) AS itemCode
        FROM  TB_DP_PROD_OPT A
             ,TB_DP_SHPG_PROD B 
             ,TB_DP_PROD C
             ,TB_DP_TENANT_PROD_PRICE D
             ,TB_DP_TENANT_PROD E
        WHERE 1=1
          AND A.EPSD_PROD_ID = B.PROD_ID
          AND A.EPSD_PROD_ID = C.PROD_ID
          AND A.EPSD_PROD_ID = D.PROD_ID
          AND A.EPSD_PROD_ID = E.PROD_ID
          AND A.CHNL_PROD_ID =#{chnlProdId}
          AND E.EXPO_YN ='Y'                                /* Y : 기본(기본여부) */
          AND E.TENANT_ID  =#{tenantHeader.tenantId}        /* INPUT 테넌트ID */
          AND D.TENANT_ID  =#{tenantHeader.tenantId}        /* INPUT 테넌트ID */
         <if test="req.includeProdStopStatus != null">
          AND (CASE WHEN A.EXPO_ORD=1 THEN NVL( A.EXPO_YN, 'N' ) 
               ELSE ( SELECT TPO2.EXPO_YN
                        FROM TB_DP_PROD_OPT TPO2
                       WHERE TPO2.CHNL_PROD_ID = A.CHNL_PROD_ID
                         AND TPO2.OPT1_NM = A.OPT1_NM
                         AND TPO2.EXPO_ORD = 1 
                         AND ROWNUM =1
                     ) 
               END
              ) = 'Y' 
          AND E.PROD_STATUS_CD ='PD000403'  
         </if>    
          <if test="req.saleDtUseYn == null">
          AND SYSDATE BETWEEN D.APPLY_START_DT AND D.APPLY_END_DT
          </if>
        ORDER BY A.CHNL_PROD_ID
                ,A.OPT1_NM
                ,A.EXPO_ORD
    </select>   

   <!-- 쇼핑상세(배송 상품 조회시 에피소드) 조회-->
    <select id="getShoppingEpisode" parameterType="Map" resultType="MetaInfo">
     /* ShoppingMapper.xml.getShoppingEpisode,쇼핑상세(배송 상품 조회시 에피소드) 조회, 김형식/SK플래닛  , 2014-12-31 */
         SELECT 
                A.CHNL_PROD_ID AS prodId
               ,A.EPSD_PROD_ID AS partProdId
        FROM  TB_DP_PROD_OPT A
             ,TB_DP_SHPG_PROD B 
             ,TB_DP_PROD C
             ,TB_DP_TENANT_PROD_PRICE D
             ,TB_DP_TENANT_PROD E
        WHERE 1=1
          AND A.EPSD_PROD_ID = B.PROD_ID
          AND A.EPSD_PROD_ID = C.PROD_ID
          AND A.EPSD_PROD_ID = D.PROD_ID
          AND A.EPSD_PROD_ID = E.PROD_ID
          AND A.CHNL_PROD_ID =#{chnlProdId}
          AND E.EXPO_YN ='Y'                                /* Y : 기본(기본여부) */
          AND E.TENANT_ID  =#{tenantHeader.tenantId}        /* INPUT 테넌트ID */
          AND D.TENANT_ID  =#{tenantHeader.tenantId}        /* INPUT 테넌트ID */
        ORDER BY A.CHNL_PROD_ID
                ,A.OPT1_NM
                ,A.EXPO_ORD
    </select>   
    
  <!-- 쇼핑상세(이미지) 조회-->
    <select id="getShoppingImgDetailList" parameterType="Map" resultType="MetaInfo">
     /* ShoppingMapper.xml.getShoppingImgDetailList,쇼핑상세(이미지) 조회, 김형식/SK플래닛  , 2014-02-04 */
        SELECT 
                 CONCAT(FILE_PATH,FILE_NM) FILE_PATH 
               , EXPO_ORD
          FROM TB_DP_PROD_IMG
         WHERE PROD_ID = #{req.productId} 
           AND IMG_CD =#{cutDetailImageCd}
           AND LANG_CD= #{lang}          /* ko : 한국어 */
         ORDER BY EXPO_ORD            
    </select>       
    
  <!-- 쇼핑상세(에피소드로 카탈로그 가져오기) 조회-->
    <select id="getChannelByepisode" parameterType="ShoppingReq" resultType="MetaInfo">
     /* ShoppingMapper.xml.getChannelByepisode,쇼핑상세(에피소드로 카탈로그 가져오기) 조회, 김형식/SK플래닛  , 2014-02-04 */
        SELECT 
               CATALOG_ID
          FROM TB_DP_PROD_CATALOG_MAPG
         WHERE PROD_ID = ( 
                           SELECT DISTINCT PROD_ID 
                             FROM TB_DP_PROD_RSHP
                            WHERE PART_PROD_ID = #{productId} 
                              AND PROD_RSHP_CD = #{prodRshpCd}     /*채널-에피소드 상품 관계*/
                              AND ROWNUM =1
                         ) 
           AND BASE_YN ='Y'
           AND USE_YN ='Y'
    </select>
     
     <!-- 특가 상품 리스트 조회-->
    <select id="getSpecialPriceProductListV2"  parameterType="ShoppingReq" resultType="MetaInfo">
       /* ShoppingMapper.xml.getSpecialPriceProductListV2,특가 상품 리스트 조회, 김형식/SK플래닛  , 2014-02-04 */
       SELECT * FROM (
               SELECT 
                        ROW_NUMBER()OVER(ORDER BY REG_DT DESC, catalogNm ) AS RNUM        
                       ,COUNT(CATALOG_ID) OVER() AS TOTALCOUNT   
                       ,PP.*                   
                 FROM ( 
                     SELECT 
                            CATALOG_ID 
                           ,PROD_NET_AMT
                           ,PROD_AMT 
                           ,DC_RATE 
                           ,DC_AMT 
                           ,DLV_PROD_YN
                           ,BRAND_ID 
                           ,BRAND_NM 
                           ,MENU_ID 
                           ,MENU_NM 
                           ,TOP_MENU_ID 
                           ,META_CLSF_CD
                           ,(SELECT MENU_NM
                                FROM TB_DP_MENU_CATEGORY_DESC
                               WHERE MENU_ID = TOP_MENU_ID
                                 AND LANG_CD = #{langCd}          /* ko : 한국어 */
                                 AND ROWNUM = 1
                             ) AS TOP_MENU_NM                        
                           ,NEW_YN 
                           ,REG_DT 
                           ,TENANT_ID
                           ,PROD_ID 
                           ,PART_PROD_ID 
                           ,PROD_NM AS catalogNm
                           ,PRCHS_CNT 
                           ,PROD_GRD_CD as prodGrdCd
                           ,TO_CHAR(SPRC_APPLY_START_DT,'YYYYMMDDHH24MISS') as applyStartDt   
                           ,TO_CHAR(SPRC_APPLY_END_DT,'YYYYMMDDHH24MISS') as applyEndDt 
                           ,PROD_CASE_CD  
                           ,CONCAT(FILE_PATH,FILE_NM) AS FILE_PATH
                           ,'Y' AS specialSale
                           ,SOLDOUT AS soldOut
                           ,NO AS no
                           ,ROW_NUMBER() OVER(PARTITION BY CATALOG_ID ORDER BY SOLDOUT ASC) AS NO1 
                           ,CONTENTS_TYPE_CD  
                           ,EXPO_ORD            
                     FROM (
                          SELECT  
                               KK.*
                               ,(CASE WHEN ( ( MTH_PRCHS_CNT >= MM_PROD_MAX_SALE_QTY ) OR
                                             ( DLY_PRCHS_CNT >= DLY_PROD_MAX_SALE_QTY )
                                              OR 
                                             ( SOLD_OUT_YN ='Y' ) 
                                            )       
                                 THEN 'Y' ELSE 'N'
                                 END ) AS SOLDOUT                                     
                           FROM (
                                  SELECT 
                                        B.CATALOG_ID 
                                       ,C.CATALOG_NM 
                                       ,NVL(L.PROD_NET_AMT, 0) AS PROD_NET_AMT 
                                       ,NVL(N.SPRC_PRICE, NVL(L.PROD_AMT, 0)) AS PROD_AMT 
                                       ,NVL(N.SPRC_DC_RATE, NVL(L.DC_RATE,0)) AS DC_RATE
                                       ,NVL(N.SPRC_DC_PRICE, NVL(L.DC_AMT, 0)) AS DC_AMT
                                       ,A.BRAND_ID  
                                       ,A.BRAND_NM  
                                       ,D.MENU_ID  
                                       ,F.MENU_NM   
                                       ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC) as NO
                                       ,CASE WHEN (SYSDATE - 7)    <![CDATA[ <= ]]>  I.REG_DT THEN 'Y' ELSE 'N' END AS NEW_YN  
                                       ,N.REG_DT 
                                       ,K.TENANT_ID 
                                       ,H.PROD_ID 
                                       ,H.PART_PROD_ID  
                                       ,I.DLV_PROD_YN
                                       ,CASE WHEN NVL(M.PRCHS_CNT, 0) <![CDATA[ < ]]> 0 THEN 0 ELSE NVL(M.PRCHS_CNT, 0) END AS PRCHS_CNT 
                                       ,J.PROD_GRD_CD   
                                       ,L.APPLY_START_DT     
                                       ,L.APPLY_END_DT    
                                        <if test="specialTypeCd == 'DP007501+DP007502'">
                                       ,(CASE WHEN I.PROD_CASE_CD='DP006301' THEN 'giftcard' 
                                              WHEN I.PROD_CASE_CD='DP006302' THEN 'exchange' 
                                              WHEN I.PROD_CASE_CD='DP006303' THEN 'delivery' 
                                         END) AS PROD_CASE_CD                                 
                                         </if>
                                         <if test="specialTypeCd == 'DP007503'">
                                        ,(CASE WHEN I.PROD_CASE_CD='DP006301' THEN 'tingGiftcard' 
                                               WHEN I.PROD_CASE_CD='DP006302' THEN 'tingExchange' 
                                               WHEN I.PROD_CASE_CD='DP006303' THEN 'tingDelivery' 
                                          END) AS PROD_CASE_CD  
                                          </if>                                 
                                       ,E.TOP_MENU_ID
                                       ,J.META_CLSF_CD       
                                       ,PI.FILE_PATH
                                       ,PI.FILE_NM
                                       , NVL( ( SELECT SUM( TSPP.PRCHS_CNT )
                                                 FROM TB_DP_SPRC_PROD_PRCHS_MANG TSPP
                                                WHERE TO_CHAR(TSPP.PRCHS_DT,'YYYYMMDD') BETWEEN CONCAT( TO_CHAR( SYSDATE, 'YYYYMM' ), '01' )
                                                                        AND TO_CHAR( LAST_DAY( SYSDATE ),'YYYYMMDD')
                                                  AND TSPP.PROD_ID = H.PART_PROD_ID )
                                           , 0 ) AS MTH_PRCHS_CNT
                                       , NVL( ( SELECT TSPP.PRCHS_CNT
                                                 FROM TB_DP_SPRC_PROD_PRCHS_MANG TSPP
                                                WHERE TO_CHAR(TSPP.PRCHS_DT,'YYYYMMDD') = TO_CHAR( SYSDATE, 'YYYYMMDD' )
                                                  AND TSPP.PROD_ID = H.PART_PROD_ID )
                                           , 0 ) AS DLY_PRCHS_CNT 
                                       ,N.MM_PROD_MAX_SALE_QTY
                                       ,N.DLY_PROD_MAX_SALE_QTY
                                       ,N.SPRC_APPLY_START_DT
                                       ,N.SPRC_APPLY_END_DT
                                       ,N.EXPO_ORD   
                                       ,N.SOLD_OUT_YN
                                       ,O.PROD_NM 
                                       ,J.CONTENTS_TYPE_CD                            
                                  FROM 
                                          TB_DP_SHPG_BRAND A
                                         ,TB_DP_SHPG_CATALOG B
                                         ,TB_DP_SHPG_CATALOG_DESC C
                                         ,TB_DP_MENU_SHPG_MAPG D
                                         ,TB_DP_MENU_CATEGORY E
                                         ,TB_DP_MENU_CATEGORY_DESC F 
                                         ,TB_DP_PROD_CATALOG_MAPG G 
                                         ,TB_DP_PROD_RSHP H
                                         ,TB_DP_SHPG_PROD I
                                         ,TB_DP_PROD J
                                         ,TB_DP_TENANT_PROD K
                                         ,TB_DP_TENANT_PROD_PRICE L
                                         ,TB_DP_PROD_IMG          PI
                                         ,(SELECT  PROD_ID
                                                  ,PRCHS_CNT
                                             FROM TB_DP_TENANT_PROD_STATS 
                                            WHERE TENANT_ID = #{tenantId}    /* INPUT 테넌트ID */
                                           ) M
                                         ,TB_DP_SPRC_PROD N
                                         ,TB_DP_PROD_DESC O
                                WHERE 1=1
                                AND A.BRAND_ID = B.BRAND_ID
                                AND B.CATALOG_ID = C.CATALOG_ID
                                AND C.CATALOG_ID = D.CATALOG_ID     
                                AND D.MENU_ID = E.MENU_ID
                                AND D.MENU_ID = F.MENU_ID
                                AND B.CATALOG_ID = G.CATALOG_ID
                                AND G.PROD_ID = H.PROD_ID
                                AND H.PROD_ID <![CDATA[ <> ]]> H.PART_PROD_ID
                                AND H.PART_PROD_ID = I.PROD_ID
                                AND I.PROD_ID = J.PROD_ID
                                AND I.PROD_ID = K.PROD_ID
                                AND I.PROD_ID = L.PROD_ID
                                AND C.CATALOG_ID = M.PROD_ID(+)                           
                                AND I.PROD_ID = N.PROD_ID
                                AND I.PROD_ID = O.PROD_ID
                                AND K.TENANT_ID = L.TENANT_ID 
                                AND N.EXPO_YN ='Y'
                                AND N.CPN_ID IS NOT NULL
                                <if test="arraySpecialTypeCd != null">
                                AND N.SPRC_TYPE_CD  IN
                                              <foreach collection="arraySpecialTypeCd" item="specialTypeCd" separator="," open="(" close=")">
                                                #{specialTypeCd}
                                              </foreach>                        
                                </if>                           
                                AND PI.IMG_CD(+) = #{imageCd}
                                AND B.CATALOG_ID = PI.PROD_ID       
                                AND H.PROD_RSHP_CD ='DP010802'    /*채널-에피소드 상품 관계*/
                                AND NVL(B.CHNL_CNT, 0) > 0          
                                AND C.LANG_CD= #{langCd}          /* ko : 한국어 */
                                AND O.LANG_CD= #{langCd}          /* ko : 한국어 */
                                AND F.LANG_CD= #{langCd}          /* ko : 한국어 */
                                AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                                AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                                AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                                AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                                AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                                AND NVL(I.B2B_PROD_YN, 'N') <![CDATA[ <> ]]> 'Y'
                                AND K.PROD_STATUS_CD = 'PD000403'  /* PD000403 : 판매중 */
                                AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                                AND SYSDATE BETWEEN  N.SPRC_APPLY_START_DT AND N.SPRC_APPLY_END_DT 
                                AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                                AND K.TENANT_ID = #{tenantId}       /* INPUT 테넌트ID */
                                <if test="prodCharge != null">
                                AND J.PROD_CHRG_YN =#{prodCharge}
                                </if>
                                <if test="arrayProdGradeCd != null">
                                AND J.PROD_GRD_CD  IN
                                              <foreach collection="arrayProdGradeCd" item="prodGradeCd" separator="," open="(" close=")">
                                                #{prodGradeCd}
                                              </foreach>                        
                                </if>   
                           )  KK
                       )  
                        ORDER BY EXPO_ORD , PROD_NM 
                ) PP
                WHERE 1=1
                  AND (CASE WHEN PROD_CASE_CD ='delivery' or  PROD_CASE_CD ='tingDelivery' THEN NO1 ELSE NO END) =1
                  ORDER BY EXPO_ORD,CATALOGNM        
        ) WHERE RNUM BETWEEN #{offset} AND #{count}
    </select>            
    
    <!-- 기획전 상품 조회-->
    <select id="getSpecialSalesListV2" parameterType="ShoppingReq" resultType="MetaInfo">
       /* ShoppingMapper.xml.getSpecialSalesListV2,기획전 상품 조회, 김형식/SK플래닛  , 2014-02-03 */
      SELECT * FROM ( 
           SELECT 
                 KK.*
                ,COUNT(PLAN_ID) OVER() AS TOTALCOUNT
                ,ROWNUM AS RNUM   
            FROM(      
                SELECT PLAN_ID
                      ,PLAN_NM as prodNm
                      ,SUB_TITL_NM
                      ,LINK_URL
                      ,TO_CHAR(PLAN_START_DT,'YYYYMMDDHH24MISS') AS PLAN_START_DT
                      ,TO_CHAR(PLAN_END_DT,'YYYYMMDDHH24MISS') AS PLAN_END_DT
                      ,TO_CHAR(PRZWNER_ANNO_DT, 'YYYYMMDDHH24MISS') AS PRZWNER_ANNO_DT
                      ,PLAN_GIFT_NM
                      ,(SELECT CONCAT(FILE_PATH,FILE_NM) FROM TB_DP_PROD_IMG
                         WHERE PROD_ID = PLAN_ID AND IMG_CD =#{bannerImgCd}
                       )as bannerFilePath
                      ,(SELECT CONCAT(FILE_PATH,FILE_NM) FROM TB_DP_PROD_IMG
                         WHERE PROD_ID = PLAN_ID AND IMG_CD =#{promotionImgCd}
                       )as FILE_PATH   
                      ,(SELECT CONCAT(FILE_PATH,FILE_NM) FROM TB_DP_PROD_IMG
                         WHERE PROD_ID = PLAN_ID AND IMG_CD =#{promotionDetailImgCd}
                       )as detailPromotionPath    
                      ,PLAN_DESC                                        
                 FROM TB_DP_PLAN_INFO_MANG KK
                WHERE SYSDATE BETWEEN PLAN_START_DT AND PLAN_END_DT
                  AND PLAN_STATUS_CD = 'DP006501'
                  AND DP_YN = 'Y'
                <if test="planId != null">
                  AND PLAN_ID = #{planId}
                </if>                  
                  AND EXISTS (
                         SELECT
                                  'X'
                           FROM 
                                    TB_DP_SHPG_BRAND A
                                   ,TB_DP_SHPG_CATALOG B
                                   ,TB_DP_SHPG_CATALOG_DESC C
                                   ,TB_DP_MENU_SHPG_MAPG D
                                   ,TB_DP_MENU_CATEGORY E
                                   ,TB_DP_MENU_CATEGORY_DESC F 
                                   ,TB_DP_PROD_CATALOG_MAPG G 
                                   ,TB_DP_PROD_RSHP H
                                   ,TB_DP_SHPG_PROD I
                                   ,TB_DP_PROD J
                                   ,TB_DP_TENANT_PROD K
                                   ,TB_DP_TENANT_PROD K1
                                   ,TB_DP_TENANT_PROD_PRICE L
                                   ,TB_DP_PLAN_CATALOG_MANG M
                          WHERE 1=1
                          AND A.BRAND_ID = B.BRAND_ID
                          AND B.CATALOG_ID = C.CATALOG_ID
                          AND C.CATALOG_ID = D.CATALOG_ID     
                          AND D.MENU_ID = E.MENU_ID
                          AND D.MENU_ID = F.MENU_ID
                          AND B.CATALOG_ID = G.CATALOG_ID
                          AND G.PROD_ID = H.PROD_ID
                          AND H.PROD_ID <![CDATA[ <> ]]> H.PART_PROD_ID
                          AND H.PART_PROD_ID = I.PROD_ID
                          AND I.PROD_ID = J.PROD_ID
                          AND I.PROD_ID = K.PROD_ID
                          AND I.PROD_ID = L.PROD_ID
                          AND G.PROD_ID = K1.PROD_ID
                          AND K.TENANT_ID = K1.TENANT_ID
                          AND K.TENANT_ID = L.TENANT_ID 
                          AND H.PROD_RSHP_CD ='DP010802'    /*채널-에피소드 상품 관계*/ 
                          AND NVL(B.CHNL_CNT, 0) > 0          
                          AND C.LANG_CD= #{langCd}          /* ko : 한국어 */
                          AND F.LANG_CD= #{langCd}         /* ko : 한국어 */
                          AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                          AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                          AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                          AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                          AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                          AND NVL(I.B2B_PROD_YN, 'N') <![CDATA[ <> ]]> 'Y'
                          AND K1.PROD_STATUS_CD = 'PD000403'  /* PD000403 : 판매중 */
                          AND K1.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */                                
                          AND K.PROD_STATUS_CD = 'PD000403'  /* PD000403 : 판매중 */
                          AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                          AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                          AND K.TENANT_ID = #{tenantId}        /* INPUT 테넌트ID */
                          AND M.EXPO_YN ='Y'            /* Y : 기본(기본여부) */
                          AND M.PLAN_ID = KK.PLAN_ID 
                          AND B.CATALOG_ID = M.CATALOG_ID  
                          AND NOT EXISTS (
                             SELECT 'X'
                               FROM  TB_DP_PROD_RSHP A2
                                    ,TB_DP_SPRC_PROD B2
                                    ,TB_DP_PROD_CATALOG_MAPG C2
                               WHERE 1=1
                                 AND A2.PART_PROD_ID = B2.PROD_ID
                                 AND A2.PROD_ID = C2.PROD_ID
                                 AND C2.BASE_YN ='Y'
                                 AND C2.USE_YN ='Y'
                                 AND B2.EXPO_YN ='Y'
                                 AND B2.CPN_ID IS NOT NULL
                                 AND B2.SPRC_TYPE_CD IN ('DP007503','DP007504')
                                 AND C2.CATALOG_ID = B.CATALOG_ID
                                 AND SYSDATE BETWEEN  B2.SPRC_APPLY_START_DT AND B2.SPRC_APPLY_END_DT                 
                            )                                                 
                         )                 
                <if test='orderedBy == "recent"'>  
                 order by REG_DT DESC , PLAN_NM
                </if>
                <if test='orderedBy == "closingTime"'>  
                 order by PLAN_END_DT , PLAN_NM
                </if>      
                        
            )KK
     )  
     <if test="planId == null"> 
     WHERE RNUM BETWEEN #{offset} AND #{count}
     </if>
    </select> 
    
    <!-- 특정 기획전에 대한 상품 리스트 조회-->
    <select id="getSpecialSalesProductListV2" parameterType="Map" resultType="ProductBasicInfo">
       /* ShoppingMapper.xml.getSpecialSalesProductListV2,특정 기획전에 대한 상품 리스트 조회, 김형식/SK플래닛  , 2014-02-04 */
        SELECT *
         FROM ( 
             SELECT 
                    rownum AS RNUM        
                   ,COUNT(CATALOG_ID) OVER() AS TOTALCOUNT      
                   ,CATALOG_ID AS catalogId
                   ,BRAND_ID AS brandId
                   ,MENU_ID AS menuId
                   ,TENANT_ID AS tenentId
                   ,PROD_ID as prodId
                   ,PART_PROD_ID as partProdId 
                   ,EXPO_ORD as expoOrd
                   ,#{channelContentTypeCd} as contentsTypeCd
             FROM (
                  SELECT  * 
                   FROM (
                          SELECT 
                                B.CATALOG_ID 
                               ,C.CATALOG_NM 
                               ,A.BRAND_ID  
                               ,D.MENU_ID  
                               ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC) as NO
                               ,K.TENANT_ID 
                               ,H.PROD_ID 
                               ,H.PART_PROD_ID  
                               ,M.EXPO_ORD
                               ,I.REG_DT   
                          FROM 
                                  TB_DP_SHPG_BRAND A
                                 ,TB_DP_SHPG_CATALOG B
                                 ,TB_DP_SHPG_CATALOG_DESC C
                                 ,TB_DP_MENU_SHPG_MAPG D
                                 ,TB_DP_MENU_CATEGORY E
                                 ,TB_DP_MENU_CATEGORY_DESC F 
                                 ,TB_DP_PROD_CATALOG_MAPG G 
                                 ,TB_DP_PROD_RSHP H
                                 ,TB_DP_SHPG_PROD I
                                 ,TB_DP_PROD J
                                 ,TB_DP_TENANT_PROD K
                                 ,TB_DP_TENANT_PROD_PRICE L
                                 ,TB_DP_PLAN_CATALOG_MANG M
                                 ,(SELECT /*+ ORDERED */
                                        B1.PROD_ID
                                      , B1.SPRC_DC_RATE
                                      , B1.SPRC_PRICE
                                   FROM  TB_DP_PROD_RSHP A1
                                        ,TB_DP_SPRC_PROD B1
                                   WHERE 1=1
                                     AND A1.PART_PROD_ID = B1.PROD_ID
                                     AND B1.EXPO_YN ='Y'
                                     AND B1.CPN_ID IS NOT NULL
                                     AND B1.SPRC_TYPE_CD IN ('DP007501','DP007502') --DP007501 : 일반특가 , DP007502 일반 배송 특가
                                     AND SYSDATE BETWEEN  B1.SPRC_APPLY_START_DT AND B1.SPRC_APPLY_END_DT 
                                  )N
                        WHERE 1=1
                        AND A.BRAND_ID = B.BRAND_ID
                        AND B.CATALOG_ID = C.CATALOG_ID
                        AND C.CATALOG_ID = D.CATALOG_ID     
                        AND D.MENU_ID = E.MENU_ID
                        AND D.MENU_ID = F.MENU_ID
                        AND B.CATALOG_ID = G.CATALOG_ID
                        AND G.PROD_ID = H.PROD_ID
                        AND H.PROD_ID <![CDATA[ <> ]]> H.PART_PROD_ID
                        AND H.PART_PROD_ID = I.PROD_ID
                        AND I.PROD_ID = J.PROD_ID
                        AND I.PROD_ID = K.PROD_ID
                        AND I.PROD_ID = L.PROD_ID
                        AND B.CATALOG_ID = M.CATALOG_ID
                        AND K.TENANT_ID = L.TENANT_ID 
                        AND M.EXPO_YN ='Y'            /* Y : 기본(기본여부) */
                        AND M.PLAN_ID = #{req.planId}  
                        AND I.PROD_ID = N.PROD_ID(+)     
                        AND H.PROD_RSHP_CD =#{prodRshpCd}     /*채널-에피소드 상품 관계*/
                        AND NVL(B.CHNL_CNT, 0) > 0                  
                        AND C.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND F.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                        AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                        AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND NVL(I.B2B_PROD_YN, 'N') <![CDATA[ <> ]]> 'Y'
                        AND K.PROD_STATUS_CD = #{prodStatusCd}  /* PD000403 : 판매중 */
                        AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                        AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                        AND K.TENANT_ID = #{tenantHeader.tenantId}       /* INPUT 테넌트ID */
                        <if test="req.prodCharge != null">
                        AND J.PROD_CHRG_YN =#{req.prodCharge}
                        </if>
                        <if test="req.arrayProdGradeCd != null">
                        AND J.PROD_GRD_CD  IN
                                      <foreach collection="req.arrayProdGradeCd" item="req.prodGradeCd" separator="," open="(" close=")">
                                        #{req.prodGradeCd}
                                      </foreach>                        
                        </if>    
                        AND NOT EXISTS (
                             SELECT 'X'
                               FROM  TB_DP_PROD_RSHP A2
                                    ,TB_DP_SPRC_PROD B2
                                    ,TB_DP_PROD_CATALOG_MAPG C2
                               WHERE 1=1
                                 AND A2.PART_PROD_ID = B2.PROD_ID
                                 AND A2.PROD_ID = C2.PROD_ID
                                 AND C2.BASE_YN ='Y'
                                 AND C2.USE_YN ='Y'
                                 AND B2.EXPO_YN ='Y'
                                 AND B2.CPN_ID IS NOT NULL
                                 AND B2.SPRC_TYPE_CD IN ('DP007503','DP007504')
                                 AND C2.CATALOG_ID = B.CATALOG_ID
                                 AND SYSDATE BETWEEN  B2.SPRC_APPLY_START_DT AND B2.SPRC_APPLY_END_DT                 
                          )                             
                 
                   ) 
                 WHERE NO =1
                 ORDER BY EXPO_ORD ASC, CATALOG_NM ASC
               ) 
        ) WHERE RNUM BETWEEN #{req.offset} AND #{req.count}
    </select>    
        
    <!-- 브랜드샵 - 메인 메뉴 리스트 조회-->
    <select id="getShoppingBrandMenuListV2" parameterType="ShoppingReq" resultType="MetaInfo">
       /* ShoppingMapper.xml.getShoppingBrandMenuListV2,브랜드샵 - 메인 메뉴 리스트 조회, 김형식/SK플래닛  , 2014-01-30 */
        SELECT  
                A.MENU_ID 
               ,B.MENU_NM 
          FROM  TB_DP_MENU_CATEGORY A
               ,TB_DP_MENU_CATEGORY_DESC B
         WHERE A.UP_MENU_ID ='DP28'
           AND A.MENU_ID = B.MENU_ID
           AND B.LANG_CD =#{langCd}          /* ko : 한국어 */
           AND A.USE_YN = 'Y'
           AND A.MENU_ID > ='DP28008'
    </select> 
    
    <!-- 브랜드샵 - 메인 리스트 조회-->
    <select id="getBrandshopMainListV2" parameterType="ShoppingReq" resultType="MetaInfo">
       /* ShoppingMapper.xml.getBrandshopMainListV2,브랜드샵 - 메인 리스트 조회, 김형식/SK플래닛  , 2014-01-30 */
       SELECT * FROM (
           SELECT 
                     KK.*
                    ,COUNT(1) OVER() AS TOTALCOUNT
                    ,ROWNUM AS RNUM         
             FROM(
                SELECT 
                           BRAND_ID 
                         , BRAND_NM AS catalogNm
                         , MENU_ID 
                         , MENU_NM 
                         , TOP_MENU_ID 
                         ,(SELECT MENU_NM
                              FROM TB_DP_MENU_CATEGORY_DESC
                             WHERE MENU_ID = TOP_MENU_ID
                               AND LANG_CD = #{langCd}          /* ko : 한국어 */
                               AND ROWNUM = 1
                           ) AS TOP_MENU_NM                      
                         ,(SELECT CONCAT(FILE_PATH,FILE_NM) FROM TB_DP_PROD_IMG
                            WHERE PROD_ID = BRAND_ID AND IMG_CD =#{imageCd}
                          ) AS FILE_PATH
                 FROM (
                    SELECT *
                    FROM (
                        SELECT  
                              SB.BRAND_ID
                             ,SB.BRAND_NM
                             ,MC.MENU_ID
                             ,MCD.MENU_NM
                             ,MC.TOP_MENU_ID
                             ,PM.DP_ORD
                        FROM  TB_DP_SHPG_BRAND SB
                             ,TB_DP_MENU_CATEGORY MC
                             ,TB_DP_MENU_CATEGORY_DESC MCD
                             ,TB_DP_RECOM_PROD_MANG PM
                        WHERE SB.MENU_ID = MC.MENU_ID
                          AND SB.MENU_ID = MCD.MENU_ID
                          AND SB.BRAND_ID = PM.BRAND_ID
                          AND MC.USE_YN ='Y'
                          AND MCD.LANG_CD =#{langCd}
                          AND EXISTS (
                               SELECT
                                        'X'
                                 FROM 
                                          TB_DP_SHPG_BRAND A
                                         ,TB_DP_SHPG_CATALOG B
                                         ,TB_DP_SHPG_CATALOG_DESC C
                                         ,TB_DP_MENU_SHPG_MAPG D
                                         ,TB_DP_MENU_CATEGORY E
                                         ,TB_DP_MENU_CATEGORY_DESC F 
                                         ,TB_DP_PROD_CATALOG_MAPG G 
                                         ,TB_DP_PROD_RSHP H
                                         ,TB_DP_SHPG_PROD I
                                         ,TB_DP_PROD J
                                         ,TB_DP_TENANT_PROD K
                                         ,TB_DP_TENANT_PROD K1
                                         ,TB_DP_TENANT_PROD_PRICE L

                                WHERE 1=1
                                AND A.BRAND_ID = B.BRAND_ID
                                AND B.CATALOG_ID = C.CATALOG_ID
                                AND C.CATALOG_ID = D.CATALOG_ID     
                                AND D.MENU_ID = E.MENU_ID
                                AND D.MENU_ID = F.MENU_ID
                                AND B.CATALOG_ID = G.CATALOG_ID
                                AND G.PROD_ID = H.PROD_ID
                                AND H.PROD_ID <![CDATA[ <> ]]> H.PART_PROD_ID
                                AND H.PART_PROD_ID = I.PROD_ID
                                AND I.PROD_ID = J.PROD_ID
                                AND I.PROD_ID = K.PROD_ID
                                AND I.PROD_ID = L.PROD_ID
                                AND G.PROD_ID = K1.PROD_ID
                                AND K.TENANT_ID = K1.TENANT_ID
                                AND K.TENANT_ID = L.TENANT_ID 
                                AND H.PROD_RSHP_CD ='DP010802'    /*채널-에피소드 상품 관계*/ 
                                AND NVL(B.CHNL_CNT, 0) > 0          
                                AND C.LANG_CD= #{langCd}          /* ko : 한국어 */
                                AND F.LANG_CD= #{langCd}         /* ko : 한국어 */
                                AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                                AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                                AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                                AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                                AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                                AND NVL(I.B2B_PROD_YN, 'N') <![CDATA[ <> ]]> 'Y'
                                AND K1.PROD_STATUS_CD = 'PD000403'  /* PD000403 : 판매중 */
                                AND K1.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */                                
                                AND K.PROD_STATUS_CD = 'PD000403'  /* PD000403 : 판매중 */
                                AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                                AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                                AND K.TENANT_ID = #{tenantId}        /* INPUT 테넌트ID */
                                AND A.BRAND_ID =SB.BRAND_ID
                                AND NOT EXISTS (
                                     SELECT 'X'
                                       FROM  TB_DP_PROD_RSHP A2
                                            ,TB_DP_SPRC_PROD B2
                                            ,TB_DP_PROD_CATALOG_MAPG C2
                                       WHERE 1=1
                                         AND A2.PART_PROD_ID = B2.PROD_ID
                                         AND A2.PROD_ID = C2.PROD_ID
                                         AND C2.BASE_YN ='Y'
                                         AND C2.USE_YN ='Y'
                                         AND B2.EXPO_YN ='Y'
                                         AND B2.CPN_ID IS NOT NULL
                                         AND B2.SPRC_TYPE_CD IN ('DP007503','DP007504')
                                         AND C2.CATALOG_ID = B.CATALOG_ID
                                         AND SYSDATE BETWEEN  B2.SPRC_APPLY_START_DT AND B2.SPRC_APPLY_END_DT                 
                                    )                                   
                          )
                     )
                    ORDER BY
                           DP_ORD ,
                    MENU_ID , BRAND_NM
                )
            )KK
        )
        WHERE RNUM BETWEEN #{offset} AND #{count}
    </select>     
    
 
    
    <!-- 브랜드샵 – 카테고리별 브랜드샵 조회-->
    <select id="getBrandshopCategoryList" parameterType="ShoppingReq" resultType="MetaInfo">
       /* ShoppingMapper.xml.getBrandshopCategoryList,브랜드샵 – 카테고리별 브랜드샵 조회, 김형식/SK플래닛  , 2014-01-30 */
       SELECT * FROM (
           SELECT 
                     KK.*
                    ,COUNT(1) OVER() AS TOTALCOUNT
                    ,ROWNUM AS RNUM         
             FROM(
                SELECT 
                           BRAND_ID 
                         , BRAND_NM AS catalogNm
                         , MENU_ID 
                         , MENU_NM 
                         , TOP_MENU_ID 
                         ,(SELECT MENU_NM
                              FROM TB_DP_MENU_CATEGORY_DESC
                             WHERE MENU_ID = TOP_MENU_ID
                               AND LANG_CD = #{langCd}          /* ko : 한국어 */
                               AND ROWNUM = 1
                           ) AS TOP_MENU_NM                      
                         ,(SELECT CONCAT(FILE_PATH,FILE_NM) FROM TB_DP_PROD_IMG
                            WHERE PROD_ID = BRAND_ID AND IMG_CD =#{imageCd}
                          ) AS FILE_PATH
                         ,(SELECT IMG_PATH
                             FROM TB_DP_MENU_LIST_CATEGORY 
                            WHERE KEY_TYPE='DP01230001'
                              AND TENANT_ID =#{tenantId}
                              AND MENU_KEY = MENU_ID
                              AND EXPO_YN = 'Y'
                              AND ROWNUM =1   
                          ) AS dlmImagePath                          
                          
                 FROM (
                    SELECT *
                    FROM (
                        SELECT  
                              SB.BRAND_ID
                             ,SB.BRAND_NM
                             ,MC.MENU_ID
                             ,MCD.MENU_NM
                             ,MC.TOP_MENU_ID
                        FROM  TB_DP_SHPG_BRAND SB
                             ,TB_DP_MENU_CATEGORY MC
                             ,TB_DP_MENU_CATEGORY_DESC MCD
                        WHERE SB.MENU_ID = MC.MENU_ID
                          AND SB.MENU_ID = MCD.MENU_ID
     
                          <if test="brandId != null">
                          AND SB.BRAND_ID = #{brandId}
                          </if>       
                          AND MC.USE_YN ='Y'
                           <if test='menuId != null'> 
                          AND MC.MENU_ID = #{menuId} 
                          </if>
                          AND MCD.LANG_CD =#{langCd}
                          AND EXISTS (
                               SELECT
                                        'X'
                                 FROM 
                                          TB_DP_SHPG_BRAND A
                                         ,TB_DP_SHPG_CATALOG B
                                         ,TB_DP_SHPG_CATALOG_DESC C
                                         ,TB_DP_MENU_SHPG_MAPG D
                                         ,TB_DP_MENU_CATEGORY E
                                         ,TB_DP_MENU_CATEGORY_DESC F 
                                         ,TB_DP_PROD_CATALOG_MAPG G 
                                         ,TB_DP_PROD_RSHP H
                                         ,TB_DP_SHPG_PROD I
                                         ,TB_DP_PROD J
                                         ,TB_DP_TENANT_PROD K
                                         ,TB_DP_TENANT_PROD K1
                                         ,TB_DP_TENANT_PROD_PRICE L

                                WHERE 1=1
                                AND A.BRAND_ID = B.BRAND_ID
                                AND B.CATALOG_ID = C.CATALOG_ID
                                AND C.CATALOG_ID = D.CATALOG_ID     
                                AND D.MENU_ID = E.MENU_ID
                                AND D.MENU_ID = F.MENU_ID
                                AND B.CATALOG_ID = G.CATALOG_ID
                                AND G.PROD_ID = H.PROD_ID
                                AND H.PROD_ID <![CDATA[ <> ]]> H.PART_PROD_ID
                                AND H.PART_PROD_ID = I.PROD_ID
                                AND I.PROD_ID = J.PROD_ID
                                AND I.PROD_ID = K.PROD_ID
                                AND I.PROD_ID = L.PROD_ID
                                AND G.PROD_ID = K1.PROD_ID
                                AND K.TENANT_ID = K1.TENANT_ID
                                AND K.TENANT_ID = L.TENANT_ID 
                                AND H.PROD_RSHP_CD ='DP010802'    /*채널-에피소드 상품 관계*/ 
                                AND NVL(B.CHNL_CNT, 0) > 0          
                                AND C.LANG_CD= #{langCd}          /* ko : 한국어 */
                                AND F.LANG_CD= #{langCd}         /* ko : 한국어 */
                                AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                                AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                                AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                                AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                                AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                                AND NVL(I.B2B_PROD_YN, 'N') <![CDATA[ <> ]]> 'Y'
                                AND K1.PROD_STATUS_CD = 'PD000403'  /* PD000403 : 판매중 */
                                AND K1.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */                                
                                AND K.PROD_STATUS_CD = 'PD000403'  /* PD000403 : 판매중 */
                                AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                                AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                                AND K.TENANT_ID = #{tenantId}        /* INPUT 테넌트ID */
                                AND A.BRAND_ID =SB.BRAND_ID
                                AND NOT EXISTS (
                                     SELECT 'X'
                                       FROM  TB_DP_PROD_RSHP A2
                                            ,TB_DP_SPRC_PROD B2
                                            ,TB_DP_PROD_CATALOG_MAPG C2
                                       WHERE 1=1
                                         AND A2.PART_PROD_ID = B2.PROD_ID
                                         AND A2.PROD_ID = C2.PROD_ID
                                         AND C2.BASE_YN ='Y'
                                         AND C2.USE_YN ='Y'
                                         AND B2.EXPO_YN ='Y'
                                         AND B2.CPN_ID IS NOT NULL
                                         AND B2.SPRC_TYPE_CD IN ('DP007503','DP007504')
                                         AND C2.CATALOG_ID = B.CATALOG_ID
                                         AND SYSDATE BETWEEN  B2.SPRC_APPLY_START_DT AND B2.SPRC_APPLY_END_DT                 
                                    )                                   
                          )
                     )
                    ORDER BY
                    MENU_ID , BRAND_NM
                )
            )KK
        )
        <if test="brandId == null"> 
        WHERE RNUM BETWEEN #{offset} AND #{count}
        </if>
    </select>
        
    <!-- 특정 브랜드샵 상품 리스트 조회-->
    <select id="getBrandshopProductListV2" parameterType="Map" resultType="ProductBasicInfo">
    /* ShoppingMapper.xml.getBrandshopProductListV2,특정 브랜드샵 상품 리스트 조회, 김형식/SK플래닛  , 2014-12-04 */
        SELECT *
         FROM ( 
             SELECT 
                    rownum AS RNUM        
                   ,COUNT(CATALOG_ID) OVER() AS TOTALCOUNT      
                   ,CATALOG_ID AS catalogId
                   ,BRAND_ID AS brandId
                   ,MENU_ID AS menuId
                   ,TENANT_ID AS tenentId
                   ,PROD_ID as prodId
                   ,PART_PROD_ID as partProdId 
                   ,#{channelContentTypeCd} as contentsTypeCd
             FROM (
                  SELECT  * 
                   FROM (
                          SELECT 
                                 B.CATALOG_ID 
                               ,C.CATALOG_NM 
                               ,A.BRAND_ID  
                               ,D.MENU_ID  
                               ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC) as NO
                               ,K.TENANT_ID 
                               ,H.PROD_ID 
                               ,H.PART_PROD_ID
                               <if test='req.orderedBy == "recent"'>   
                               ,NVL((
                                    SELECT 
                                         MAX(SP.REG_DT)
                                    FROM 
                                         TB_DP_PROD_CATALOG_MAPG CM
                                        ,TB_DP_SHPG_PROD SP
                                    WHERE CM.CATALOG_ID =B.CATALOG_ID
                                      AND CM.PROD_ID = SP.PROD_ID
                                      AND CM.USE_YN ='Y'
                                      AND CM.BASE_YN ='Y'
                               ),I.REG_DT) AS REG_DT                                  
                               ,'1' EXPO_ORD
                               </if>
                               <if test='req.orderedBy == "popular"'>                 
                               ,NVL(M.EXPO_ORD_ALWAYS_YN,'A') AS EXPO_ORD_ALWAYS_YN
                               ,M.EXPO_ORD
                               ,M.EXPO_ORD_SUB   
                               </if>                   
                               ,NVL(N.SPRC_PRICE, L.DC_AFT_PROD_AMT) PROD_AMT                 
                          FROM 
                                  TB_DP_SHPG_BRAND A
                                 ,TB_DP_SHPG_CATALOG B
                                 ,TB_DP_SHPG_CATALOG_DESC C
                                 ,TB_DP_MENU_SHPG_MAPG D
                                 ,TB_DP_MENU_CATEGORY E
                                 ,TB_DP_MENU_CATEGORY_DESC F 
                                 ,TB_DP_PROD_CATALOG_MAPG G 
                                 ,TB_DP_PROD_RSHP H
                                 ,TB_DP_SHPG_PROD I
                                 ,TB_DP_PROD J
                                 ,TB_DP_TENANT_PROD K
                                 ,TB_DP_TENANT_PROD_PRICE L
                                 <if test='req.orderedBy == "popular"'>
                                ,(
                                    SELECT  TDLP.TENANT_ID
                                          , TDLP.LIST_ID
                                          , TDLP.MENU_ID
                                          , TDLP.PROD_ID
                                          , TDLP.EXPO_ORD_ALWAYS_YN
                                          , TDLP.EXPO_ORD
                                          , TDLP.EXPO_ORD_SUB
                                          , TDLP.PRCHS_QTY  
                                          , TDLP.DWLD_QTY                                      
                                      FROM  
                                            TB_DP_LIST_PROD TDLP
                                           ,TB_DP_LIST TDL
                                     WHERE 1=1
                                       AND  TDLP.TENANT_ID = TDL.TENANT_ID
                                       AND  TDLP.LIST_ID   = TDL.LIST_ID
                                       AND  TDLP.TENANT_ID = #{tenantHeader.tenantId}   /* 테넌트ID */
                                       AND  TDLP.LIST_ID   = #{req.listId}     /* RNK000000101 쇼핑 카탈로그 인기 */
                                       AND  TDLP.EXPO_YN = 'Y'             /* Y : 노출 (노출여부) */
                                       AND  TDL.EXPO_YN  = 'Y'             /* Y : 노출 (노출여부) */
                                       AND  TDLP.STD_DT = TO_DATE(#{stdDt}, 'YYYYMMDDHH24MISS') 
                                       AND  SYSDATE BETWEEN TDLP.EXPO_START_DT AND TDLP.EXPO_END_DT                            
                                  ) M                                  
                                 </if>                                 
                                 ,(SELECT /*+ ORDERED */
                                        B1.PROD_ID
                                      , B1.SPRC_DC_RATE
                                      , B1.SPRC_PRICE
                                   FROM  TB_DP_PROD_RSHP A1
                                        ,TB_DP_SPRC_PROD B1
                                   WHERE 1=1
                                     AND A1.PART_PROD_ID = B1.PROD_ID
                                     AND B1.EXPO_YN ='Y'
                                     AND B1.CPN_ID IS NOT NULL
                                     AND B1.SPRC_TYPE_CD IN ('DP007501','DP007502') --DP007501 : 일반특가 , DP007502 일반 배송 특가
                                     AND SYSDATE BETWEEN  B1.SPRC_APPLY_START_DT AND B1.SPRC_APPLY_END_DT 
                                  )N
                        WHERE 1=1
                        AND A.BRAND_ID = B.BRAND_ID
                        AND B.CATALOG_ID = C.CATALOG_ID
                        AND C.CATALOG_ID = D.CATALOG_ID     
                        AND D.MENU_ID = E.MENU_ID
                        AND D.MENU_ID = F.MENU_ID
                        AND B.CATALOG_ID = G.CATALOG_ID
                        AND G.PROD_ID = H.PROD_ID
                        AND H.PROD_ID <![CDATA[ <> ]]> H.PART_PROD_ID
                        AND H.PART_PROD_ID = I.PROD_ID
                        AND I.PROD_ID = J.PROD_ID
                        AND I.PROD_ID = K.PROD_ID
                        AND I.PROD_ID = L.PROD_ID
                        AND K.TENANT_ID = L.TENANT_ID 
                        <if test='req.orderedBy == "popular"'>
                        AND B.CATALOG_ID = M.PROD_ID(+)                             
                        </if>                        
                        AND I.PROD_ID = N.PROD_ID(+)  
                        AND H.PROD_RSHP_CD = #{prodRshpCd}    /*채널-에피소드 상품 관계*/ 
                        AND NVL(B.CHNL_CNT, 0) > 0          
                        AND C.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND F.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                        AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                        AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND NVL(I.B2B_PROD_YN, 'N') <![CDATA[ <> ]]> 'Y'
                        AND K.PROD_STATUS_CD = #{prodStatusCd}  /* PD000403 : 판매중 */
                        AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                        AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                        AND K.TENANT_ID = #{tenantHeader.tenantId}  /* INPUT 테넌트ID */
                        AND A.BRAND_ID = #{req.brandId}        /* INPUT 브랜드ID */
                        <if test="req.prodCharge != null">
                        AND J.PROD_CHRG_YN =#{req.prodCharge}
                        </if>
                        <if test="req.arrayProdGradeCd != null">
                        AND J.PROD_GRD_CD  IN
                                      <foreach collection="req.arrayProdGradeCd" item="req.prodGradeCd" separator="," open="(" close=")">
                                        #{req.prodGradeCd}
                                      </foreach>                        
                        </if>      
                        AND NOT EXISTS (
                             SELECT 'X'
                               FROM  TB_DP_PROD_RSHP A2
                                    ,TB_DP_SPRC_PROD B2
                                    ,TB_DP_PROD_CATALOG_MAPG C2
                               WHERE 1=1
                                 AND A2.PART_PROD_ID = B2.PROD_ID
                                 AND A2.PROD_ID = C2.PROD_ID
                                 AND C2.BASE_YN ='Y'
                                 AND C2.USE_YN ='Y'
                                 AND B2.EXPO_YN ='Y'
                                 AND B2.CPN_ID IS NOT NULL
                                 AND B2.SPRC_TYPE_CD IN ('DP007503','DP007504')
                                 AND C2.CATALOG_ID = B.CATALOG_ID
                                 AND SYSDATE BETWEEN  B2.SPRC_APPLY_START_DT AND B2.SPRC_APPLY_END_DT                 
                            )                         
                      
                   ) 
                 WHERE NO =1
               <if test='req.orderedBy == "recent"'>                 
               ORDER BY 
                      REG_DT DESC
                    , CATALOG_NM ASC
               </if>
               <if test='req.orderedBy == "lowprice"'>                 
               ORDER BY 
                      PROD_AMT ASC
                    , CATALOG_NM ASC
               </if>
               
               <if test='req.orderedBy == "popular"'>                 
               ORDER BY 
                      EXPO_ORD_ALWAYS_YN DESC
                    , EXPO_ORD   
                    , EXPO_ORD_SUB 
                    , CATALOG_NM ASC               
               </if>                     
               ) 
        ) WHERE RNUM BETWEEN #{req.offset} AND #{req.count}
    </select>     

 
    
    <!-- 특정 카탈로그에 대한 다른 상품 리스트 조회-->
    <select id="getCatagoryAnotherProductListV2" parameterType="Map" resultType="ProductBasicInfo">
      /* ShoppingMapper.xml.getCatagoryAnotherProductListV2,특정 카탈로그에 대한 다른 상품 리스트 조회, 김형식/SK플래닛  , 2014-12-04 */
        SELECT *
         FROM ( 
             SELECT 
                    rownum AS RNUM        
                   ,COUNT(CATALOG_ID) OVER() AS TOTALCOUNT      
                   ,CATALOG_ID AS catalogId
                   ,BRAND_ID AS brandId
                   ,MENU_ID AS menuId
                   ,TENANT_ID AS tenentId
                   ,PROD_ID as prodId
                   ,PART_PROD_ID as partProdId 
                   ,#{channelContentTypeCd} as contentsTypeCd
             FROM (
                  SELECT  * 
                   FROM (
                          SELECT /*+ LEADING(E F D C B A) USE_MERGE(M N) USE_NL(A B C D F G) INDEX(D (MENU_ID)) */ --ADDED BY 2014.10.14 
                                B.CATALOG_ID 
                               ,C.CATALOG_NM 
                               ,A.BRAND_ID  
                               ,D.MENU_ID  
                               ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC) as NO
                               ,K.TENANT_ID 
                               ,H.PROD_ID 
                               ,H.PART_PROD_ID
                               <if test='req.orderedBy == "recent"'>  
                               ,NVL((
                                    SELECT 
                                         MAX(SP.REG_DT)
                                    FROM 
                                         TB_DP_PROD_CATALOG_MAPG CM
                                        ,TB_DP_SHPG_PROD SP
                                    WHERE CM.CATALOG_ID =B.CATALOG_ID
                                      AND CM.PROD_ID = SP.PROD_ID
                                      AND CM.USE_YN ='Y'
                                      AND CM.BASE_YN ='Y'
                               ),I.REG_DT) AS REG_DT                                  
                               ,'1' EXPO_ORD
                               </if>
                               <if test='req.orderedBy == "popular"'>                 
                               ,NVL(M.EXPO_ORD_ALWAYS_YN,'A') AS EXPO_ORD_ALWAYS_YN
                               ,M.EXPO_ORD
                               ,M.EXPO_ORD_SUB    
                               </if>             
                               ,NVL(N.SPRC_PRICE, L.DC_AFT_PROD_AMT) PROD_AMT                                                                                                                                        
                          FROM 
                                  TB_DP_SHPG_BRAND A
                                 ,TB_DP_SHPG_CATALOG B
                                 ,TB_DP_SHPG_CATALOG_DESC C
                                 ,TB_DP_MENU_SHPG_MAPG D
                                 ,TB_DP_MENU_CATEGORY E
                                 ,TB_DP_MENU_CATEGORY_DESC F 
                                 ,TB_DP_PROD_CATALOG_MAPG G 
                                 ,TB_DP_PROD_RSHP H
                                 ,TB_DP_SHPG_PROD I
                                 ,TB_DP_PROD J
                                 ,TB_DP_TENANT_PROD K
                                 ,TB_DP_TENANT_PROD_PRICE L
                                 <if test='req.orderedBy == "popular"'>
                                ,(
                                    SELECT  /*+ NO_MERGE */ --ADDED BY 2014.10.14
                                            TDLP.TENANT_ID
                                          , TDLP.LIST_ID
                                          , TDLP.MENU_ID
                                          , TDLP.PROD_ID
                                          , TDLP.EXPO_ORD_ALWAYS_YN
                                          , TDLP.EXPO_ORD
                                          , TDLP.EXPO_ORD_SUB
                                          , TDLP.PRCHS_QTY  
                                          , TDLP.DWLD_QTY                                      
                                      FROM  
                                            TB_DP_LIST_PROD TDLP
                                           ,TB_DP_LIST TDL
                                     WHERE 1=1
                                       AND  TDLP.TENANT_ID = TDL.TENANT_ID
                                       AND  TDLP.LIST_ID   = TDL.LIST_ID
                                       AND  TDLP.TENANT_ID = #{tenantHeader.tenantId}   /* 테넌트ID */
                                       AND  TDLP.LIST_ID   = #{req.listId}     /* RNK000000101 쇼핑 카탈로그 인기 */
                                       AND  TDLP.EXPO_YN = 'Y'             /* Y : 노출 (노출여부) */
                                       AND  TDL.EXPO_YN  = 'Y'             /* Y : 노출 (노출여부) */
                                       AND  TDLP.STD_DT = TO_DATE(#{stdDt}, 'YYYYMMDDHH24MISS') 
                                       AND  SYSDATE BETWEEN TDLP.EXPO_START_DT AND TDLP.EXPO_END_DT                            
                                  ) M                                  
                                 </if>
                                 ,(SELECT /*+ NO_MEGRE */ --ADDED BY 2014.10.14
                                        B1.PROD_ID
                                      , B1.SPRC_DC_RATE
                                      , B1.SPRC_PRICE
                                   FROM  TB_DP_PROD_RSHP A1
                                        ,TB_DP_SPRC_PROD B1
                                   WHERE 1=1
                                     AND A1.PART_PROD_ID = B1.PROD_ID
                                     AND B1.EXPO_YN ='Y'
                                     AND B1.CPN_ID IS NOT NULL
                                     AND B1.SPRC_TYPE_CD IN ('DP007501','DP007502') --DP007501 : 일반특가 , DP007502 일반 배송 특가
                                     AND SYSDATE BETWEEN  B1.SPRC_APPLY_START_DT AND B1.SPRC_APPLY_END_DT 
                                  )N
                        WHERE 1=1
                        AND A.BRAND_ID = B.BRAND_ID
                        AND B.CATALOG_ID = C.CATALOG_ID
                        AND C.CATALOG_ID = D.CATALOG_ID     
                        AND D.MENU_ID = E.MENU_ID
                        AND D.MENU_ID = F.MENU_ID
                        AND D.MENU_ID = #{req.menuId}           /*INPUT 메뉴ID*/
                        AND B.CATALOG_ID = G.CATALOG_ID
                        <if test="req.exceptId != null">
                        AND C.CATALOG_ID <![CDATA[<>]]> #{req.exceptId}
                        </if> 
                        AND G.PROD_ID = H.PROD_ID
                        AND H.PROD_ID <![CDATA[ <> ]]> H.PART_PROD_ID
                        AND H.PART_PROD_ID = I.PROD_ID
                        AND I.PROD_ID = J.PROD_ID
                        AND I.PROD_ID = K.PROD_ID
                        AND I.PROD_ID = L.PROD_ID
                        AND K.TENANT_ID = L.TENANT_ID
                        <if test='req.orderedBy == "popular"'>
                        AND B.CATALOG_ID = M.PROD_ID(+)                             
                        </if>                   
                        AND I.PROD_ID = N.PROD_ID(+)       
                        AND H.PROD_RSHP_CD =#{prodRshpCd}    /*채널-에피소드 상품 관계*/   
                        AND NVL(B.CHNL_CNT, 0) > 0        
                        AND C.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND F.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                        AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                        AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND NVL(I.B2B_PROD_YN, 'N') <![CDATA[ <> ]]> 'Y'
                        AND K.PROD_STATUS_CD = #{prodStatusCd}  /* PD000403 : 판매중 */
                        AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                        AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                        AND K.TENANT_ID = #{tenantHeader.tenantId}       /* INPUT 테넌트ID */
                        <if test="req.prodCharge != null">
                        AND J.PROD_CHRG_YN =#{req.prodCharge}
                        </if>
                        <if test="req.arrayProdGradeCd != null">
                        AND J.PROD_GRD_CD  IN
                                      <foreach collection="req.arrayProdGradeCd" item="req.prodGradeCd" separator="," open="(" close=")">
                                        #{req.prodGradeCd}
                                      </foreach>                        
                        </if>      
                        AND NOT EXISTS (
                             SELECT 'X'
                               FROM  TB_DP_PROD_RSHP A2
                                    ,TB_DP_SPRC_PROD B2
                                    ,TB_DP_PROD_CATALOG_MAPG C2
                               WHERE 1=1
                                 AND A2.PART_PROD_ID = B2.PROD_ID
                                 AND A2.PROD_ID = C2.PROD_ID
                                 AND C2.BASE_YN ='Y'
                                 AND C2.USE_YN ='Y'
                                 AND B2.EXPO_YN ='Y'
                                 AND B2.CPN_ID IS NOT NULL
                                 AND B2.SPRC_TYPE_CD IN ('DP007503','DP007504')
                                 AND C2.CATALOG_ID = B.CATALOG_ID
                                 AND SYSDATE BETWEEN  B2.SPRC_APPLY_START_DT AND B2.SPRC_APPLY_END_DT                 
                            )                         
                      
                   ) 
                 WHERE NO =1
               <if test='req.orderedBy == "recent"'>                 
               ORDER BY 
                      REG_DT DESC
                    , CATALOG_NM ASC
               </if>
               <if test='req.orderedBy == "lowprice"'>                 
               ORDER BY 
                      PROD_AMT ASC
                    , CATALOG_NM ASC
               </if>               
               <if test='req.orderedBy == "popular"'>                 
               ORDER BY 
                      EXPO_ORD_ALWAYS_YN DESC
                    , EXPO_ORD   
                    , EXPO_ORD_SUB 
                    , CATALOG_NM ASC                   
               </if>                   
               )
        ) WHERE RNUM BETWEEN #{req.offset} AND #{req.count}
    </select>        
     
   <!-- 특정 브랜드에 대한 다른 상품 리스트 조회-->
    <select id="getBrandAnotherProductListV2" parameterType="Map" resultType="ProductBasicInfo">
       /* ShoppingMapper.xml.getBrandAnotherProductListV2,특정 브랜드에 대한 다른 상품 리스트, 김형식/SK플래닛  , 2014-12-04 */
        SELECT *
         FROM ( 
             SELECT 
                    rownum AS RNUM        
                   ,COUNT(CATALOG_ID) OVER() AS TOTALCOUNT      
                   ,CATALOG_ID AS catalogId
                   ,BRAND_ID AS brandId
                   ,MENU_ID AS menuId
                   ,TENANT_ID AS tenentId
                   ,PROD_ID as prodId
                   ,PART_PROD_ID as partProdId 
                   ,#{channelContentTypeCd} as contentsTypeCd
             FROM (
                  SELECT  * 
                   FROM (
                          SELECT 
                                B.CATALOG_ID 
                               ,C.CATALOG_NM 
                               ,A.BRAND_ID  
                               ,D.MENU_ID  
                               ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC) as NO
                               ,K.TENANT_ID 
                               ,H.PROD_ID 
                               ,H.PART_PROD_ID  
                               <if test='req.orderedBy == "recent"'>    
                               ,NVL((
                                    SELECT 
                                         MAX(SP.REG_DT)
                                    FROM 
                                         TB_DP_PROD_CATALOG_MAPG CM
                                        ,TB_DP_SHPG_PROD SP
                                    WHERE CM.CATALOG_ID =B.CATALOG_ID
                                      AND CM.PROD_ID = SP.PROD_ID
                                      AND CM.USE_YN ='Y'
                                      AND CM.BASE_YN ='Y'
                               ),I.REG_DT) AS REG_DT                                  
                               ,'1' EXPO_ORD
                               </if>
                               <if test='req.orderedBy == "popular"'>                 
                               ,NVL(M.EXPO_ORD_ALWAYS_YN,'A') AS EXPO_ORD_ALWAYS_YN
                               ,M.EXPO_ORD
                               ,M.EXPO_ORD_SUB     
                               </if>              
                               ,NVL(N.SPRC_PRICE, L.DC_AFT_PROD_AMT) PROD_AMT                                                                                                                                
                          FROM 
                                  TB_DP_SHPG_BRAND A
                                 ,TB_DP_SHPG_CATALOG B
                                 ,TB_DP_SHPG_CATALOG_DESC C
                                 ,TB_DP_MENU_SHPG_MAPG D
                                 ,TB_DP_MENU_CATEGORY E
                                 ,TB_DP_MENU_CATEGORY_DESC F 
                                 ,TB_DP_PROD_CATALOG_MAPG G 
                                 ,TB_DP_PROD_RSHP H
                                 ,TB_DP_SHPG_PROD I
                                 ,TB_DP_PROD J
                                 ,TB_DP_TENANT_PROD K
                                 ,TB_DP_TENANT_PROD_PRICE L

                                 <if test='req.orderedBy == "popular"'>
                                ,(
                                    SELECT  TDLP.TENANT_ID
                                          , TDLP.LIST_ID
                                          , TDLP.MENU_ID
                                          , TDLP.PROD_ID
                                          , TDLP.EXPO_ORD_ALWAYS_YN
                                          , TDLP.EXPO_ORD
                                          , TDLP.EXPO_ORD_SUB
                                          , TDLP.PRCHS_QTY  
                                          , TDLP.DWLD_QTY                                      
                                      FROM  
                                            TB_DP_LIST_PROD TDLP
                                           ,TB_DP_LIST TDL
                                     WHERE 1=1
                                       AND  TDLP.TENANT_ID = TDL.TENANT_ID
                                       AND  TDLP.LIST_ID   = TDL.LIST_ID
                                       AND  TDLP.TENANT_ID = #{tenantHeader.tenantId}   /* 테넌트ID */
                                       AND  TDLP.LIST_ID   = #{req.listId}     /* RNK000000101 쇼핑 카탈로그 인기 */
                                       AND  TDLP.EXPO_YN = 'Y'             /* Y : 노출 (노출여부) */
                                       AND  TDL.EXPO_YN  = 'Y'             /* Y : 노출 (노출여부) */
                                       AND  TDLP.STD_DT = TO_DATE(#{stdDt}, 'YYYYMMDDHH24MISS') 
                                       AND  SYSDATE BETWEEN TDLP.EXPO_START_DT AND TDLP.EXPO_END_DT                            
                                  ) M                                  
                                 </if>
                                 ,(SELECT /*+ ORDERED */
                                        B1.PROD_ID
                                      , B1.SPRC_DC_RATE
                                      , B1.SPRC_PRICE
                                   FROM  TB_DP_PROD_RSHP A1
                                        ,TB_DP_SPRC_PROD B1
                                   WHERE 1=1
                                     AND A1.PART_PROD_ID = B1.PROD_ID
                                     AND B1.EXPO_YN ='Y'
                                     AND B1.CPN_ID IS NOT NULL
                                     AND B1.SPRC_TYPE_CD IN ('DP007501','DP007502') --DP007501 : 일반특가 , DP007502 일반 배송 특가
                                     AND SYSDATE BETWEEN  B1.SPRC_APPLY_START_DT AND B1.SPRC_APPLY_END_DT 
                                  )N
                        WHERE 1=1
                        AND A.BRAND_ID = B.BRAND_ID
                        AND B.CATALOG_ID = C.CATALOG_ID
                        AND C.CATALOG_ID = D.CATALOG_ID     
                        AND D.MENU_ID = E.MENU_ID
                        AND D.MENU_ID = F.MENU_ID
                        AND A.BRAND_ID = #{req.brandId}           /*INPUT 브랜드ID*/
                        AND B.CATALOG_ID = G.CATALOG_ID
                        <if test="req.exceptId != null">
                        AND C.CATALOG_ID <![CDATA[<>]]> #{req.exceptId}  /*INPUT 제외상품ID*/
                        </if>
                        AND G.PROD_ID = H.PROD_ID
                        AND H.PROD_ID <![CDATA[ <> ]]> H.PART_PROD_ID
                        AND H.PART_PROD_ID = I.PROD_ID
                        AND I.PROD_ID = J.PROD_ID
                        AND I.PROD_ID = K.PROD_ID
                        AND I.PROD_ID = L.PROD_ID
                        AND K.TENANT_ID = L.TENANT_ID
                        <if test='req.orderedBy == "popular"'>
                        AND B.CATALOG_ID = M.PROD_ID(+)                             
                        </if>                   
                        AND I.PROD_ID = N.PROD_ID(+)       
                        AND H.PROD_RSHP_CD =#{prodRshpCd}    /*채널-에피소드 상품 관계*/   
                        AND NVL(B.CHNL_CNT, 0) > 0        
                        AND C.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND F.LANG_CD= #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                        AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                        AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND NVL(I.B2B_PROD_YN, 'N') <![CDATA[ <> ]]> 'Y'
                        AND K.PROD_STATUS_CD = #{prodStatusCd}  /* PD000403 : 판매중 */
                        AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                        AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                        AND K.TENANT_ID = #{tenantHeader.tenantId}       /* INPUT 테넌트ID */
                        <if test="req.prodCharge != null">
                        AND J.PROD_CHRG_YN =#{req.prodCharge}
                        </if>
                        <if test="req.arrayProdGradeCd != null">
                        AND J.PROD_GRD_CD  IN
                                      <foreach collection="req.arrayProdGradeCd" item="req.prodGradeCd" separator="," open="(" close=")">
                                        #{req.prodGradeCd}
                                      </foreach>                        
                        </if>      
                        AND NOT EXISTS (
                             SELECT 'X'
                               FROM  TB_DP_PROD_RSHP A2
                                    ,TB_DP_SPRC_PROD B2
                                    ,TB_DP_PROD_CATALOG_MAPG C2
                               WHERE 1=1
                                 AND A2.PART_PROD_ID = B2.PROD_ID
                                 AND A2.PROD_ID = C2.PROD_ID
                                 AND C2.BASE_YN ='Y'
                                 AND C2.USE_YN ='Y'
                                 AND B2.EXPO_YN ='Y'
                                 AND B2.CPN_ID IS NOT NULL
                                 AND B2.SPRC_TYPE_CD IN ('DP007503','DP007504')
                                 AND C2.CATALOG_ID = B.CATALOG_ID
                                 AND SYSDATE BETWEEN  B2.SPRC_APPLY_START_DT AND B2.SPRC_APPLY_END_DT                 
                            )                         
                      
                   ) 
                 WHERE NO =1
               <if test='req.orderedBy == "recent"'>                 
               ORDER BY 
                      REG_DT DESC
                    , CATALOG_NM ASC
               </if>
               <if test='req.orderedBy == "lowprice"'>                 
               ORDER BY 
                      PROD_AMT ASC
                    , CATALOG_NM ASC
               </if>               
               <if test='req.orderedBy == "popular"'>                 
               ORDER BY 
                      EXPO_ORD_ALWAYS_YN DESC
                    , EXPO_ORD   
                    , EXPO_ORD_SUB 
                    , CATALOG_NM ASC                 
               </if>                   
               )
        ) WHERE RNUM BETWEEN #{req.offset} AND #{req.count}

    </select>         

    <!-- 쇼핑상세(채널) 조회-->
    <select id="getShoppingChannelDetailV2" parameterType="Map" resultType="MetaInfo">
     /* ShoppingMapper.xml.getShoppingChannelDetailV2,쇼핑상세(채널) 조회, 김형식/SK플래닛  , 2014-02-04 */
          SELECT  * 
           FROM (
                  SELECT 
                         B.CATALOG_ID 
                         <if test="(req.specialProdId == null and req.type == 'catalog') or req.type == 'episode' ">
                        ,C.CATALOG_NM 
                        </if>
                        <if test="req.specialProdId != null and req.type == 'catalog'">
                        ,O.PROD_NM  as catalogNm
                        </if>
                        ,H.PROD_ID 
                        ,H.PART_PROD_ID                          
                        ,C.CATALOG_DESC as prodBaseDesc
                        ,A.BRAND_ID  
                        ,A.BRAND_NM  
                        ,D.MENU_ID   
                        ,F.MENU_NM 
                        ,J.TOP_MENU_ID 
                        ,(SELECT MENU_NM
                            FROM TB_DP_MENU_CATEGORY_DESC
                           WHERE MENU_ID = J.TOP_MENU_ID
                             AND LANG_CD = #{lang}
                             AND ROWNUM = 1
                         ) AS TOP_MENU_NM 
                        ,F.MENU_DESC                                   
                        ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID ORDER BY L.PROD_AMT ASC , ROUND(DBMS_RANDOM.VALUE(1, 100), 0)) as NO
                        ,CASE WHEN NVL(M.PRCHS_CNT, 0) <![CDATA[ < ]]> 0 THEN 0 ELSE NVL(M.PRCHS_CNT, 0) END AS PRCHS_CNT 
                         <if test="req.specialTypeCd == 'DP007501' or req.specialTypeCd == 'DP007502'">
                        ,(CASE WHEN I.PROD_CASE_CD='DP006301' THEN 'giftcard' 
                               WHEN I.PROD_CASE_CD='DP006302' THEN 'exchange' 
                               WHEN I.PROD_CASE_CD='DP006303' THEN 'delivery' 
                          END) AS PROD_CASE_CD  
                          </if>
                         <if test="req.specialTypeCd == 'DP007503' or req.specialTypeCd == 'DP007504'">
                        ,(CASE WHEN I.PROD_CASE_CD='DP006301' THEN 'tingGiftcard' 
                               WHEN I.PROD_CASE_CD='DP006302' THEN 'tingExchange' 
                               WHEN I.PROD_CASE_CD='DP006303' THEN 'tingDelivery' 
                          END) AS PROD_CASE_CD  
                          </if>
                        ,CONCAT(PI.FILE_PATH,PI.FILE_NM) as FILE_PATH
                        ,J.CONTENTS_TYPE_CD 
                        ,(SELECT SRC_CONTENT_ID 
                            FROM TB_DP_SHPG_PROD 
                           WHERE prod_id=H.PROD_ID 
                         ) AS SRC_CONTENT_ID
                        ,K.PROD_STATUS_CD
                        ,C.CATALOG_DTL_DESC AS prodDtlDesc
                        <if test="req.userKey != null">  
                        ,(CASE WHEN ML.STATS_KEY IS NOT NULL THEN 'Y' ELSE 'N' END) AS likeYn
                        </if> 
                  FROM 
                          TB_DP_SHPG_BRAND A
                         ,TB_DP_SHPG_CATALOG B
                         ,TB_DP_SHPG_CATALOG_DESC C
                         ,TB_DP_MENU_SHPG_MAPG D
                         ,TB_DP_MENU_CATEGORY E
                         ,TB_DP_MENU_CATEGORY_DESC F 
                         ,TB_DP_PROD_CATALOG_MAPG G 
                         ,TB_DP_PROD_RSHP H
                         ,TB_DP_SHPG_PROD I
                         ,TB_DP_PROD J
                         ,TB_DP_TENANT_PROD K
                         ,TB_DP_TENANT_PROD_PRICE L
                         ,TB_DP_PROD_IMG    PI
                         ,TB_DP_PROD_DESC O
                         ,(SELECT  PROD_ID
                                  ,PRCHS_CNT
                             FROM TB_DP_TENANT_PROD_STATS 
                            WHERE TENANT_ID = #{tenantHeader.tenantId}    /* INPUT 테넌트ID */
                           ) M
                         <if test="req.userKey != null">
                         ,TB_DP_SOCIAL_STATS_MBR_LIKE ML
                         </if>
                WHERE 1=1
                AND A.BRAND_ID = B.BRAND_ID
                AND B.CATALOG_ID = C.CATALOG_ID
                AND C.CATALOG_ID = D.CATALOG_ID     
                AND D.MENU_ID = E.MENU_ID
                AND D.MENU_ID = F.MENU_ID
                AND B.CATALOG_ID = G.CATALOG_ID
                AND G.PROD_ID = H.PROD_ID
                AND H.PROD_ID <![CDATA[ <> ]]> H.PART_PROD_ID
                AND H.PART_PROD_ID = I.PROD_ID
                AND I.PROD_ID = J.PROD_ID
                AND I.PROD_ID = K.PROD_ID
                AND I.PROD_ID = L.PROD_ID
                AND I.PROD_ID = O.PROD_ID
                AND K.TENANT_ID = L.TENANT_ID
                AND C.CATALOG_ID = PI.PROD_ID
                AND PI.IMG_CD = #{imageCd}          
                AND C.CATALOG_ID = M.PROD_ID(+)
                <if test="req.userKey != null">   
                AND #{tenantHeader.tenantId} = ML.TENANT_ID(+)
                AND #{req.userKey} = ML.USER_KEY(+)
                AND 'DP01210002' = ML.STATS_CLSF(+)
                AND C.CATALOG_ID = ML.STATS_KEY(+)
                </if>
                AND H.PROD_RSHP_CD =#{prodRshpCd}    /*채널-에피소드 상품 관계*/ 
                <if test="req.includeProdStopStatus != null ">
                AND NVL(B.CHNL_CNT, 0) <![CDATA[> ]]> 0
                AND K.PROD_STATUS_CD = 'PD000403'  /* PD000403 : 판매중 */       
                </if>                 
                AND C.LANG_CD= #{lang}          /* ko : 한국어 */
                AND F.LANG_CD= #{lang}          /* ko : 한국어 */
                AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                <if test="req.saleDtUseYn == null">
                AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                </if>
                AND K.TENANT_ID = #{tenantHeader.tenantId}        /* INPUT 테넌트ID */
                AND B.CATALOG_ID = #{req.productId}
                <if test="req.specialProdId != null and req.specialType=='episode'">
                AND I.PROD_ID = #{req.specialProdId}
                </if>
                <if test="req.specialProdId != null and req.specialType=='channel'">
                AND H.PROD_ID = #{req.specialProdId}
                </if>                
           ) 
           WHERE NO =1
    </select>    
   <!-- 쇼핑상세(에피소드) 조회-->
    <select id="getShoppingEpisodeDetailV2" parameterType="Map" resultType="MetaInfo">
     /* ShoppingMapper.xml.getShoppingEpisodeDetailV2,쇼핑상세(에피소드) 조회, 김형식/SK플래닛  , 2014-02-04 */
     SELECT * FROM (
         SELECT 
                PP.* 
                <if test="endRow != null">
                ,ROW_NUMBER() OVER(PARTITION BY PROD_ID ORDER BY SOLDOUT ASC) AS NO1
                </if>
          FROM (     
                  SELECT  
                        KK.*
                       ,(CASE WHEN KK.SPECIAL_SALE_YN ='Y' THEN 
                                 ( CASE WHEN ( ( KK.MTH_PRCHS_CNT >= KK.MTH_MAX_CNT ) OR
                                               ( KK.DLY_PRCHS_CNT >= KK.DLY_MAX_CNT )
                                               OR 
                                               ( KK.SOLD_OUT_YN ='Y' )                                         
                                             ) 
                                    THEN 'Y'
                                    ELSE  'N' END 
                                  )
                        ELSE 'N'
                        END ) AS soldOut         
                       ,KK.SPECIAL_SALE_YN AS specialSale
                       ,TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') AS SYS_DATE
                   FROM (
                          SELECT 
                                 D.MENU_ID
                                ,J.TOP_MENU_ID 
                                ,H.PROD_ID                         
                                ,H.PART_PROD_ID 
                                ,J.SELLER_MBR_NO 
                                ,NVL(L.PROD_NET_AMT, 0) AS PROD_NET_AMT 
                                ,NVL(N.SPRC_PRICE, NVL(L.DC_AFT_PROD_AMT, 0)) AS PROD_AMT
                                ,NVL(N.SPRC_DC_RATE, NVL(L.DC_RATE,0)) AS DC_RATE
                                ,NVL(N.SPRC_DC_PRICE, NVL(L.DC_AMT, 0)) AS DC_AMT
                                ,NVL(L.PROD_AMT, 0) AS orgDiscountPrice                        
                                ,J.PROD_GRD_CD
                                ,J.USE_PERIOD_UNIT_CD
                                ,J.USE_PERIOD
                                 <if test="req.specialTypeCd == 'DP007501' or req.specialTypeCd == 'DP007502'">
                                ,(CASE WHEN I.PROD_CASE_CD='DP006301' THEN 'giftcard' 
                                       WHEN I.PROD_CASE_CD='DP006302' THEN 'exchange' 
                                       WHEN I.PROD_CASE_CD='DP006303' THEN 'delivery' 
                                  END) AS PROD_CASE_CD  
                                  </if>
                                 <if test="req.specialTypeCd == 'DP007503' or req.specialTypeCd == 'DP007504'">
                                ,(CASE WHEN I.PROD_CASE_CD='DP006301' THEN 'tingGiftcard' 
                                       WHEN I.PROD_CASE_CD='DP006302' THEN 'tingExchange' 
                                       WHEN I.PROD_CASE_CD='DP006303' THEN 'tingDelivery' 
                                  END) AS PROD_CASE_CD  
                                  </if>
                                ,TO_CHAR(NVL( N.SPRC_APPLY_START_DT, L.APPLY_START_DT),'YYYYMMDDHH24MISS') AS APPLY_START_DT
                                ,TO_CHAR(NVL( N.SPRC_APPLY_END_DT , L.APPLY_END_DT ),'YYYYMMDDHH24MISS') AS APPLY_END_DT      
                                ,I.SALE_CNT 
                                ,NVL(N.MM_PROD_MAX_SALE_QTY, I.MM_MAX_SALE_QTY ) AS MTH_MAX_CNT     /* 월_최대_판매_수량 */
                                ,NVL(N.DLY_PROD_MAX_SALE_QTY, I.DAY_MAX_SALE_QTY ) AS DLY_MAX_CNT   /* 일_최대_판매_수량 */
                                ,NVL(N.PERMAN_MM_MAX_PRCHS_QTY, I.MM_MBR_MAX_PRCHS_QTY ) AS MTH_USR_MAX_CNT /* 월_회원_최대_구매_수량 */
                                ,NVL(N.PERMAN_DAY_MAX_PRCHS_QTY, I.DAY_MBR_MAX_PRCHS_QTY ) AS DLY_USR_MAX_CNT /* 일_회원_최대_구매_수량 */
                                ,NVL(N.ONCE_MAX_PRCHS_POSB_CNT, I.FIRST_MAX_PRCHS_QTY ) AS EACH_MAX_CNT  /* 1차_최대_구매_수량 */                                        
                                ,I.USE_PLAC                     /* 사용_장소 */
                                ,I.USE_LIMT_DESC                /* 사용_제한_설명 */
                                ,I.NOTICE_MATT                  /* 공지_사항 */
                                ,I.PRCHS_CANCEL_DRBK_REASON     /* 구매_취소_환불_사유 */
                                ,I.B2B_PROD_YN                  /* B2B_상품_여부 */
                                ,I.DLV_PROD_YN                  /* 배송_상품_여부 */
                                ,CASE WHEN N.PROD_ID IS NOT NULL AND N.SPRC_TYPE_CD IN ('DP007501','DP007502') THEN 'Y' ELSE 'N'END AS SPECIAL_SALE_YN
                                ,CASE WHEN N.PROD_ID IS NOT NULL THEN N.CPN_ID ELSE '' END AS SPECIAL_COUPON_ID
                                <if test="req.userKey != null">                        
                                ,(SELECT ( CASE WHEN COUNT( PD.NOTI_SEQ )=0 THEN 'feedback' END )
                                    FROM TB_DP_PROD_NOTI PD
                                   WHERE PD.PROD_ID = H.PART_PROD_ID
                                 
                                     AND PD.MBR_NO = #{req.userKey}
                                 
                                     AND PD.NOTI_TYPE_CD = 'DP000401'
                                     AND PD.DEL_YN = 'N'                            
                                     AND PD.TENANT_ID = #{tenantHeader.tenantId}        /* INPUT 테넌트ID */
                                 )AS ALLOW
                                 </if>
                                ,NVL( ( SELECT SUM( TSPP.PRCHS_CNT )
                                         FROM TB_DP_SPRC_PROD_PRCHS_MANG TSPP
                                        WHERE TO_CHAR(TSPP.PRCHS_DT,'YYYYMMDD') BETWEEN CONCAT( TO_CHAR( SYSDATE, 'YYYYMM' ), '01' )
                                                                AND TO_CHAR( LAST_DAY( SYSDATE ),'YYYYMMDD')
                                          AND TSPP.PROD_ID = H.PART_PROD_ID )
                                   , 0 ) AS MTH_PRCHS_CNT
                                ,NVL( ( SELECT TSPP.PRCHS_CNT
                                         FROM TB_DP_SPRC_PROD_PRCHS_MANG TSPP
                                        WHERE TO_CHAR(TSPP.PRCHS_DT,'YYYYMMDD') = TO_CHAR( SYSDATE, 'YYYYMMDD' )
                                          AND TSPP.PROD_ID = H.PART_PROD_ID )
                                   , 0 ) AS DLY_PRCHS_CNT           
                                ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID 
                                                   ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC 
                                                  ,DECODE(I.PROD_CASE_CD ,'DP006303'
                                                            ,(SELECT 1 FROM TB_DP_TENANT_PROD WHERE TENANT_ID =#{tenantHeader.tenantId} AND PROD_ID = H.PART_PROD_ID AND PROD_STATUS_CD='PD000403')
                                                            ,ROUND(DBMS_RANDOM.VALUE(1, 100), 0)
                                                          )
                                                   ) as NO 
                                ,(SELECT SRC_CONTENT_ID 
                                    FROM TB_DP_SHPG_PROD 
                                   WHERE prod_id=H.PROD_ID 
                                 ) AS couponCode                        
                                ,I.SRC_CONTENT_ID AS itemCode
                                ,(CASE WHEN (SELECT EPSD_CNT FROM TB_DP_SHPG_PROD WHERE PROD_ID = H.PROD_ID)>0 
                                        THEN (SELECT PROD_STATUS_CD FROM TB_DP_TENANT_PROD WHERE TENANT_ID=#{tenantHeader.tenantId} AND PROD_ID=H.PROD_ID) 
                                  ELSE 'PD000404' END
                                  ) PROD_STATUS_CD
                                ,O.PROD_NM as catalogNm
                                ,I.COUPON_SEND_TYPE 
                                ,N.SOLD_OUT_YN 
                          FROM 
                                  TB_DP_SHPG_BRAND A
                                 ,TB_DP_SHPG_CATALOG B
                                 ,TB_DP_SHPG_CATALOG_DESC C
                                 ,TB_DP_MENU_SHPG_MAPG D
                                 ,TB_DP_MENU_CATEGORY E
                                 ,TB_DP_MENU_CATEGORY_DESC F 
                                 ,TB_DP_PROD_CATALOG_MAPG G 
                                 ,TB_DP_PROD_RSHP H
                                 ,TB_DP_SHPG_PROD I
                                 ,TB_DP_PROD J
                                 ,TB_DP_TENANT_PROD K
                                 ,TB_DP_TENANT_PROD_PRICE L
                                 ,TB_DP_PROD_DESC O
                                 ,(SELECT /*+ ORDERED */
                                         B1.PROD_ID
                                       , B1.SPRC_DC_RATE
                                       , B1.SPRC_PRICE
                                       , B1.SPRC_DC_PRICE
                                       , B1.SPRC_APPLY_START_DT
                                       , B1.SPRC_APPLY_END_DT
                                       , B1.MM_PROD_MAX_SALE_QTY
                                       , B1.DLY_PROD_MAX_SALE_QTY   
                                       , B1.PERMAN_MM_MAX_PRCHS_QTY
                                       , B1.PERMAN_DAY_MAX_PRCHS_QTY
                                       , B1.ONCE_MAX_PRCHS_POSB_CNT  
                                       , B1.CPN_ID   
                                       , B1.SPRC_TYPE_CD 
                                       , B1.SOLD_OUT_YN                               
                                   FROM  TB_DP_PROD_RSHP A1
                                        ,TB_DP_SPRC_PROD B1
                                   WHERE 1=1
                                     AND A1.PART_PROD_ID = B1.PROD_ID
                                    <if test="req.specialProdId != null and req.specialType=='episode'">
                                     AND B1.PROD_ID  = #{req.specialProdId}
                                    </if>
                                    <if test="req.specialProdId != null and req.specialType=='channel'">
                                     AND A1.PROD_ID = #{req.specialProdId}
                                    </if>                                
                                     AND B1.EXPO_YN ='Y'
                                     AND B1.CPN_ID IS NOT NULL
                                     <if test="req.specialTypeCd != null">
                                     AND B1.SPRC_TYPE_CD = #{req.specialTypeCd}
                                     </if>
                                     AND SYSDATE BETWEEN  B1.SPRC_APPLY_START_DT AND B1.SPRC_APPLY_END_DT 
                                  )N
                        WHERE 1=1
                        AND A.BRAND_ID = B.BRAND_ID
                        AND B.CATALOG_ID = C.CATALOG_ID
                        AND C.CATALOG_ID = D.CATALOG_ID     
                        AND D.MENU_ID = E.MENU_ID
                        AND D.MENU_ID = F.MENU_ID
                        AND B.CATALOG_ID = G.CATALOG_ID
                        AND G.PROD_ID = H.PROD_ID
                        AND H.PROD_ID <![CDATA[ <> ]]> H.PART_PROD_ID
                        AND H.PART_PROD_ID = I.PROD_ID
                        AND I.PROD_ID = J.PROD_ID
                        AND I.PROD_ID = K.PROD_ID
                        AND I.PROD_ID = L.PROD_ID
                        AND I.PROD_ID = O.PROD_ID
                        AND K.TENANT_ID = L.TENANT_ID
                        AND I.PROD_ID = N.PROD_ID(+)
                        AND H.PROD_RSHP_CD =#{prodRshpCd}    /*채널-에피소드 상품 관계*/ 
                        <if test="req.includeProdStopStatus != null ">
                        AND NVL(B.CHNL_CNT, 0) <![CDATA[> ]]> 0
                        AND K.PROD_STATUS_CD = 'PD000403'  /* PD000403 : 판매중 */       
                        </if>                         
                        AND C.LANG_CD= #{lang}          /* ko : 한국어 */
                        AND F.LANG_CD= #{lang}          /* ko : 한국어 */
                        AND O.LANG_CD= #{lang}          /* ko : 한국어 */
                        AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                        AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                        AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                        <if test="req.saleDtUseYn == null">
                        AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                        </if>
                        AND K.TENANT_ID = #{tenantHeader.tenantId}        /* INPUT 테넌트ID */
                        AND B.CATALOG_ID = #{req.productId}
                        <if test="req.specialProdId != null and req.specialType=='episode'">
                        AND I.PROD_ID = #{req.specialProdId}
                        </if>
                        <if test="req.specialProdId != null and req.specialType=='channel'">
                        AND H.PROD_ID = #{req.specialProdId}
                        </if>   
                             
                   ) KK
                )PP
           )
           <if test="endRow != null">
           WHERE DECODE(SPECIALSALE,'Y',NO1,NO) <![CDATA[ <= ]]> #{endRow}   <!-- 배송상품 단품건으로 처리 -->
           </if>
    </select>   
    
   <!-- 쇼핑상세(옵션) 조회-->
    <select id="getShoppingOptionV2" parameterType="Map" resultType="MetaInfo">
     /* ShoppingMapper.xml.getShoppingOptionV2,쇼핑상세(옵션) 조회, 김형식/SK플래닛  , 2014-02-04 */
        SELECT 
                KK.*
               ,(CASE WHEN KK.SPECIAL_SALE_YN ='Y' THEN 
                         ( CASE WHEN ( ( KK.MTH_PRCHS_CNT >= KK.MTH_MAX_CNT ) OR
                                       ( KK.DLY_PRCHS_CNT >= KK.DLY_MAX_CNT )
                                       OR 
                                       ( KK.SOLD_OUT_YN ='Y' )                                         
                                     ) 
                            THEN 'Y'
                            ELSE 'N' END 
                          )
                ELSE 'N'
                END ) AS soldOut               
        FROM (     
                 SELECT 
                        A.CHNL_PROD_ID AS prodId
                       ,A.EPSD_PROD_ID AS partProdId
                       ,A.OPT1_NM as prodNm
                       ,A.EXPO_ORD as expoOrd
                       ,(CASE WHEN  A.EXPO_ORD = 1 THEN A.OPT1_NM ELSE A.OPT2_NM END) AS optPdNm
                       ,(CASE WHEN  A.EXPO_ORD = 1 THEN 'Y' ELSE 'N' END) AS subYn
                       ,C.CONTENTS_TYPE_CD AS contentTypeCd  
                       ,NVL(N.SPRC_DC_RATE, NVL(D.DC_RATE,0)) AS DC_RATE
                       ,NVL(N.SPRC_PRICE, NVL(D.PROD_AMT, 0)) AS PROD_AMT 
                       ,NVL(N.SPRC_DC_PRICE, NVL(D.DC_AMT, 0)) AS DC_AMT                        
                       ,D.PROD_NET_AMT
                       ,NVL(D.PROD_AMT, 0) AS orgDiscountPrice
                       ,D.DC_AFT_PROD_AMT
                       ,B.FIRST_MAX_PRCHS_QTY 
                       ,(CASE WHEN  C.CONTENTS_TYPE_CD = 'PD002502' THEN E.PROD_STATUS_CD ELSE '' END) AS PROD_STATUS_CD
                       ,(CASE WHEN  C.CONTENTS_TYPE_CD = 'PD002502' THEN B.SRC_CONTENT_ID ELSE '' END) AS itemCode
                       ,B.SALE_CNT 
                       ,NVL(N.MM_PROD_MAX_SALE_QTY, B.MM_MAX_SALE_QTY ) AS MTH_MAX_CNT     /* 월_최대_판매_수량 */
                       ,NVL(N.DLY_PROD_MAX_SALE_QTY, B.DAY_MAX_SALE_QTY ) AS DLY_MAX_CNT   /* 일_최대_판매_수량 */
                       ,NVL(N.PERMAN_MM_MAX_PRCHS_QTY, B.MM_MBR_MAX_PRCHS_QTY ) AS MTH_USR_MAX_CNT /* 월_회원_최대_구매_수량 */
                       ,NVL(N.PERMAN_DAY_MAX_PRCHS_QTY, B.DAY_MBR_MAX_PRCHS_QTY ) AS DLY_USR_MAX_CNT /* 일_회원_최대_구매_수량 */
                       ,NVL(N.ONCE_MAX_PRCHS_POSB_CNT, B.FIRST_MAX_PRCHS_QTY ) AS EACH_MAX_CNT  /* 1차_최대_구매_수량 */
                       ,NVL( ( SELECT SUM( TSPP.PRCHS_CNT )
                                FROM TB_DP_SPRC_PROD_PRCHS_MANG TSPP
                                WHERE TO_CHAR(TSPP.PRCHS_DT,'YYYYMMDD') BETWEEN CONCAT( TO_CHAR( SYSDATE, 'YYYYMM' ), '01' )
                                                        AND TO_CHAR( LAST_DAY( SYSDATE ),'YYYYMMDD')
                                  AND TSPP.PROD_ID = A.EPSD_PROD_ID )
                           , 0 ) AS MTH_PRCHS_CNT
                       ,NVL( ( SELECT TSPP.PRCHS_CNT
                                 FROM TB_DP_SPRC_PROD_PRCHS_MANG TSPP
                                WHERE TO_CHAR(TSPP.PRCHS_DT,'YYYYMMDD') = TO_CHAR( SYSDATE, 'YYYYMMDD' )
                                  AND TSPP.PROD_ID = A.EPSD_PROD_ID )
                          , 0 ) AS DLY_PRCHS_CNT         
                       ,N.SOLD_OUT_YN
                       ,CASE WHEN N.PROD_ID IS NOT NULL THEN N.CPN_ID ELSE '' END AS SPECIAL_COUPON_ID                                         
                       ,CASE WHEN N.PROD_ID IS NOT NULL THEN 'Y' ELSE '' END AS SPECIAL_SALE_YN                    
                FROM  TB_DP_PROD_OPT A
                     ,TB_DP_SHPG_PROD B 
                     ,TB_DP_PROD C
                     ,TB_DP_TENANT_PROD_PRICE D
                     ,TB_DP_TENANT_PROD E
                     ,(SELECT * 
                         FROM TB_DP_SPRC_PROD
                        WHERE EXPO_YN = 'Y'
                          AND CPN_ID IS NOT NULL
                          AND SYSDATE BETWEEN SPRC_APPLY_START_DT AND SPRC_APPLY_END_DT    
                        <if test="req.specialTypeCd != null">
                          AND SPRC_TYPE_CD = #{req.specialTypeCd}
                        </if>                          
                      ) N
                WHERE 1=1
                  AND A.EPSD_PROD_ID = B.PROD_ID
                  AND A.EPSD_PROD_ID = C.PROD_ID
                  AND A.EPSD_PROD_ID = D.PROD_ID
                  AND A.EPSD_PROD_ID = E.PROD_ID
                  AND A.EPSD_PROD_ID = N.PROD_ID(+)
                  AND A.CHNL_PROD_ID =#{chnlProdId}
                  AND E.EXPO_YN ='Y'                                /* Y : 기본(기본여부) */
                  AND E.TENANT_ID  =#{tenantHeader.tenantId}        /* INPUT 테넌트ID */
                  AND D.TENANT_ID  =#{tenantHeader.tenantId}        /* INPUT 테넌트ID */
                  <if test="req.saleDtUseYn == null">
                  AND SYSDATE BETWEEN D.APPLY_START_DT AND D.APPLY_END_DT
                  </if>
                 <if test="req.includeProdStopStatus != null">
                  AND (CASE WHEN A.EXPO_ORD=1 THEN NVL( A.EXPO_YN, 'N' ) 
                       ELSE ( SELECT TPO2.EXPO_YN
                                FROM TB_DP_PROD_OPT TPO2
                               WHERE TPO2.CHNL_PROD_ID = A.CHNL_PROD_ID
                                 AND TPO2.OPT1_NM = A.OPT1_NM
                                 AND TPO2.EXPO_ORD = 1 
                                 AND ROWNUM =1
                             ) 
                       END
                      ) = 'Y'   
                  AND E.PROD_STATUS_CD ='PD000403'                      
                 </if>            
                ORDER BY A.CHNL_PROD_ID
                        ,A.OPT1_NM
                        ,A.EXPO_ORD
        )KK
    </select>        
    
   <!-- 쇼핑상세(배송 상품 조회시 에피소드) 조회-->
    <select id="getShoppingEpisodeV2" parameterType="Map" resultType="MetaInfo">
     /* ShoppingMapper.xml.getShoppingEpisodeV2,쇼핑상세(배송 상품 조회시 에피소드) 조회, 김형식/SK플래닛  , 2014-12-31 */
         SELECT 
                A.CHNL_PROD_ID AS prodId
               ,A.EPSD_PROD_ID AS partProdId
        FROM  TB_DP_PROD_OPT A
             ,TB_DP_SHPG_PROD B 
             ,TB_DP_PROD C
             ,TB_DP_TENANT_PROD_PRICE D
             ,TB_DP_TENANT_PROD E
        WHERE 1=1
          AND A.EPSD_PROD_ID = B.PROD_ID
          AND A.EPSD_PROD_ID = C.PROD_ID
          AND A.EPSD_PROD_ID = D.PROD_ID
          AND A.EPSD_PROD_ID = E.PROD_ID
          AND A.CHNL_PROD_ID =#{chnlProdId}
          AND E.EXPO_YN ='Y'                                /* Y : 기본(기본여부) */
          AND E.TENANT_ID  =#{tenantHeader.tenantId}        /* INPUT 테넌트ID */
          AND D.TENANT_ID  =#{tenantHeader.tenantId}        /* INPUT 테넌트ID */
        ORDER BY A.CHNL_PROD_ID
                ,A.OPT1_NM
                ,A.EXPO_ORD
    </select>    
    
  <!-- 쇼핑상세(이미지) 조회-->
    <select id="getShoppingImgDetailListV2" parameterType="Map" resultType="MetaInfo">
     /* ShoppingMapper.xml.getShoppingImgDetailListV2,쇼핑상세(이미지) 조회, 김형식/SK플래닛  , 2014-02-04 */
        SELECT 
                 CONCAT(FILE_PATH,FILE_NM) FILE_PATH 
               , EXPO_ORD
          FROM TB_DP_PROD_IMG
         WHERE PROD_ID = #{req.productId} 
           AND IMG_CD =#{cutDetailImageCd}
           AND LANG_CD= #{lang}          /* ko : 한국어 */
         ORDER BY EXPO_ORD            
    </select>       
    
  <!-- 쇼핑상세(에피소드로 카탈로그 가져오기) 조회-->
    <select id="getChannelByepisodeV2" parameterType="ShoppingReq" resultType="MetaInfo">
     /* ShoppingMapper.xml.getChannelByepisodeV2,쇼핑상세(에피소드로 카탈로그 가져오기) 조회, 김형식/SK플래닛  , 2014-02-04 */
        SELECT 
               CATALOG_ID
          FROM TB_DP_PROD_CATALOG_MAPG
         WHERE PROD_ID = ( 
                           SELECT DISTINCT PROD_ID 
                             FROM TB_DP_PROD_RSHP
                            WHERE PART_PROD_ID = #{productId} 
                              AND PROD_RSHP_CD = #{prodRshpCd}     /*채널-에피소드 상품 관계*/
                              AND ROWNUM =1
                         ) 
           AND BASE_YN ='Y'
           AND USE_YN ='Y'
    </select>    
  <!-- 쇼핑상세(팅요금제 조회 여부) 조회-->
    <select id="getTingPaidQueryV2" parameterType="ShoppingReq" resultType="String">
     /* ShoppingMapper.xml.getChannelByepisodeV2,쇼핑상세(팅요금제 조회 여부) 조회, 김형식/SK플래닛  , 2014-02-04 */
         SELECT SPRC_TYPE_CD
           FROM  TB_DP_PROD_RSHP A2
                ,TB_DP_SPRC_PROD B2
                ,TB_DP_PROD_CATALOG_MAPG C2
          WHERE 1=1
            AND A2.PART_PROD_ID = B2.PROD_ID
            AND A2.PROD_ID = C2.PROD_ID
            AND C2.BASE_YN ='Y'
            AND C2.USE_YN ='Y'
            AND B2.EXPO_YN ='Y'
            AND B2.CPN_ID IS NOT NULL
            AND C2.CATALOG_ID = #{productId}
            AND SYSDATE BETWEEN  B2.SPRC_APPLY_START_DT AND B2.SPRC_APPLY_END_DT
            AND ROWNUM = 1 
    </select>       
              
    <!-- 카테고리 쇼핑 상세 조회-->
    <select id="searchSpecificShoppingDetail" parameterType="Map" resultType="MetaInfo">
       /* ShoppingMapper.xml.searchSpecificShoppingDetail,카테고리 쇼핑 상세 조회, 김형식/SK플래닛  , 2014-12-07 */
     SELECT * FROM (
         SELECT 
                PP.* 
                ,ROW_NUMBER() OVER(PARTITION BY PROD_ID ORDER BY SOLDOUT ASC) AS NO1
          FROM (     
                  SELECT  
                        KK.*
                       ,(CASE WHEN KK.SPECIAL_SALE_YN ='Y' THEN 
                                 ( CASE WHEN ( ( KK.MTH_PRCHS_CNT >= KK.MTH_MAX_CNT ) OR
                                               ( KK.DLY_PRCHS_CNT >= KK.DLY_MAX_CNT )
                                               OR 
                                               ( KK.SOLD_OUT_YN ='Y' )                                         
                                             ) 
                                    THEN 'Y'
                                    ELSE  'N' END 
                                  )
                        ELSE 'N'
                        END ) AS soldOut         
                       ,KK.SPECIAL_SALE_YN AS specialSale
                       ,TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') AS SYS_DATE
                   FROM (
                          SELECT 
                                B.CATALOG_ID 
                               ,C.CATALOG_NM         
                               ,A.BRAND_ID 
                               ,A.BRAND_NM                            
                               ,D.MENU_ID
                               ,J.TOP_MENU_ID 
                               ,F.MENU_NM
                               ,(SELECT MENU_NM
                                   FROM TB_DP_MENU_CATEGORY_DESC
                                  WHERE MENU_ID = J.TOP_MENU_ID
                                    AND LANG_CD = #{lang}
                                    AND ROWNUM = 1
                                ) AS TOP_MENU_NM  
                                ,J.META_CLSF_CD                                   
                                ,H.PROD_ID                         
                                ,H.PART_PROD_ID 
                                ,J.CONTENTS_TYPE_CD   
                                ,NVL(L.PROD_NET_AMT, 0) AS PROD_NET_AMT 
                                ,NVL(N.SPRC_PRICE, NVL(L.DC_AFT_PROD_AMT, 0)) AS PROD_AMT
                                ,NVL(N.SPRC_DC_RATE, NVL(L.DC_RATE,0)) AS DC_RATE
                                ,NVL(N.SPRC_DC_PRICE, NVL(L.DC_AMT, 0)) AS DC_AMT                        
                                ,J.PROD_GRD_CD
                                ,TO_CHAR(NVL( N.SPRC_APPLY_START_DT, L.APPLY_START_DT),'YYYYMMDDHH24MISS') AS APPLY_START_DT
                                ,TO_CHAR(NVL( N.SPRC_APPLY_END_DT , L.APPLY_END_DT ),'YYYYMMDDHH24MISS') AS APPLY_END_DT                                  
                                ,J.USE_PERIOD_UNIT_CD
                                ,J.USE_PERIOD
                                ,(CASE WHEN I.PROD_CASE_CD='DP006301' THEN 'giftcard' 
                                       WHEN I.PROD_CASE_CD='DP006302' THEN 'exchange' 
                                       WHEN I.PROD_CASE_CD='DP006303' THEN 'delivery' 
                                  END) AS PROD_CASE_CD  
                                ,NVL(N.MM_PROD_MAX_SALE_QTY, I.MM_MAX_SALE_QTY ) AS MTH_MAX_CNT     /* 월_최대_판매_수량 */
                                ,NVL(N.DLY_PROD_MAX_SALE_QTY, I.DAY_MAX_SALE_QTY ) AS DLY_MAX_CNT   /* 일_최대_판매_수량 */
                                ,CASE WHEN N.PROD_ID IS NOT NULL AND N.SPRC_TYPE_CD IN ('DP007501','DP007502') THEN 'Y' ELSE 'N'END AS SPECIAL_SALE_YN
                                ,CASE WHEN N.PROD_ID IS NOT NULL THEN N.CPN_ID ELSE '' END AS SPECIAL_COUPON_ID
                                ,NVL( ( SELECT SUM( TSPP.PRCHS_CNT )
                                         FROM TB_DP_SPRC_PROD_PRCHS_MANG TSPP
                                        WHERE TO_CHAR(TSPP.PRCHS_DT,'YYYYMMDD') BETWEEN CONCAT( TO_CHAR( SYSDATE, 'YYYYMM' ), '01' )
                                                                AND TO_CHAR( LAST_DAY( SYSDATE ),'YYYYMMDD')
                                          AND TSPP.PROD_ID = H.PART_PROD_ID )
                                   , 0 ) AS MTH_PRCHS_CNT
                                ,NVL( ( SELECT TSPP.PRCHS_CNT
                                         FROM TB_DP_SPRC_PROD_PRCHS_MANG TSPP
                                        WHERE TO_CHAR(TSPP.PRCHS_DT,'YYYYMMDD') = TO_CHAR( SYSDATE, 'YYYYMMDD' )
                                          AND TSPP.PROD_ID = H.PART_PROD_ID )
                                   , 0 ) AS DLY_PRCHS_CNT           
                                ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID 
                                                   ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC 
                                                  ,DECODE(I.PROD_CASE_CD ,'DP006303'
                                                            ,(SELECT 1 FROM TB_DP_TENANT_PROD WHERE TENANT_ID =#{tenantHeader.tenantId} AND PROD_ID = H.PART_PROD_ID AND PROD_STATUS_CD='PD000403')
                                                            ,ROUND(DBMS_RANDOM.VALUE(1, 100), 0)
                                                          )
                                                   ) as NO 
                                ,N.SOLD_OUT_YN 
                                ,CONCAT(PI.FILE_PATH,PI.FILE_NM) FILE_PATH 
                                ,PI.FILE_NM
                                ,PI.FILE_SIZE   
                                ,CASE WHEN NVL(M.PRCHS_CNT, 0) <![CDATA[ < ]]> 0 THEN 0 ELSE NVL(M.PRCHS_CNT, 0) END AS PRCHS_CNT
                                ,(CASE WHEN (SELECT EPSD_CNT FROM TB_DP_SHPG_PROD WHERE PROD_ID = H.PROD_ID)>0 
                                        THEN (SELECT PROD_STATUS_CD FROM TB_DP_TENANT_PROD WHERE TENANT_ID=#{tenantHeader.tenantId} AND PROD_ID=H.PROD_ID) 
                                  ELSE 'PD000404' END
                                  ) PROD_STATUS_CD                                                                  
                          FROM 
                                  TB_DP_SHPG_BRAND A
                                 ,TB_DP_SHPG_CATALOG B
                                 ,TB_DP_SHPG_CATALOG_DESC C
                                 ,TB_DP_MENU_SHPG_MAPG D
                                 ,TB_DP_MENU_CATEGORY E
                                 ,TB_DP_MENU_CATEGORY_DESC F 
                                 ,TB_DP_PROD_CATALOG_MAPG G 
                                 ,TB_DP_PROD_RSHP H
                                 ,TB_DP_SHPG_PROD I
                                 ,TB_DP_PROD J
                                 ,TB_DP_TENANT_PROD K
                                 ,TB_DP_TENANT_PROD_PRICE L
                                 ,TB_DP_PROD_IMG          PI
                                 ,(SELECT  PROD_ID
                                          ,PRCHS_CNT
                                     FROM TB_DP_TENANT_PROD_STATS 
                                    WHERE TENANT_ID = #{tenantHeader.tenantId}    /* INPUT 테넌트ID */
                                   ) M                                 
                                 ,TB_DP_PROD_DESC O
                                 ,(SELECT /*+ ORDERED */
                                         B1.PROD_ID
                                       , B1.SPRC_DC_RATE
                                       , B1.SPRC_PRICE
                                       , B1.SPRC_DC_PRICE
                                       , B1.SPRC_APPLY_START_DT
                                       , B1.SPRC_APPLY_END_DT
                                       , B1.MM_PROD_MAX_SALE_QTY
                                       , B1.DLY_PROD_MAX_SALE_QTY   
                                       , B1.PERMAN_MM_MAX_PRCHS_QTY
                                       , B1.PERMAN_DAY_MAX_PRCHS_QTY
                                       , B1.ONCE_MAX_PRCHS_POSB_CNT  
                                       , B1.CPN_ID   
                                       , B1.SPRC_TYPE_CD 
                                       , B1.SOLD_OUT_YN                               
                                   FROM  TB_DP_PROD_RSHP A1
                                        ,TB_DP_SPRC_PROD B1
                                   WHERE 1=1
                                     AND A1.PART_PROD_ID = B1.PROD_ID
                                    <if test="req.specialProdId != null">
                                     AND B1.PROD_ID  = #{req.specialProdId}
                                    </if>
                                     AND B1.EXPO_YN ='Y'
                                     AND B1.CPN_ID IS NOT NULL
                                     AND SYSDATE BETWEEN  B1.SPRC_APPLY_START_DT AND B1.SPRC_APPLY_END_DT 
                                  )N
                        WHERE 1=1
                        AND A.BRAND_ID = B.BRAND_ID
                        AND B.CATALOG_ID = C.CATALOG_ID
                        AND C.CATALOG_ID = D.CATALOG_ID     
                        AND D.MENU_ID = E.MENU_ID
                        AND D.MENU_ID = F.MENU_ID
                        AND B.CATALOG_ID = G.CATALOG_ID
                        AND G.PROD_ID = H.PROD_ID
                        AND H.PROD_ID <![CDATA[ <> ]]> H.PART_PROD_ID
                        AND H.PART_PROD_ID = I.PROD_ID
                        AND I.PROD_ID = J.PROD_ID
                        AND I.PROD_ID = K.PROD_ID
                        AND I.PROD_ID = L.PROD_ID
                        AND I.PROD_ID = O.PROD_ID
                        AND K.TENANT_ID = L.TENANT_ID
                        AND C.CATALOG_ID = PI.PROD_ID(+)
                        AND C.CATALOG_ID = M.PROD_ID(+) 
                        AND PI.IMG_CD(+) = #{imageCd}                        
                        AND I.PROD_ID = N.PROD_ID(+)
                        AND H.PROD_RSHP_CD =#{prodRshpCd}    /*채널-에피소드 상품 관계*/ 
                        <if test="req.includeProdStopStatus != null ">
                        AND NVL(B.CHNL_CNT, 0) <![CDATA[> ]]> 0
                        AND K.PROD_STATUS_CD = 'PD000403'  /* PD000403 : 판매중 */       
                        </if>                         
                        AND C.LANG_CD= #{lang}          /* ko : 한국어 */
                        AND F.LANG_CD= #{lang}          /* ko : 한국어 */
                        AND O.LANG_CD= #{lang}          /* ko : 한국어 */
                        AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                        AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                        AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                        AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                        <if test="req.saleDtUseYn == null">
                        AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                        </if>
                        AND K.TENANT_ID = #{tenantHeader.tenantId}        /* INPUT 테넌트ID */
                        AND B.CATALOG_ID = #{req.productId}
                        <if test="req.specialProdId != null">
                        AND I.PROD_ID = #{req.specialProdId}
                        </if>
                   ) KK
                )PP
           )
           WHERE DECODE(SPECIALSALE,'Y',NO1,NO) <![CDATA[ <= ]]> 1
    </select>            
                  
              
</mapper>
