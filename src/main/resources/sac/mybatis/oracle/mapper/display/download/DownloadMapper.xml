<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Download">
    <!-- OS 지원여부 조회 -->
    <select id="selectSupportOsVersion" parameterType="DownloadAppSacReq" resultType="HashMap">
	SELECT /* DownloadMapper.selectSupportOsVersion, 지원 OS VERSION 조회, 이석희/아이에스플러스, 2014-05-29 */
	       IA.PROD_ID
	     , NVL(IB.VM_VER, 'N') AS VM_VER
	  FROM 
	       (
	       SELECT A.PROD_ID AS PROD_ID
	            , B.SUB_CONTENTS_ID
	         FROM TB_DP_APP_PROD     A  
	            , TB_DP_SPRT_DEVICE  B
	         WHERE 1=1
	           AND A.PROD_ID = B.PROD_ID
	           AND A.PROD_ID = #{productId} 
	           AND B.DEVICE_MODEL_CD = #{deviceModelCd}
	       ) IA ,
	       TB_DP_SUB_CONTENTS IB
	  WHERE IA.PROD_ID = IB.PROD_ID(+)
	    AND IA.SUB_CONTENTS_ID = IB.SUB_CONTENTS_ID(+)
	    AND IB.VM_VER(+) LIKE '%'||#{osVersion}||'%'
    </select>

    <!-- 패키지명으로 상품 ID 조회 -->
    <select id="getProductIdForPackageName" resultType="String">
    SELECT /* DownloadMapper.getProductIdForPackageName, 패키지명으로 상품 ID 조회, 이석희/아이에스플러스, 2014-01-23 */
           PROD_ID
         , APK_PKG_NM
      FROM (
		     SELECT  A.PROD_ID
		           , D.APK_PKG_NM
		       FROM  TB_DP_PROD                    A
		           , TB_DP_APP_PROD                B
		           , TB_DP_SUB_CONTENTS            D
		           , TB_DP_SPRT_DEVICE             C
		      WHERE  D.PROD_ID = A.PROD_ID
		        AND  D.SUB_CONTENTS_ID = C.SUB_CONTENTS_ID
		        AND  C.PROD_ID = A.PROD_ID
		        AND  A.PROD_ID = B.PROD_ID        
		        AND  C.DEVICE_MODEL_CD = #{deviceModelCd} /* 단말모델코드 */
		        AND  D.APK_PKG_NM = #{packageName}
		      ORDER BY B.REG_DT DESC
            )   
     WHERE ROWNUM <![CDATA[<=]]> 1                     
    </select>

    <!-- TID bunchId Provisioning -->
    <select id="getBunchIdProvisioning" parameterType="DownloadAppSacReq" resultType="java.lang.Integer">
        SELECT /* DownloadMapper.getBunchIdProvisioning, TID BunchId Provisioning for DL (App), 양해엽, 2014-08-21 */
            COUNT(P.PROD_ID)
		FROM            TB_DP_PROD              P
		    INNER JOIN  TB_DP_APP_PROD          APP ON P.PROD_ID = APP.PROD_ID
		    INNER JOIN  TB_DP_TENANT_PROD       TP  ON P.PROD_ID = TP.PROD_ID 
		    INNER JOIN  TB_DP_PROD_IMG          PI  ON P.PROD_ID = PI.PROD_ID
		    INNER JOIN  TB_DP_SPRT_DEVICE       SDV ON P.PROD_ID = SDV.PROD_ID 
		    INNER JOIN  TB_CM_DEVICE            CDV ON SDV.DEVICE_MODEL_CD = CDV.DEVICE_MODEL_CD
		    INNER JOIN  TB_DP_SUB_CONTENTS      SC  ON SDV.PROD_ID = SC.PROD_ID AND SDV.SUB_CONTENTS_ID = SC.SUB_CONTENTS_ID
		WHERE   1 = 1
		    AND P.PROD_CHRG_YN      = 'N'               /* 무료상품 */
		    AND P.SVC_GRP_CD        = 'DP000201'        /* DP000201 : App 상품 */
		    AND P.PROD_ID           = #{bnchProdId}     /* Bunch Prod Id */
		    AND TP.TENANT_ID        = #{tenantId} 
		    AND TP.PROD_STATUS_CD   = 'PD000403'        /* PD000403 : 판매중 */
		    AND TP.EXPO_YN          = 'Y'
		    AND PI.EXPO_ORD         = 1
		    AND PI.LANG_CD          = #{langCd}
		    AND PI.IMG_CD           = #{imageCd}        /* 'DP000101' : App 대표 이미지코드 */
		    AND SDV.DEVICE_MODEL_CD = #{deviceModelCd}
		    AND CDV.USE_YN          ='Y'
		    AND DECODE( CDV.UA_CD , '9999', NVL2( APP.PART_PARENT_CLSF_CD, 0, 1 ) + DECODE( P.DRM_YN, 'N', 1, 0 ), 2 ) = 2 /* UA_CD: 9999 (외산단말) */
		    AND (APP.PART_PARENT_CLSF_CD = 'PD012301' OR APP.PART_PARENT_CLSF_CD IS NULL)    /* PD012301 : 부분 유료화 부모상품 */   
		    AND SC.SALE_YN          = 'Y'
		    AND SC.VM_VER  LIKE '%'||#{osVersion}||'%'   /* Provisioning OS VERSION 체크 */     
    </select>
    
    <!-- validate by parentBunchId -->
    <select id="getValidateParentBunchId" parameterType="DownloadAppSacReq" resultType="java.lang.Integer">
        SELECT /* DownloadMapper.getValidateParentBunchId, validate by parentBunchId for DL (App), 양해엽, 2014-08-21 */
            COUNT(PROD_ID)
		FROM    TB_DP_SEED_MAPP
		WHERE   1=1
		    AND PROD_ID         = #{parentBunchId}
		    AND CASE_REF_CD     = 'PD013020'  /* PD013020 : TID 상품 */
		    AND BNCH_PROD_ID    = #{productId}
	</select>
	
	<!-- get Delta Meta for App Delta Update -->
	<select id="getDownloadAppDeltaUpdate" parameterType="AppDeltaUpdateParam" resultType="AppDeltaUpdate">
        SELECT /* DownloadMapper.getDownloadAppDeltaUpdate, get Delta Meta for App Delta Update, 양해엽, 2014-09-15 */
            PROD_ID
		    ,SUB_CONTENTS_ID
		    ,APK_VER 
		    ,PRE_APK_VER
		    ,DELTA_FILE_SIZE
		    ,DELTA_FILE_PATH        
		FROM    TB_DP_APP_DELTA_DEPLOY_FILE 
		WHERE   1=1
		    AND PROD_ID         = #{prodId}
		    AND SUB_CONTENTS_ID = #{subContentsId}
		    AND APK_VER         = #{apkVer}
		    AND PRE_APK_VER     = #{preApkVer}
    </select>
	
	<!-- 구매내역이 없는 상품이면서 다운로드 가능한 예외 상품 조회 -->
    <select id="getDwldPolicy" parameterType="java.util.Map" resultType="java.lang.Integer">
        SELECT /* DownloadMapper.getDwldPolicy, 다운로드 예외 상품명 조회 for DL (App), 양해엽, 2014-08-21 */
            COUNT(PROD_ID)
        FROM   TB_DP_DWLD_POLICY
        WHERE   1=1
            AND TENANT_ID   = #{tenantId}
            AND PROD_ID     = #{prodId}
            AND CLSF_CD     = 'DP012601' /* FOR D/L WHITE 상품 리스트 */ 
    </select>
	
    <!-- 상품정보요청(for download) App -->
    <select id="getDownloadAppInfo" parameterType="DownloadAppSacReq" resultType="MetaInfo">
      SELECT  /* DownloadMapper.getDownloadAppInfo, 상품정보요청(for download) App , 이석희/아이에스플러스, 2014-01-23 */
                TA.*
              , NVL(TB.PROD_ID, '') AS SEED_PRODUCT_ID
              , TB.CASE_REF_CD AS SEED_CASE_REF_CD
              , TB.USE_YN AS SEED_USE_YN
              , TB2.BNCH_PROD_ID
              , TB2.BNCH_DWLD_MSG
              , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') AS SYS_DATE
          FROM 
               (
                SELECT  COUNT(*) OVER() AS TOTAL_COUNT
                      , KA.TOP_MENU_ID
                      , (SELECT MENU_NM 
                           FROM TB_DP_MENU_CATEGORY_DESC
                          WHERE MENU_ID = KA.TOP_MENU_ID
                            AND ROWNUM = 1) AS TOP_MENU_NM
                      , KA.MENU_ID
                      , KA.MENU_NM
                      , KA.PROD_ID
                      , KA.AID
                      , KA.PROD_NM
                      , KA.PROD_BASE_DESC
                      , DECODE(KA.PROD_CHRG_YN, 'Y', 'paid', 'free') AS PROD_CHRG
                      , KA.PROD_GRD_CD
                      , KA.CONTENTS_TYPE_CD
                      , KA.META_CLSF_CD
                      , KA.SELLER_MBR_NO
                      , KA.EXPO_SELLER_NM
                      , KA.EXPO_SELLER_TELNO
                      , KA.EXPO_SELLER_EMAIL                  
                      , KA.PART_PARENT_CLSF_CD
                      , KA.DRM_YN
                      , DECODE( KA.PROD_CLSF_CD , 'PD000601', 'paid' , 'PD000602', 'library' , 'PD000603', 'vm' , 'PD000604', 'free' , 'PD000605', 'paid-rss' , 'PD000606', 'free-rss' , 'paid' ) AS PROD_CLSF_CD
                      , KB.APK_VER_NM AS PROD_VER
                      , NVL(KB.APK_PKG_NM, '' ) AS APK_PKG_NM
                      , NVL2( KB.APK_VER, KB.APK_VER, KA.PKG_VER_CD ) AS APK_VER   
                      , KA.PLAT_CLSF_CD
                      , KA.GAME_CENTR_VER_CD
                      , NVL(KA.GAME_CENTR_ID, '') AS GAME_CENTR_ID
                      , KA.PROD_AMT                                                                                                
                      , NVL2( KB.FILE_SIZE, KB.FILE_SIZE, ( SELECT MAX(FILE_SIZE) FROM TB_DP_SUB_CONTENTS WHERE PROD_ID = KA.PROD_ID ) ) AS FILE_SIZE
                      , KB.SUB_CONTENTS_ID
                      , (PLAT_CLSF_CD_NM ||' '|| KB.VM_VER) AS SUPPORTED_OS
                      , KB.FILE_PATH AS FILE_PATH
                      , KC.FILE_PATH AS IMAGE_PATH
                      , KC.FILE_SIZE AS IMAGE_SIZE
                  FROM (
                        SELECT  COUNT(B.PROD_ID) OVER() AS TOTAL_COUNT
                               , A.MENU_ID
                               , (SELECT MENU_NM FROM TB_DP_MENU_CATEGORY_DESC T WHERE T.MENU_ID = A.MENU_ID AND LANG_CD= #{langCd}) AS MENU_NM
                               , D.TOP_MENU_ID
                               , B.PROD_ID
                               , D.PROD_CHRG_YN
                               , D.PROD_GRD_CD
                               , D.CONTENTS_TYPE_CD
                               , D.META_CLSF_CD
                               , D.REG_DT
                               , D.SELLER_MBR_NO
                               , D.EXPO_SELLER_NM
                               , D.EXPO_SELLER_TELNO
                               , D.EXPO_SELLER_EMAIL
                               , D.DRM_YN                          
                               , E.AID
                               , E.VER_MAJOR
                               , E.VER_MINOR
                               , E.PART_PARENT_CLSF_CD
                               , E.PKG_VER_CD
                               , E.PROD_CLSF_CD
                               , E.GAME_CENTR_VER_CD
                               , E.GAME_CENTR_ID                           
                               , E.PKG_NM
                               , E.PLAT_CLSF_CD
                               , (SELECT CD_NM FROM TB_CM_CD WHERE CD_ID = E.PLAT_CLSF_CD) AS PLAT_CLSF_CD_NM
                               , F.PROD_NM
                               , F.PROD_BASE_DESC
                               , G.TENANT_ID
                               , H.PROD_AMT
                               , I.SUB_CONTENTS_ID
                           FROM  TB_DP_MENU_CATEGORY           A
                               , TB_DP_MENU_CATEGORY_PROD_MAPG B
                               , TB_DP_PROD                    D
                               , TB_DP_APP_PROD                E
                               , TB_DP_PROD_DESC               F
                               , TB_DP_TENANT_PROD             G
                               , TB_DP_TENANT_PROD_PRICE       H
                               , TB_DP_SPRT_DEVICE             I
                               , TB_CM_DEVICE                  J
                          WHERE  A.MENU_ID = B.MENU_ID
                            AND  B.PROD_ID = D.PROD_ID
                            AND  B.PROD_ID = E.PROD_ID
                            AND  B.PROD_ID = F.PROD_ID
                            AND  B.PROD_ID = G.PROD_ID
                            AND  G.TENANT_ID = H.TENANT_ID
                            AND  G.PROD_ID = H.PROD_ID
                            AND  B.PROD_ID = I.PROD_ID
--                            AND  A.USE_YN = 'Y'                       /* Y : 사용 (사용여부) */
--                            AND  B.USE_YN = 'Y'                       /* Y : 사용 (사용여부) */
                            AND  D.SVC_GRP_CD = 'DP000201'            /* DP000201 : 애플리캐이션 */
                            AND  D.PROD_ID = #{productId}             /* param : product Id */
                            AND  F.LANG_CD = #{langCd}                     /* ko : 한국어 */
                            AND  G.PROD_STATUS_CD IN ( 'PD000403', 'PD000404', 'PD000409', 'PD000410' )      
                            AND  G.EXPO_YN = 'Y'                      /* Y : 노출 (노출여부) */
                            AND H.APPLY_END_DT = (SELECT MAX(APPLY_END_DT) /* ForDownload 판매기간체크 제거, 최종가격정보 조회를 위함 */
                                                     FROM TB_DP_TENANT_PROD_PRICE PR 
                                                    WHERE PR.TENANT_ID = H.TENANT_ID
                                                      AND PR.PROD_ID = H.PROD_ID)
                            AND  G.TENANT_ID = #{tenantId}            /* 테넌트ID */
                            AND  D.TOP_MENU_ID  <![CDATA[ <> ]]>  'DP02' /* DP02 : 폰꾸미기 */
                            AND  I.DEVICE_MODEL_CD = J.DEVICE_MODEL_CD
                            AND  J.DEVICE_MODEL_CD = #{deviceModelCd} /* 단말모델코드 */
                            AND  J.USE_YN ='Y'
                            AND DECODE( J.UA_CD , '9999' , NVL2( E.PART_PARENT_CLSF_CD, 0, 1 ) + DECODE( D.DRM_YN, 'N', 1, 0 ) + DECODE( D.PROD_CHRG_YN, 'N', 1, 0 ) , 3 ) = 3
                            AND (E.PART_PARENT_CLSF_CD = 'PD012301' OR E.PART_PARENT_CLSF_CD is null)    
                       )                   KA
                      , TB_DP_SUB_CONTENTS KB
                      , TB_DP_PROD_IMG     KC
                 WHERE  KA.PROD_ID = KB.PROD_ID(+)
                   AND  KA.SUB_CONTENTS_ID = KB.SUB_CONTENTS_ID(+)
                   AND  KA.PROD_ID = KC.PROD_ID
                   AND  KB.SALE_YN = 'Y'
                   AND  KB.VM_VER  LIKE '%'||#{osVersion}||'%' /* Provisioning OS VERSION 체크 */              
                   AND  KC.EXPO_ORD = '1'
                   AND  KC.LANG_CD = #{langCd}
                   AND  KC.IMG_CD = #{imageCd} 
               ) TA
              LEFT OUTER JOIN TB_DP_SEED_MAPP TB
                ON TA.PROD_ID = TB.PROD_ID AND TB.CASE_REF_CD IN ('PD013018', 'PD013005') /* PD013018: T store 런쳐, PD013005: T store 게임센터 */
              LEFT OUTER JOIN TB_DP_SEED_MAPP TB2
                ON TB2.PROD_ID = TA.PROD_ID AND TB2.CASE_REF_CD = 'PD013020' /* TID */
    </select>
    
    <!-- 상품정보요청(for download) Vod -->
    <select id="getDownloadVodInfo" parameterType="DownloadVodSacReq" resultType="MetaInfo">
    SELECT /* DownloadMapper.getDownloadVodInfo, 상품정보요청(for download) Vod , 이석희/아이에스플러스, 2014-01-23 */
            XA.*
          ,(SELECT FILE_PATH FROM TB_DP_SUB_CONTENTS WHERE PROD_ID = XA.ESPD_PROD_ID AND SUB_CONTENTS_ID = XA.NM_SUB_CONTS_ID  ) AS NM_FILE_PATH
          ,(SELECT FILE_PATH FROM TB_DP_SUB_CONTENTS WHERE PROD_ID = XA.ESPD_PROD_ID AND SUB_CONTENTS_ID = XA.SD_SUB_CONTS_ID  ) AS SD_FILE_PATH
          ,(SELECT FILE_PATH FROM TB_DP_SUB_CONTENTS WHERE PROD_ID = XA.ESPD_PROD_ID AND SUB_CONTENTS_ID = XA.HD_SUB_CONTS_ID  ) AS HD_FILE_PATH
          ,(SELECT FILE_PATH FROM TB_DP_SUB_CONTENTS WHERE PROD_ID = XA.ESPD_PROD_ID AND SUB_CONTENTS_ID = XA.FHD_SUB_CONTS_ID  ) AS FHD_FILE_PATH
      FROM
          (     
            SELECT RNUM
                 , MENU_ID
                 , MENU_NM
                 , CID
                 , CHNL_PROD_ID AS PROD_ID
                 , ESPD_PROD_ID
                 , TOP_MENU_ID
                 , TOP_MENU_NM
                 , META_CLSF_CD
                 , STORE_PROD_ID
                 , PLAY_PROD_ID
                 , NVL(STORE_PROD_AMT, 0) AS STORE_PROD_AMT
                 , NVL(PLAY_PROD_AMT, 0) AS PLAY_PROD_AMT
                 , STORE_PROD_CHRG
                 , PLAY_PROD_CHRG
                 , STORE_USE_PERIOD_UNIT_CD
                 , PLAY_USE_PERIOD_UNIT_CD                 
                 , DECODE( STORE_DRM_YN, 'Y', STORE_DRM_YN, 'N' ) AS STORE_DRM_YN
                 , DECODE( PLAY_DRM_YN, 'Y', PLAY_DRM_YN, 'N' ) AS PLAY_DRM_YN  
                 , DECODE( HDCP_YN, 'Y', HDCP_YN, 'N' ) AS HDCP_YN
                 , DECODE( HDV_YN, 'Y', HDV_YN, 'N' ) AS HDV_YN
                 , PROD_NM
                 , REGEXP_REPLACE( CHAPTER, '[^[:digit:]]' ) AS CHAPTER
                 , ( CASE WHEN CHAPTER IS NOT NULL THEN '회' END ) AS CHAPTER_UNIT
                 , DECODE( USE_PERIOD_UNIT_CD
                         , 'PD00310', NULL
                         , CONCAT( USE_PERIOD, USE_PERIOD_UNIT_CD_NM ) ) AS USE_PERIOD_NM
                 , USE_PERIOD_UNIT_CD            
                 , NVL(DWLD_AREA_LIMT_YN , 'N') AS DWLD_AREA_LIMT_YN 
                 , EPSD_PLAY_TM
                 , PROD_GRD_CD
                 , SELLER_MBR_NO
                 , EXPO_SELLER_NM
                 , EXPO_SELLER_TELNO
                 , EXPO_SELLER_EMAIL            
                 , DECODE( DOLBY_YN , 'Y' , DECODE( DOLBY_SPRT_YN, 'Y', DOLBY_SPRT_YN, 'N' ), 'N' ) AS DOLBY_SPRT_YN
                 , REGEXP_SUBSTR(NM_SUB_CONTS,'[^,]+',1,1) AS NM_SUB_CONTS_ID
                 , REGEXP_SUBSTR(SD_SUB_CONTS,'[^,]+',1,1) AS SD_SUB_CONTS_ID
                 , REGEXP_SUBSTR(HD_SUB_CONTS,'[^,]+',1,1) AS HD_SUB_CONTS_ID
                 , REGEXP_SUBSTR(FHD_SUB_CONTS,'[^,]+',1,1) AS FHD_SUB_CONTS_ID
                 , REGEXP_SUBSTR(NM_SUB_CONTS,'[^,]+',1,5) AS NM_PROD_VER
                 , REGEXP_SUBSTR(SD_SUB_CONTS,'[^,]+',1,5) AS SD_PROD_VER
                 , REGEXP_SUBSTR(HD_SUB_CONTS,'[^,]+',1,5) AS HD_PROD_VER
                 , REGEXP_SUBSTR(FHD_SUB_CONTS,'[^,]+',1,5) AS FHD_PROD_VER
                 , NVL2(REGEXP_SUBSTR(NM_SUB_CONTS,'[^,]+',1,2), REGEXP_SUBSTR(NM_SUB_CONTS,'[^,]+',1,2), 0) AS NM_FILE_SIZE
                 , NVL2(REGEXP_SUBSTR(SD_SUB_CONTS,'[^,]+',1,2), REGEXP_SUBSTR(SD_SUB_CONTS,'[^,]+',1,2), 0) AS SD_FILE_SIZE
                 , NVL2(REGEXP_SUBSTR(HD_SUB_CONTS,'[^,]+',1,2), REGEXP_SUBSTR(HD_SUB_CONTS,'[^,]+',1,2), 0) AS HD_FILE_SIZE
                 , NVL2(REGEXP_SUBSTR(FHD_SUB_CONTS,'[^,]+',1,2), REGEXP_SUBSTR(FHD_SUB_CONTS,'[^,]+',1,2), 0) AS FHD_FILE_SIZE
                 , ( SELECT CD_NM FROM TB_CM_CD WHERE CD_ID =  REGEXP_SUBSTR(NM_SUB_CONTS,'[^,]+',1,3 ) ) AS NM_DP_PIXEL
                 , ( SELECT CD_NM FROM TB_CM_CD WHERE CD_ID =  REGEXP_SUBSTR(SD_SUB_CONTS,'[^,]+',1,3 ) ) AS SD_DP_PIXEL
                 , ( SELECT CD_NM FROM TB_CM_CD WHERE CD_ID =  REGEXP_SUBSTR(HD_SUB_CONTS,'[^,]+',1,3 ) ) AS HD_DP_PIXEL
                 , ( SELECT CD_NM FROM TB_CM_CD WHERE CD_ID =  REGEXP_SUBSTR(FHD_SUB_CONTS,'[^,]+',1,3 ) ) AS FHD_DP_PIXEL
                 , ( SELECT CD_NM FROM TB_CM_CD WHERE CD_ID =  REGEXP_SUBSTR(SD_SUB_CONTS,'[^,]+',1,4 ) ) AS NM_DP_PIC_RATIO
                 , ( SELECT CD_NM FROM TB_CM_CD WHERE CD_ID =  REGEXP_SUBSTR(NM_SUB_CONTS,'[^,]+',1,4 ) ) AS SD_DP_PIC_RATIO
                 , ( SELECT CD_NM FROM TB_CM_CD WHERE CD_ID =  REGEXP_SUBSTR(HD_SUB_CONTS,'[^,]+',1,4 ) ) AS HD_DP_PIC_RATIO
                 , ( SELECT CD_NM FROM TB_CM_CD WHERE CD_ID =  REGEXP_SUBSTR(FHD_SUB_CONTS,'[^,]+',1,4 ) ) AS FHD_DP_PIC_RATIO
                 , REGEXP_SUBSTR(NM_SUB_CONTS,'[^,]+',1,6) AS NM_BTV_CID
                 , REGEXP_SUBSTR(SD_SUB_CONTS,'[^,]+',1,6) AS SD_BTV_CID
                 , REGEXP_SUBSTR(HD_SUB_CONTS,'[^,]+',1,6) AS HD_BTV_CID
                 , REGEXP_SUBSTR(FHD_SUB_CONTS,'[^,]+',1,6) AS FHD_BTV_CID
                 , DECODE( DWLD_NETWORK_CD , 'DP004402', 'restrict', NULL ) AS DWLD_NETWORK_CD
                 , DECODE( STRM_NETWORK_CD , 'DP004402', 'restrict', NULL ) AS STRM_NETWORK_CD
                 , CONCAT(TB.FILE_PATH, TB.FILE_NM)  AS IMAGE_PATH
                 , TB.FILE_NM AS IMAGE_NM
                 , TB.FILE_SIZE AS IMAGE_SIZE
                 , TA.FILE_PATH
            FROM
                 (
                   SELECT  ROWNUM AS RNUM
                         , CID
                         , MENU_ID
                         , MENU_NM
                         , CHNL_PROD_ID
                         , ESPD_PROD_ID
                         , TOP_MENU_ID
                         , TOP_MENU_NM
                         , META_CLSF_CD
                         , STORE_PROD_ID
                         , PLAY_PROD_ID
                         , STORE_PROD_AMT
                         , PLAY_PROD_AMT
                         , STORE_PROD_CHRG
                         , PLAY_PROD_CHRG
                         , STORE_USE_PERIOD_UNIT_CD
                         , PLAY_USE_PERIOD_UNIT_CD
                         , STORE_DRM_YN
                         , PLAY_DRM_YN
                         , HDCP_YN
                         , HDV_YN
                         , PROD_NM
                         , CHAPTER
                         , USE_PERIOD
                         , USE_PERIOD_UNIT_CD
                         , USE_PERIOD_UNIT_CD_NM
                         , DWLD_AREA_LIMT_YN
                         , EPSD_PLAY_TM
                         , PROD_GRD_CD
                         , SELLER_MBR_NO
                         , EXPO_SELLER_NM
                         , EXPO_SELLER_TELNO
                         , EXPO_SELLER_EMAIL                  
                         , DOLBY_SPRT_YN
                         , DOLBY_YN
                         , DECODE( DOLBY_YN, 'Y', NVL( NM_SUB_CONTS_DB, NM_SUB_CONTS ), NM_SUB_CONTS ) AS NM_SUB_CONTS
                         , DECODE( DOLBY_YN, 'Y', NVL( SD_SUB_CONTS_DB, SD_SUB_CONTS ), SD_SUB_CONTS ) AS SD_SUB_CONTS
                         , DECODE( DOLBY_YN, 'Y', NVL( HD_SUB_CONTS_DB, HD_SUB_CONTS ), HD_SUB_CONTS ) AS HD_SUB_CONTS
                         , DECODE( DOLBY_YN, 'Y', NVL( FHD_SUB_CONTS_DB, FHD_SUB_CONTS ), FHD_SUB_CONTS ) AS FHD_SUB_CONTS
                         , DWLD_NETWORK_CD
                         , STRM_NETWORK_CD
                         , FILE_PATH
                     FROM
                          (
                            SELECT  JA.CID
                                  , MAX( JA.MENU_ID ) AS MENU_ID
                                  , MAX( JA.MENU_NM) AS MENU_NM
                                  , MAX( JA.CHNL_PROD_ID ) AS CHNL_PROD_ID
                                  , MAX( JA.ESPD_PROD_ID ) AS ESPD_PROD_ID              
                                  , MAX( JA.TOP_MENU_ID ) AS TOP_MENU_ID
                                  , MAX( JA.TOP_MENU_NM) AS TOP_MENU_NM
                                  , MAX( JA.META_CLSF_CD ) AS META_CLSF_CD
                                  , MAX( JA.STORE_PROD_ID ) AS STORE_PROD_ID
                                  , MAX( JA.PLAY_PROD_ID ) AS PLAY_PROD_ID
                                  , MAX( JA.STORE_PROD_AMT ) AS STORE_PROD_AMT
                                  , MAX( JA.PLAY_PROD_AMT ) AS PLAY_PROD_AMT
                                  , MAX( JA.STORE_DRM_YN ) AS STORE_DRM_YN
                                  , MAX( JA.PLAY_DRM_YN ) AS PLAY_DRM_YN
                                  , MAX(DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', DECODE(JA.PROD_CHRG_YN, 'Y', 'paid', 'free'))) AS STORE_PROD_CHRG
                                  , MAX(DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', NULL, DECODE(JA.PROD_CHRG_YN, 'Y', 'paid', 'free'))) AS PLAY_PROD_CHRG
                                  , MAX(DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', JA.USE_PERIOD_UNIT_CD)) AS STORE_USE_PERIOD_UNIT_CD
                                  , MAX(DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', NULL, JA.USE_PERIOD_UNIT_CD)) AS PLAY_USE_PERIOD_UNIT_CD
                                  , MAX( JA.HDCP_YN ) AS HDCP_YN
                                  , MAX( JA.HDV_YN ) AS HDV_YN
                                  , MAX( JA.PROD_NM ) AS PROD_NM
                                  , MAX( JA.CHAPTER ) AS CHAPTER
                                  , MAX( JA.USE_PERIOD ) AS USE_PERIOD
                                  , MAX( JA.USE_PERIOD_UNIT_CD ) AS USE_PERIOD_UNIT_CD
                                  , MAX( USE_PERIOD_UNIT_CD_NM ) AS USE_PERIOD_UNIT_CD_NM
                                  , MAX( JA.DWLD_AREA_LIMT_YN ) AS DWLD_AREA_LIMT_YN
                                  , MAX( JA.EPSD_PLAY_TM ) AS EPSD_PLAY_TM
                                  , MAX( JA.PROD_GRD_CD ) AS PROD_GRD_CD
                                  , MAX( JA.SELLER_MBR_NO ) AS SELLER_MBR_NO
                                  , MAX( JA.EXPO_SELLER_NM ) AS EXPO_SELLER_NM
                                  , MAX( JA.EXPO_SELLER_TELNO ) AS EXPO_SELLER_TELNO
                                  , MAX( JA.EXPO_SELLER_EMAIL ) AS EXPO_SELLER_EMAIL               
                                  , MAX( JA.DOLBY_SPRT_YN ) AS DOLBY_SPRT_YN
                                  , MAX( JA.DOLBY_YN ) AS DOLBY_YN
                                  , MAX( JA.NM_SUB_CONTS ) AS NM_SUB_CONTS
                                  , MAX( JA.SD_SUB_CONTS ) AS SD_SUB_CONTS
                                  , MAX( JA.HD_SUB_CONTS ) AS HD_SUB_CONTS
                                  , MAX( JA.FHD_SUB_CONTS ) AS FHD_SUB_CONTS
                                  , MAX( JA.NM_SUB_CONTS_DB ) AS NM_SUB_CONTS_DB
                                  , MAX( JA.SD_SUB_CONTS_DB  ) AS SD_SUB_CONTS_DB
                                  , MAX( JA.HD_SUB_CONTS_DB  ) AS HD_SUB_CONTS_DB
                                  , MAX( JA.FHD_SUB_CONTS_DB  ) AS FHD_SUB_CONTS_DB
                                  , MAX( JA.DWLD_NETWORK_CD ) AS DWLD_NETWORK_CD
                                  , MAX( JA.STRM_NETWORK_CD ) AS STRM_NETWORK_CD
                                  , MAX( JA.FILE_PATH ) AS FILE_PATH
                              FROM
                                   (
                                    SELECT  IA.MENU_ID
                                          , IA.MENU_NM
                                          , IA.CHNL_PROD_ID 
                                          , IA.PROD_ID AS ESPD_PROD_ID
                                          , IA.CID
                                          , IA.TOP_MENU_ID
                                          , IA.TOP_MENU_NM
                                          , IA.META_CLSF_CD
                                          , DECODE( IA.USE_PERIOD_UNIT_CD, 'PD00310', IA.PROD_ID ) AS STORE_PROD_ID
                                          , DECODE( IA.USE_PERIOD_UNIT_CD, 'PD00310', NULL, IA.PROD_ID ) AS PLAY_PROD_ID
                                          , IA.STORE_PROD_AMT
                                          , IA.PLAY_PROD_AMT
                                          , IA.STORE_DRM_YN
                                          , IA.PLAY_DRM_YN
                                          , IA.HDCP_YN
                                          , IA.HDV_YN
                                          , IA.PROD_NM
                                          , IA.CHAPTER
                                          , IA.USE_PERIOD
                                          , IA.USE_PERIOD_UNIT_CD
                                          , (SELECT CD_NM FROM TB_CM_CD WHERE CD_ID = IA.USE_PERIOD_UNIT_CD AND LANG_CD = #{langCd}) AS USE_PERIOD_UNIT_CD_NM
                                          , IA.DWLD_AREA_LIMT_YN
                                          , IA.EPSD_PLAY_TM
                                          , IA.PROD_GRD_CD
                                          , IA.SELLER_MBR_NO
                                          , IA.EXPO_SELLER_NM
                                          , IA.EXPO_SELLER_TELNO
                                          , IA.EXPO_SELLER_EMAIL 
                                          , IA.PROD_CHRG_YN                                 
                                          , IA.DOLBY_SPRT_YN
                                          , IA.DOLBY_YN
                                          , IA.NM_SUB_CONTS_DB
                                          , IA.SD_SUB_CONTS_DB
                                          , IA.HD_SUB_CONTS_DB
                                          , IA.FHD_SUB_CONTS_DB
                                          , IA.NM_SUB_CONTS
                                          , IA.SD_SUB_CONTS
                                          , IA.HD_SUB_CONTS
                                          , IA.FHD_SUB_CONTS
                                          , IA.DWLD_NETWORK_CD
                                          , IA.STRM_NETWORK_CD
                                          , IA.FILE_PATH
                                      FROM
                                           (
                                            SELECT A.MENU_ID
                                                 , (SELECT MENU_NM FROM TB_DP_MENU_CATEGORY_DESC T WHERE T.MENU_ID = A.MENU_ID AND LANG_CD=#{langCd}) AS MENU_NM                                    
                                                 , D.PROD_ID AS CHNL_PROD_ID
                                                 , E.HDCP_YN
                                                 , E.HDV_YN
                                                 , P.DWLD_AREA_LIMT_YN
                                                 , E.DOLBY_SPRT_YN                                         
                                                 , E.DWLD_NETWORK_CD 
                                                 , E.STRM_NETWORK_CD                                          
                                                 , Q.PROD_NM 
                                                 , J.CID
                                                 , J.PROD_ID                           
                                                 , J.TOP_MENU_ID
                                                 , (SELECT MENU_NM 
                                                      FROM TB_DP_MENU_CATEGORY_DESC
                                                     WHERE MENU_ID = J.TOP_MENU_ID
                                                       AND LANG_CD = #{langCd}
                                                       AND ROWNUM = 1) AS TOP_MENU_NM        
                                                 , J.USE_PERIOD_UNIT_CD
                                                 , J.META_CLSF_CD
                                                 , DECODE( J.USE_PERIOD_UNIT_CD, 'PD00310', O.PROD_AMT ) AS STORE_PROD_AMT
                                                 , DECODE( J.USE_PERIOD_UNIT_CD, 'PD00310', NULL, O.PROD_AMT ) AS PLAY_PROD_AMT
                                                 , DECODE( J.USE_PERIOD_UNIT_CD, 'PD00310', J.DRM_YN ) AS STORE_DRM_YN
                                                 , DECODE( J.USE_PERIOD_UNIT_CD, 'PD00310', NULL, J.DRM_YN ) AS PLAY_DRM_YN              
                                                 ,( SELECT CHAPTER FROM TB_DP_VOD_PROD WHERE PROD_ID = I.PART_PROD_ID) AS CHAPTER     
                                                 , J.USE_PERIOD
                                                 , J.PROD_GRD_CD 
                                                 , J.SELLER_MBR_NO
                                                 , J.EXPO_SELLER_NM
                                                 , J.EXPO_SELLER_TELNO
                                                 , J.EXPO_SELLER_EMAIL  
                                                 , J.PROD_CHRG_YN
                                                 , L.DOLBY_SPRT_YN AS DOLBY_YN
                                                 , ( CASE WHEN ( M.AUDIO_TYPE_CD = 'PD002215' AND M.DP_PG_QULT_CD = 'PD009701' ) THEN
                                                          M.SUB_CONTENTS_ID||','||M.FILE_SIZE||','||M.RSLTN_CD||','||M.DP_PG_RATIO_CD||','||M.PROD_VER||','||''
                                                      END ) AS NM_SUB_CONTS_DB
                                                 , ( CASE WHEN ( M.AUDIO_TYPE_CD = 'PD002215' AND M.DP_PG_QULT_CD = 'PD009702' ) THEN
                                                          M.SUB_CONTENTS_ID||','||M.FILE_SIZE||','||M.RSLTN_CD||','||M.DP_PG_RATIO_CD||','||M.PROD_VER||','||''
                                                      END ) AS SD_SUB_CONTS_DB
                                                 , ( CASE WHEN ( P.HDV_YN = 'Y' AND M.AUDIO_TYPE_CD = 'PD002215' AND M.DP_PG_QULT_CD = 'PD009703' ) THEN
                                                          M.SUB_CONTENTS_ID||','||M.FILE_SIZE||','||M.RSLTN_CD||','||M.DP_PG_RATIO_CD||','||M.PROD_VER||','||''
                                                      END ) AS HD_SUB_CONTS_DB
                                                 , ( CASE WHEN ( P.HDV_YN = 'Y' AND M.AUDIO_TYPE_CD = 'PD002215' AND M.DP_PG_QULT_CD = 'PD009704' ) THEN
                                                          M.SUB_CONTENTS_ID||','||M.FILE_SIZE||','||M.RSLTN_CD||','||M.DP_PG_RATIO_CD||','||M.PROD_VER||','||''
                                                      END ) AS FHD_SUB_CONTS_DB
                                                 , ( CASE WHEN ( ( M.AUDIO_TYPE_CD IS NULL OR M.AUDIO_TYPE_CD != 'PD002215' ) AND M.DP_PG_QULT_CD = 'PD009701' ) THEN
                                                          M.SUB_CONTENTS_ID||','||M.FILE_SIZE||','||M.RSLTN_CD||','||M.DP_PG_RATIO_CD||','||M.PROD_VER||','||''
                                                      END ) AS NM_SUB_CONTS
                                                 , ( CASE WHEN ( ( M.AUDIO_TYPE_CD IS NULL OR M.AUDIO_TYPE_CD != 'PD002215' ) AND M.DP_PG_QULT_CD = 'PD009702' ) THEN
                                                          M.SUB_CONTENTS_ID||','||M.FILE_SIZE||','||M.RSLTN_CD||','||M.DP_PG_RATIO_CD||','||M.PROD_VER||','||''
                                                      END ) AS SD_SUB_CONTS
                                                 , ( CASE WHEN (  P.HDV_YN = 'Y' AND ( M.AUDIO_TYPE_CD IS NULL OR M.AUDIO_TYPE_CD != 'PD002215' ) AND M.DP_PG_QULT_CD = 'PD009703' ) THEN
                                                         M.SUB_CONTENTS_ID||','||M.FILE_SIZE||','||M.RSLTN_CD||','||M.DP_PG_RATIO_CD||','||M.PROD_VER||','||''
                                                      END ) AS HD_SUB_CONTS  
                                                 , ( CASE WHEN (  P.HDV_YN = 'Y' AND ( M.AUDIO_TYPE_CD IS NULL OR M.AUDIO_TYPE_CD != 'PD002215' ) AND M.DP_PG_QULT_CD = 'PD009704' ) THEN
                                                         M.SUB_CONTENTS_ID||','||M.FILE_SIZE||','||M.RSLTN_CD||','||M.DP_PG_RATIO_CD||','||M.PROD_VER||','||''
                                                      END ) AS FHD_SUB_CONTS  
                                                 , M.EPSD_PLAY_TM
                                                 , M.FILE_PATH
                                              FROM TB_DP_MENU_CATEGORY_PROD_MAPG A
                                                 , TB_DP_MENU_CATEGORY           B
                                                 , TB_DP_PROD                    D
                                                 , TB_DP_VOD_PROD                E
                                                 , TB_DP_TENANT_PROD             G
                                                 , TB_DP_PROD_RSHP               I
                                                 , TB_DP_PROD                    J
                                                 , TB_DP_SPRT_DEVICE             K
                                                 , TB_CM_DEVICE                  L
                                                 , TB_DP_SUB_CONTENTS            M
                                                 , TB_DP_TENANT_PROD             N
                                                 , TB_DP_TENANT_PROD_PRICE       O
                                                 , TB_DP_VOD_PROD                P
                                                 , TB_DP_PROD_DESC               Q
                                             WHERE A.MENU_ID = B.MENU_ID
                                               AND A.PROD_ID = D.PROD_ID
                                               AND D.PROD_ID = E.PROD_ID  
                                               AND D.PROD_ID = G.PROD_ID                                                                              
                                               AND D.PROD_ID = I.PROD_ID
                                               AND I.PART_PROD_ID = J.PROD_ID
                                               AND I.PART_PROD_ID = K.PROD_ID
                                               AND I.PART_PROD_ID = M.PROD_ID
                                               AND J.PROD_ID = N.PROD_ID
                                               AND J.PROD_ID = O.PROD_ID  
                                               AND N.TENANT_ID = #{tenantId}
                                               AND N.TENANT_ID = O.TENANT_ID                                         
                                               AND J.PROD_ID = P.PROD_ID
                                               AND J.PROD_ID = Q.PROD_ID                                     
--                                               AND B.USE_YN = 'Y'                        /* Y : 사용 (사용여부) */
                                               AND D.SVC_GRP_CD = 'DP000203'             /* DP000203 : 멀티미디어 */
                                               AND D.CONTENTS_TYPE_CD = 'PD002501'       /* PD002501 : 채널타입 */
                                               AND D.TOP_MENU_ID IN ('DP17', 'DP18')
                                               AND G.PROD_STATUS_CD IN ('PD000402', 'PD000403', 'PD000404') /* PD000402 : 판매대기 , PD000403 : 판매중, PD000404 : 판매중지 */
                                               AND G.EXPO_YN = 'Y'                       /* Y : 노출 (노출여부) */   
                                               AND G.TENANT_ID = #{tenantId}                                       
                                               AND J.SVC_GRP_CD = 'DP000203'       /* PD002501 : 에피소드타입 */  
                                               AND J.CONTENTS_TYPE_CD = 'PD002502'       /* PD002501 : 에피소드타입 */  
                                               AND J.TOP_MENU_ID IN ('DP17', 'DP18')
                                               AND (K.DEVICE_MODEL_CD = #{deviceModelCd} OR K.DEVICE_MODEL_CD = #{anyDeviceModelCd})                                       
                                               AND DECODE( L.SD_VIDEO_SPRT_YN , 'Y' , DECODE( M.DP_PG_QULT_CD, 'PD009701', 1, 'PD009702', 1, DECODE( L.HDV_SPRT_YN, 'Y', 1, 0 ) ), DECODE( M.DP_PG_QULT_CD, 'PD009701', 1, 0 ) ) = 1                                              
                                               AND (CASE WHEN L.VIDEO_DRM_SPRT_YN = 'N' AND NVL(J.DRM_YN, 'N') = 'Y' THEN 'NOT SUPPORT'
                                                         ELSE 'SUPPORT' END) = 'SUPPORT' /* DRM 미지원 단말이고 에피소드 상품이 DRM 상품일 경우 노출 안함 */                                                                                                                                     
                                               AND L.DEVICE_MODEL_CD = #{deviceModelCd} /* header param : 단말모델코드 */
                                               AND L.USE_YN ='Y'   
                                               AND M.SALE_YN ='Y'                                       
                                               AND N.PROD_STATUS_CD IN ('PD000403', 'PD000404', 'PD000409') /* PD000403 : 판매중, PD000404 : 판매중지, PD000409 : 판매불가-다운허용 */
                                               AND N.EXPO_YN = 'Y'                       /* Y : 노출 (노출여부) */                                         
                                               AND O.APPLY_END_DT = (SELECT MAX(APPLY_END_DT) /* ForDownload 판매기간체크 제거, 최종가격정보 조회를 위함 */
					                                                     FROM TB_DP_TENANT_PROD_PRICE PR
					                                                    WHERE PR.TENANT_ID = O.TENANT_ID
					                                                      AND PR.PROD_ID = O.PROD_ID)
                                               AND Q.LANG_CD = #{langCd}                      /* ko : 한국어 */                                               
                                               <if test="idType == 'episode'">
                                               AND J.PROD_ID = #{productId} /* 에피소드 ID 조회 */
                                               </if>
                                               <if test="idType == 'channel'">
                                               AND D.PROD_ID= #{productId}    /* 채널 Id조회 */
                                               </if>
                                           ) IA
                                   )JA
                              GROUP BY JA.CID
                          )  KA
                 ) TA  LEFT OUTER JOIN TB_DP_PROD_IMG TB 
                   ON  TA.CHNL_PROD_ID = TB.PROD_ID
                  AND  TB.EXPO_ORD = '1'
                  AND  TB.LANG_CD = #{langCd}
                  AND  TB.IMG_CD = #{imageCd}
          ) XA                       
     WHERE  XA.RNUM = 1         
    </select>
    
    <!-- for download 현재일시 및 요청만료일시 조회 -->
    <select id="selectDownloadSystemDate" resultType="MetaInfo">
        SELECT  /* DownloadMapper.selectDownloadSystemDate, for download 현재일시 및 요청만료일시 조회, 이태희/부르칸, 2014-03-17 */
                '20991231235959' AS SYS_DATE
             ,  TO_CHAR(SYSDATE + 1 / 24, 'YYYYMMDDHH24MISS') AS EXPIRED_DATE
             ,  TO_CHAR(SYSDATE - 1 / 24, 'YYYYMMDDHH24MISS') AS PURCHASE_DT
          FROM  DUAL
    </select>
    
    <!-- ebook 상품 정보 조회(for download) -->
    <select id="selectDownloadEbookInfo" parameterType="DownloadEbookSacReq" resultType="MetaInfo">
        SELECT  /* DownloadMapper.selectDownloadEbookInfo, eBook 상품 정보 조회, 이태희/부르칸, 2014-03-17 */
                KA.*
              , DECODE(KA.META_CLSF_CD, 'CT26', NVL(KA.MALL_CD, 'MM001308'), KA.MALL_CD) AS MALL_CD
              , FC_GET_IMAGE(DECODE(KA.META_CLSF_CD, 'CT19', KA.PROD_ID, KA.PART_PROD_ID), #{imageCd}, #{langCd}) AS DLM_IMAGE_PATH
              , CONCAT(KB.FILE_PATH, KB.FILE_NM) AS IMAGE_PATH
              , KB.FILE_SIZE AS IMAGE_SIZE
              , (SELECT MENU_NM
                   FROM TB_DP_MENU_CATEGORY_DESC
                  WHERE MENU_ID = KA.TOP_MENU_ID
                    AND LANG_CD = #{langCd}
                    AND ROWNUM = 1) AS TOP_MENU_NM
              , (SELECT MENU_NM
                   FROM TB_DP_MENU_CATEGORY_DESC
                  WHERE MENU_ID = KA.MENU_ID
                    AND LANG_CD = #{langCd}
                    AND ROWNUM = 1) AS MENU_NM
              , CASE WHEN KA.USE_PERIOD_UNIT_CD != 'PD00310' THEN CONCAT(USE_PERIOD, (SELECT CD_NM FROM TB_CM_CD WHERE CD_ID = KA.USE_PERIOD_UNIT_CD AND LANG_CD = #{langCd}))
                     ELSE '' END AS USE_PERIOD_NM
          FROM (SELECT  MAX(DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', JA.PART_PROD_ID)) AS STORE_PROD_ID
                      , MAX(DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', NULL, JA.PART_PROD_ID)) AS PLAY_PROD_ID
                      , MAX(DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', JA.PROD_AMT)) AS STORE_PROD_AMT
                      , MAX(DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', NULL, JA.PROD_AMT)) AS PLAY_PROD_AMT
                      , MAX(DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', JA.PROD_NET_AMT)) AS STORE_PROD_NET_AMT
                      , MAX(DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', NULL, JA.PROD_NET_AMT)) AS PLAY_PROD_NET_AMT
                      , NVL(MAX(DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', JA.DRM_YN)), 'N') AS STORE_DRM_YN
                      , NVL(MAX(DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', NULL, JA.DRM_YN)), 'N') AS PLAY_DRM_YN
                      , MAX(DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', JA.PROD_STATUS_CD)) AS STORE_PROD_STATUS_CD
                      , MAX(DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', NULL, JA.PROD_STATUS_CD)) AS PLAY_PROD_STATUS_CD
                      , MAX(DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', DECODE(JA.PROD_CHRG_YN, 'Y', 'paid', 'free'))) AS STORE_PROD_CHRG
                      , MAX(DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', NULL, DECODE(JA.PROD_CHRG_YN, 'Y', 'paid', 'free'))) AS PLAY_PROD_CHRG
                      , MAX(DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', JA.USE_PERIOD_UNIT_CD)) AS STORE_USE_PERIOD_UNIT_CD
                      , MAX(DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', NULL, JA.USE_PERIOD_UNIT_CD)) AS PLAY_USE_PERIOD_UNIT_CD
                      , MAX(JA.PROD_ID) AS PROD_ID
                      , MAX(JA.PART_PROD_ID) AS PART_PROD_ID
                      , MAX(JA.SELLER_MBR_NO) AS SELLER_MBR_NO
                      , MAX(JA.EXPO_SELLER_NM) AS EXPO_SELLER_NM
                      , MAX(JA.EXPO_SELLER_TELNO) AS EXPO_SELLER_TELNO
                      , MAX(JA.EXPO_SELLER_EMAIL) AS EXPO_SELLER_EMAIL
                      , MAX(JA.CHNL_PROD_NM) AS CHNL_PROD_NM
                      , MAX(JA.ARTIST1_NM) AS ARTIST1_NM
                      , MAX(JA.ARTIST2_NM) AS ARTIST2_NM
                      , MAX(JA.CHNL_COMP_NM) AS CHNL_COMP_NM
                      , MAX(JA.GENRE_CD) AS GENRE_CD
                      , MAX(JA.GENRE_CD2) AS GENRE_CD2
                      , MAX(JA.COMPT_YN) AS COMPT_YN
                      , MAX(JA.PROD_NM) AS PROD_NM
                      , MAX(JA.META_CLSF_CD) AS META_CLSF_CD
                      , MAX(JA.BOOK_CLSF_CD) AS BOOK_CLSF_CD
                      , MAX(JA.MALL_CD) AS MALL_CD
                      , MAX(JA.USE_PERIOD_UNIT_CD) AS USE_PERIOD_UNIT_CD
                      , MAX(JA.USE_PERIOD) AS USE_PERIOD
                      , MAX(JA.SUB_CONTENTS_ID) AS SUB_CONTENTS_ID
                      , MAX(JA.PROD_GRD_CD) AS PROD_GRD_CD
                      , MAX(JA.PROD_VER) AS PROD_VER
                      , MAX(JA.FILE_SIZE) AS FILE_SIZE
                      , MAX(JA.FILE_PATH) AS FILE_PATH
                      , MAX(JA.BP_JOIN_FILE_NO) AS BP_JOIN_FILE_NO
                      , MAX(JA.ARTIST3_NM) AS ARTIST3_NM
                      , MAX(JA.PROD_BASE_DESC) AS PROD_BASE_DESC
                      , MAX(JA.PROD_DTL_DESC) AS PROD_DTL_DESC
                      , MAX(JA.BOOK_PAGE_CNT) AS BOOK_PAGE_CNT
                      , MAX(JA.CHAPTER) AS CHAPTER
                      , MAX(JA.COLOR_SPRT_YN) AS COLOR_SPRT_YN
                      , MAX(JA.ISBN) AS ISBN
                      , NVL(MAX(JA.MGZIN_COVER_YN), 'N') AS MGZIN_COVER_YN
                      , MAX(JA.ISSUE_DAY) AS ISSUE_DAY
                      , MAX(JA.TOP_MENU_ID) AS TOP_MENU_ID
                      , MAX(JA.MENU_ID) AS MENU_ID
                  FROM (SELECT IA.*, IC.TOP_MENU_ID, IC.MENU_ID
                          FROM (SELECT  ROW_NUMBER() OVER(PARTITION BY MP_E.PART_PROD_ID ORDER BY EP_M.PROD_VER DESC) AS RNUM
                                      , CH_A.PROD_ID
                                      , CH_A.SELLER_MBR_NO
                                      , CH_A.EXPO_SELLER_NM
                                      , CH_A.EXPO_SELLER_TELNO
                                      , CH_A.EXPO_SELLER_EMAIL
                                      , CH_B.PROD_NM AS CHNL_PROD_NM
                                      , CH_B.ARTIST1_NM
                                      , CH_B.ARTIST2_NM
                                      , CH_C.CHNL_COMP_NM
                                      , CH_C.GENRE_CD
                                      , CH_C.GENRE_CD2
                                      , CH_C.COMPT_YN
                                      , MP_E.PART_PROD_ID
                                      , EP_F.META_CLSF_CD
                                      , EP_F.PROD_GRD_CD
                                      , EP_F.CID
                                      , EP_F.DRM_YN
                                      , EP_F.USE_PERIOD_UNIT_CD
                                      , EP_F.USE_PERIOD
                                      , EP_F.PROD_CHRG_YN
                                      , EP_F.MALL_CD
                                      , EP_G.PROD_NM
                                      , EP_G.ARTIST3_NM
                                      , EP_G.PROD_BASE_DESC
                                      , EP_G.PROD_DTL_DESC
                                      , EP_H.BOOK_PAGE_CNT
                                      , EP_H.CHAPTER
                                      , EP_H.COLOR_SPRT_YN
                                      , EP_H.ISBN
                                      , EP_H.MGZIN_COVER_YN
                                      , EP_H.BOOK_CLSF_CD
                                      , EP_H.ISSUE_DAY
                                      , EP_I.PROD_STATUS_CD
                                      , EP_J.PROD_AMT
                                      , EP_J.PROD_NET_AMT
                                      , EP_M.SUB_CONTENTS_ID
                                      , EP_M.PROD_VER
                                      , EP_M.FILE_SIZE
                                      , EP_M.FILE_PATH
                                      , EP_M.BP_JOIN_FILE_NO
                                  FROM  TB_DP_PROD                    CH_A
                                      , TB_DP_PROD_DESC               CH_B
                                      , TB_DP_EBOOK_PROD              CH_C
                                      , TB_DP_TENANT_PROD             CH_D
                                      , TB_DP_PROD_RSHP               MP_E
                                      , TB_DP_PROD                    EP_F
                                      , TB_DP_PROD_DESC               EP_G
                                      , TB_DP_EBOOK_PROD              EP_H
                                      , TB_DP_TENANT_PROD             EP_I
                                      , TB_DP_TENANT_PROD_PRICE       EP_J
                                      , TB_DP_SPRT_DEVICE             EP_K
                                      , TB_CM_DEVICE                  EP_L
                                      , TB_DP_SUB_CONTENTS            EP_M
                                 WHERE  CH_A.PROD_ID = CH_B.PROD_ID
                                   AND  CH_A.PROD_ID = CH_C.PROD_ID
                                   AND  CH_A.PROD_ID = CH_D.PROD_ID
                                   AND  CH_A.PROD_ID = MP_E.PROD_ID
                                   AND  MP_E.PART_PROD_ID = EP_F.PROD_ID
                                   AND  MP_E.PART_PROD_ID = EP_G.PROD_ID
                                   AND  MP_E.PART_PROD_ID = EP_H.PROD_ID
                                   AND  MP_E.PART_PROD_ID = EP_I.PROD_ID
                                   AND  MP_E.PART_PROD_ID = EP_J.PROD_ID
                                   AND  EP_I.TENANT_ID = EP_J.TENANT_ID
                                   AND  MP_E.PART_PROD_ID = EP_K.PROD_ID 
                                   AND  MP_E.PART_PROD_ID = EP_M.PROD_ID
                                   AND  CH_A.SVC_GRP_CD = 'DP000203'
                                   AND  CH_A.CONTENTS_TYPE_CD = 'PD002501'
                                   AND  CH_B.LANG_CD = #{langCd}
                                   AND  CH_D.EXPO_YN = 'Y'
                                   AND  CH_D.TENANT_ID = #{tenantId}
                                   AND  CH_D.PROD_STATUS_CD IN ('PD000402', 'PD000403', 'PD000404')
                                   AND  MP_E.PROD_RSHP_CD = 'DP010802'
                                   AND  EP_F.SVC_GRP_CD = 'DP000203'
                                   AND  EP_F.CONTENTS_TYPE_CD = 'PD002502'
                                   AND  EP_G.LANG_CD = #{langCd}
                                   AND  EP_I.EXPO_YN = 'Y'
                                   AND  EP_I.TENANT_ID = #{tenantId}
                                   AND  EP_I.PROD_STATUS_CD IN ('PD000403', 'PD000404', 'PD000409')
                                   AND  EP_J.APPLY_END_DT = (SELECT MAX(APPLY_END_DT) /* ForDownload 판매기간체크 제거, 최종가격정보 조회를 위함 */
                                   						   FROM TB_DP_TENANT_PROD_PRICE PR
                                                          WHERE PR.TENANT_ID = EP_J.TENANT_ID
                                                            AND PR.PROD_ID = EP_J.PROD_ID)
                                   AND  (EP_K.DEVICE_MODEL_CD = #{deviceModelCd} OR EP_K.DEVICE_MODEL_CD = #{anyDeviceModelCd})
                                   AND  EP_L.DEVICE_MODEL_CD = #{deviceModelCd}
                                   AND  EP_L.EBOOK_SPRT_YN = 'Y'
                                   AND  EP_M.SALE_YN = 'Y'
                                   <if test='idType == "channel"'>
                                   AND  CH_A.PROD_ID = #{productId}
                                   </if>
                                   <if test='idType == "episode"'>
                                   AND  MP_E.PART_PROD_ID = #{productId}
                                   </if>
                               )                               IA
                               , TB_DP_MENU_CATEGORY_PROD_MAPG IB
                               , TB_DP_MENU_CATEGORY           IC
                         WHERE IA.PART_PROD_ID = IB.PROD_ID
                           AND IB.MENU_ID = IC.MENU_ID
                           AND IA.RNUM = 1
                           AND IB.USE_YN = 'Y'
                           AND IC.USE_YN = 'Y'
                           AND IC.TOP_MENU_ID = 'DP13'
                       ) JA
                 GROUP BY JA.CID
               )                KA 
               , TB_DP_PROD_IMG KB
         WHERE KA.PROD_ID = KB.PROD_ID(+)
           AND KB.EXPO_ORD(+) = 1
           AND KB.IMG_CD(+) = #{imageCd}
           AND KB.LANG_CD(+) = #{langCd}
           AND ROWNUM = 1
    </select>
    
    <!-- for download 대여 상품 구매상태 조회 -->
    <select id="getDownloadPurchaseState" parameterType="DownloadEbookSacReq" resultType="java.util.HashMap">
        SELECT  /* DownloadMapper.getDownloadPurchaseState, for download 대여 상품 구매상태 조회, 이태희/부르칸, 2014-03-17 */
                TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') AS SYS_DATE
              , CASE WHEN TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN #{dwldStartDt} AND #{dwldExprDt} THEN 'payment' ELSE 'expired' END AS PURCHASE_STATE
          FROM DUAL
    </select>
    
    <!-- Comic 상품 정보 조회(for download) -->
    <select id="selectDownloadComicInfo" parameterType="DownloadComicSacReq" resultType="MetaInfo">
        SELECT  /* DownloadMapper.selectDownloadComicInfo, Comic 상품 정보 조회, 이태희/부르칸, 2014-03-17 */
                JA.*
              , DECODE(JA.PROD_CHRG_YN, 'Y', 'paid', 'free') AS PROD_CHRG
              , FC_GET_IMAGE(JA.PART_PROD_ID, 'DP000194', #{langCd}) AS DLM_IMAGE_PATH
              , DECODE(JA.META_CLSF_CD, 'CT26', NVL(JA.MALL_CD, 'MM001308'), JA.MALL_CD) AS MALL_CD
              , CONCAT(JB.FILE_PATH, JB.FILE_NM) AS IMAGE_PATH
              , JB.FILE_SIZE AS IMAGE_SIZE
              , DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', JA.PART_PROD_ID) AS STORE_PROD_ID
              , DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', NULL, JA.PART_PROD_ID) AS PLAY_PROD_ID
			  , DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', JA.PROD_AMT) AS STORE_PROD_AMT
              , DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', NULL, JA.PROD_AMT) AS PLAY_PROD_AMT
              , DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', JA.PROD_NET_AMT) AS STORE_PROD_NET_AMT
              , DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', NULL, JA.PROD_NET_AMT) AS PLAY_PROD_NET_AMT
              , DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', JA.DRM_YN) AS STORE_DRM_YN
              , DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', NULL, JA.DRM_YN) AS PLAY_DRM_YN
              , DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', JA.USE_PERIOD_UNIT_CD) AS STORE_USE_PERIOD_UNIT_CD
              , DECODE(JA.USE_PERIOD_UNIT_CD, 'PD00310', NULL, JA.USE_PERIOD_UNIT_CD) AS PLAY_USE_PERIOD_UNIT_CD
              , CASE WHEN JA.USE_PERIOD_UNIT_CD != 'PD00310' THEN CONCAT(USE_PERIOD, (SELECT CD_NM FROM TB_CM_CD WHERE CD_ID = JA.USE_PERIOD_UNIT_CD AND LANG_CD = #{langCd}))
                     ELSE '' END AS USE_PERIOD_NM
              , (SELECT MENU_NM
                   FROM TB_DP_MENU_CATEGORY_DESC
                  WHERE MENU_ID = JA.TOP_MENU_ID
                    AND LANG_CD = #{langCd}
                    AND ROWNUM = 1) AS TOP_MENU_NM
              , (SELECT MENU_NM
                   FROM TB_DP_MENU_CATEGORY_DESC
                  WHERE MENU_ID = JA.MENU_ID
                    AND LANG_CD = #{langCd}
                    AND ROWNUM = 1) AS MENU_NM
          FROM (SELECT IA.*, IC.TOP_MENU_ID, IC.MENU_ID
                  FROM (SELECT  ROW_NUMBER() OVER(PARTITION BY MP_E.PART_PROD_ID ORDER BY EP_M.PROD_VER DESC) AS RNUM
                              , CH_A.PROD_ID
                              , CH_A.SELLER_MBR_NO
                              , CH_A.EXPO_SELLER_NM
                              , CH_A.EXPO_SELLER_TELNO
                              , CH_A.EXPO_SELLER_EMAIL
                              , CH_B.PROD_NM AS CHNL_PROD_NM
                              , CH_B.ARTIST1_NM
                              , CH_B.ARTIST2_NM
                              , CH_B.ARTIST3_NM
                              , CH_C.CHNL_COMP_NM
                              , MP_E.PART_PROD_ID
                              , EP_F.META_CLSF_CD
                              , EP_F.PROD_GRD_CD
                              , EP_F.DRM_YN
                              , EP_F.USE_PERIOD_UNIT_CD
                              , EP_F.USE_PERIOD
                              , EP_F.PROD_CHRG_YN
                              , EP_F.MALL_CD
                              , EP_G.PROD_NM
                              , EP_G.PROD_BASE_DESC
                              , EP_G.PROD_DTL_DESC
                              , EP_H.BOOK_PAGE_CNT
                              , EP_H.CHAPTER
                              , EP_H.COLOR_SPRT_YN
                              , EP_H.ISBN
                              , EP_H.ISSUE_DAY
                              , EP_H.GENRE_CD
                              , EP_H.GENRE_CD2
                              , EP_H.BOOK_CLSF_CD
                              , EP_H.COMPT_YN
                              , EP_J.PROD_AMT
                              , EP_J.PROD_NET_AMT
                              , EP_M.SUB_CONTENTS_ID
                              , EP_M.PROD_VER
                              , EP_M.FILE_SIZE
                              , EP_M.FILE_PATH
                          FROM  TB_DP_PROD              CH_A
                              , TB_DP_PROD_DESC         CH_B
                              , TB_DP_EBOOK_PROD        CH_C
                              , TB_DP_TENANT_PROD       CH_D
                              , TB_DP_PROD_RSHP         MP_E
                              , TB_DP_PROD              EP_F
                              , TB_DP_PROD_DESC         EP_G
                              , TB_DP_EBOOK_PROD        EP_H
                              , TB_DP_TENANT_PROD       EP_I
                              , TB_DP_TENANT_PROD_PRICE EP_J
                              , TB_DP_SPRT_DEVICE       EP_K
                              , TB_CM_DEVICE            EP_L
                              , TB_DP_SUB_CONTENTS      EP_M
                         WHERE  CH_A.PROD_ID = CH_B.PROD_ID
                           AND  CH_A.PROD_ID = CH_C.PROD_ID
                           AND  CH_A.PROD_ID = CH_D.PROD_ID
                           AND  CH_A.PROD_ID = MP_E.PROD_ID
                           AND  MP_E.PART_PROD_ID = EP_F.PROD_ID
                           AND  MP_E.PART_PROD_ID = EP_G.PROD_ID
                           AND  MP_E.PART_PROD_ID = EP_H.PROD_ID
                           AND  MP_E.PART_PROD_ID = EP_I.PROD_ID
                           AND  MP_E.PART_PROD_ID = EP_J.PROD_ID
                           AND  EP_I.TENANT_ID = EP_J.TENANT_ID
                           AND  MP_E.PART_PROD_ID = EP_K.PROD_ID
                           AND  MP_E.PART_PROD_ID = EP_M.PROD_ID
                           AND  CH_A.SVC_GRP_CD = 'DP000203'
                           AND  CH_A.CONTENTS_TYPE_CD = 'PD002501'
                           AND  CH_B.LANG_CD = #{langCd}
                           AND  CH_D.EXPO_YN = 'Y'
                           AND  CH_D.TENANT_ID = #{tenantId}
                           AND  CH_D.PROD_STATUS_CD IN ('PD000402', 'PD000403', 'PD000404')
                           AND  MP_E.PROD_RSHP_CD = 'DP010802'
                           AND  EP_F.SVC_GRP_CD = 'DP000203'
                           AND  EP_F.CONTENTS_TYPE_CD = 'PD002502'
                           AND  EP_G.LANG_CD = #{langCd}
                           AND  EP_I.EXPO_YN = 'Y'
                           AND  EP_I.TENANT_ID = #{tenantId}
                           AND  EP_I.PROD_STATUS_CD IN ('PD000403', 'PD000404', 'PD000409')
                           AND  EP_J.APPLY_END_DT = (SELECT MAX(APPLY_END_DT) /* ForDownload 판매기간체크 제거, 최종가격정보 조회를 위함 */
					                					   FROM TB_DP_TENANT_PROD_PRICE PR
					                                      WHERE PR.TENANT_ID = EP_J.TENANT_ID
					                                        AND PR.PROD_ID = EP_J.PROD_ID)
                           AND  (EP_K.DEVICE_MODEL_CD = #{deviceModelCd} OR EP_K.DEVICE_MODEL_CD = #{anyDeviceModelCd})
                           AND  EP_L.DEVICE_MODEL_CD = #{deviceModelCd}
                           AND  EP_L.COMIC_SPRT_YN = 'Y'
                           AND  EP_M.SALE_YN = 'Y'
                           AND  MP_E.PART_PROD_ID = #{productId}
                       )                               IA
                       , TB_DP_MENU_CATEGORY_PROD_MAPG IB
                       , TB_DP_MENU_CATEGORY           IC
                 WHERE IA.PART_PROD_ID = IB.PROD_ID
                   AND IB.MENU_ID = IC.MENU_ID
                   AND IA.RNUM = 1
                   AND IB.USE_YN = 'Y'
                   AND IC.USE_YN = 'Y'
                   AND IC.TOP_MENU_ID = 'DP14'
               )                JA
               , TB_DP_PROD_IMG JB
         WHERE JA.PROD_ID = JB.PROD_ID(+)
           AND JB.EXPO_ORD(+) = 1
           AND JB.IMG_CD(+) = #{imageCd}
           AND JB.LANG_CD(+) = #{langCd}
    </select>

    <select id="getDownloadMusicInfo" parameterType="DownloadMusicSacReq" resultType="MetaInfo">
        SELECT  /* DownloadMapper.getDownloadMusicInfo, 상품정보요청(for download) Music , 이석희/아이에스플러스, 2014-02-07 */
                TA.PROD_ID
              , TA.MUSIC_ID
              , TA.OUTSD_CONTENTS_ID
              , TA.PROD_NM
              , TA.PROD_GRD_CD
              , TA.ARTIST1_NM
              , TA.ARTIST2_NM
              , TA.ARTIST3_NM
              , TA.FILE_SIZE_H
              , TA.FILE_SIZE
              , TA.CHNL_PROD_ID
              , TA.MENU_ID
              , TA.MENU_NM
              , TA.TOP_MENU_ID
              , (SELECT MENU_NM 
                   FROM TB_DP_MENU_CATEGORY_DESC
                  WHERE MENU_ID = TA.TOP_MENU_ID
                    AND LANG_CD = #{langCd}
                    AND ROWNUM = 1) AS TOP_MENU_NM         
              , TA.META_CLSF_CD
              , TA.FILE_PATH
              , TA.PROD_AMT
              , CONCAT(TB.FILE_PATH, TB.FILE_NM)  AS IMAGE_PATH
              , TB.FILE_NM AS IMAGE_NM
              , TB.FILE_SIZE AS IMAGE_SIZE
              , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') AS SYS_DATE
          FROM
              (
              
                SELECT MAX(A.MENU_ID) AS MENU_ID
                     , MAX((SELECT MENU_NM FROM TB_DP_MENU_CATEGORY_DESC T WHERE T.MENU_ID = A.MENU_ID AND LANG_CD=#{langCd})) AS MENU_NM                           
                     , MAX(D.PROD_ID) AS CHNL_PROD_ID
                     , J.PROD_ID             
                     , MAX(J.PROD_GRD_CD) AS PROD_GRD_CD
                     , MAX(J.TOP_MENU_ID) AS TOP_MENU_ID             
                     , MAX(J.META_CLSF_CD) AS META_CLSF_CD
                     , MAX(M.FILE_PATH) AS FILE_PATH
                     , MAX(N.PROD_STATUS_CD) AS PROD_STATUS_CD
                     , MAX(P.OUTSD_CONTENTS_ID) AS OUTSD_CONTENTS_ID
                     , MAX(Q.ARTIST1_NM ) AS ARTIST1_NM
                     , MAX(Q.ARTIST2_NM ) AS ARTIST2_NM
                     , MAX(Q.ARTIST3_NM ) AS ARTIST3_NM
                     , MAX(DECODE( M.DP_PG_QULT_CD, 'PD009711', M.FILE_SIZE ) ) AS FILE_SIZE_H
                     , MAX(DECODE( M.DP_PG_QULT_CD, 'PD009712', M.FILE_SIZE ) ) AS FILE_SIZE                  
                     , MAX(Q.PROD_NM) AS PROD_NM
                     , MAX(R.MUSIC_ID) AS MUSIC_ID
                     , MAX(O.PROD_AMT) AS PROD_AMT
                  FROM TB_DP_MENU_CATEGORY_PROD_MAPG A
                     , TB_DP_MENU_CATEGORY           B
                     , TB_DP_PROD                    D
                     , TB_DP_TENANT_PROD             G
                     , TB_DP_PROD_RSHP               I
                     , TB_DP_PROD                    J
                     , TB_DP_SPRT_DEVICE             K
                     , TB_CM_DEVICE                  L
                     , TB_DP_SUB_CONTENTS            M
                     , TB_DP_TENANT_PROD             N
                     , TB_DP_TENANT_PROD_PRICE       O
                     , TB_DP_MUSIC_PROD              P
                     , TB_DP_PROD_DESC               Q
                     , TB_DP_CHART_PROD_MAPG         R
                 WHERE A.MENU_ID = B.MENU_ID
                   AND A.PROD_ID = D.PROD_ID
                   AND D.PROD_ID = G.PROD_ID                                                                              
                   AND D.PROD_ID = I.PROD_ID
                   AND I.PART_PROD_ID = J.PROD_ID
                   AND I.PART_PROD_ID = K.PROD_ID
                   AND I.PART_PROD_ID = M.PROD_ID
                   AND J.PROD_ID = N.PROD_ID
                   AND J.PROD_ID = O.PROD_ID  
                   AND N.TENANT_ID = #{tenantId}
                   AND N.TENANT_ID = O.TENANT_ID                                         
                   AND J.PROD_ID = P.PROD_ID
                   AND J.PROD_ID = Q.PROD_ID 
                   AND J.PROD_ID = R.PROD_ID                                    
                   --AND B.USE_YN = 'Y'                        /* Y : 사용 (사용여부) */
                   AND D.SVC_GRP_CD = 'DP000203'             /* DP000203 : 멀티미디어 */
                   AND D.CONTENTS_TYPE_CD = 'PD002501'       /* PD002501 : 채널타입 */
                   AND D.TOP_MENU_ID = 'DP16'
                   AND G.PROD_STATUS_CD IN ('PD000402', 'PD000403', 'PD000404') /* PD000402 : 판매대기 , PD000403 : 판매중, PD000404 : 판매중지 */
                   AND G.EXPO_YN = 'Y'                       /* Y : 노출 (노출여부) */   
                   AND G.TENANT_ID = #{tenantId}                                       
                   AND J.SVC_GRP_CD = 'DP000203'       /* PD002501 : 에피소드타입 */  
                   AND J.CONTENTS_TYPE_CD = 'PD002502'       /* PD002502 : 에피소드타입 */  
                   AND J.TOP_MENU_ID = 'DP16'
                   AND (K.DEVICE_MODEL_CD = #{deviceModelCd} OR K.DEVICE_MODEL_CD = #{anyDeviceModelCd})                                       
                   AND L.DEVICE_MODEL_CD = #{deviceModelCd} /* header param : 단말모델코드 */   
                   AND L.MUSIC_SPRT_YN ='Y'
                   AND L.USE_YN ='Y'
                   AND M.SALE_YN ='Y'                                       
                   AND N.PROD_STATUS_CD IN ('PD000403', 'PD000404', 'PD000409') /* PD000403 : 판매중, PD000404 : 판매중지, PD000409 : 판매불가-다운허용 */
                   AND N.EXPO_YN = 'Y'                       /* Y : 노출 (노출여부) */                                         
                   AND SYSDATE BETWEEN O.APPLY_START_DT AND O.APPLY_END_DT
				   AND O.APPLY_END_DT = (SELECT MAX(APPLY_END_DT) /* ForDownload 판매기간체크 제거, 최종가격정보 조회를 위함 */
					   						  FROM TB_DP_TENANT_PROD_PRICE PR
					                         WHERE PR.TENANT_ID = O.TENANT_ID
					                           AND PR.PROD_ID = O.PROD_ID)
                   AND Q.LANG_CD = #{langCd}                      /* ko : 한국어 */
                   AND J.PROD_ID = #{productId} /* 상품 ID(에피소드) */ 
                 GROUP BY J.PROD_ID
             ) TA  LEFT OUTER JOIN TB_DP_PROD_IMG TB 
               ON  TA.CHNL_PROD_ID = TB.PROD_ID
              AND  TB.EXPO_ORD = '1'
              AND  TB.LANG_CD = #{langCd}
              AND  TB.IMG_CD = #{imageCd}
    </select>

    <select id="getDownloadRingBellInfo" parameterType="DownloadMusicSacReq" resultType="MetaInfo">
        SELECT  /* DownloadMapper.getDownloadRingBellInfo, 상품정보요청(for download) Music , 정희원/SKP, 2014-07-10 */
            TA.PROD_ID
            , TA.MUSIC_ID
            , TA.PROD_NM
            , TA.PROD_GRD_CD
            , TA.ARTIST1_NM
            , TA.ARTIST2_NM
            , TA.ARTIST3_NM
            , TA.CHNL_PROD_ID
            , TA.MENU_ID
            , TA.MENU_NM
            , TA.TOP_MENU_ID
            , (SELECT MENU_NM
               FROM TB_DP_MENU_CATEGORY_DESC
               WHERE MENU_ID = TA.TOP_MENU_ID
                     AND LANG_CD = #{langCd}
                     AND ROWNUM = 1) AS TOP_MENU_NM
            , TA.META_CLSF_CD
            , TA.PROD_AMT
            , CONCAT(TB.FILE_PATH, TB.FILE_NM)  AS IMAGE_PATH
            , TB.FILE_NM AS IMAGE_NM
            , TB.FILE_SIZE AS IMAGE_SIZE
            , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') AS SYS_DATE
        FROM
            (
                SELECT MAX(A.MENU_ID) AS MENU_ID
                    , MAX((SELECT MENU_NM FROM TB_DP_MENU_CATEGORY_DESC T WHERE T.MENU_ID = A.MENU_ID AND LANG_CD=#{langCd})) AS MENU_NM
                    , MAX(D.PROD_ID) AS CHNL_PROD_ID
                    , EP.PROD_ID
                    , MAX(EP.PROD_GRD_CD) AS PROD_GRD_CD
                    , MAX(EP.TOP_MENU_ID) AS TOP_MENU_ID
                    , MAX(EP.META_CLSF_CD) AS META_CLSF_CD
                    , MAX(N.PROD_STATUS_CD) AS PROD_STATUS_CD
                    , MAX(P.OUTSD_CONTENTS_ID) AS MUSIC_ID
                    , MAX(Q.PROD_NM) AS PROD_NM
                    , MAX(O.PROD_AMT) AS PROD_AMT
                    , MAX(EMPD.ARTIST1_NM) AS ARTIST1_NM
                    , MAX(EMPD.ARTIST2_NM) AS ARTIST2_NM
                    , MAX(EMPD.ARTIST3_NM) AS ARTIST3_NM
                FROM TB_DP_MENU_CATEGORY_PROD_MAPG A
                    , TB_DP_MENU_CATEGORY           B
                    , TB_DP_PROD                    D
                    , TB_DP_TENANT_PROD             G
                    , TB_DP_PROD_RSHP               RSHP
                    , TB_DP_PROD                    EP
                    , TB_DP_SPRT_DEVICE             K
                    , TB_CM_DEVICE                  L
                    , TB_DP_TENANT_PROD             N
                    , TB_DP_TENANT_PROD_PRICE       O
                    , TB_DP_MUSIC_PROD              P
                    , TB_DP_PROD_DESC               Q
                    , TB_DP_PROD_RSHP RSHP2
                    , TB_DP_PROD EMP
                    , TB_DP_PROD_DESC EMPD
                WHERE A.MENU_ID = B.MENU_ID
                      AND A.PROD_ID = D.PROD_ID
                      AND D.PROD_ID = G.PROD_ID
                      AND D.PROD_ID = RSHP.PROD_ID
                      AND RSHP.PART_PROD_ID = EP.PROD_ID
                      AND RSHP.PART_PROD_ID = K.PROD_ID
                      AND EP.PROD_ID = N.PROD_ID
                      AND EP.PROD_ID = O.PROD_ID
                      AND N.TENANT_ID = #{tenantId}
                      AND N.TENANT_ID = O.TENANT_ID
                      AND RSHP.PROD_ID = P.PROD_ID
                      AND RSHP.PROD_ID = Q.PROD_ID
                      --AND B.USE_YN = 'Y'                        /* Y : 사용 (사용여부) */
                      AND D.SVC_GRP_CD = 'DP000203'             /* DP000203 : 멀티미디어 */
                      AND D.CONTENTS_TYPE_CD = 'PD002501'       /* PD002501 : 채널타입 */
                      AND G.PROD_STATUS_CD IN ('PD000402', 'PD000403', 'PD000404') /* PD000402 : 판매대기 , PD000403 : 판매중, PD000404 : 판매중지 */
                      AND G.EXPO_YN = 'Y'                       /* Y : 노출 (노출여부) */
                      AND G.TENANT_ID = #{tenantId}
                      AND EP.SVC_GRP_CD = 'DP000204'       /* PD002501 : 에피소드타입 */
                      AND EP.CONTENTS_TYPE_CD = 'PD002502'       /* PD002502 : 에피소드타입 */
                      AND (K.DEVICE_MODEL_CD = #{deviceModelCd} OR K.DEVICE_MODEL_CD = #{anyDeviceModelCd})
                      AND L.DEVICE_MODEL_CD = #{deviceModelCd} /* header param : 단말모델코드 */
                      AND L.MUSIC_SPRT_YN ='Y'
                      AND L.USE_YN ='Y'
                      AND N.PROD_STATUS_CD IN ('PD000403', 'PD000404', 'PD000409') /* PD000403 : 판매중, PD000404 : 판매중지, PD000409 : 판매불가-다운허용 */
                      AND N.EXPO_YN = 'Y'                       /* Y : 노출 (노출여부) */
				      AND O.APPLY_END_DT = (SELECT MAX(APPLY_END_DT) /* ForDownload 판매기간체크 제거, 최종가격정보 조회를 위함 */
					   						  FROM TB_DP_TENANT_PROD_PRICE PR
					                         WHERE PR.TENANT_ID = O.TENANT_ID
					                           AND PR.PROD_ID = O.PROD_ID)
                      AND Q.LANG_CD = #{langCd}                      /* ko : 한국어 */
                      AND EP.PROD_ID = #{productId} /* 상품 ID(에피소드) */
                      AND RSHP2.PROD_ID = RSHP.PROD_ID
                      AND EMP.PROD_ID = RSHP2.PART_PROD_ID
                      AND EMP.SVC_GRP_CD = 'DP000203'
                      AND EMP.PROD_ID = EMPD.PROD_ID
                      AND EMPD.LANG_CD = Q.LANG_CD
                GROUP BY EP.PROD_ID
            ) TA LEFT OUTER JOIN TB_DP_PROD_IMG TB
                ON  TA.CHNL_PROD_ID = TB.PROD_ID
                    AND  TB.EXPO_ORD = '1'
                    AND  TB.LANG_CD = #{langCd}
                    AND  TB.IMG_CD = #{imageCd}
    </select>
    
    
	<!-- 정액권 상품 정보 조회 -->
    <select id="selectFixrateProdInfo" parameterType="Map" resultType="MetaInfo">
		  SELECT  /* DownloadMapper.selectFixrateProdInfo, 정액권 상품 정보 조회, 임근대/SKP, 2014-09-02 */
		          a.prod_id as freepass_prod_id, a.part_prod_id as chnl_prod_id, b.part_prod_id as prod_id, 
		          a.dwld_drm_yn as store_drm_yn, a.strm_drm_yn as play_drm_yn
		    FROM  tb_dp_fixrate_prod_mapg a, tb_dp_prod_rshp b
		   WHERE  a.prod_id = #{fixrateProdId} /* 정액권 상품ID */
		     AND  a.part_prod_id = b.prod_id
		     AND  b.part_prod_id = #{prodId} /* 상품ID */

    </select>
    
</mapper>