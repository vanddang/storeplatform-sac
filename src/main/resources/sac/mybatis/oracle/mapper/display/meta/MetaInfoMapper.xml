<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="MetaInfo">
     <resultMap id="AppMetaInfoMap" type="MetaInfo" autoMapping="true">
         <association property="support" javaType="java.util.HashMap">
                 <result column="DRM_YN" property="drm" />
                 <result column="PART_PARENT_CLSF_CD" property="iab" />
         </association>
     </resultMap>
    <select id="getAppMetaInfo" parameterType="Map" resultType="MetaInfo">
        SELECT /* MetaInfoMapper.xml, getAppMetaInfo, SAC 전시, 2014-01-07 */
                TB.TOP_MENU_ID
              , TB.UP_MENU_ID
              , TB.MENU_ID
              , TB.MENU_NM
              , TB.PROD_ID
              , TB.PROD_ID AS PART_PROD_ID
              , TB.AID
              , TB.PROD_NM
              , TB.PROD_BASE_DESC
              , TB.PROD_AMT
              , TB.PROD_GRD_CD
              , DECODE( TB.PART_PARENT_CLSF_CD, 'PD012301', 'Y', 'N' ) AS PART_PARENT_CLSF_CD
              , TB.DRM_YN
              , TB.CONTENTS_TYPE_CD
              , TB.VER_MAJOR || '.' || TB.VER_MINOR AS PROD_VER
              , TB.APK_PKG_NM
              , TB.APK_VER
              , TB.FILE_SIZE
--              , TB.FILE_PATH
              , TB.IMAGE_PATH
              , TB.IMAGE_SIZE
              , NVL(TB.PATICPERS_CNT, 0) AS PATICPERS_CNT
              , NVL(TB.PRCHS_CNT, 0) AS PRCHS_CNT
                <![CDATA[       
              , NVL((CASE WHEN (TB.AVG_EVLU_SCORE > 0 AND TB.AVG_EVLU_SCORE < 1) THEN 1
                          WHEN TB.AVG_EVLU_SCORE > 5 THEN 5
                          ELSE ROUND(TB.AVG_EVLU_SCORE, 1) END), 0) AS AVG_EVLU_SCORE
               ]]>            
              , (SELECT MENU_NM
                   FROM TB_DP_MENU_CATEGORY_DESC
                  WHERE MENU_ID = TB.TOP_MENU_ID
                    AND LANG_CD = #{tenantHeader.langCd}
                    AND ROWNUM = 1) AS TOP_MENU_NM
              , TB.PROD_DTL_DESC
              , TB.MENU_DESC
              , TB.PROD_STATUS_CD
              , TB.PROD_CHRG_YN AS PROD_CHRG
          FROM (SELECT  A.TOP_MENU_ID
                      , A.UP_MENU_ID
                      , A.MENU_ID
                      , B.PROD_ID
                      , C.MENU_NM
                      , C.MENU_DESC
                      , D.PROD_CHRG_YN
                      , D.PROD_GRD_CD
                      , D.DRM_YN
                      , D.REG_DT
                      , D.CONTENTS_TYPE_CD
                      , E.AID
                      , E.VER_MAJOR
                      , E.VER_MINOR
                      , E.PART_PARENT_CLSF_CD
                      , F.PROD_NM
                      , F.PROD_BASE_DESC
                      , G.TENANT_ID
                      , H.PROD_AMT
                      , I.SUB_CONTENTS_ID
                      , J.APK_PKG_NM
                      , J.APK_VER
                      , J.FILE_SIZE
--                      , J.FILE_PATH
                      , K.FILE_PATH AS IMAGE_PATH
                      , K.FILE_SIZE AS IMAGE_SIZE
                      , L.PATICPERS_CNT
                      , L.PRCHS_CNT
                      , L.AVG_EVLU_SCORE
                      , F.PROD_DTL_DESC
                      , G.PROD_STATUS_CD
                  FROM  TB_DP_MENU_CATEGORY           A
                      , TB_DP_MENU_CATEGORY_PROD_MAPG B
                      , TB_DP_MENU_CATEGORY_DESC      C
                      , TB_DP_PROD                    D
                      , TB_DP_APP_PROD                E
                      , TB_DP_PROD_DESC               F
                      , TB_DP_TENANT_PROD             G
                      , TB_DP_TENANT_PROD_PRICE       H
                      , TB_DP_SPRT_DEVICE             I
                      , TB_DP_SUB_CONTENTS            J
                      , TB_DP_PROD_IMG                K
                      , TB_DP_TENANT_PROD_STATS       L
                 WHERE  A.MENU_ID = B.MENU_ID
                   AND  A.MENU_ID = C.MENU_ID
                   AND  B.PROD_ID = D.PROD_ID
                   AND  B.PROD_ID = E.PROD_ID
                   AND  B.PROD_ID = F.PROD_ID
                   AND  B.PROD_ID = G.PROD_ID
                   AND  G.TENANT_ID = H.TENANT_ID
                   AND  B.PROD_ID = H.PROD_ID
                   AND  B.PROD_ID = I.PROD_ID
                   AND  B.PROD_ID = J.PROD_ID
                   AND  I.SUB_CONTENTS_ID = J.SUB_CONTENTS_ID
                   AND  B.PROD_ID = K.PROD_ID(+)
                   AND  G.TENANT_ID = L.TENANT_ID(+)
                   AND  G.PROD_ID = L.PROD_ID(+)
                   AND  A.USE_YN = 'Y'                                    /* Y : 사용 (사용여부) */
                   AND  B.USE_YN = 'Y'                                    /* Y : 사용 (사용여부) */
                   AND  C.LANG_CD = #{tenantHeader.langCd}                /* ko : 한국어 */
                   <if test='productBasicInfo.svcGrpCd != null'>
                   AND  D.SVC_GRP_CD = #{productBasicInfo.svcGrpCd}       /* DP000201 : 애플리캐이션 */
                   </if>
                   AND  F.LANG_CD = #{tenantHeader.langCd}                /* ko : 한국어 */
                   <if test='prodStatusCd != null'>
                   AND  G.PROD_STATUS_CD = #{prodStatusCd}                /* PD000403 : 판매중 */
                   </if>
                   AND  G.EXPO_YN = 'Y'                 /* Y : 노출 (노출여부) */
                   AND  SYSDATE BETWEEN H.APPLY_START_DT AND H.APPLY_END_DT
                   AND  K.IMG_CD(+) = #{imageCd}           /* 이미지코드 */
                   AND  K.EXPO_ORD (+)= 1                  /* 노출순서 */
                   AND  K.LANG_CD(+) = #{tenantHeader.langCd}                /* ko : 한국어 */
                   -----------------------------------------------------------------------------
                   -- INPUT PARAMETER
                   -----------------------------------------------------------------------------
                   <if test='productBasicInfo.menuId != null'>
                   AND  A.MENU_ID = #{productBasicInfo.menuId}            /* 메뉴ID */
                   </if>
                   AND  B.PROD_ID = #{productBasicInfo.prodId}            /* 상품ID */
                   AND  G.TENANT_ID = #{tenantHeader.tenantId}            /* 테넌트ID */
                   AND  I.DEVICE_MODEL_CD = #{deviceHeader.model}         /* 단말모델코드 */
                   AND ROWNUM = 1
       ) TB
    </select>
    <select id="getVODMetaInfo" parameterType="Map" resultType="MetaInfo">
        SELECT /* MetaInfoMapper.xml, getVODMetaInfo, SAC 전시, 2014-01-07 */
		       A1.UP_MENU_ID
		     , A1.TOP_MENU_ID
		     , A1.MENU_ID
		     , A1.MENU_NM
		     , A1.MENU_DESC
		     , A1.META_CLSF_CD
		     , A1.COMPT_YN
	 	     , #{productBasicInfo.contentsTypeCd} as CONTENTS_TYPE_CD
	 	     , A1.PROD_ID
	 	     , A1.PART_PROD_ID
	 	     , A1.VOD_TITL_NM
	 	     , A1.PROD_NM
	 	     , A1.CHAPTER /* 회차의 수 */
	 	     , A1.SAMPL_URL
	 	     , A1.SC_SAMPL_URL
	 	     , A1.PROD_BASE_DESC
	 	     , A1.PROD_GRD_CD
	 	     , A1.ARTIST1_NM
	 	     , A1.ARTIST2_NM
		     , A1.ISSUE_DAY
		     , A1.CHNL_COMP_NM
		     , A1.AGENCY_NM
		     , NVL(A1.HDV_YN, 'N') AS HDV_YN
		     , NVL(A1.DOLBY_SPRT_YN, 'N') AS DOLBY_SPRT_YN
		     , A1.EXPO_SELLER_EMAIL
		     , A1.EXPO_SELLER_NM
		     , A1.EXPO_SELLER_TELNO
		     , ( CASE WHEN A1.EPSD_CNT > 0 THEN 'Y' END ) AS SUPPORT_STORE
		     , ( CASE WHEN A1.STRM_EPSD_CNT > 0 THEN 'Y' END ) AS SUPPORT_PLAY
		     <if test='productBasicInfo.contentsTypeCd == "PD002501"'>
		     , CASE WHEN (A1.CHNL_PERIOD_AMT >= 0  AND A1.STRM_EPSD_CNT > 0) THEN CHNL_PERIOD_AMT
		            ELSE NVL(A1.CHNL_UNLMT_AMT, 0) 
		        END AS PROD_AMT  /* 채널 대표 가격 */
		     </if>
		     <if test='productBasicInfo.contentsTypeCd == "PD002502"'>
		     , NVL(A1.PROD_AMT, 0) AS PROD_AMT  /* 에피소드 가격 */
		     </if>
		     , A1.PROD_NET_AMT
		     , A1.PROD_CHRG_YN AS PROD_CHRG
		     , NVL(A1.PATICPERS_CNT, 0) AS PATICPERS_CNT
		     , NVL(A1.PRCHS_CNT, 0) AS PRCHS_CNT
		     <![CDATA[             
		     , NVL((CASE WHEN (A1.AVG_EVLU_SCORE > 0 AND A1.AVG_EVLU_SCORE < 1) THEN 1
		                 WHEN A1.AVG_EVLU_SCORE > 5 THEN 5
		                 ELSE ROUND(A1.AVG_EVLU_SCORE, 1) 
		             END), 0) AS AVG_EVLU_SCORE
		     ]]>
		     , A1.FILE_PATH || A1.FILE_NM AS FILE_PATH
		     , A1.TOP_MENU_NM
		     , A1.FILE_SIZE
		     , A1.PROD_DTL_DESC
		     , A1.PROD_STATUS_CD
		     , FC_GET_CM_CD_NM(A1.BRDC_COMP_CD, #{tenantHeader.langCd}) AS BRDC_COMP_NM
		  FROM (SELECT A.PROD_ID
		             , A.PART_PROD_ID
		             , B.PROD_GRD_CD
		             , B.USE_PERIOD_UNIT_CD
		             , B.META_CLSF_CD
		             , B.CONTENTS_TYPE_CD
		             , B.EXPO_SELLER_EMAIL
		             , B.EXPO_SELLER_NM
		             , B.EXPO_SELLER_TELNO
		             , B.DRM_YN
		             , C.PROD_NM
		             , C.ARTIST1_NM
		             , C.ARTIST2_NM
		             , C.PROD_BASE_DESC
		             , C.PROD_DTL_DESC
		             , D.COMPT_YN
		             , D.VOD_TITL_NM
		             , D.STRM_EPSD_CNT
		             , D.EPSD_CNT
		             , D.CHNL_COMP_NM
		             , D.AGENCY_NM
		             , D.HDV_YN
		             , D.DOLBY_SPRT_YN
		             , D.BRDC_COMP_CD
		             , E.TENANT_ID
		             , E.PROD_STATUS_CD
		             , F.CHNL_PERIOD_AMT
		             , F.CHNL_UNLMT_AMT
		             , G.AVG_EVLU_SCORE
		             , G.PATICPERS_CNT
		             , G.PRCHS_CNT
		             , H.FILE_PATH
		             , H.FILE_NM
		             , H.FILE_SIZE
		             , I.PROD_CHRG_YN
		             , J.CHAPTER
		             , J.SAMPL_URL
		             , J.SC_SAMPL_URL
		             , J.ISSUE_DAY
		             , L.PROD_AMT
		             , L.PROD_NET_AMT
		             , M.MENU_ID
		             , N.UP_MENU_ID
		             , N.TOP_MENU_ID
		             , O.MENU_NM
		             , O.MENU_DESC
		             , P.MENU_NM AS TOP_MENU_NM
		          FROM TB_DP_PROD_RSHP A
		             , TB_DP_PROD B  /* 채널 */
		             , TB_DP_PROD_DESC C  /* 채널 */
		             , TB_DP_VOD_PROD D  /* 채널 */
		             , TB_DP_TENANT_PROD E  /* 채널 */
		             , TB_DP_TENANT_PROD_PRICE F  /* 채널 */
		             , TB_DP_TENANT_PROD_STATS G  /* 채널 */
		             , TB_DP_PROD_IMG H  /* 채널 */
		             , TB_DP_PROD I  /* 에피소드 */
		             , TB_DP_VOD_PROD J  /* 에피소드 */
		             , TB_DP_TENANT_PROD K  /* 에피소드 */
		             , TB_DP_TENANT_PROD_PRICE L  /* 에피소드 */
		             , TB_DP_MENU_CATEGORY_PROD_MAPG M  /* 에피소드 */
		             , TB_DP_MENU_CATEGORY N
		             , TB_DP_MENU_CATEGORY_DESC O  /* 에피소드 */
		             , TB_DP_MENU_CATEGORY_DESC P  /* 채널 */
		         WHERE A.PROD_RSHP_CD = 'DP010802'
		           <if test='productBasicInfo.contentsTypeCd == "PD002501"'>
		           AND A.PROD_ID = #{productBasicInfo.prodId}  /* 채널 ID */
		           </if>
		           <if test='productBasicInfo.contentsTypeCd == "PD002502"'>
		           AND A.PART_PROD_ID = #{productBasicInfo.partProdId}  /* 에피소드 ID */
		           </if>
		           AND A.PROD_ID = B.PROD_ID
		           AND B.CONTENTS_TYPE_CD = 'PD002501'
		           AND B.PROD_ID = C.PROD_ID
		           AND C.LANG_CD = #{tenantHeader.langCd}
		           AND C.PROD_ID = D.PROD_ID
		           AND D.PROD_ID = E.PROD_ID
		           AND E.TENANT_ID = #{tenantHeader.tenantId}
		           <if test='prodStatusCd != null'>
		           AND E.PROD_STATUS_CD = #{prodStatusCd}  /* PD000403 : 판매중 */
		           </if>
		           AND E.EXPO_YN = 'Y'
		           AND E.TENANT_ID = F.TENANT_ID
		           AND E.PROD_ID = F.PROD_ID
		           AND SYSDATE BETWEEN F.APPLY_START_DT AND F.APPLY_END_DT
		           AND F.PROD_ID = G.PROD_ID(+)
		           AND F.TENANT_ID = G.TENANT_ID(+)
		           AND B.PROD_ID = H.PROD_ID(+)
		           AND #{imageCd} = H.IMG_CD(+)
                   AND #{tenantHeader.langCd} = H.LANG_CD(+)
		           AND A.PART_PROD_ID = I.PROD_ID
		           AND I.CONTENTS_TYPE_CD = 'PD002502'
		           AND I.PROD_ID = J.PROD_ID
		           AND J.PROD_ID = K.PROD_ID
		           AND K.TENANT_ID = #{tenantHeader.tenantId}
		           <if test='prodStatusCd != null'>
		           AND K.PROD_STATUS_CD = #{prodStatusCd}  /* PD000403 : 판매중 */
		           </if>
		           AND K.EXPO_YN = 'Y'
		           AND K.PROD_ID = L.PROD_ID
		           AND K.TENANT_ID = L.TENANT_ID
		           AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
		           AND L.PROD_ID = M.PROD_ID
		           AND M.USE_YN = 'Y'
		           AND M.MENU_ID = N.MENU_ID
		           AND N.USE_YN = 'Y'
		           AND M.MENU_ID = O.MENU_ID
		           AND O.LANG_CD = #{tenantHeader.langCd}
		           AND N.TOP_MENU_ID = P.MENU_ID
		           AND P.LANG_CD = #{tenantHeader.langCd}
		         ORDER BY J.CHAPTER DESC, I.REG_DT DESC
		       ) A1
		 WHERE ROWNUM = 1
    </select>
    
    <select id="getMusicMetaInfo" parameterType="Map" resultType="MetaInfo">
       SELECT /* MetaInfoMapper.xml, getMusicMetaInfo, SAC 전시, 2014-01-07 */
              CP.PROD_ID 
            , CP.PART_PROD_ID
            , C.MENU_ID
            , CD.MENU_NM
            , CD.MENU_DESC
            , C.TOP_MENU_ID
            , CD2.MENU_NM AS TOP_MENU_NM
            , CD2.MENU_DESC AS TOP_MENU_DESC
            , MP.OUTSD_CONTENTS_ID -- 외부_컨텐츠_ID
            , PD.PROD_NM
            , PD.PROD_DTL_DESC
            , TPP.PROD_AMT
            , P.PROD_GRD_CD
            , P.META_CLSF_CD
            , PD.ARTIST1_NM
            , PD.ARTIST2_NM
            , PD.ARTIST3_NM                        
            , MP.CHNL_COMP_NM
            , MP.AGENCY_NM
            , MP.ISSUE_DAY
            , 'Y' AS MP3_SPRT_YN
            , MP.BELL_SPRT_YN
            , MP.COLORRING_SPRT_YN
            , CONCAT(PI.FILE_PATH, PI.FILE_NM) AS FILE_PATH
            , PI.FILE_NM
            , PI.FILE_SIZE
            , P.CONTENTS_TYPE_CD
            , TP.PROD_STATUS_CD
            , PD.PROD_BASE_DESC
            , NVL(PS.PATICPERS_CNT, 0) AS PATICPERS_CNT
            , NVL(PS.PRCHS_CNT, 0) AS PRCHS_CNT
            <![CDATA[       
            , NVL((CASE WHEN (PS.AVG_EVLU_SCORE > 0 AND PS.AVG_EVLU_SCORE < 1) THEN 1
                        WHEN PS.AVG_EVLU_SCORE > 5 THEN 5
                        ELSE ROUND(PS.AVG_EVLU_SCORE, 1) 
                    END)
                 , 0) AS AVG_EVLU_SCORE
            ]]>  
          <if test='chartClsfCd != null and chartClsfCd != ""'>
            , MCI.RANK_CHG_CNT
            , MCI.RANK_CHG_CLSF_CD
            , (SELECT DA.ARTIST_ID FROM TB_DP_ARTIST DA WHERE DA.ARTIST_ID = MCI.ARTIST_ID AND ROWNUM = 1) AS ARTIST_ID
            , TO_CHAR(MCI.REG_DT, 'YYYYMMDDHH24MISS') AS REG_DT
          </if>
          <if test='chartClsfCd == null or chartClsfCd == ""'>
            , (SELECT DA.ARTIST_ID FROM TB_DP_ARTIST DA WHERE DA.ARTIST_ID = PD.ARTIST1_ID AND ROWNUM = 1) AS ARTIST_ID
          </if>
         FROM TB_DP_MUSIC_PROD MP
          <if test='chartClsfCd != null and chartClsfCd != ""'>
            , TB_DP_MUSIC_CHART MCI
          </if>
            , TB_DP_PROD P
            , TB_DP_PROD_DESC PD
            , TB_DP_PROD_RSHP CP
            , TB_DP_TENANT_PROD TP
            , TB_DP_TENANT_PROD_PRICE TPP
            , TB_DP_MENU_CATEGORY_PROD_MAPG CPM
            , TB_DP_MENU_CATEGORY C
            , TB_DP_MENU_CATEGORY_DESC CD
            , TB_DP_MENU_CATEGORY_DESC CD2
            , TB_DP_MUSIC_PROD MP2
            , TB_DP_PROD P2
            , TB_DP_TENANT_PROD TP2
            , TB_DP_PROD_IMG PI
            , TB_DP_TENANT_PROD_STATS PS
        WHERE MP.PROD_ID = CP.PART_PROD_ID
          AND P.PROD_ID = CP.PART_PROD_ID
          <if test='chartClsfCd != null and chartClsfCd != ""'>
          AND MCI.PROD_ID = CP.PART_PROD_ID -- EPISODE PROD ID
          </if>
          AND CPM.PROD_ID = CP.PART_PROD_ID
          AND C.MENU_ID = CPM.MENU_ID
          AND CD.MENU_ID = C.MENU_ID
          AND CD2.MENU_ID = C.TOP_MENU_ID
          AND CD2.LANG_CD = CD.LANG_CD
          AND P2.PROD_ID = CP.PROD_ID -- CHANNEL PROD ID
          AND P2.META_CLSF_CD = P.META_CLSF_CD
          AND TP2.PROD_ID = P2.PROD_ID
          AND TP2.TENANT_ID = TP.TENANT_ID
          AND TP2.PROD_STATUS_CD = TP.PROD_STATUS_CD
          AND TP2.EXPO_YN = TP.EXPO_YN
          AND MP2.PROD_ID = P2.PROD_ID
          AND TP.PROD_ID = P.PROD_ID
          AND TPP.PROD_ID = TP.PROD_ID
          AND TPP.TENANT_ID = TP.TENANT_ID
          AND PD.PROD_ID = P.PROD_ID
          AND PI.PROD_ID(+) = CP.PROD_ID
          <if test='chartClsfCd != null and chartClsfCd != ""'>
       -----------------------------------------------------------------------------
       -- 차트 정보 조건절 START
       -- ( 멜론 TOP 100 : CHART_CLSF_CD = DP004901, BATCH_ID = MELON_DP004901 )
       -- ( 최신    음악 : CHART_CLSF_CD = DP004904, BATCH_ID = MELON_DP004904 )
       ----------------------------------------------------------------------------- 
          AND MCI.CHART_CLSF_CD = #{chartClsfCd} -- 멜론 TOP 100
          AND MCI.RANK_START_DAY = #{stdDt}
       -----------------------------------------------------------------------------
       -- 차트 정보 조건절 END
       ----------------------------------------------------------------------------- 
          </if>
          <if test='prodStatusCd != null'>
          AND TP.PROD_STATUS_CD = #{prodStatusCd}   -- 판매중
          </if>
          AND TP.EXPO_YN = 'Y'                 -- 노출 여부
          AND P2.CONTENTS_TYPE_CD = 'PD002501' -- 채널
          AND P.CONTENTS_TYPE_CD = 'PD002502'  -- 에피소드
          <if test='productBasicInfo.metaClsfCd != null'>
          AND P.META_CLSF_CD = #{productBasicInfo.metaClsfCd}          -- 통합 뮤직
          </if>
          AND CPM.USE_YN = 'Y'
          AND C.USE_YN = 'Y'
       -----------------------------------------------------------------------------
       -- INPUT PARAMETER
       ----------------------------------------------------------------------------- 
          <if test='productBasicInfo.contentsTypeCd == "PD002501"'>
            AND CP.PROD_ID = #{productBasicInfo.prodId}
          </if>
          <if test='productBasicInfo.contentsTypeCd == "PD002502"'>
            AND CP.PART_PROD_ID = #{productBasicInfo.partProdId}
          </if>
          AND P.TOP_MENU_ID = #{productBasicInfo.topMenuId}
          AND PI.IMG_CD(+) = #{imageCd}
          AND TP.TENANT_ID = #{tenantHeader.tenantId}
          AND PD.LANG_CD = #{tenantHeader.langCd}
          AND CD.LANG_CD = #{tenantHeader.langCd}
          AND TP2.PROD_ID = PS.PROD_ID(+)
          AND TP2.TENANT_ID = PS.TENANT_ID(+)
          AND ROWNUM = 1
    </select>
    
    <select id="getEbookComicMetaInfo" parameterType="Map" resultType="MetaInfo">
       SELECT /* MetaInfoMapper.xml, getEbookComicMetaInfo, SAC 전시, 2014-01-07 */
               TB.UP_MENU_ID
             , (SELECT MENU_NM
                  FROM TB_DP_MENU_CATEGORY_DESC
                 WHERE MENU_ID = TB.TOP_MENU_ID
                   AND LANG_CD = #{tenantHeader.langCd}
                   AND ROWNUM = 1) AS TOP_MENU_NM
             , TB.TOP_MENU_ID
             , TB.MENU_ID
             , TB.MENU_NM
             , TB.MENU_DESC
             , TB.META_CLSF_CD
             , TB.PROD_ID
             , TB.PART_PROD_ID
             , #{productBasicInfo.contentsTypeCd} as CONTENTS_TYPE_CD
             , TB.PROD_NM
             , TB.CHAPTER
             , TB.BOOK_CLSF_CD
             , CASE WHEN TB.TOP_MENU_ID = 'DP13' -- 이북은 상품기본설명 컬럼 위치가 다름
                    THEN TB.PROD_DTL_DESC
                    ELSE TB.PROD_BASE_DESC
               END AS PROD_BASE_DESC
             , CASE WHEN TB.TOP_MENU_ID = 'DP13' -- 이북은 상품상세설명 컬럼 위치가 다름
                    THEN TB.PROD_BASE_DESC
                    ELSE TB.PROD_DTL_DESC
               END AS PROD_DTL_DESC
             , TB.PROD_GRD_CD
             , TB.ARTIST1_NM
             , TB.ARTIST2_NM
             , TB.ARTIST3_NM
             , TB.ISSUE_DAY
             , TB.CHNL_COMP_NM
             , ( CASE WHEN TB.META_CLSF_CD IN ( 'CT20', 'CT21' ) THEN 'serial' END ) AS BOOK_TYPE
             , ( CASE WHEN TB.META_CLSF_CD IN ( 'CT20', 'CT21' ) THEN ( TB.EPSD_CNT + TB.STRM_EPSD_CNT ) ELSE 1 END ) AS BOOK_COUNT
             , ( CASE WHEN TB.EPSD_CNT > 0 THEN 'Y' END ) AS SUPPORT_STORE
             , ( CASE WHEN TB.STRM_EPSD_CNT > 0 THEN 'Y' END ) AS SUPPORT_PLAY
             , TB.COMPT_YN
             , ( CASE WHEN TB.META_CLSF_CD IN ( 'CT20', 'CT21' ) THEN DECODE( TB.COMPT_YN, 'Y', 'completed', 'continue' ) END ) AS BOOK_STATUS                          
           <if test='productBasicInfo.contentsTypeCd == "PD002501"'>
             , CASE WHEN (TB.CHNL_UNLMT_AMT >= 0  AND TB.EPSD_CNT > 0) THEN CHNL_UNLMT_AMT
                    ELSE NVL(TB.CHNL_PERIOD_AMT, 0) END AS PROD_AMT /* 채널 대표 가격 - 소장 있으면 소장 가격, 소장 없으면 대여 가격 */
             , CASE WHEN (TB.CHNL_UNLMT_AMT >= 0  AND TB.EPSD_CNT > 0) THEN TB.CHNL_UNLMT_AMT END AS UNLMT_AMT  /* 채널 소장 가격 */
             , CASE WHEN (TB.CHNL_PERIOD_AMT >= 0 AND TB.STRM_EPSD_CNT > 0) THEN TB.CHNL_PERIOD_AMT END AS PERIOD_AMT  /* 채널 대여 가격 */
           </if>
           <if test='productBasicInfo.contentsTypeCd == "PD002502"'>
             , NVL(TB.PROD_AMT, 0) AS PROD_AMT  /* 에피소드 가격 */
             , (SELECT MAX(SC.PROD_AMT)
                  FROM TB_DP_PROD_RSHP SA
                     , TB_DP_PROD SB
                     , TB_DP_TENANT_PROD_PRICE SC
                     , TB_DP_TENANT_PROD SD
                 WHERE SA.PROD_ID = TB.PROD_ID
                   AND SA.PROD_RSHP_CD = 'DP010802'
                   AND SA.PART_PROD_ID = SB.PROD_ID
                   AND SB.CID = TB.CID
                   AND SB.PROD_ID = SC.PROD_ID
                   AND SB.CONTENTS_TYPE_CD = 'PD002502'
                   AND SC.TENANT_ID = #{tenantHeader.tenantId}
                   AND SYSDATE BETWEEN SC.APPLY_START_DT AND SC.APPLY_END_DT
                   AND SC.PROD_ID = SD.PROD_ID
                   AND SD.TENANT_ID = #{tenantHeader.tenantId}
                   AND SD.PROD_STATUS_CD = 'PD000403'
                   AND SB.USE_PERIOD_UNIT_CD = 'PD00310'
               ) AS UNLMT_AMT  /* 에피소드 동일 CID 소장 가격 */
             , (SELECT MAX(SC.PROD_AMT)
                  FROM TB_DP_PROD_RSHP SA
                     , TB_DP_PROD SB
                     , TB_DP_TENANT_PROD_PRICE SC
                     , TB_DP_TENANT_PROD SD
                 WHERE SA.PROD_ID = TB.PROD_ID
                   AND SA.PROD_RSHP_CD = 'DP010802'
                   AND SA.PART_PROD_ID = SB.PROD_ID
                   AND SB.CID = TB.CID
                   AND SB.PROD_ID = SC.PROD_ID
                   AND SB.CONTENTS_TYPE_CD = 'PD002502'
                   AND SC.TENANT_ID = #{tenantHeader.tenantId}
                   AND SYSDATE BETWEEN SC.APPLY_START_DT AND SC.APPLY_END_DT
                   AND SC.PROD_ID = SD.PROD_ID
                   AND SD.TENANT_ID = #{tenantHeader.tenantId}
                   AND SD.PROD_STATUS_CD = 'PD000403'
                   AND SB.USE_PERIOD_UNIT_CD != 'PD00310'
               ) AS PERIOD_AMT  /* 에피소드 동일 CID 대여 가격 */
           </if>
             , NVL(TB.PROD_NET_AMT, 0) AS PROD_NET_AMT
             , NVL(TB.PATICPERS_CNT, 0) AS PATICPERS_CNT
             , NVL(TB.PRCHS_CNT, 0) AS DWLD_CNT
             , NVL(TB.PRCHS_CNT, 0) AS PRCHS_CNT
              <![CDATA[
             , NVL((CASE WHEN (TB.AVG_EVLU_SCORE > 0 AND TB.AVG_EVLU_SCORE < 1) THEN 1
                         WHEN TB.AVG_EVLU_SCORE > 5 THEN 5
                         ELSE ROUND(TB.AVG_EVLU_SCORE, 1) END), 0) AS AVG_EVLU_SCORE
             ]]>
             , TB.PROD_CHRG_YN AS PROD_CHRG
             , TB.FILE_PATH || TB.FILE_NM AS FILE_PATH
             , TB.PROD_STATUS_CD
          FROM (
                 SELECT 
                        ROW_NUMBER( ) OVER ( PARTITION BY B.PROD_ID
                                                 ORDER BY DECODE( L.BOOK_CLSF_CD, E.BOOK_CLSF_CD, 1, 2 )
                                                        , L.CHAPTER DESC
                                                        , NVL( J.USE_PERIOD_UNIT_CD, 'PD00310' ) DESC
                                                        , J.LAST_DEPLOY_DT DESC ) AS RN
                      , A.UP_MENU_ID
                      , A.TOP_MENU_ID                                                             
                      , A.MENU_ID
                      , B.PROD_ID
                      , I.PART_PROD_ID                                     
                      , C.MENU_NM
                      , C.MENU_DESC
                      , D.PROD_GRD_CD
                      , D.USE_PERIOD_UNIT_CD
                      , D.META_CLSF_CD
                      , D.CONTENTS_TYPE_CD
                      , E.STRM_EPSD_CNT
                      , E.ISSUE_DAY
                      , E.CHNL_COMP_NM
                      , E.EPSD_CNT
                      , E.COMPT_YN
                      , F.PROD_NM
                      , F.ARTIST1_NM
                      , F.ARTIST2_NM
                      , F.ARTIST3_NM
                      , F.PROD_BASE_DESC
                      , F.PROD_DTL_DESC
                      , H.CHNL_PERIOD_AMT
                      , H.CHNL_UNLMT_AMT
                      , J.DRM_YN
                      , J.PROD_CHRG_YN
                      , L.CHAPTER
                      , L.BOOK_CLSF_CD
                      , M.FILE_PATH
                      , M.FILE_NM
                      , N.PATICPERS_CNT
                      , N.PRCHS_CNT
                      , N.AVG_EVLU_SCORE              
                      , O.PROD_AMT
                      <if test='productBasicInfo.contentsTypeCd == "PD002501"'>
                      , H.PROD_NET_AMT 
                      </if>
                      <if test='productBasicInfo.contentsTypeCd == "PD002502"'>
                      , O.PROD_NET_AMT 
                      </if>
                      , G.PROD_STATUS_CD
                      , J.CID
                  FROM  TB_DP_MENU_CATEGORY           A
                      , TB_DP_MENU_CATEGORY_PROD_MAPG B
                      , TB_DP_MENU_CATEGORY_DESC      C
                      , TB_DP_PROD                    D /* 채널 상품 */
                      , TB_DP_EBOOK_PROD              E /* 채널 상품 */
                      , TB_DP_PROD_DESC               F /* 채널 상품 설명 */
                      , TB_DP_TENANT_PROD             G /* 채널 Tenant 상품 */
                      , TB_DP_TENANT_PROD_PRICE       H /* 채널 Tenant 상품 가격 */
                      , TB_DP_PROD_RSHP               I
                      , TB_DP_PROD                    J /* 에피소드 상품 */
                      , TB_DP_EBOOK_PROD              L /* 에피소드 상품 */
                      , TB_DP_PROD_IMG                M /* 채널 상품 이미지 */
                      , TB_DP_TENANT_PROD_STATS       N /* 채널 Tenant 상품 통계 건수 */
                      , TB_DP_TENANT_PROD_PRICE       O /* 에피소드 Tenant 상품 가격 */
                      , TB_DP_TENANT_PROD             P /* 에피소드 Tenant 상품 */
                 WHERE A.MENU_ID = B.MENU_ID
                   AND A.MENU_ID = C.MENU_ID
                   AND B.PROD_ID = D.PROD_ID
                   AND B.PROD_ID = E.PROD_ID
                   AND B.PROD_ID = F.PROD_ID
                   AND B.PROD_ID = G.PROD_ID
                   AND B.PROD_ID = H.PROD_ID
                   AND B.PROD_ID = I.PROD_ID
                   AND B.PROD_ID = M.PROD_ID(+)
                   AND G.TENANT_ID = H.TENANT_ID                      
                   AND G.TENANT_ID = N.TENANT_ID(+)
                   AND G.TENANT_ID = O.TENANT_ID
                   AND G.TENANT_ID = P.TENANT_ID
                   AND G.PROD_ID = N.PROD_ID(+)           
                   AND I.PART_PROD_ID = J.PROD_ID
                   AND I.PART_PROD_ID = L.PROD_ID
                   AND I.PART_PROD_ID = O.PROD_ID
                   AND I.PART_PROD_ID = P.PROD_ID
                   AND A.USE_YN = 'Y'        
                   AND B.USE_YN = 'Y'                        /* Y : 사용 (사용여부) */
                   AND C.LANG_CD = #{tenantHeader.langCd}    /* ko : 한국어 */
                   AND D.SVC_GRP_CD = 'DP000203'             /* DP000203 : 멀티미디어 */
                   AND D.CONTENTS_TYPE_CD = 'PD002501'       /* PD002501 : 채널타입 */
                   AND F.LANG_CD = #{tenantHeader.langCd}    /* ko : 한국어 */
                   <if test='prodStatusCd != null'>
                   AND G.PROD_STATUS_CD = #{prodStatusCd}    /* PD000403 : 채널 판매중 */
                   </if>
                   AND G.EXPO_YN = 'Y'                       /* Y : 노출 (노출여부) */
                   AND SYSDATE BETWEEN H.APPLY_START_DT AND H.APPLY_END_DT
/*                 AND H.SEQ = 1 */                          /* 조건 추가 고려 필요 */
                   AND I.PROD_RSHP_CD = 'DP010802'           /* DP010802 : 채널-에피소드 상품 관계 */
                   AND J.CONTENTS_TYPE_CD = 'PD002502'       /* PD002502 : 에피소드 */           
                   AND M.IMG_CD(+) = #{imageCd}                 /* 이미지코드 */
                   AND M.EXPO_ORD(+) = 1                        /* 노출순서 */
                   AND M.LANG_CD(+) = #{tenantHeader.langCd}    /* ko : 한국어 */           
                   AND SYSDATE BETWEEN O.APPLY_START_DT AND O.APPLY_END_DT
                   <if test='prodStatusCd != null'>
                   AND P.PROD_STATUS_CD = #{prodStatusCd}    /* PD000403 : 에피소드 판매중 */
                   </if>
                   -----------------------------------------------------------------------------
                   -- INPUT PARAMETER
                   ----------------------------------------------------------------------------- 
                   <if test='productBasicInfo.contentsTypeCd == "PD002501"'>
                        AND B.PROD_ID = #{productBasicInfo.prodId}      -- 채널 상품 ID 조회             
                   </if>
                   <if test='productBasicInfo.contentsTypeCd == "PD002502"'>
                        AND I.PART_PROD_ID = #{productBasicInfo.partProdId}   -- 에피소드 상품 ID 조회
                   </if>
                   AND G.TENANT_ID = #{tenantHeader.tenantId} /* 테넌트ID */
        
               ) TB
           WHERE TB.RN = 1 
    </select>
    
    <select id="getWebtoonMetaInfo" parameterType="Map" resultType="MetaInfo">
       SELECT /* MetaInfoMapper.xml, getWebtoonMetaInfo, SAC 전시, 2014-01-07 */
               TB.UP_MENU_ID
             , (SELECT MENU_NM
                  FROM TB_DP_MENU_CATEGORY_DESC
                 WHERE MENU_ID = TB.TOP_MENU_ID
                   AND LANG_CD = #{tenantHeader.langCd}
                   AND ROWNUM = 1) AS TOP_MENU_NM
             , TB.TOP_MENU_ID
             , TB.MENU_ID
             , TB.MENU_NM
             , TB.MENU_DESC
             , TB.META_CLSF_CD
             , TB.PROD_ID
             , TB.PART_PROD_ID
             , #{productBasicInfo.contentsTypeCd} as CONTENTS_TYPE_CD
             , TB.PROD_NM
             , TB.CHAPTER
             , TB.BOOK_CLSF_CD
             , TB.PROD_BASE_DESC
             , TB.PROD_GRD_CD
             , TB.ARTIST1_NM
             , TB.ARTIST2_NM
             , TB.ARTIST3_NM
             , TB.ISSUE_DAY
             , TB.CHNL_COMP_NM
             , DECODE( TB.COMPT_YN, 'Y', 'completed', 'continue' ) AS BOOK_STATUS                          
           <if test='productBasicInfo.contentsTypeCd == "PD002501"'>
             , CASE WHEN (TB.CHNL_PERIOD_AMT >= 0  AND STRM_EPSD_CNT > 0) THEN CHNL_PERIOD_AMT
                    ELSE NVL(CHNL_UNLMT_AMT, 0) END AS PROD_AMT -- 채널 대표 가격
           </if>
           <if test='productBasicInfo.contentsTypeCd == "PD002502"'>
             , NVL(TB.PROD_AMT, 0) AS PROD_AMT -- 에피소드 가격
           </if>       
             , NVL(TB.PATICPERS_CNT, 0) AS PATICPERS_CNT
             , NVL(TB.PRCHS_CNT, 0) AS DWLD_CNT
              <![CDATA[
             , NVL((CASE WHEN (TB.AVG_EVLU_SCORE > 0 AND TB.AVG_EVLU_SCORE < 1) THEN 1
                         WHEN TB.AVG_EVLU_SCORE > 5 THEN 5
                         ELSE ROUND(TB.AVG_EVLU_SCORE, 1) END), 0) AS AVG_EVLU_SCORE
             ]]>
             , TB.FILE_PATH || TB.FILE_NM AS FILE_PATH
             , CASE WHEN (SYSDATE - TB.LAST_DEPLOY_DT) <![CDATA[<= 3]]> THEN 'Y' ELSE 'N' END AS ICON_YN     /* 아이콘 */
             , TB.LAST_DEPLOY_DT AS UPD_DT
             , TB.PROD_STATUS_CD
          FROM (
                 SELECT ROW_NUMBER( ) OVER ( PARTITION BY B.PROD_ID ORDER BY J.LAST_DEPLOY_DT DESC ) AS RN
                      , A.UP_MENU_ID
                      , A.TOP_MENU_ID                                                             
                      , A.MENU_ID
                      , B.PROD_ID
                      , I.PART_PROD_ID                                     
                      , C.MENU_NM
                      , C.MENU_DESC
                      , D.PROD_GRD_CD
                      , D.USE_PERIOD_UNIT_CD
                      , D.META_CLSF_CD
                      , D.CONTENTS_TYPE_CD
                      , E.STRM_EPSD_CNT
                      , E.ISSUE_DAY
                      , E.CHNL_COMP_NM
                      , E.EPSD_CNT
                      , E.COMPT_YN
                      , F.PROD_NM
                      , F.ARTIST1_NM
                      , F.ARTIST2_NM
                      , F.ARTIST3_NM
                      , F.PROD_BASE_DESC
                      , F.PROD_DTL_DESC
                      , H.CHNL_PERIOD_AMT
                      , H.CHNL_UNLMT_AMT
                      , J.DRM_YN
                      , J.LAST_DEPLOY_DT
                      , L.CHAPTER                      
                      , L.BOOK_CLSF_CD
                      , M.FILE_PATH
                      , M.FILE_NM
                      , N.PATICPERS_CNT
                      , N.PRCHS_CNT
                      , N.AVG_EVLU_SCORE              
                      , O.PROD_AMT
                      , O.PROD_NET_AMT 
                      , G.PROD_STATUS_CD
                  FROM  TB_DP_MENU_CATEGORY           A
                      , TB_DP_MENU_CATEGORY_PROD_MAPG B
                      , TB_DP_MENU_CATEGORY_DESC      C
                      , TB_DP_PROD                    D /* 채널 상품 */
                      , TB_DP_EBOOK_PROD              E /* 채널 상품 */
                      , TB_DP_PROD_DESC               F /* 채널 상품 설명 */
                      , TB_DP_TENANT_PROD             G /* 채널 Tenant 상품 */
                      , TB_DP_TENANT_PROD_PRICE       H /* 채널 Tenant 상품 가격 */
                      , TB_DP_PROD_RSHP               I
                      , TB_DP_PROD                    J /* 에피소드 상품 */
                      , TB_DP_EBOOK_PROD              L /* 에피소드 상품 */
                      , TB_DP_PROD_IMG                M /* 채널 상품 이미지 */
                      , TB_DP_TENANT_PROD_STATS       N /* 채널 Tenant 상품 통계 건수 */
                      , TB_DP_TENANT_PROD_PRICE       O /* 에피소드 Tenant 상품 가격 */
                      , TB_DP_TENANT_PROD             P /* 에피소드 Tenant 상품 */
                 WHERE A.MENU_ID = B.MENU_ID
                   AND A.MENU_ID = C.MENU_ID
                   AND B.PROD_ID = D.PROD_ID
                   AND B.PROD_ID = E.PROD_ID
                   AND B.PROD_ID = F.PROD_ID
                   AND B.PROD_ID = G.PROD_ID
                   AND B.PROD_ID = H.PROD_ID
                   AND B.PROD_ID = I.PROD_ID
                   AND B.PROD_ID = M.PROD_ID(+)
                   AND G.TENANT_ID = H.TENANT_ID                      
                   AND G.TENANT_ID = N.TENANT_ID(+)
                   AND G.TENANT_ID = O.TENANT_ID
                   AND G.TENANT_ID = P.TENANT_ID
                   AND G.PROD_ID = N.PROD_ID(+)           
                   AND I.PART_PROD_ID = J.PROD_ID
                   AND I.PART_PROD_ID = L.PROD_ID
                   AND I.PART_PROD_ID = O.PROD_ID
                   AND I.PART_PROD_ID = P.PROD_ID
                   AND A.USE_YN = 'Y'        
                   AND B.USE_YN = 'Y'                        /* Y : 사용 (사용여부) */
                   AND C.LANG_CD = #{tenantHeader.langCd}    /* ko : 한국어 */
                   AND D.SVC_GRP_CD = 'DP000203'             /* DP000203 : 멀티미디어 */
                   AND D.CONTENTS_TYPE_CD = 'PD002501'       /* PD002501 : 채널타입 */
                   AND F.LANG_CD = #{tenantHeader.langCd}    /* ko : 한국어 */
                   <if test='prodStatusCd != null'>
                   AND G.PROD_STATUS_CD = #{prodStatusCd}    /* PD000403 : 채널 판매중 */
                   </if>
                   AND G.EXPO_YN = 'Y'                       /* Y : 노출 (노출여부) */
                   AND SYSDATE BETWEEN H.APPLY_START_DT AND H.APPLY_END_DT
                   AND I.PROD_RSHP_CD = 'DP010802'           /* DP010802 : 채널-에피소드 상품 관계 */
                   AND J.CONTENTS_TYPE_CD = 'PD002502'       /* PD002502 : 에피소드 */           
                   AND M.IMG_CD(+) = #{imageCd}                 /* 이미지코드 */
                   AND M.EXPO_ORD(+) = 1                        /* 노출순서 */
                   AND M.LANG_CD(+) = #{tenantHeader.langCd}    /* ko : 한국어 */           
                   AND SYSDATE BETWEEN O.APPLY_START_DT AND O.APPLY_END_DT
                   <if test='prodStatusCd != null'>
                   AND P.PROD_STATUS_CD = #{prodStatusCd}    /* PD000403 : 에피소드 판매중 */
                   </if>
                   -----------------------------------------------------------------------------
                   -- INPUT PARAMETER
                   ----------------------------------------------------------------------------- 
                   <if test='productBasicInfo.contentsTypeCd == "PD002501"'>
                        AND B.PROD_ID = #{productBasicInfo.prodId}      -- 채널 상품 ID 조회             
                   </if>
                   <if test='productBasicInfo.contentsTypeCd == "PD002502"'>
                        AND I.PART_PROD_ID = #{productBasicInfo.partProdId}   -- 에피소드 상품 ID 조회
                   </if>
                   AND G.TENANT_ID = #{tenantHeader.tenantId} /* 테넌트ID */
        
               ) TB
           WHERE TB.RN = 1 
    </select>
    
    <select id="getShoppingMetaInfo" parameterType="Map" resultType="MetaInfo">
        SELECT  *  /* MetaInfoMapper.xml, getShoppingMetaInfo, 쇼핑 메타 정보 조회, 김형식/SK플래닛, 2014-01-07 */
                   FROM (
                          SELECT 
                                B.CATALOG_ID 
                               ,C.CATALOG_NM 
                               ,C.CATALOG_DESC
                               ,NVL(L.PROD_NET_AMT, 0) AS PROD_NET_AMT 
                               ,NVL(N.SPRC_PRICE, NVL(L.PROD_AMT, 0)) AS PROD_AMT 
                               ,NVL(N.SPRC_DC_RATE, NVL(L.DC_RATE,0)) AS DC_RATE
                               ,NVL(N.SPRC_DC_PRICE, NVL(L.DC_AMT, 0)) AS DC_AMT
                               ,CASE WHEN N.SPRC_DC_RATE IS NOT NULL THEN 'Y' ELSE 'N'END AS SPECIAL_SALE_YN
                               ,A.BRAND_ID  
                               ,A.BRAND_NM  
                               ,D.MENU_ID  
                               ,F.MENU_NM
                               ,J.TOP_MENU_ID
                               ,J.META_CLSF_CD  
                               ,J.CONTENTS_TYPE_CD   
                               ,(SELECT MENU_NM
                                   FROM TB_DP_MENU_CATEGORY_DESC
                                  WHERE MENU_ID = J.TOP_MENU_ID
                                    AND LANG_CD = #{tenantHeader.langCd}
                                    AND ROWNUM = 1
                                ) AS TOP_MENU_NM                                   
                               ,ROW_NUMBER() OVER(PARTITION BY B.CATALOG_ID ORDER BY NVL(N.SPRC_PRICE, L.PROD_AMT) ASC) as NO
                               ,CASE WHEN (SYSDATE - 7)    <![CDATA[ <= ]]>  I.REG_DT THEN 'Y' ELSE 'N' END AS NEW_YN  
                               ,I.REG_DT 
                               ,K.TENANT_ID 
                               ,H.PROD_ID 
                               ,H.PART_PROD_ID  
                               ,I.DLV_PROD_YN
                               ,CASE WHEN NVL(M.PRCHS_CNT, 0) <![CDATA[ < ]]> 0 THEN 0 ELSE NVL(M.PRCHS_CNT, 0) END AS PRCHS_CNT 
                               ,J.PROD_GRD_CD
		                       ,TO_CHAR(NVL( N.SPRC_APPLY_START_DT, L.APPLY_START_DT),'YYYYMMDDHH24MISS') AS APPLY_START_DT
		                       ,TO_CHAR(NVL( N.SPRC_APPLY_END_DT , L.APPLY_END_DT ),'YYYYMMDDHH24MISS') AS APPLY_END_DT      
                               ,TO_CHAR(N.SPRC_APPLY_START_DT,'YYYYMMDDHH24MISS')
                               ,TO_CHAR(N.SPRC_APPLY_END_DT,'YYYYMMDDHH24MISS')
                               ,(CASE WHEN I.PROD_CASE_CD='DP006301' THEN 'giftcard' 
                                      WHEN I.PROD_CASE_CD='DP006302' THEN 'exchange' 
                                      WHEN I.PROD_CASE_CD='DP006303' THEN 'delivery' 
                                 END) AS PROD_CASE_CD                                  
                               ,J.PROD_CHRG_YN
                               ,I.B2B_PROD_YN
                               ,CONCAT(PI.FILE_PATH,PI.FILE_NM) FILE_PATH 
                               ,PI.FILE_NM
                               ,PI.FILE_SIZE                               
                          FROM 
                                  TB_DP_SHPG_BRAND         A
                                 ,TB_DP_SHPG_CATALOG       B
                                 ,TB_DP_SHPG_CATALOG_DESC  C
                                 ,TB_DP_MENU_SHPG_MAPG     D
                                 ,TB_DP_MENU_CATEGORY      E
                                 ,TB_DP_MENU_CATEGORY_DESC F 
                                 ,TB_DP_PROD_CATALOG_MAPG  G 
                                 ,TB_DP_PROD_RSHP          H
                                 ,TB_DP_SHPG_PROD          I
                                 ,TB_DP_PROD               J
                                 ,TB_DP_TENANT_PROD        K
                                 ,TB_DP_TENANT_PROD_PRICE  L
                                 ,TB_DP_PROD_IMG           PI
                                 ,(SELECT  PROD_ID
                                          ,PRCHS_CNT
                                     FROM TB_DP_TENANT_PROD_STATS 
                                    WHERE TENANT_ID = #{tenantHeader.tenantId}    /* INPUT 테넌트ID */
                                   ) M
                                 ,(SELECT /*+ ORDERED */
                                        B1.PROD_ID
                                      , B1.SPRC_DC_RATE
                                      , B1.SPRC_PRICE
                                      , B1.SPRC_DC_PRICE
                                      , B1.SPRC_APPLY_START_DT
                                      , B1.SPRC_APPLY_END_DT
                                   FROM  TB_DP_PROD_RSHP A1
                                        ,TB_DP_SPRC_PROD B1
                                   WHERE 1=1
                                     AND A1.PART_PROD_ID = B1.PROD_ID
                                     AND B1.EXPO_YN ='Y'
                                     AND B1.CPN_ID IS NOT NULL
                                     AND SYSDATE BETWEEN  B1.SPRC_APPLY_START_DT AND B1.SPRC_APPLY_END_DT 
                                  ) N
                        WHERE 1=1
                        AND A.BRAND_ID = B.BRAND_ID
                        AND B.CATALOG_ID = C.CATALOG_ID
                        AND C.CATALOG_ID = D.CATALOG_ID     
                        AND D.MENU_ID = E.MENU_ID
                        AND D.MENU_ID = F.MENU_ID
                        AND B.CATALOG_ID = G.CATALOG_ID
                        AND G.PROD_ID = H.PROD_ID
                        AND H.PROD_ID <![CDATA[ <> ]]> H.PART_PROD_ID
                        AND H.PART_PROD_ID = I.PROD_ID
                        AND I.PROD_ID = J.PROD_ID
                        AND I.PROD_ID = K.PROD_ID
                        AND I.PROD_ID = L.PROD_ID
                        AND K.TENANT_ID = L.TENANT_ID 
                        AND C.CATALOG_ID = PI.PROD_ID(+)
                        AND PI.IMG_CD(+) = #{imageCd}
                        AND PI.EXPO_ORD ='1'
                        AND C.CATALOG_ID = M.PROD_ID(+)                           
                        AND I.PROD_ID = N.PROD_ID(+)
                      <if test='productBasicInfo.contentsTypeCd == "PD002501"'>
                        AND B.CATALOG_ID = #{productBasicInfo.catalogId}          
                      </if>
                      <if test='productBasicInfo.contentsTypeCd == "PD002502"'>
                        AND H.PART_PROD_ID = #{productBasicInfo.partProdId}
                      </if>
                      
                        AND K.PROD_STATUS_CD = 'PD000403'  /* PD000403 : 판매중 */
                        AND H.PROD_RSHP_CD = #{prodRshpCd}    /*채널-에피소드 상품 관계*/
                        AND NVL(B.CHNL_CNT, 0) > 0  
                        AND PI.LANG_CD = #{tenantHeader.langCd}         /* ko : 한국어 */         
                        AND C.LANG_CD = #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND F.LANG_CD = #{tenantHeader.langCd}          /* ko : 한국어 */
                        AND D.BASE_YN ='Y'                 /* Y : 기본(기본여부) */
                        AND D.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND E.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND G.BASE_YN ='Y'                 /* Y : 기본(기본여부) */
                        AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                        AND NVL(I.B2B_PROD_YN, 'N') <![CDATA[ <> ]]>  'Y'
                        AND SYSDATE BETWEEN L.APPLY_START_DT AND L.APPLY_END_DT
                        AND K.TENANT_ID = #{tenantHeader.tenantId}       /* INPUT 테넌트ID */
                   ) 
                 WHERE NO =1   
    </select>
    
    <!-- 정액제 상품 메타 조회 -->
    <select id="getFreepassMetaInfo" parameterType="Map" resultType="MetaInfo">
	SELECT  /* MetaInfoMapper.getFreepassMetaInfo, 정액제 상품 메타 조회, SAC전시 서영배/지티소프트, 2014-02-12 */
		IV.*
		, NVL(BIG.FILE_PATH, '') || NVL(BIG.FILE_NM, '') AS BANNER_FILE_PATH
		, NVL(TIG.FILE_PATH, '') || NVL(TIG.FILE_NM, '') AS THUMBNAIL_FILE_PATH
	FROM (
		SELECT  
			PD.PROD_ID
			, PD.TOP_MENU_ID
			, (SELECT MENU_DESC FROM TB_DP_MENU_CATEGORY_DESC WHERE MENU_ID = PD.TOP_MENU_ID AND LANG_CD = DC.LANG_CD) AS TOP_MENU_NM
			, PD.META_CLSF_CD
			, PD.PROD_CHRG_YN
			, PD.SELLER_MBR_NO
			, PD.SVC_GRP_CD
			, PD.SVC_TYPE_CD
			, PD.PROD_GRD_CD
			, PD.CID
			, PD.MALL_CD
			, PD.FEE_CASE_CD
			, PD.FEE_UNIT_CD
			, PD.USE_PERIOD_UNIT_CD
			, PD.USE_PERIOD
			, PD.DRM_YN
			, PD.DRM_SET_CD
			, PD.DRM_SET_VALUE
			, PD.CONTENTS_TYPE_CD
			, CM.CMPX_PROD_CLSF_CD
			, DC.PROD_INTR_DSCR
			, PR.PROD_AMT
			, DC.PROD_NM
			, DC.PROD_ALIAS
			, DC.PROD_BASE_DESC
			, DC.PROD_DTL_DESC
			, DC.PROD_USE_MTD
			, CM.AUTO_APPR_YN
			, CM.MAX_SALE_CNT
			, CM.SALE_POC_CD
			, CM.DUP_PRCHS_LIMT_YN
			, TP.PROD_STATUS_CD
			, TP.EXPO_YN
			, TP.EXPO_ORD
			, TO_CHAR(PR.APPLY_START_DT, 'YYYYMMDDHH24MISS') AS APPLY_START_DT
			, TO_CHAR(PR.APPLY_END_DT, 'YYYYMMDDHH24MISS') AS APPLY_END_DT
			, PR.CHNL_UNLMT_AMT
			, PR.CHNL_PERIOD_AMT
			, PR.PROD_NET_AMT
			, PR.DC_RATE
			, PR.DC_AMT
			, PR.DC_AFT_PROD_AMT
			, PR.TAX_CLSF
			, DC.LANG_CD
            , CM.CASH_AMT
            , CM.BNS_CASH_AMT_CLSF_CD
            , CM.BNS_CASH_AMT
            , CM.BNS_CASH_RATIO
            , CM.BNS_USE_PERIOD_UNIT_CD
            , CM.BNS_USE_PERIOD			
		FROM 
			TB_DP_PROD PD, TB_DP_CMPX_PROD CM, TB_DP_PROD_DESC DC, 
  			TB_DP_TENANT_PROD TP, TB_DP_TENANT_PROD_PRICE PR
		WHERE PD.PROD_ID = #{productBasicInfo.prodId}
		AND PD.PROD_ID = CM.PROD_ID
		AND PD.PROD_ID = DC.PROD_ID
		AND PD.PROD_ID = TP.PROD_ID
		AND PD.PROD_ID = PR.PROD_ID
		AND DC.LANG_CD = #{tenantHeader.langCd}
		AND TP.TENANT_ID = #{tenantHeader.tenantId}
		AND TP.TENANT_ID = PR.TENANT_ID
		AND SYSDATE BETWEEN PR.APPLY_START_DT AND PR.APPLY_END_DT
	) IV LEFT OUTER JOIN TB_DP_PROD_IMG BIG
	ON BIG.LANG_CD = IV.LANG_CD AND IV.PROD_ID = BIG.PROD_ID AND BIG.IMG_CD = #{bannerImageCd}
	LEFT OUTER JOIN TB_DP_PROD_IMG TIG
	ON TIG.LANG_CD = IV.LANG_CD 
	   AND IV.PROD_ID = TIG.PROD_ID 
       AND TIG.IMG_CD = (
            CASE WHEN IV.CMPX_PROD_CLSF_CD IN ('OR004301','OR004302') THEN  #{thumbnailImageCd}
                 WHEN IV.CMPX_PROD_CLSF_CD IN ('OR004303','OR004304') THEN  #{ebookThumbnailImageCd}
            END
       )	
    </select>
 </mapper>