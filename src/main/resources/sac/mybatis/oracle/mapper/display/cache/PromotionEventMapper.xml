<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="PromotionEventMapper">

    <select id="getPromotionEventList" parameterType="map" resultType="com.skplanet.storeplatform.sac.display.cache.vo.RawPromotionEvent">
        SELECT /* CachedExtraInfoManager.getPromotionEventList, 정희원/SKP, 2015-07-17 */
            TENANT_ID,
            PROM_TYPE_CD,
            PROM_TYPE_VALUE,
            to_char(START_DT,'yyyyMMddHH24miss')||'_'||to_char(END_DT,'yyyyMMddHH24miss') as DATETIME_KEY,
            PROM_ID,
            ACML_METHOD_CD,
            ACML_LIMT,
            TO_CHAR(ACML_DATE, 'yyyyMMddHH24miss') as ACML_DT,
            RATE_GRD_1,
            RATE_GRD_2,
            RATE_GRD_3,
            START_DT,
            END_DT,
            PROM_FORCE_CLOSE_CD,
            PROM_FORCE_CLOSE_DT,
            TARGET_USER_KIND,
            PAY_METHOD_VDTY_DT
        FROM TB_DP_PROM_POLICY
        WHERE 1=1
          <if test="liveOnly || liveAndReserved">AND PROM_FORCE_CLOSE_CD IS NULL</if>
          <if test="liveOnly || all">AND sysdate between START_DT AND END_DT</if>
          <if test="liveAndReserved">AND sysdate <![CDATA[<]]> END_DT</if>
          <if test="tenantId != null">AND TENANT_ID = #{tenantId}</if>
          <if test="keyList != null">AND PROM_TYPE_VALUE IN <foreach collection="keyList" separator="," open="(" close=")" item="v">#{v, jdbcType=VARCHAR}</foreach></if>
          <if test="promIdList != null">AND PROM_ID IN <foreach collection="promIdList" separator="," open="(" close=")" item="v">#{v, jdbcType=VARCHAR}</foreach></if>
          <if test="liveAndReserved">ORDER BY TENANT_ID, PROM_TYPE_VALUE, START_DT</if>
          <if test="liveOnly || all">ORDER BY PROM_TYPE_CD</if>
    </select>

    <select id="getLivePromotionEventForUser" parameterType="map" resultType="com.skplanet.storeplatform.sac.display.cache.vo.RawPromotionEvent">
        SELECT * FROM (
            SELECT /* CachedExtraInfoManager.getLivePromotionEventForUser, 정희원/SKP, 2015-10-22 */
                ROW_NUMBER() OVER (ORDER BY
                  CASE WHEN TARGET_USER_KIND = #{targetUserAll} THEN '1' ELSE  NVL2(PU.USER_KEY, '1', '2') END,
                  PROM_TYPE_CD) RN,
                PP.TENANT_ID,
                PP.PROM_TYPE_VALUE,
                to_char(START_DT,'yyyyMMddHH24miss')||'_'||to_char(END_DT,'yyyyMMddHH24miss') as DATETIME_KEY,
                PP.PROM_ID,
                ACML_METHOD_CD,
                ACML_LIMT,
                TO_CHAR(ACML_DATE, 'yyyyMMddHH24miss') as ACML_DT,
                RATE_GRD_1,
                RATE_GRD_2,
                RATE_GRD_3,
                START_DT,
                END_DT,
                PROM_FORCE_CLOSE_CD,
                PROM_FORCE_CLOSE_DT,
                CASE WHEN TARGET_USER_KIND = #{targetUserAll} THEN '1' ELSE  NVL2(PU.USER_KEY, '1', '2') END AS JOIN_CD,
                PROM_TYPE_CD,
                PP.TARGET_USER_KIND,
                PAY_METHOD_VDTY_DT
            FROM TB_DP_PROM_POLICY PP
              LEFT OUTER JOIN TB_DP_PROM_USER PU
                ON PU.PROM_ID = PP.PROM_ID AND PU.USER_KEY = #{userKey, jdbcType=VARCHAR}
            WHERE 1=1
              AND sysdate between START_DT AND END_DT
              AND PROM_FORCE_CLOSE_CD IS NULL
              AND PP.TENANT_ID = #{tenantId}
              AND PP.PROM_TYPE_VALUE IN
              <foreach collection="keyList" separator="," open="(" close=")" item="v">#{v, jdbcType=VARCHAR}</foreach>
        )
        WHERE RN = 1
    </select>

    <select id="getPromotionUserList" parameterType="map" resultType="String">
        SELECT /* CachedExtraInfoManager.getPromotionUserList, 정희원/SKP, 2015-10-22 */
          USER_KEY
        FROM TB_DP_PROM_USER
        WHERE 1=1
        AND PROM_ID = #{promId}
        <if test="userKey != null">AND USER_KEY = #{userKey}</if>
    </select>
    
</mapper>