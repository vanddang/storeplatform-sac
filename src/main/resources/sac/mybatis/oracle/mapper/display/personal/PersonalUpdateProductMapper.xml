<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="PersonalUpdateProduct">
    
     <select id="searchRecentFromPkgNm" parameterType="map" resultType="com.skplanet.storeplatform.sac.display.personal.vo.SubContentInfo">
         SELECT /*PersonalUpdateProductMapper.searchRecentFromPkgNm, searchRecentFromPkgNm, 오승민/인크로스, 2014-02-28 */
         LA.*
         FROM
             ( SELECT SC.PROD_ID
             , SC.APK_PKG_NM
             , SC.APK_VER
             , SC.SUB_CONTENTS_ID
             ,ROW_NUMBER() OVER (PARTITION BY SC.APK_PKG_NM ORDER BY SC.APK_VER DESC) AS RNUM
         FROM TB_DP_APP_PROD APPPROD
             ,TB_DP_SUB_CONTENTS SC
             ,TB_DP_SPRT_DEVICE DEVICE
             ,TB_CM_DEVICE CMDEVICE
         WHERE
             <if test="pkgList != null">SC.APK_PKG_NM IN <foreach collection="pkgList" item="v" open="(" separator="," close=")">#{v}</foreach></if>
             <if test="hashedPkgList != null">SC.APK_PKG_HASH IN<foreach collection="hashedPkgList" item="v" open="(" separator="," close=")">#{v}</foreach></if>
             AND APPPROD.PROD_ID = SC.PROD_ID
             AND SC.PROD_ID = DEVICE.PROD_ID
             AND SC.SUB_CONTENTS_ID = DEVICE.SUB_CONTENTS_ID
             AND DEVICE.DEVICE_MODEL_CD = #{deviceModelCd}
             AND DEVICE.DEVICE_MODEL_CD = CMDEVICE.DEVICE_MODEL_CD
             AND (APPPROD.PART_PARENT_CLSF_CD = #{parentClsfCd} or APPPROD.PART_PARENT_CLSF_CD is null)
             AND CMDEVICE.USE_YN = 'Y'
         )LA
         WHERE RNUM = 1
     </select>
    
    
    
    <select id="getAppInfo" parameterType="map" resultType="Map">
        SELECT /*PersonalUpdateProductMapper.getAppInfo, getAppInfo, 오승민/인크로스, 2014-02-28 */
        LB.* 
       ,( CASE WHEN ( LB.FAKE_CNT > 0 AND NVL( LB.PROD_AMT, 0 ) = 0 ) THEN 'Y' ELSE 'N' END ) AS FAKE_YN
       ,(SELECT MENU_NM
                   FROM TB_DP_MENU_CATEGORY_DESC
                  WHERE MENU_ID = LB.TOP_MENU_ID
                    AND LANG_CD = 'ko'
                    AND ROWNUM = 1) AS TOP_MENU_NM
       ,LB.VER_MAJOR || '.' || LB.VER_MINOR AS PROD_VER
    FROM(
        SELECT
             LA.*
            ,( SELECT COUNT(PROD_ID)
                            FROM TB_CM_AUTO_UPGRD_ALTR_PROD AUAP
                           WHERE AUAP.PROD_ID = LA.PART_PROD_ID
             ) AS FAKE_CNT
         FROM (
            SELECT
                 AP.AID
                 ,AP.VER_MAJOR
                 ,AP.VER_MINOR
                 ,MC.TOP_MENU_ID
				 ,MC.UP_MENU_ID
				 ,MC.MENU_ID
				 ,MCD.MENU_NM
				 ,MCD.MENU_DESC
                 ,P.PROD_ID AS PART_PROD_ID
                 ,RSHP.PROD_ID AS PROD_ID
                 ,TO_CHAR(P.LAST_DEPLOY_DT, 'YYYYMMDDHH24MISS') AS UPD_DT
                 ,P.PROD_GRD_CD
                 ,PD.PROD_NM
                 ,SC.APK_PKG_NM
                 ,SC.APK_VER
                 ,SC.FILE_SIZE
                 ,SC.FILE_PATH
                 ,PI.FILE_PATH as IMAGE_PATH
                 ,PI.FILE_SIZE as IMAGE_SIZE
                 ,TPP.PROD_AMT
              FROM   TB_DP_PROD P
                    ,TB_DP_PROD_DESC PD
                    ,TB_DP_APP_PROD AP
                    ,TB_DP_SPRT_DEVICE SD
                    ,TB_DP_SUB_CONTENTS SC
                    ,TB_DP_TENANT_PROD TP
                    ,TB_DP_TENANT_PROD_PRICE TPP
                    ,TB_DP_MENU_CATEGORY           MC
                    ,TB_DP_MENU_CATEGORY_PROD_MAPG MCPM
                    ,TB_DP_MENU_CATEGORY_DESC      MCD
                    ,TB_DP_PROD_IMG                PI
                    ,TB_CM_DEVICE                  DEVICE
                    ,TB_DP_PROD_RSHP               RSHP
             WHERE   MC.MENU_ID = MCPM.MENU_ID
               AND   MC.MENU_ID = MCD.MENU_ID
               AND   MCPM.PROD_ID = P.PROD_ID   
               AND   P.PROD_ID = AP.PROD_ID
               AND   P.PROD_ID = SD.PROD_ID
               AND   P.PROD_ID = PI.PROD_ID
               AND   P.PROD_ID = PD.PROD_ID
               AND   P.PROD_ID = RSHP.PART_PROD_ID
               AND   SD.DEVICE_MODEL_CD = #{deviceHeader.model}
               AND   SD.PROD_ID = SC.PROD_ID
               AND   SD.SUB_CONTENTS_ID = SC.SUB_CONTENTS_ID
               AND   SD.DEVICE_MODEL_CD = DEVICE.DEVICE_MODEL_CD
               AND   DEVICE.USE_YN = 'Y'
               AND   P.PROD_ID = #{prodId}
               AND   P.SVC_GRP_CD = #{svcGrpCd}   
               AND   SD.SUB_CONTENTS_ID = #{subContentsId}
               AND   P.PROD_ID = TP.PROD_ID
               AND   TP.TENANT_ID = #{tenantHeader.tenantId}
               AND   TP.PROD_ID = TPP.PROD_ID
               AND   TP.TENANT_ID = TPP.TENANT_ID
               AND   TP.PROD_STATUS_CD = #{prodStatusCd}   /* PD000403 : 판매중 */
               AND   TP.EXPO_YN = 'Y'                 /* Y : 노출 (노출여부) */
               AND   P.CONTENTS_TYPE_CD = #{contentsTypeCd}                -- 에피소드
               AND   MC.USE_YN = 'Y'
               AND   MCPM.USE_YN = 'Y'
               AND   MCD.LANG_CD = #{tenantHeader.langCd}                /* ko : 한국어 */
               AND   PI.IMG_CD = #{imageCd}           /* 이미지코드 */
               AND   PI.EXPO_ORD = 1                  /* 노출순서 */
               AND   PI.LANG_CD = #{tenantHeader.langCd}                /* ko : 한국어 */
               AND   PD.LANG_CD = #{tenantHeader.langCd}                /* ko : 한국어 */
               AND   RSHP.PROD_RSHP_CD = #{rshpCd} 
               AND   SYSDATE BETWEEN TPP.APPLY_START_DT AND TPP.APPLY_END_DT
        ) LA
    )LB
    </select>
     
</mapper>
