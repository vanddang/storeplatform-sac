<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="SimilarProduct">
    <!-- 이 상품과 유사 상품 조회 -->
    <select id="selectSimilarProductList" parameterType="SimilarProductSacReq" resultType="ProductBasicInfo">
        <if test="testYn != null"> /* 임시 테스트 데이터 */
        WITH TB_DP_SMLR_PROD_MANG AS (
        SELECT 
                 C.TOP_MENU_ID STD_PROD_ID
                , A.PROD_ID SMLR_PROD_ID
                , ROWNUM SCORE
        FROM TB_DP_PROD A, TB_DP_MENU_CATEGORY_PROD_MAPG B, TB_DP_MENU_CATEGORY C
        WHERE A.PROD_ID = B.PROD_ID
        AND B.MENU_ID = C.MENU_ID
        )    
        </if>
        SELECT /* SimilarProductMapper.xml, selectSimilarProductList, SAC : 유시혁 , 2014-02-18 */
            A.TOTAL_COUNT
            , A.TOP_MENU_ID
            , A.MENU_ID
            , A.PROD_ID
            , A.CONTENTS_TYPE_CD
        FROM (
            SELECT 
                COUNT(1) OVER() TOTAL_COUNT
                , ROW_NUMBER() OVER(ORDER BY SCORE DESC) RNK
                , A.*
            FROM (
                SELECT 
                    ROW_NUMBER() OVER(PARTITION BY B.PROD_ID ORDER BY A.SCORE DESC) RNUM
                    , D.TOP_MENU_ID
                    , D.MENU_ID
                    , B.PROD_ID
                    , A.SCORE
                    , B.CONTENTS_TYPE_CD
                FROM 
                    TB_DP_SMLR_PROD_MANG A
                    , TB_DP_PROD B
                    , TB_DP_MENU_CATEGORY_PROD_MAPG C
                    , TB_DP_MENU_CATEGORY D
                    , TB_DP_SPRT_DEVICE E
                    , TB_DP_TENANT_PROD F
                    , TB_CM_DEVICE G
                WHERE A.SMLR_PROD_ID = B.PROD_ID
                AND A.SMLR_PROD_ID = C.PROD_ID
                AND C.MENU_ID = D.MENU_ID
                AND A.SMLR_PROD_ID = E.PROD_ID
                AND A.SMLR_PROD_ID = F.PROD_ID
                AND E.DEVICE_MODEL_CD = G.DEVICE_MODEL_CD
                AND C.USE_YN ='Y'
                AND D.USE_YN ='Y'
                AND G.USE_YN = 'Y'
                AND F.EXPO_YN = 'Y'
                AND B.SVC_GRP_CD ='DP000201'
                AND F.PROD_STATUS_CD = 'PD000403'
                AND A.STD_PROD_ID = #{productId}
                AND F.TENANT_ID = #{tenantId}
                AND G.DEVICE_MODEL_CD = #{deviceModelCd}
                <if test="arrayExceptId != null"> /* 제외 상품ID */
                    AND A.SMLR_PROD_ID NOT IN 
                    <foreach collection="arrayExceptId" item="exceptId" separator="," open="(" close=")">
                        #{exceptId}
                    </foreach>
                </if> 
                UNION ALL
                SELECT 
                    ROW_NUMBER() OVER(PARTITION BY B.PROD_ID ORDER BY A.SCORE DESC) RNUM
                    , D.TOP_MENU_ID
                    , D.MENU_ID
                    , B.PROD_ID
                    , A.SCORE
                    , 'PD002501' CONTENTS_TYPE_CD
                FROM
                    TB_DP_SMLR_PROD_MANG A
                    , TB_DP_PROD_RSHP B
                    , TB_DP_MENU_CATEGORY_PROD_MAPG C
                    , TB_DP_MENU_CATEGORY D
                    , TB_DP_PROD E /* 에피소드 */
                    , TB_DP_TENANT_PROD F /* 에피소드 */
                    , TB_DP_SPRT_DEVICE G /* 에피소드 */
                    , TB_CM_DEVICE H
                WHERE A.SMLR_PROD_ID = B.PROD_ID
                AND B.PROD_ID = C.PROD_ID
                AND C.MENU_ID = D.MENU_ID
                AND B.PART_PROD_ID = E.PROD_ID
                AND B.PART_PROD_ID = F.PROD_ID
                AND B.PART_PROD_ID = G.PROD_ID
                AND G.DEVICE_MODEL_CD = H.DEVICE_MODEL_CD
                AND C.USE_YN = 'Y'
                AND D.USE_YN = 'Y'
                AND H.USE_YN = 'Y'
                AND F.EXPO_YN = 'Y'
                AND E.SVC_GRP_CD = 'DP000203'
                AND E.CONTENTS_TYPE_CD = 'PD002502'
                AND F.PROD_STATUS_CD = 'PD000403'
                AND B.PROD_RSHP_CD = 'DP010802'
                AND 1 = CASE    WHEN D.TOP_MENU_ID = 'DP16' AND H.MUSIC_SPRT_YN = 'Y' THEN 1
                        WHEN D.TOP_MENU_ID IN ('DP17','DP18') AND DECODE(NVL(E.DRM_YN, 'N'), 'N', 1, NVL(H.VIDEO_DRM_SPRT_YN, 'N'), 1, 0) = 1 THEN 1
                        WHEN D.TOP_MENU_ID = 'DP13' AND H.EBOOK_SPRT_YN = 'Y' THEN 1
                        WHEN D.TOP_MENU_ID = 'DP14' AND H.COMIC_SPRT_YN = 'Y' THEN 1
                        ELSE 0 END
                AND A.STD_PROD_ID = #{productId} /* 상품ID */
                AND F.TENANT_ID = #{tenantId}
                AND (G.DEVICE_MODEL_CD = #{deviceModelCd} OR G.DEVICE_MODEL_CD = #{mmDeviceModelCd})
                <if test="arrayExceptId != null"> /* 제외 상품ID */
                    AND A.SMLR_PROD_ID NOT IN 
                    <foreach collection="arrayExceptId" item="exceptId" separator="," open="(" close=")">
                        #{exceptId}
                    </foreach>
                </if> 
            ) A
            WHERE RNUM = 1
        ) A
        WHERE A.RNK BETWEEN #{offset} AND #{count} + #{offset} - 1
        ORDER BY A.RNK
    </select>
    
    
    <select id="selectMusicMetaInfo" parameterType="Map" resultType="MetaInfo">
        SELECT /* SimilarProductMapper.xml, selectMusicMetaInfo, SAC : 유시혁 , 2014-03-06 */
              CP.PROD_ID 
            , CP.PART_PROD_ID
            , PD.ARTIST1_ID AS ARTIST_ID
            , C.MENU_ID
            , CD.MENU_NM
            , CD.MENU_DESC
            , C.TOP_MENU_ID
            , CD2.MENU_NM AS TOP_MENU_NM
            , CD2.MENU_DESC AS TOP_MENU_DESC
            , MP.OUTSD_CONTENTS_ID -- 외부_컨텐츠_ID
            , PD.PROD_NM
            , PD.PROD_BASE_DESC
            , PD.PROD_DTL_DESC
            , TPP.PROD_AMT
            , TPP.PROD_NET_AMT
            , P.PROD_GRD_CD
            , P.META_CLSF_CD
            , PD.ARTIST1_NM
            , PD.ARTIST2_NM
            , PD.ARTIST3_NM                        
            , MP.CHNL_COMP_NM
            , MP.AGENCY_NM
            , MP.ISSUE_DAY
            , 'Y' AS MP3_SPRT_YN
            , MP.BELL_SPRT_YN
            , MP.COLORRING_SPRT_YN
            , CONCAT(PI.FILE_PATH, PI.FILE_NM) AS FILE_PATH
            , PI.FILE_NM
            , PI.FILE_SIZE
            , P.CONTENTS_TYPE_CD
            , TP.PROD_STATUS_CD
            , P.REG_DT
            , NVL(TPS.PATICPERS_CNT, 0) AS PATICPERS_CNT
            , NVL(TPS.PRCHS_CNT, 0) AS DWLD_CNT
            , NVL(TPS.PRCHS_CNT, 0) AS PRCHS_CNT
             <![CDATA[
            , NVL((CASE WHEN (TPS.AVG_EVLU_SCORE > 0 AND TPS.AVG_EVLU_SCORE < 1) THEN 1
                        WHEN TPS.AVG_EVLU_SCORE > 5 THEN 5
                        ELSE ROUND(TPS.AVG_EVLU_SCORE, 1) END), 0) AS AVG_EVLU_SCORE
            ]]>
         FROM UV_TB_DP_MULTIMDA_PROD MP
            , TB_DP_PROD P
            , TB_DP_PROD_DESC PD
            , TB_DP_PROD_RSHP CP
            , TB_DP_TENANT_PROD TP
            , TB_DP_TENANT_PROD_PRICE TPP
            , TB_DP_MENU_CATEGORY_PROD_MAPG CPM
            , TB_DP_MENU_CATEGORY C
            , TB_DP_MENU_CATEGORY_DESC CD
            , TB_DP_MENU_CATEGORY_DESC CD2
            , UV_TB_DP_MULTIMDA_PROD MP2
            , TB_DP_PROD P2
            , TB_DP_TENANT_PROD TP2
            , TB_DP_PROD_IMG PI
            , TB_DP_TENANT_PROD_STATS TPS
        WHERE MP.PROD_ID = CP.PART_PROD_ID
          AND P.PROD_ID = CP.PART_PROD_ID
          AND CPM.PROD_ID = CP.PART_PROD_ID
          AND C.MENU_ID = CPM.MENU_ID
          AND CD.MENU_ID = C.MENU_ID
          AND CD2.MENU_ID = C.TOP_MENU_ID
          AND CD2.LANG_CD = CD.LANG_CD
          AND P2.PROD_ID = CP.PROD_ID -- CHANNEL PROD ID
          AND P2.META_CLSF_CD = P.META_CLSF_CD
          AND TP2.PROD_ID = P2.PROD_ID
          AND TP2.TENANT_ID = TP.TENANT_ID
          AND TP2.PROD_STATUS_CD = TP.PROD_STATUS_CD
          AND TP2.EXPO_YN = TP.EXPO_YN
          AND MP2.PROD_ID = P2.PROD_ID
          AND TP.PROD_ID = P.PROD_ID
          AND TPP.PROD_ID = TP.PROD_ID
          AND SYSDATE BETWEEN TPP.APPLY_START_DT AND TPP.APPLY_END_DT
          AND TPP.TENANT_ID = TP.TENANT_ID
          AND PD.PROD_ID = P.PROD_ID
          AND PI.PROD_ID = CP.PROD_ID
          AND TP2.PROD_ID = TPS.PROD_ID(+)
          AND TP2.TENANT_ID = TPS.TENANT_ID(+)
          AND TP.EXPO_YN = 'Y'                 -- 노출 여부
          AND P2.CONTENTS_TYPE_CD = 'PD002501' -- 채널
          AND P.CONTENTS_TYPE_CD = 'PD002502'  -- 에피소드
          AND CPM.USE_YN = 'Y'
          AND C.USE_YN = 'Y'
       -----------------------------------------------------------------------------
       -- INPUT PARAMETER
       ----------------------------------------------------------------------------- 
          <if test='productBasicInfo.contentsTypeCd == "PD002501"'>
            AND CP.PROD_ID = #{productBasicInfo.prodId}
          </if>
          <if test='productBasicInfo.contentsTypeCd == "PD002502"'>
            AND CP.PART_PROD_ID = #{productBasicInfo.partProdId}
          </if>
          AND P.TOP_MENU_ID = #{productBasicInfo.topMenuId}
          AND PI.IMG_CD = #{imageCd}
          AND TP.TENANT_ID = #{tenantHeader.tenantId}
          AND PD.LANG_CD = #{tenantHeader.langCd}
          AND CD.LANG_CD = #{tenantHeader.langCd}
          AND ROWNUM = 1
    </select>
            
</mapper>
