<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="VodDetail">
    
    <select id="selectProdRshp" parameterType="map" resultType="string">
		SELECT /* VodDetailMapper.xml, selectProdRshp, SAC : 임근대 , 2014-01-28 */
			PART_PROD_ID
	  	FROM TB_DP_PROD_RSHP
		WHERE PROD_ID = #{channelId}
	</select>    
    
    <select id="selectVodChannel" parameterType="map" resultType="VodDetail">
		SELECT /* VodDetailMapper.xml, selectVodChannel, SAC : 임근대 , 2014-01-28 */
			P.TENANT_ID, P.LANG_CD
			, P.MENU_ID, P.MENU_NM, P2.TOP_MENU_ID, (SELECT MENU_NM FROM TB_DP_MENU_CATEGORY_DESC WHERE MENU_ID = P2.TOP_MENU_ID AND LANG_CD = P.LANG_CD AND ROWNUM = 1) AS TOP_MENU_NM
			, P.EPSD_PLAY_TIME AS RUNNING_TIME
			, P2.META_CLSF_CD, P2.CID, TP.PROD_STATUS_CD, P2.PROD_GRD_CD
			, P2.PROD_ID, P2.REG_DT, P2.SVC_GRP_CD, MP.GENRE_CD
			, PD.PROD_NM, PD.PROD_BASE_DESC, PD.PROD_DTL_DESC, PD.PROD_INTR_DSCR, PD.ARTIST1_NM, PD.ARTIST2_NM, MP.VOD_TITL_NM
			, STORE_PROD_ID, PLAY_PROD_ID
			, ( CASE WHEN ( MP.EPSD_CNT > 0 AND TPP.CHNL_UNLMT_AMT >= 0 ) THEN TPP.CHNL_UNLMT_AMT END ) AS STORE_AMT
			, ( CASE WHEN ( MP.EPSD_CNT > 0 AND TPP.PROD_AMT >= 0 ) THEN TPP.PROD_AMT END ) AS PLAY_AMT
			, MP.DWLD_AREA_LIMT_YN, MP.SVC_START_DT, MP.CHNL_COMP_NM, MP.AGENCY_NM
			, P2.SELLER_MBR_NO, P2.EXPO_SELLER_NM, P2.EXPO_SELLER_TELNO, P2.EXPO_SELLER_EMAIL
			, MP.BRDC_COMP_CD, (SELECT CD_NM FROM TB_CM_CD WHERE CD_ID = MP.BRDC_COMP_CD) AS BRDC_COMP_CD_NM
			, MP.HDV_YN, MP.HDCP_YN, MP.DOLBY_SPRT_YN
			, MP.SAMPL_URL, MP.SC_SAMPL_URL 
			, P2.SELLER_MBR_NO, P2.EXPO_SELLER_NM, P2.EXPO_SELLER_TELNO, P2.EXPO_SELLER_EMAIL
		    , PI.FILE_PATH AS IMG_PATH, PI.FILE_NM AS IMG_NM, PI.FILE_SIZE AS IMG_SIZE
			, NVL(STAT.PATICPERS_CNT, 0) AS PATICPERS_CNT, NVL(STAT.PRCHS_CNT, 0) AS PRCHS_CNT
			<![CDATA[
			, ( CASE WHEN ( MP.EPSD_CNT > 0 AND MP.STRM_NETWORK_CD = 'DP004402' ) THEN 'restrict' END ) AS STORE_DWLD_NET
			, ( CASE WHEN ( MP.EPSD_CNT > 0 AND MP.DWLD_NETWORK_CD = 'DP004402' ) THEN 'restrict' END ) AS PLAY_DWLD_NET
			, ( CASE WHEN ( MP.EPSD_CNT > 0 AND NVL( P.STORE_DRM, 0 ) > 0 ) THEN 'Y' ELSE 'N' END ) AS STORE_DRM_YN
		    , ( CASE WHEN ( MP.EPSD_CNT > 0 AND NVL( P.PLAY_DRM, 0 ) > 0 ) THEN 'Y' ELSE 'N' END ) AS PLAY_DRM_YN
			, NVL((CASE WHEN (STAT.AVG_EVLU_SCORE > 0 AND STAT.AVG_EVLU_SCORE < 1) THEN 1
				WHEN STAT.AVG_EVLU_SCORE > 5 THEN 5
				  ELSE ROUND(STAT.AVG_EVLU_SCORE, 1) END), 0) AS AVG_EVLU_SCORE
		    ]]>
		FROM (
				SELECT RSHP.PROD_ID AS CHNL_PROD_ID, G.TENANT_ID, C.LANG_CD
				    , MAX(RSHP.PART_PROD_ID) AS PROD_ID
					, MAX( D.USE_PERIOD_UNIT_CD ) AS USE_PERIOD_UNIT_CD
					, MAX( A.MENU_ID ) AS MENU_ID, MAX( C.MENU_NM ) AS MENU_NM
					, MAX( D.USE_PERIOD ) AS USE_TERM
					, SUM( DECODE( NVL ( CASE WHEN D.USE_PERIOD_UNIT_CD = 'PD00310' THEN D.DRM_YN END , 'N' ), 'Y', 1, 0 ) ) AS STORE_DRM
					, SUM( DECODE( NVL ( CASE WHEN D.USE_PERIOD_UNIT_CD != 'PD00310' THEN D.DRM_YN END , 'N' ), 'Y', 1, 0 ) ) AS PLAY_DRM
					, MAX(DECODE( D.USE_PERIOD_UNIT_CD, 'PD00310', D.PROD_ID )) AS STORE_PROD_ID, MAX(DECODE( D.USE_PERIOD_UNIT_CD, 'PD00310', NULL, D.PROD_ID )) AS PLAY_PROD_ID
					, MAX( SC.EPSD_PLAY_TM ) AS EPSD_PLAY_TIME
					, MAX( L.DOLBY_SPRT_YN ) AS DOLBY_SPRT_YN
				FROM TB_DP_MENU_CATEGORY_PROD_MAPG A
					INNER JOIN TB_DP_MENU_CATEGORY B		ON A.MENU_ID = B.MENU_ID
					INNER JOIN TB_DP_MENU_CATEGORY_DESC C	ON A.MENU_ID = C.MENU_ID
					INNER JOIN TB_DP_PROD_RSHP RSHP		ON RSHP.PROD_ID = A.PROD_ID
					INNER JOIN TB_DP_PROD D 				ON RSHP.PART_PROD_ID = D.PROD_ID
					INNER JOIN UV_TB_DP_MULTIMDA_PROD E 	ON D.PROD_ID = E.PROD_ID
					INNER JOIN TB_DP_TENANT_PROD G        ON D.PROD_ID = G.PROD_ID
					INNER JOIN TB_DP_TENANT_PROD_PRICE O	ON G.PROD_ID = O.PROD_ID AND O.TENANT_ID = G.TENANT_ID
					INNER JOIN TB_DP_SUB_CONTENTS SC 		ON D.PROD_ID = SC.PROD_ID
					INNER JOIN TB_DP_SPRT_DEVICE K 		ON D.PROD_ID = K.PROD_ID
					INNER JOIN TB_CM_DEVICE L			ON K.DEVICE_MODEL_CD = L.DEVICE_MODEL_CD
				WHERE 1=1
				AND G.TENANT_ID = #{tenantId}			/* tenant ID */
				AND C.LANG_CD = #{langCd}                /* 언어 */
				AND RSHP.PROD_ID = #{channelId} 			/* channel ID */
				AND G.PROD_STATUS_CD IN ('PD000402', 'PD000403', 'PD000404') /* PD000402 : 판매대기 , PD000403 : 판매중, PD000404 : 판매중지 */
				AND G.EXPO_YN = 'Y'                       /* Y : 노출 (노출여부) */
				AND A.BASE_YN = 'Y' AND A.BASE_YN = 'Y' 
				AND B.USE_YN = 'Y'                        /* Y : 사용 (사용여부) */
				AND D.SVC_GRP_CD = 'DP000203'             /* DP000203 : 멀티미디어 */
				AND D.CONTENTS_TYPE_CD = 'PD002502'       /* PD002502 :  */
				AND D.TOP_MENU_ID IN ('DP17', 'DP18')	/* 영화,TV방송 */
				AND SC.SALE_YN ='Y'
				AND SYSDATE BETWEEN O.APPLY_START_DT AND O.APPLY_END_DT
				AND (L.DEVICE_MODEL_CD = #{deviceModel} OR L.DEVICE_MODEL_CD = #{virtualDeviceModelNo}) 		/* 단말모델코드 */
				AND L.USE_YN = 'Y'
				GROUP BY RSHP.PROD_ID, G.TENANT_ID, C.LANG_CD
			) P
			INNER JOIN TB_DP_PROD P2 		ON P2.PROD_ID = P.CHNL_PROD_ID
			INNER JOIN UV_TB_DP_MULTIMDA_PROD MP  ON P.PROD_ID = MP.PROD_ID
			INNER JOIN TB_DP_TENANT_PROD TP	ON P2.PROD_ID = TP.PROD_ID AND P.TENANT_ID = TP.TENANT_ID
			INNER JOIN TB_DP_TENANT_PROD_PRICE TPP ON P2.PROD_ID = TPP.PROD_ID AND P.TENANT_ID = TPP.TENANT_ID
			INNER JOIN TB_DP_PROD_DESC PD		ON P2.PROD_ID = PD.PROD_ID AND P.LANG_CD = PD.LANG_CD
			INNER JOIN TB_DP_PROD_IMG PI 		ON PI.PROD_ID = P.CHNL_PROD_ID
			LEFT OUTER JOIN TB_DP_TENANT_PROD_STATS STAT ON STAT.PROD_ID = P2.PROD_ID AND P.TENANT_ID = STAT.TENANT_ID
		WHERE 1=1
		 AND PI.EXPO_ORD = '1' AND PI.IMG_CD = #{imgCd}
		 AND SYSDATE BETWEEN TPP.APPLY_START_DT AND TPP.APPLY_END_DT
    </select>
    
    <select id="selectSourceList" parameterType="map" resultType="ProductImage">
        SELECT A.*
          FROM (
			SELECT
				FILE_PATH, FILE_NM, FILE_SIZE, EXPO_ORD
			FROM TB_DP_PROD_IMG
			WHERE PROD_ID = #{channelId}
			  AND LANG_CD = #{langCd}
			  AND IMG_CD IN ( 'DP000137', 'DP000138', 'DP000139', 'DP000140' )
			UNION ALL
			SELECT 
				FILE_PATH, FILE_NM, FILE_SIZE, EXPO_ORD
			FROM TB_DP_PROD_IMG
			WHERE PROD_ID = #{channelId}
	          AND LANG_CD = #{langCd}
			  AND IMG_CD IN ( 'DP000128', 'DP000129', 'DP000130', 'DP000131' )
		) A
		ORDER BY EXPO_ORD
    </select>
    
    <select id="selectVodSeries" parameterType="map" resultType="VodDetail">
		SELECT /* VodDetailMapper.xml, selectVodSeries, SAC : 임근대 , 2014-01-28 */
			   TA.TENANT_ID, TA.LANG_CD, TOTAL_COUNT
			 , MENU_ID, MENU_NM, TOP_MENU_ID, (SELECT MENU_NM FROM TB_DP_MENU_CATEGORY_DESC WHERE MENU_ID = TA.TOP_MENU_ID AND LANG_CD = TA.LANG_CD AND ROWNUM = 1) AS TOP_MENU_NM
			 , META_CLSF_CD
			 , CID, CHNL_PROD_ID, ESPD_PROD_ID AS PROD_ID, TA.REG_DT
			 , STORE_PROD_ID, PLAY_PROD_ID, TA.VOD_TITL_NM
			 , PROD_NM, TA.PROD_BASE_DESC, TA.PROD_DTL_DESC, TA.PROD_INTR_DSCR, TA.ARTIST1_NM, TA.ARTIST2_NM
			 , STORE_PROD_AMT, PLAY_PROD_AMT
			 , DECODE( STORE_DRM_YN, 'Y', STORE_DRM_YN, 'N' ) AS STORE_DRM_YN, DECODE( PLAY_DRM_YN, 'Y', STORE_DRM_YN, 'N' ) AS PLAY_DRM_YN  
			 , GENRE_CD, ISSUE_DAY, BRDC_COMP_CD, (SELECT CD_NM FROM TB_CM_CD WHERE CD_ID = TA.BRDC_COMP_CD) AS BRDC_COMP_CD_NM /* 방송사명 */, SVC_START_DT, CHNL_COMP_NM
			 , DECODE( HDCP_YN, 'Y', HDCP_YN, 'N' ) AS HDCP_YN, DECODE( HDV_YN, 'Y', HDV_YN, 'N' ) AS HDV_YN
			 , REGEXP_REPLACE( CHAPTER, '[^[:digit:]]' ) AS CHAPTER
			 , ( CASE WHEN CHAPTER IS NOT NULL THEN '회' END ) AS CHAPTER_UNIT
			 , DECODE( USE_PERIOD_UNIT_CD, 'PD00310', NULL, CONCAT( USE_PERIOD, USE_PERIOD_UNIT_CD_NM ) ) AS USAGE_PERIOD            
			 , DWLD_AREA_LIMT_YN
			 , EPSD_PLAY_TM, PROD_GRD_CD
			 , DECODE( DOLBY_YN , 'Y' , DECODE( DOLBY_SPRT_YN, 'Y', DOLBY_SPRT_YN, 'N' ), 'N' ) AS DOLBY_SPRT_YN
			 , SELLER_MBR_NO, EXPO_SELLER_NM, EXPO_SELLER_TELNO, EXPO_SELLER_EMAIL
			 , REGEXP_SUBSTR(NM_SUB_CONTS,'[^,]+',1,1) AS NM_SUB_CONTS_ID
			 , REGEXP_SUBSTR(SD_SUB_CONTS,'[^,]+',1,1) AS SD_SUB_CONTS_ID
			 , REGEXP_SUBSTR(HD_SUB_CONTS,'[^,]+',1,1) AS HD_SUB_CONTS_ID
			 , REGEXP_SUBSTR(NM_SUB_CONTS,'[^,]+',1,5) AS NM_PROD_VER
			 , REGEXP_SUBSTR(SD_SUB_CONTS,'[^,]+',1,5) AS SD_PROD_VER
			 , REGEXP_SUBSTR(HD_SUB_CONTS,'[^,]+',1,5) AS HD_PROD_VER
			 , NVL2(REGEXP_SUBSTR(NM_SUB_CONTS,'[^,]+',1,2), REGEXP_SUBSTR(NM_SUB_CONTS,'[^,]+',1,2), 0) AS NM_FILE_SIZE
			 , NVL2(REGEXP_SUBSTR(SD_SUB_CONTS,'[^,]+',1,2), REGEXP_SUBSTR(SD_SUB_CONTS,'[^,]+',1,2), 0) AS SD_FILE_SIZE
			 , NVL2(REGEXP_SUBSTR(HD_SUB_CONTS,'[^,]+',1,2), REGEXP_SUBSTR(HD_SUB_CONTS,'[^,]+',1,2), 0) AS HD_FILE_SIZE
			 , ( SELECT CD_NM FROM TB_CM_CD WHERE CD_ID =  REGEXP_SUBSTR(NM_SUB_CONTS,'[^,]+',1,3 ) ) AS NM_DP_PIXEL
			 , ( SELECT CD_NM FROM TB_CM_CD WHERE CD_ID =  REGEXP_SUBSTR(SD_SUB_CONTS,'[^,]+',1,3 ) ) AS SD_DP_PIXEL
			 , ( SELECT CD_NM FROM TB_CM_CD WHERE CD_ID =  REGEXP_SUBSTR(HD_SUB_CONTS,'[^,]+',1,3 ) ) AS HD_DP_PIXEL
			 , ( SELECT CD_NM FROM TB_CM_CD WHERE CD_ID =  REGEXP_SUBSTR(SD_SUB_CONTS,'[^,]+',1,4 ) ) AS NM_DP_PIC_RATIO
			 , ( SELECT CD_NM FROM TB_CM_CD WHERE CD_ID =  REGEXP_SUBSTR(NM_SUB_CONTS,'[^,]+',1,4 ) ) AS SD_DP_PIC_RATIO
			 , ( SELECT CD_NM FROM TB_CM_CD WHERE CD_ID =  REGEXP_SUBSTR(HD_SUB_CONTS,'[^,]+',1,4 ) ) AS HD_DP_PIC_RATIO
			 , DECODE( DWLD_NETWORK_CD , 'DP004402', 'restrict', NULL ) AS DWLD_NETWORK_CD
			 , DECODE( STRM_NETWORK_CD , 'DP004402', 'restrict', NULL ) AS STRM_NETWORK_CD
			 , TB.FILE_PATH  AS IMG_PATH, TB.FILE_NM AS IMG_NM, TB.FILE_SIZE AS IMG_SIZE
			 , TA.FILE_PATH
			 , NVL(STAT.PATICPERS_CNT, 0) AS PATICPERS_CNT
			 , NVL(STAT.PRCHS_CNT, 0) AS PRCHS_CNT
			 <![CDATA[
		     , NVL((CASE WHEN (STAT.AVG_EVLU_SCORE > 0 AND STAT.AVG_EVLU_SCORE < 1) THEN 1
				WHEN STAT.AVG_EVLU_SCORE > 5 THEN 5
		        ELSE ROUND(STAT.AVG_EVLU_SCORE, 1) END), 0) AS AVG_EVLU_SCORE
		     ]]>
		     , SAMPL_URL, SC_SAMPL_URL
		FROM
			 (
			 SELECT  TENANT_ID, LANG_CD, CID, TOTAL_COUNT, ROWNUM AS RNUM
					 , TOP_MENU_ID, MENU_ID, MENU_NM, META_CLSF_CD
					 , CHNL_PROD_ID, ESPD_PROD_ID, REG_DT
					 , STORE_PROD_ID, PLAY_PROD_ID, VOD_TITL_NM
					 , PROD_NM, PROD_BASE_DESC, PROD_DTL_DESC, PROD_INTR_DSCR, ARTIST1_NM, ARTIST2_NM
					 , STORE_PROD_AMT, PLAY_PROD_AMT
					 , STORE_DRM_YN, PLAY_DRM_YN
					 , GENRE_CD, ISSUE_DAY, BRDC_COMP_CD, SVC_START_DT, CHNL_COMP_NM
					 , HDCP_YN, HDV_YN
					 , CHAPTER
					 , USE_PERIOD, USE_PERIOD_UNIT_CD, USE_PERIOD_UNIT_CD_NM
					 , EPSD_PLAY_TM, PROD_GRD_CD
					 , DOLBY_SPRT_YN, DOLBY_YN
					 , DWLD_AREA_LIMT_YN, DWLD_NETWORK_CD, STRM_NETWORK_CD
					 , FILE_PATH
					 , SELLER_MBR_NO, EXPO_SELLER_NM, EXPO_SELLER_TELNO, EXPO_SELLER_EMAIL
					 , DECODE( DOLBY_YN, 'Y', NVL( NM_SUB_CONTS_DB, NM_SUB_CONTS ), NM_SUB_CONTS ) AS NM_SUB_CONTS
					 , DECODE( DOLBY_YN, 'Y', NVL( SD_SUB_CONTS_DB, SD_SUB_CONTS ), SD_SUB_CONTS ) AS SD_SUB_CONTS
					 , DECODE( DOLBY_YN, 'Y', NVL( HD_SUB_CONTS_DB, HD_SUB_CONTS ), HD_SUB_CONTS ) AS HD_SUB_CONTS
					 , SAMPL_URL, SC_SAMPL_URL
				 FROM
					  (
						SELECT  JA.TENANT_ID, JA.LANG_CD, JA.CID, COUNT(*) OVER () AS TOTAL_COUNT
							  , MAX( JA.MENU_ID ) AS MENU_ID, MAX( JA.MENU_NM ) AS MENU_NM, MAX( JA.TOP_MENU_ID ) AS TOP_MENU_ID, MAX( JA.META_CLSF_CD ) AS META_CLSF_CD
							  , MAX( JA.CHNL_PROD_ID ) AS CHNL_PROD_ID, MAX( JA.ESPD_PROD_ID ) AS ESPD_PROD_ID, MAX( JA.REG_DT ) AS REG_DT, MAX( JA.UPD_DT ) AS UPD_DT
							  , MAX( JA.STORE_PROD_ID ) AS STORE_PROD_ID, MAX( JA.PLAY_PROD_ID ) AS PLAY_PROD_ID, MAX( JA.VOD_TITL_NM ) AS VOD_TITL_NM
							  , MAX( JA.PROD_NM ) AS PROD_NM, MAX( JA.PROD_BASE_DESC ) AS PROD_BASE_DESC, MAX( JA.PROD_DTL_DESC ) AS PROD_DTL_DESC, MAX( JA.PROD_INTR_DSCR ) AS PROD_INTR_DSCR, MAX( JA.ARTIST1_NM ) AS ARTIST1_NM, MAX( JA.ARTIST2_NM ) AS ARTIST2_NM
							  , MAX( JA.STORE_PROD_AMT ) AS STORE_PROD_AMT, MAX( JA.PLAY_PROD_AMT ) AS PLAY_PROD_AMT
							  , MAX( JA.STORE_DRM_YN ) AS STORE_DRM_YN, MAX( JA.PLAY_DRM_YN ) AS PLAY_DRM_YN
							  , MAX( JA.GENRE_CD ) AS GENRE_CD, MAX( JA.ISSUE_DAY ) AS ISSUE_DAY, MAX( JA.BRDC_COMP_CD ) AS BRDC_COMP_CD, MAX( JA.SVC_START_DT ) AS SVC_START_DT, MAX( JA.CHNL_COMP_NM ) AS CHNL_COMP_NM
							  , MAX( JA.HDCP_YN ) AS HDCP_YN, MAX( JA.HDV_YN ) AS HDV_YN
							  , MAX( JA.CHAPTER ) AS CHAPTER
							  , MAX( JA.USE_PERIOD ) AS USE_PERIOD, MAX( JA.USE_PERIOD_UNIT_CD ) AS USE_PERIOD_UNIT_CD, MAX( USE_PERIOD_UNIT_CD_NM ) AS USE_PERIOD_UNIT_CD_NM
							  , MAX( JA.DWLD_AREA_LIMT_YN ) AS DWLD_AREA_LIMT_YN
							  , MAX( JA.EPSD_PLAY_TM ) AS EPSD_PLAY_TM, MAX( JA.PROD_GRD_CD ) AS PROD_GRD_CD
							  , MAX( JA.DOLBY_SPRT_YN ) AS DOLBY_SPRT_YN, MAX( JA.DOLBY_YN ) AS DOLBY_YN
							  , MAX( JA.DWLD_NETWORK_CD ) AS DWLD_NETWORK_CD, MAX( JA.STRM_NETWORK_CD ) AS STRM_NETWORK_CD
							  , MAX( JA.FILE_PATH ) AS FILE_PATH
							  , MAX( JA.SELLER_MBR_NO ) AS SELLER_MBR_NO, MAX( JA.EXPO_SELLER_NM ) AS EXPO_SELLER_NM, MAX( JA.EXPO_SELLER_TELNO ) AS EXPO_SELLER_TELNO, MAX( JA.EXPO_SELLER_EMAIL ) AS EXPO_SELLER_EMAIL               
							  , MAX( JA.NM_SUB_CONTS ) AS NM_SUB_CONTS, MAX( JA.SD_SUB_CONTS ) AS SD_SUB_CONTS, MAX( JA.HD_SUB_CONTS ) AS HD_SUB_CONTS
							  , MAX( JA.NM_SUB_CONTS_DB ) AS NM_SUB_CONTS_DB, MAX( JA.SD_SUB_CONTS_DB  ) AS SD_SUB_CONTS_DB, MAX( JA.HD_SUB_CONTS_DB  ) AS HD_SUB_CONTS_DB
							  , MAX( JA.SAMPL_URL ) AS SAMPL_URL, MAX( JA.SC_SAMPL_URL ) AS SC_SAMPL_URL
						  FROM
							   (SELECT  IA.TENANT_ID, IA.LANG_CD, IA.CID
									  , IA.MENU_ID, IA.MENU_NM, IA.MENU_DESC, IA.TOP_MENU_ID, IA.META_CLSF_CD
									  , IA.PROD_ID AS ESPD_PROD_ID, IA.CHNL_PROD_ID, IA.REG_DT, IA.UPD_DT
									  , IA.PROD_NM, IA.PROD_BASE_DESC, IA.PROD_DTL_DESC, IA.PROD_INTR_DSCR, IA.ARTIST1_NM, IA.ARTIST2_NM, IA.VOD_TITL_NM
									  , DECODE( IA.USE_PERIOD_UNIT_CD, 'PD00310', IA.PROD_ID ) AS STORE_PROD_ID, DECODE( IA.USE_PERIOD_UNIT_CD, 'PD00310', NULL, IA.PROD_ID ) AS PLAY_PROD_ID
									  , IA.STORE_PROD_AMT, IA.PLAY_PROD_AMT, IA.STORE_DRM_YN, IA.PLAY_DRM_YN
									  , IA.GENRE_CD, IA.ISSUE_DAY, IA.BRDC_COMP_CD, IA.SVC_START_DT, IA.CHNL_COMP_NM
									  , IA.HDCP_YN, IA.HDV_YN, IA.DOLBY_SPRT_YN, IA.DOLBY_YN
									  , IA.USE_PERIOD, IA.USE_PERIOD_UNIT_CD, (SELECT CD_NM FROM TB_CM_CD WHERE CD_ID = IA.USE_PERIOD_UNIT_CD) AS USE_PERIOD_UNIT_CD_NM, IA.CHAPTER
									  , IA.EPSD_PLAY_TM, IA.PROD_GRD_CD
									  , IA.DWLD_AREA_LIMT_YN, IA.DWLD_NETWORK_CD, IA.STRM_NETWORK_CD
									  , IA.FILE_PATH
									  , IA.SELLER_MBR_NO, IA.EXPO_SELLER_NM, IA.EXPO_SELLER_TELNO, IA.EXPO_SELLER_EMAIL
									  , IA.NM_SUB_CONTS_DB, IA.SD_SUB_CONTS_DB, IA.HD_SUB_CONTS_DB
									  , IA.NM_SUB_CONTS, IA.SD_SUB_CONTS, IA.HD_SUB_CONTS
									  , IA.SAMPL_URL, IA.SC_SAMPL_URL
								  FROM
									   (
									   SELECT 
											  G.TENANT_ID, C.LANG_CD, J.CID
											, A.MENU_ID , C.MENU_NM, C.MENU_DESC, J.TOP_MENU_ID, J.META_CLSF_CD
											, J.PROD_ID, D.PROD_ID AS CHNL_PROD_ID, D.REG_DT, D.UPD_DT
											, Q.PROD_NM, F.PROD_BASE_DESC, F.PROD_DTL_DESC, F.PROD_INTR_DSCR, F.ARTIST1_NM, F.ARTIST2_NM, P.VOD_TITL_NM
											, J.USE_PERIOD, J.USE_PERIOD_UNIT_CD,( SELECT CHAPTER FROM UV_TB_DP_MULTIMDA_PROD WHERE PROD_ID = I.PART_PROD_ID) AS CHAPTER
											, DECODE( J.USE_PERIOD_UNIT_CD, 'PD00310', O.PROD_AMT ) AS STORE_PROD_AMT, DECODE( J.USE_PERIOD_UNIT_CD, 'PD00310', NULL, O.PROD_AMT ) AS PLAY_PROD_AMT
											, DECODE( J.USE_PERIOD_UNIT_CD, 'PD00310', J.DRM_YN ) AS STORE_DRM_YN, DECODE( J.USE_PERIOD_UNIT_CD, 'PD00310', NULL, J.DRM_YN ) AS PLAY_DRM_YN
											, E.GENRE_CD, E.ISSUE_DAY, E.BRDC_COMP_CD, E.SVC_START_DT, E.CHNL_COMP_NM
											, E.HDCP_YN, E.HDV_YN, E.DOLBY_SPRT_YN, L.DOLBY_SPRT_YN AS DOLBY_YN
											, M.EPSD_PLAY_TM, J.PROD_GRD_CD
											, E.DWLD_AREA_LIMT_YN, E.DWLD_NETWORK_CD, E.STRM_NETWORK_CD
											, M.FILE_PATH
											, J.SELLER_MBR_NO, J.EXPO_SELLER_NM, J.EXPO_SELLER_TELNO, J.EXPO_SELLER_EMAIL
											, P.SAMPL_URL, P.SC_SAMPL_URL
											, ( CASE WHEN ( M.AUDIO_TYPE_CD = 'PD002215' AND M.DP_PG_QULT_CD = 'PD009701' ) THEN
													  M.SUB_CONTENTS_ID||','||M.FILE_SIZE||','||M.RSLTN_CD||','||M.DP_PG_RATIO_CD||','||M.PROD_VER
												  END ) AS NM_SUB_CONTS_DB
											, ( CASE WHEN ( M.AUDIO_TYPE_CD = 'PD002215' AND M.DP_PG_QULT_CD = 'PD009702' ) THEN
													  M.SUB_CONTENTS_ID||','||M.FILE_SIZE||','||M.RSLTN_CD||','||M.DP_PG_RATIO_CD||','||M.PROD_VER
												  END ) AS SD_SUB_CONTS_DB
											, ( CASE WHEN ( E.HDV_YN = 'Y' AND M.AUDIO_TYPE_CD = 'PD002215' AND M.DP_PG_QULT_CD = 'PD009703' ) THEN
													  M.SUB_CONTENTS_ID||','||M.FILE_SIZE||','||M.RSLTN_CD||','||M.DP_PG_RATIO_CD||','||M.PROD_VER
												  END ) AS HD_SUB_CONTS_DB
											, ( CASE WHEN ( ( M.AUDIO_TYPE_CD IS NULL OR M.AUDIO_TYPE_CD != 'PD002215' ) AND M.DP_PG_QULT_CD = 'PD009701' ) THEN
													  M.SUB_CONTENTS_ID||','||M.FILE_SIZE||','||M.RSLTN_CD||','||M.DP_PG_RATIO_CD||','||M.PROD_VER
												  END ) AS NM_SUB_CONTS
											, ( CASE WHEN ( ( M.AUDIO_TYPE_CD IS NULL OR M.AUDIO_TYPE_CD != 'PD002215' ) AND M.DP_PG_QULT_CD = 'PD009702' ) THEN
													  M.SUB_CONTENTS_ID||','||M.FILE_SIZE||','||M.RSLTN_CD||','||M.DP_PG_RATIO_CD||','||M.PROD_VER
												  END ) AS SD_SUB_CONTS
											, ( CASE WHEN (  E.HDV_YN = 'Y' AND ( M.AUDIO_TYPE_CD IS NULL OR M.AUDIO_TYPE_CD != 'PD002215' ) AND M.DP_PG_QULT_CD = 'PD009703' ) THEN
													 M.SUB_CONTENTS_ID||','||M.FILE_SIZE||','||M.RSLTN_CD||','||M.DP_PG_RATIO_CD||','||M.PROD_VER
												  END ) AS HD_SUB_CONTS
										  FROM TB_DP_MENU_CATEGORY_PROD_MAPG A
											 INNER JOIN TB_DP_MENU_CATEGORY B		ON A.MENU_ID = B.MENU_ID
											 INNER JOIN TB_DP_MENU_CATEGORY_DESC C	ON A.MENU_ID = C.MENU_ID
											 INNER JOIN TB_DP_PROD D 				ON A.PROD_ID = D.PROD_ID
											 INNER JOIN UV_TB_DP_MULTIMDA_PROD E		ON D.PROD_ID = E.PROD_ID
											 INNER JOIN TB_DP_PROD_DESC F			ON D.PROD_ID = F.PROD_ID AND F.LANG_CD = C.LANG_CD
											 INNER JOIN TB_DP_TENANT_PROD G			ON D.PROD_ID = G.PROD_ID
											 INNER JOIN TB_DP_PROD_RSHP I			ON D.PROD_ID = I.PROD_ID
											 INNER JOIN TB_DP_SPRT_DEVICE K			ON I.PART_PROD_ID = K.PROD_ID
											 INNER JOIN TB_CM_DEVICE L				ON K.DEVICE_MODEL_CD = L.DEVICE_MODEL_CD
											 INNER JOIN TB_DP_PROD J				ON I.PART_PROD_ID = J.PROD_ID
											 INNER JOIN TB_DP_SUB_CONTENTS M		ON J.PROD_ID = M.PROD_ID
											 INNER JOIN TB_DP_TENANT_PROD N			ON J.PROD_ID = N.PROD_ID AND N.TENANT_ID = G.TENANT_ID
											 INNER JOIN TB_DP_TENANT_PROD_PRICE O	ON J.PROD_ID = O.PROD_ID AND O.TENANT_ID = G.TENANT_ID
											 INNER JOIN UV_TB_DP_MULTIMDA_PROD P		ON J.PROD_ID = P.PROD_ID
											 INNER JOIN TB_DP_PROD_DESC Q			ON J.PROD_ID = Q.PROD_ID AND C.LANG_CD = Q.LANG_CD
										 WHERE 1=1
										   AND G.TENANT_ID = #{tenantId}			/* tenant ID */
										   AND D.PROD_ID = #{channelId} 			/* channel ID */
										   AND C.LANG_CD = #{langCd}                /* 언어 */
                                           AND (K.DEVICE_MODEL_CD = #{deviceModel} OR K.DEVICE_MODEL_CD = #{virtualDeviceModelNo}) 		/* 단말모델코드 */
										   AND L.USE_YN = 'Y'
										   AND B.USE_YN = 'Y'                       /* Y : 사용 (사용여부) */
										   AND D.SVC_GRP_CD = 'DP000203'            /* DP000203 : 멀티미디어 */
										   AND D.CONTENTS_TYPE_CD = 'PD002501'      /* PD002501 : 채널타입 */
										   AND D.TOP_MENU_ID IN ('DP17', 'DP18')	/* 영화,TV방송 */
										   AND G.PROD_STATUS_CD IN ('PD000402', 'PD000403', 'PD000404') /* PD000402 : 판매대기 , PD000403 : 판매중, PD000404 : 판매중지 */
										   AND G.EXPO_YN = 'Y'                      /* Y : 노출 (노출여부) */ 
										   AND J.SVC_GRP_CD = 'DP000203'       		/* 서비스그룹코드 : 멀티미디어 */  
										   AND J.CONTENTS_TYPE_CD = 'PD002502'      /* 컨텐츠 타입코드 : (PD002502:에피소드타입) */  
										   AND J.TOP_MENU_ID IN ('DP17', 'DP18')	/* 영화,TV방송 */
										   AND DECODE( L.SD_VIDEO_SPRT_YN , 'Y' , DECODE( M.DP_PG_QULT_CD, 'PD009701', 1, 'PD009702', 1, DECODE( L.HDV_SPRT_YN, 'Y', 1, 0 ) ), DECODE( M.DP_PG_QULT_CD, 'PD009701', 1, 0 ) ) = 1
										   AND (CASE WHEN L.VIDEO_DRM_SPRT_YN = 'N' AND NVL(J.DRM_YN, 'N') = 'Y' THEN 'NOT SUPPORT'
													 ELSE 'SUPPORT' END) = 'SUPPORT' /* DRM 미지원 단말이고 에피소드 상품이 DRM 상품일 경우 노출 안함 */                                                                                                                                     
										   AND M.SALE_YN ='Y'                                       
										   AND N.PROD_STATUS_CD IN ('PD000403', 'PD000404', 'PD000409') /* PD000403 : 판매중, PD000404 : 판매중지, PD000409 : 판매불가-다운허용 */
										   AND N.EXPO_YN = 'Y'                       /* Y : 노출 (노출여부) */                                         
										   AND SYSDATE BETWEEN O.APPLY_START_DT AND O.APPLY_END_DT
										   <if test="orderedBy == 'nonPayment'">
										   <if test="paymentProdIdList !=null and paymentProdIdList.size() > 0">
										   AND J.PROD_ID NOT IN  
											  <foreach collection="paymentProdIdList" item="item" index="index" open="(" separator="," close=")">
											  #{item}
											  </foreach>
										   </if>
										   </if>
									   ) IA
							   )JA
						  GROUP BY JA.CID, JA.TENANT_ID, JA.LANG_CD
						  <if test="orderedBy == 'recent'">
						      ORDER BY TO_NUMBER( REGEXP_REPLACE(CHAPTER, '[^[:digit:]]') ) DESC, UPD_DT DESC
						  </if>
						  <if test="orderedBy == 'regDate'">
						      ORDER BY TO_NUMBER( REGEXP_REPLACE(CHAPTER, '[^[:digit:]]') ) ASC, UPD_DT DESC
						  </if>
					  )  KA
			 ) TA  
				 LEFT OUTER JOIN TB_DP_PROD_IMG TB
					ON  TA.CHNL_PROD_ID = TB.PROD_ID AND TB.LANG_CD = TA.LANG_CD
				 LEFT OUTER JOIN TB_DP_TENANT_PROD_STATS STAT
					ON TA.TENANT_ID = STAT.TENANT_ID AND TA.CHNL_PROD_ID = STAT.PROD_ID
		  	WHERE RNUM BETWEEN #{offset} AND (#{offset}+#{count}-1)
			  AND TB.EXPO_ORD = '1'
			  AND TB.IMG_CD = #{imgCd}
    </select>
    
</mapper>
