<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="FeatureCategory">
    <!-- 영화 추천 및 영화 1000원관 상품 조회 -->
    <select id="selectFeatureMovieList" parameterType="FeatureCategoryVodReq" resultType="FeatureCategoryVodDTO">
		SELECT  /* FeatureCategoryMapper.xml, selectFeatureMovieList, tae hee Lee, 2014-01-07 */
		        LA.TOTAL_COUNT
		      , LA.RNUM
		      , LA.TOP_MENU_ID
		      , LA.MENU_ID
		      , LA.MENU_NM
		      , LA.MENU_DESC
		      , LA.META_CLSF_CD
		      , LA.PROD_ID
		      , LA.PART_PROD_ID
		      , LA.VOD_TITL_NM
		      , LA.PROD_NM
		      , LA.PROD_BASE_DESC
		      , LA.PROD_GRD_CD
		      , LA.ARTIST1_NM
		      , LA.ARTIST2_NM
		      , LA.ISSUE_DAY
		      , LA.CHNL_COMP_NM
		      , LA.AGENCY_NM
		      , LA.HDV_YN
		      , LA.DOLBY_SPRT_YN
		      <![CDATA[
		      , CASE WHEN (LA.USE_PERIOD_UNIT_CD = 'PD00312' AND STRM_EPSD_CNT > 0) THEN CHNL_PERIOD_AMT
		             ELSE CHNL_UNLMT_AMT END AS PROD_AMT
              ]]>
		      , NVL(LB.PATICPERS_CNT, 0) AS PATICPERS_CNT
		      , NVL(LB.PRCHS_CNT, 0) AS PRCHS_CNT
              <![CDATA[
		      , NVL((CASE WHEN (LB.AVG_EVLU_SCORE > 0 AND LB.AVG_EVLU_SCORE < 1) THEN 1
		                  WHEN LB.AVG_EVLU_SCORE > 5 THEN 5
		                  ELSE ROUND(LB.AVG_EVLU_SCORE, 1) END), 0) AS AVG_EVLU_SCORE
              ]]>
		      , CONCAT(LC.FILE_PATH, LC.FILE_NM) AS IMG_PATH
		      , (SELECT MENU_NM
		           FROM TB_DP_MENU_CATEGORY_DESC
		          WHERE MENU_ID = LA.TOP_MENU_ID
		            AND LANG_CD = 'ko'
		            AND ROWNUM = 1) AS TOP_MENU_NM
		      , (SELECT SAMPL_URL FROM TB_DP_MULTIMDA_PROD WHERE PROD_ID = LA.PART_PROD_ID AND ROWNUM = 1) AS SAMPL_URL
		      , LA.PROD_CHRG_YN
		  FROM (SELECT KA.*
		          FROM (SELECT JA.*
		                     <if test='filteredBy == "recommend"'>
		                     , ROW_NUMBER() OVER(ORDER BY JA.EXPO_ORD, JA.PROD_NM) AS RNUM
		                     </if>
		                     <if test='filteredBy == "movie1000"'>
		                     , ROW_NUMBER() OVER(ORDER BY JA.EXPO_ORD, JA.UPD_DT DESC, JA.PROD_NM) AS RNUM
		                     </if>
		                  FROM (SELECT IA.*, COUNT(IA.PROD_ID) OVER() AS TOTAL_COUNT
		                          FROM (SELECT ROW_NUMBER() OVER(PARTITION BY A.PROD_ID ORDER BY D.UPD_DT DESC) AS RN
		                                     , A.TENANT_ID
		                                     , A.MENU_ID
		                                     , A.PROD_ID
		                                     , A.EXPO_ORD
		                                     , B.UP_MENU_ID
		                                     , B.TOP_MENU_ID
		                                     , C.MENU_NM
		                                     , C.MENU_DESC
		                                     , D.PROD_GRD_CD
		                                     , D.USE_PERIOD_UNIT_CD
		                                     , D.UPD_DT
		                                     , D.META_CLSF_CD
		                                     , E.VOD_TITL_NM
		                                     , E.STRM_EPSD_CNT
		                                     , E.ISSUE_DAY
		                                     , E.CHNL_COMP_NM
		                                     , E.AGENCY_NM
		                                     , E.HDV_YN
		                                     , E.DOLBY_SPRT_YN
		                                     , F.PROD_NM
		                                     , F.ARTIST1_NM
		                                     , F.ARTIST2_NM
		                                     , F.PROD_BASE_DESC
		                                     , H.CHNL_PERIOD_AMT
		                                     , H.CHNL_UNLMT_AMT
		                                     , I.PART_PROD_ID
		                                     , J.DRM_YN
		                                     , D.PROD_CHRG_YN
		                                  FROM (SELECT  TENANT_ID
		                                              , LIST_ID
		                                              , MENU_ID
		                                              , PROD_ID
		                                              , EXPO_ORD
		                                          FROM  TB_DP_LIST_PROD
		                                         WHERE  TENANT_ID = #{tenantId}   /* 테넌트ID */
		                                           AND  LIST_ID = #{listId}       /* ADM000000008 : 운영자추천 멀티미디어 */
                                                 <if test='filteredBy == "recommend"'>
		                                           AND  ETC_CD = 'DP004801'       /* DP004801 : 영화 */
                                                 </if>
                                                 <if test='filteredBy == "movie1000"'>
		                                           AND  ETC_CD = 'DP004807'       /* DP004807 : 1000원관 */
                                                 </if>
		                                           AND  EXPO_YN = 'Y'             /* Y : 노출 (노출여부) */
		                                           AND  TO_CHAR(STD_DT, 'YYYYMMDDHH24MISS') = #{stdDt}
		                                           AND  SYSDATE BETWEEN EXPO_START_DT AND EXPO_END_DT
		                                       )                        A
		                                     , TB_DP_MENU_CATEGORY      B
		                                     , TB_DP_MENU_CATEGORY_DESC C
		                                     , TB_DP_PROD               D
		                                     , TB_DP_MULTIMDA_PROD      E
		                                     , TB_DP_PROD_DESC          F
		                                     , TB_DP_TENANT_PROD        G
		                                     , TB_DP_TENANT_PROD_PRICE  H
		                                     , TB_DP_PROD_RSHP          I
		                                     , TB_DP_PROD               J
		                                     , TB_DP_SPRT_DEVICE        K
		                                 WHERE A.MENU_ID = B.MENU_ID
		                                   AND A.MENU_ID = C.MENU_ID
		                                   AND A.PROD_ID = D.PROD_ID
		                                   AND A.PROD_ID = E.PROD_ID
		                                   AND A.PROD_ID = F.PROD_ID
		                                   AND A.PROD_ID = G.PROD_ID
		                                   AND A.TENANT_ID = G.TENANT_ID
		                                   AND A.PROD_ID = H.PROD_ID
		                                   AND A.TENANT_ID = H.TENANT_ID
		                                   AND A.PROD_ID = I.PROD_ID
		                                   AND I.PART_PROD_ID = J.PROD_ID
		                                   AND I.PART_PROD_ID = K.PROD_ID(+)
		                                   AND B.USE_YN = 'Y'                          /* Y : 사용 (사용여부) */
		                                   AND C.LANG_CD = 'ko'                        /* ko : 한국어 */
		                                   AND D.SVC_GRP_CD = 'DP000203'               /* DP000201 : 멀티미디어 */
		                                   AND D.CONTENTS_TYPE_CD = 'PD002501'         /* PD002501 : 채널타입 */
		                                   AND F.LANG_CD = 'ko'                        /* ko : 한국어 */
		                                   AND G.PROD_STATUS_CD = 'PD000403'           /* PD000403 : 판매중 */
		                                   AND G.EXPO_YN = 'Y'                         /* Y : 노출 (노출여부) */
		                                   AND SYSDATE BETWEEN H.APPLY_START_DT AND H.APPLY_END_DT
		                                   AND J.CONTENTS_TYPE_CD = 'PD002502'         /* PD002502 : 에피소드타입 */
		                                   AND K.DEVICE_MODEL_CD(+) = #{deviceModelCd} /* 단말기 모델 코드 */
		                                   AND K.PROD_ID IS NOT NULL                   /* 멀티미디어 상품 지원단말 블랙리스트 처리 (현재 데이터는 화이트리스트) */
		                                   AND (CASE WHEN (SELECT VIDEO_DRM_SPRT_YN FROM TB_CM_DEVICE WHERE DEVICE_MODEL_CD = #{deviceModelCd}) = 'N' AND NVL(J.DRM_YN, 'N') = 'Y' THEN 'NOT SUPPORT'
		                                             ELSE 'SUPPORT' END) = 'SUPPORT'   /* DRM 미지원 단말이고 에피소드 상품이 DRM 상품일 경우 노출 안함 */
		                                   AND B.TOP_MENU_ID = #{topMenuId}            /* 탑메뉴ID */
                                         <if test='prodGradeCd != null and prodGradeCd != ""'>
		                                   AND D.PROD_GRD_CD = #{prodGradeCd}          /* 상품등급코드 */
                                         </if>
		                               ) IA
		                         WHERE IA.RN = 1
		                       ) JA
		               ) KA
		         WHERE KA.RNUM BETWEEN #{offset} AND #{count}
		       )                       LA
		     , TB_DP_TENANT_PROD_STATS LB
		     , TB_DP_PROD_IMG          LC
		 WHERE LA.TENANT_ID = LB.TENANT_ID(+)
		   AND LA.PROD_ID = LB.PROD_ID(+)
		   AND LA.PROD_ID = LC.PROD_ID
		   AND LC.EXPO_ORD = '1'
		   AND LC.LANG_CD = 'ko'
		   AND LC.IMG_CD = #{imageCd}
    </select>
    
    <!-- 방송 추천 상품 조회 -->
    <select id="selectFeatureBroadcastList" parameterType="FeatureCategoryVodReq" resultType="FeatureCategoryVodDTO">
		SELECT  /* FeatureCategoryMapper.xml, selectFeatureBroadcastList, tae hee Lee, 2014-01-14 */
		        LA.TOTAL_COUNT
		      , LA.RNUM
		      , LA.TOP_MENU_ID
		      , LA.MENU_ID
		      , LA.MENU_NM
		      , LA.MENU_DESC
		      , LA.META_CLSF_CD
		      , LA.PROD_ID
		      , LA.PART_PROD_ID
		      , LA.VOD_TITL_NM
		      , LA.PROD_NM
		      , LA.CHAPTER
		      , LA.PROD_BASE_DESC
		      , LA.PROD_GRD_CD
		      , LA.ARTIST1_NM
		      , LA.ARTIST2_NM
		      , LA.ISSUE_DAY
		      , LA.CHNL_COMP_NM
		      , LA.AGENCY_NM
		      , LA.HDV_YN
		      , LA.DOLBY_SPRT_YN
		      <![CDATA[
		      , CASE WHEN (LA.USE_PERIOD_UNIT_CD = 'PD00312' AND STRM_EPSD_CNT > 0) THEN CHNL_PERIOD_AMT
		             ELSE CHNL_UNLMT_AMT END AS PROD_AMT
              ]]>
		      , NVL(LB.PATICPERS_CNT, 0) AS PATICPERS_CNT
		      , NVL(LB.PRCHS_CNT, 0) AS PRCHS_CNT
		      <![CDATA[
		      , NVL((CASE WHEN (LB.AVG_EVLU_SCORE > 0 AND LB.AVG_EVLU_SCORE < 1) THEN 1
		                  WHEN LB.AVG_EVLU_SCORE > 5 THEN 5
		                  ELSE ROUND(LB.AVG_EVLU_SCORE, 1) END), 0) AS AVG_EVLU_SCORE
              ]]>
		      , CONCAT(LC.FILE_PATH, LC.FILE_NM) AS IMG_PATH
		      , (SELECT MENU_NM
		           FROM TB_DP_MENU_CATEGORY_DESC
		          WHERE MENU_ID = LA.TOP_MENU_ID
		            AND LANG_CD = 'ko'
		            AND ROWNUM = 1) AS TOP_MENU_NM
		     , LA.SAMPL_URL
		     , LA.PROD_CHRG_YN
		  FROM (SELECT KA.*
		          FROM (SELECT JA.*
		                     , ROW_NUMBER() OVER(ORDER BY JA.EXPO_ORD, JA.PROD_NM) AS RNUM
		                  FROM (SELECT IA.*, COUNT(IA.PROD_ID) OVER() AS TOTAL_COUNT
		                          FROM (SELECT ROW_NUMBER() OVER(PARTITION BY A.PROD_ID ORDER BY TO_NUMBER(REGEXP_REPLACE(K.CHAPTER, '[^[:digit:]]')) DESC, J.REG_DT DESC) AS RN
		                                     , A.TENANT_ID
		                                     , A.MENU_ID
		                                     , A.PROD_ID
		                                     , A.EXPO_ORD
		                                     , B.UP_MENU_ID
		                                     , B.TOP_MENU_ID
		                                     , C.MENU_NM
		                                     , C.MENU_DESC
		                                     , D.PROD_GRD_CD
		                                     , D.USE_PERIOD_UNIT_CD
		                                     , D.UPD_DT
		                                     , D.META_CLSF_CD
		                                     , E.VOD_TITL_NM
		                                     , E.STRM_EPSD_CNT
		                                     , E.ISSUE_DAY
		                                     , E.CHNL_COMP_NM
		                                     , E.AGENCY_NM
		                                     , E.HDV_YN
		                                     , E.DOLBY_SPRT_YN
		                                     , F.PROD_NM
		                                     , F.ARTIST1_NM
		                                     , F.ARTIST2_NM
		                                     , F.PROD_BASE_DESC
		                                     , H.CHNL_PERIOD_AMT
		                                     , H.CHNL_UNLMT_AMT
		                                     , I.PART_PROD_ID
		                                     , J.DRM_YN
		                                     , K.CHAPTER
		                                     , K.SAMPL_URL
		                                     , D.PROD_CHRG_YN
		                                  FROM (SELECT  TENANT_ID
		                                              , LIST_ID
		                                              , MENU_ID
		                                              , PROD_ID
		                                              , EXPO_ORD
		                                          FROM  TB_DP_LIST_PROD
		                                         WHERE  TENANT_ID = #{tenantId}   /* 테넌트ID */
		                                           AND  LIST_ID = #{listId}       /* ADM000000008 : 운영자추천 멀티미디어 */
                                                 <if test='filteredBy == "westernDrama"'>
		                                           AND  ETC_CD = 'DP004803'       /* 미드/외화 */  
                                                 </if>
                                                 <if test='filteredBy == "drama"'>
		                                           AND  ETC_CD = 'DP004804'       /* 드라마 */
                                                 </if>
                                                 <if test='filteredBy == "entertainmentFun"'>
		                                           AND  ETC_CD = 'DP004805'       /* 연예/오락 */
                                                 </if>
                                                 <if test='filteredBy == "animationKids"'>
		                                           AND  ETC_CD = 'DP004806'       /* 애니/키즈 */
                                                 </if>
                                                 <if test='filteredBy == "cable"'>
		                                           AND  ETC_CD = 'DP004811'       /* 케이블 */
                                                 </if>
                                                 <if test='filteredBy == "special"'>
		                                           AND  ETC_CD = 'DP004812'       /* 스페셜 */
                                                 </if>
		                                           AND  EXPO_YN = 'Y'             /* Y : 노출 (노출여부) */
		                                           AND  TO_CHAR(STD_DT, 'YYYYMMDDHH24MISS') = #{stdDt}
		                                           AND  SYSDATE BETWEEN EXPO_START_DT AND EXPO_END_DT
		                                       )                        A
		                                     , TB_DP_MENU_CATEGORY      B
		                                     , TB_DP_MENU_CATEGORY_DESC C
		                                     , TB_DP_PROD               D
		                                     , TB_DP_MULTIMDA_PROD      E
		                                     , TB_DP_PROD_DESC          F
		                                     , TB_DP_TENANT_PROD        G
		                                     , TB_DP_TENANT_PROD_PRICE  H
		                                     , TB_DP_PROD_RSHP          I
		                                     , TB_DP_PROD               J
		                                     , TB_DP_MULTIMDA_PROD      K
		                                     , TB_DP_SPRT_DEVICE        L
		                                 WHERE A.MENU_ID = B.MENU_ID
		                                   AND A.MENU_ID = C.MENU_ID
		                                   AND A.PROD_ID = D.PROD_ID
		                                   AND A.PROD_ID = E.PROD_ID
		                                   AND A.PROD_ID = F.PROD_ID
		                                   AND A.PROD_ID = G.PROD_ID
		                                   AND A.TENANT_ID = G.TENANT_ID
		                                   AND A.PROD_ID = H.PROD_ID
		                                   AND A.TENANT_ID = H.TENANT_ID
		                                   AND A.PROD_ID = I.PROD_ID
		                                   AND I.PART_PROD_ID = J.PROD_ID
		                                   AND I.PART_PROD_ID = K.PROD_ID
		                                   AND I.PART_PROD_ID = L.PROD_ID(+)
		                                   AND B.USE_YN = 'Y'                          /* Y : 사용 (사용여부) */
		                                   AND C.LANG_CD = 'ko'                        /* ko : 한국어 */
		                                   AND D.SVC_GRP_CD = 'DP000203'               /* DP000201 : 멀티미디어 */
		                                   AND D.CONTENTS_TYPE_CD = 'PD002501'         /* PD002501 : 채널타입 */
		                                   AND F.LANG_CD = 'ko'                        /* ko : 한국어 */
		                                   AND G.PROD_STATUS_CD = 'PD000403'           /* PD000403 : 판매중 */
		                                   AND G.EXPO_YN = 'Y'                         /* Y : 노출 (노출여부) */
		                                   AND SYSDATE BETWEEN H.APPLY_START_DT AND H.APPLY_END_DT
		                                   AND J.CONTENTS_TYPE_CD = 'PD002502'         /* PD002502 : 에피소드타입 */
		                                   AND L.DEVICE_MODEL_CD(+) = #{deviceModelCd} /* 단말기 모델 코드 */
		                                   AND L.PROD_ID IS NOT NULL                   /* 멀티미디어 상품 지원단말 블랙리스트 처리 (현재 데이터는 화이트리스트) */
		                                   AND (CASE WHEN (SELECT VIDEO_DRM_SPRT_YN FROM TB_CM_DEVICE WHERE DEVICE_MODEL_CD = #{deviceModelCd}) = 'N' AND NVL(J.DRM_YN, 'N') = 'Y' THEN 'NOT SUPPORT'
		                                             ELSE 'SUPPORT' END) = 'SUPPORT'   /* DRM 미지원 단말이고 에피소드 상품이 DRM 상품일 경우 노출 안함 */
		                                   AND B.TOP_MENU_ID = #{topMenuId}            /* 탑메뉴ID */
                                         <if test='prodGradeCd != null and prodGradeCd != ""'>
                                           AND D.PROD_GRD_CD = #{prodGradeCd}          /* 상품등급코드 */
                                         </if>
		                               ) IA
		                         WHERE IA.RN = 1
		                       ) JA
		               ) KA
		         WHERE KA.RNUM BETWEEN #{offset} AND #{count}
		       )                       LA
		     , TB_DP_TENANT_PROD_STATS LB
		     , TB_DP_PROD_IMG          LC
		 WHERE LA.TENANT_ID = LB.TENANT_ID(+)
		   AND LA.PROD_ID = LB.PROD_ID(+)
		   AND LA.PROD_ID = LC.PROD_ID
		   AND LC.EXPO_ORD = '1'
		   AND LC.LANG_CD = 'ko'
		   AND LC.IMG_CD = #{imageCd}
    </select>
    
    <!--운영자 추천 이북/코믹 더미 조회-->
    <select id="selectCategoryEpubListDummy" parameterType="FeatureCategoryEpubReq" resultType="FeatureCategoryEpubDTO">
       /* FeatureCategoryMapper.xml, selectCategoryEpubListDummy, SAC : 서영배 , 2014-01-03 */
       SELECT
			PROD.*
			, NVL(ST.DWLD_CNT, 0) DWLD_CNT
			, NVL(ST.PRCHS_CNT, 0) PRCHS_CNT
		FROM (
			SELECT 
				COUNT(*) OVER () AS TOTAL_COUNT
				, LP.TENANT_ID
				, MN.UP_MENU_ID AS TOP_MENU_ID
				, (SELECT MENU_NM FROM TB_DP_MENU_CATEGORY_DESC WHERE MENU_ID = MN.UP_MENU_ID AND LANG_CD = 'ko') TOP_MENU_NM
				, MN.MENU_ID
				, (SELECT MENU_NM FROM TB_DP_MENU_CATEGORY_DESC WHERE MENU_ID = MN.MENU_ID AND LANG_CD = 'ko') MENU_NM
				, DP.PROD_ID
				, DP.META_CLSF_CD
				, AP.BOOK_CLSF_CD
				, AP.CHAPTER
                , CONCAT( PS.PROD_NM
                	, NVL2( AP.BOOK_CLSF_CD
                       , ' '||CONCAT( AP.CHAPTER
                                    , DECODE( AP.BOOK_CLSF_CD
                                            , 'DP004301', '권'
                                            , 'DP004302', '회'
                                            , 'DP004303', '호' ) )
                       , NULL ) ) AS PROD_NM
				, PS.PROD_BASE_DESC
				, PR.PROD_AMT
				, PR.PROD_NET_AMT
				, PS.ARTIST1_NM
        		, PS.ARTIST2_NM
        		, PS.ARTIST3_NM
				, DECODE( DP.PROD_GRD_CD
				        , 'PD004401', 0
				        , 'PD004402', 1
				        , 'PD004403', 2
				        , 'PD004404', 4 ) AS PROD_GRD_CD
				, AP.CHNL_COMP_NM
        		, AP.ISSUE_DAY
        		, AP.BOOK_PAGE_CNT
        		, NVL(AP.EPSD_CNT, 0) EPSD_CNT
        		, NVL(AP.STRM_EPSD_CNT, 0) STRM_EPSD_CNT
        		, AP.CAPTION_YN
				, ( CASE WHEN DP.META_CLSF_CD = 'CT20' THEN 'serial' END ) AS BOOK_TYPE
        		, ( CASE WHEN DP.META_CLSF_CD = 'CT20' THEN ( AP.EPSD_CNT + AP.STRM_EPSD_CNT ) END ) AS BOOK_COUNT
        		, ( CASE WHEN AP.EPSD_CNT > 0 THEN 'store' END ) AS SUPPORT_STORE
        		, ( CASE WHEN AP.STRM_EPSD_CNT > 0 THEN 'play' END ) AS SUPPORT_PLAY
        		, ( CASE WHEN DP.META_CLSF_CD = 'CT20' THEN DECODE( AP.CAPTION_YN, 'Y', 'completed', 'continue' ) END ) AS BOOK_STATUS
				, SC.FILE_SIZE AS FILE_SIZE
				, PI.FILE_PATH || PI.FILE_NM AS FILE_PATH
			FROM 
				TB_DP_LIST_PROD LP,
				TB_DP_PROD DP,
				TB_DP_TENANT_PROD_PRICE PR,
				TB_DP_MENU_CATEGORY_PROD_MAPG MP, 
				TB_DP_MULTIMDA_PROD AP,
				TB_DP_TENANT_PROD TP, 
				TB_DP_PROD_DESC PS,
				TB_DP_SUB_CONTENTS SC,
				TB_DP_PROD_IMG PI,
				TB_DP_MENU_CATEGORY MN
			WHERE LP.LIST_ID LIKE 'ADM%'
			AND DP.PROD_ID = LP.PROD_ID
			AND DP.PROD_ID = PR.PROD_ID
			AND MP.PROD_ID = DP.PROD_ID
			AND DP.PROD_ID = AP.PROD_ID
			AND DP.PROD_ID = TP.PROD_ID
			AND DP.PROD_ID = PS.PROD_ID
			AND DP.PROD_ID = SC.PROD_ID
			AND DP.PROD_ID = PI.PROD_ID
			AND MN.MENU_ID = MP.MENU_ID
			AND PI.IMG_CD = 'DP000109'
			AND ROWNUM <![CDATA[<=]]> #{count}
			AND DP.META_CLSF_CD IN ('CT20','CT19')
		) PROD LEFT OUTER JOIN TB_DP_TENANT_PROD_STATS ST
		ON PROD.PROD_ID = ST.PROD_ID
		AND PROD.TENANT_ID = ST.TENANT_ID
    </select>    
    
    <!--운영자 추천 앱상품 조회-->
    <select id="selectTopMenuAppListByRecent" parameterType="FeatureCategoryAppReq" resultType="FeatureCategoryAppDTO">
        /* FeatureCategoryMapper.xml, selectTopMenuAppListByRecent, SAC : 서영배 , 2014-01-03 */
		SELECT
			F_PROD.*
			, NVL(ST.DWLD_CNT, 0) AS DWLD_CNT
			, NVL(ST.PRCHS_CNT, 0) AS PRCHS_CNT
			, NVL(
				( 
					CASE WHEN ( ST.AVG_EVLU_SCORE <![CDATA[>]]> 0 AND ST.AVG_EVLU_SCORE <![CDATA[<]]> 1 ) THEN 1
                    	WHEN ST.AVG_EVLU_SCORE > 5 THEN 5
                    	ELSE ROUND( ST.AVG_EVLU_SCORE , 1 )
                    END ) 
                  , 0 ) AS AVG_EVLU_SCORE
		FROM (
				SELECT
					R_PROD.*
				FROM (
					SELECT
						T_PROD.*
						, ROWNUM AS RNUM
						, COUNT(*) OVER () AS TOTAL_COUNT
					FROM (
						SELECT
              				ROW_NUMBER() OVER ( PARTITION BY P1.SELLER_MBR_NO
    		      			ORDER BY LP.UPD_DT DESC ) AS RN
							, TP.TENANT_ID
							, MN.TOP_MENU_ID
							, (SELECT MENU_NM FROM TB_DP_MENU_CATEGORY_DESC WHERE MENU_ID = MN.UP_MENU_ID AND LANG_CD = #{langCd}) TOP_MENU_NM
							, MN.MENU_ID
							, (SELECT MENU_NM FROM TB_DP_MENU_CATEGORY_DESC WHERE MENU_ID = MN.MENU_ID AND LANG_CD = #{langCd}) MENU_NM
							, P1.PROD_ID
							, AP.AID
							, PS.PROD_NM
							, PS.PROD_BASE_DESC
							, TR.PROD_AMT
							, P1.PROD_GRD_CD
							, AP.PART_PARENT_CLSF_CD
							, P1.DRM_YN
							, SC.APK_PKG_NM
							, SC.APK_VER
							, SC.FILE_SIZE
							, AP.VER_MAJOR
							, AP.VER_MINOR
							, PI.FILE_PATH
							, PI.FILE_NM
							, P1.UPD_DT
							, LP.EXPO_ORD
							, LP.EXPO_ORD_ALWAYS_YN
							, LP.EXPO_ORD_SUB
						FROM TB_DP_LIST_PROD LP
						    , TB_DP_MENU_CATEGORY_PROD_MAPG MP
						    , TB_DP_MENU_CATEGORY MN
						    , TB_DP_PROD P1
						    , TB_DP_PROD_DESC PS
						    , TB_DP_TENANT_PROD TP 
						    , TB_DP_TENANT_PROD_PRICE TR
						    , TB_DP_SUB_CONTENTS SC
						    , TB_DP_APP_PROD AP
						    , TB_DP_PROD_IMG PI
						    , TB_DP_SPRT_DEVICE DV
						    , TB_CM_DEVICE CD
						WHERE LP.TENANT_ID = #{tenantId}
						AND LP.LIST_ID = #{listId}
						AND LP.PROD_ID = P1.PROD_ID
						AND P1.PROD_ID = PS.PROD_ID
						AND PS.LANG_CD = #{langCd}
						<if test='menuId != null and menuId != ""'>
						AND MN.TOP_MENU_ID = #{menuId}
						</if>
						AND MN.MENU_ID = MP.MENU_ID
						AND MP.PROD_ID = P1.PROD_ID
						AND TP.PROD_ID = P1.PROD_ID
						AND TP.TENANT_ID = LP.TENANT_ID
						AND TP.PROD_ID = LP.PROD_ID
						AND TP.PROD_STATUS_CD = 'PD000403'
						AND TP.EXPO_YN = 'Y'
						AND P1.PROD_ID = SC.PROD_ID
						AND P1.PROD_ID = AP.PROD_ID
						AND TP.PROD_ID = TR.PROD_ID
						AND TP.TENANT_ID = TR.TENANT_ID
						AND SYSDATE BETWEEN TR.APPLY_START_DT AND TR.APPLY_END_DT
						AND PI.PROD_ID = P1.PROD_ID
						AND PI.IMG_CD = 'DP000103'
						AND SC.PROD_ID = DV.PROD_ID
						AND SC.SUB_CONTENTS_ID = DV.SUB_CONTENTS_ID
						AND DV.DEVICE_MODEL_CD = CD.DEVICE_MODEL_CD
						AND CD.DEVICE_MODEL_CD = #{deviceModelCd}
						AND TO_CHAR(LP.STD_DT, 'YYYYMMDDHH24MISS') = #{stdDt}
		                AND SYSDATE BETWEEN LP.EXPO_START_DT AND LP.EXPO_END_DT
						<if test='prodGradeCd != null and prodGradeCd != ""'>
		        		AND P1.PROD_GRD_CD = #{prodGradeCd}          /* 상품등급코드 */
            			</if>
            			<if test='prodCharge == "Y"'>
		        		AND P1.PROD_CHRG_YN = 'Y'       /* 유료 */
            			</if>
            			<if test='prodCharge == "N"'>
		        		AND P1.PROD_CHRG_YN = 'N'       /* 무료 */
            			</if>
					) T_PROD
					WHERE T_PROD.RN <![CDATA[<=]]> 2
					ORDER BY T_PROD.EXPO_ORD_ALWAYS_YN DESC, T_PROD.EXPO_ORD, T_PROD.EXPO_ORD_SUB
				) R_PROD
				WHERE RNUM BETWEEN #{offset} AND (#{offset}+#{count}-1)
			) F_PROD LEFT OUTER JOIN TB_DP_TENANT_PROD_STATS ST
		ON F_PROD.PROD_ID = ST.PROD_ID
		AND F_PROD.TENANT_ID = ST.TENANT_ID
    </select>
    
    <!--운영자 추천 앱상품 조회 메인-->
    <select id="selectTopMenuAppList" parameterType="FeatureCategoryAppReq" resultType="FeatureCategoryAppDTO">
        /* FeatureCategoryMapper.xml, selectTopMenuAppList, SAC : 서영배 , 2014-01-16 */
		SELECT
			F_PROD.*
			, NVL(ST.DWLD_CNT, 0) AS DWLD_CNT
			, NVL(ST.PRCHS_CNT, 0) AS PRCHS_CNT
			, NVL(
				( 
					CASE WHEN ( ST.AVG_EVLU_SCORE <![CDATA[>]]> 0 AND ST.AVG_EVLU_SCORE <![CDATA[<]]> 1 ) THEN 1
                    	WHEN ST.AVG_EVLU_SCORE > 5 THEN 5
                    	ELSE ROUND( ST.AVG_EVLU_SCORE , 1 )
                    END ) 
                  , 0 ) AS AVG_EVLU_SCORE
		FROM (
				SELECT
					R_PROD.*
				FROM (
					SELECT
						T_PROD.*
						, ROWNUM AS RNUM
					FROM (
						SELECT
							COUNT(*) OVER () AS TOTAL_COUNT
							, TP.TENANT_ID
							, MN.TOP_MENU_ID
							, (SELECT MENU_NM FROM TB_DP_MENU_CATEGORY_DESC WHERE MENU_ID = MN.UP_MENU_ID AND LANG_CD = #{langCd}) TOP_MENU_NM
							, MN.MENU_ID
							, (SELECT MENU_NM FROM TB_DP_MENU_CATEGORY_DESC WHERE MENU_ID = MN.MENU_ID AND LANG_CD = #{langCd}) MENU_NM
							, P1.PROD_ID
							, AP.AID
							, PS.PROD_NM
							, PS.PROD_BASE_DESC
							, TR.PROD_AMT
							, P1.PROD_GRD_CD
							, AP.PART_PARENT_CLSF_CD
							, P1.DRM_YN
							, SC.APK_PKG_NM
							, SC.APK_VER
							, SC.FILE_SIZE
							, AP.VER_MAJOR
							, AP.VER_MINOR
							, PI.FILE_PATH
							, PI.FILE_NM
						FROM TB_DP_LIST_PROD LP
						    , TB_DP_MENU_CATEGORY_PROD_MAPG MP
						    , TB_DP_MENU_CATEGORY MN
						    , TB_DP_PROD P1
						    , TB_DP_PROD_DESC PS
						    , TB_DP_TENANT_PROD TP 
						    , TB_DP_TENANT_PROD_PRICE TR
						    , TB_DP_SUB_CONTENTS SC
						    , TB_DP_APP_PROD AP
						    , TB_DP_PROD_IMG PI
						    , TB_DP_SPRT_DEVICE DV
						    , TB_CM_DEVICE CD
						WHERE LP.TENANT_ID = #{tenantId}
						AND LP.LIST_ID = #{listId}
						AND LP.PROD_ID = P1.PROD_ID
						AND P1.PROD_ID = PS.PROD_ID
						AND PS.LANG_CD = #{langCd}
						<if test='menuId != null and menuId != ""'>
						AND MN.TOP_MENU_ID = #{menuId}
						</if>
						AND MN.MENU_ID = MP.MENU_ID
						AND MP.PROD_ID = P1.PROD_ID
						AND TP.PROD_ID = P1.PROD_ID
						AND TP.TENANT_ID = LP.TENANT_ID
						AND TP.PROD_ID = LP.PROD_ID
						AND TP.PROD_STATUS_CD = 'PD000403'
						AND TP.EXPO_YN = 'Y'
						AND P1.PROD_ID = SC.PROD_ID
						AND P1.PROD_ID = AP.PROD_ID
						AND TP.PROD_ID = TR.PROD_ID
						AND TP.TENANT_ID = TR.TENANT_ID
						AND SYSDATE BETWEEN TR.APPLY_START_DT AND TR.APPLY_END_DT
						AND PI.PROD_ID = P1.PROD_ID
						AND PI.IMG_CD = 'DP000103'
						AND SC.PROD_ID = DV.PROD_ID
						AND SC.SUB_CONTENTS_ID = DV.SUB_CONTENTS_ID
						AND DV.DEVICE_MODEL_CD = CD.DEVICE_MODEL_CD
						AND CD.DEVICE_MODEL_CD = #{deviceModelCd}
						AND TO_CHAR(LP.STD_DT, 'YYYYMMDDHH24MISS') = #{stdDt}
		                AND SYSDATE BETWEEN LP.EXPO_START_DT AND LP.EXPO_END_DT
						<if test='prodGradeCd != null and prodGradeCd != ""'>
		        		AND P1.PROD_GRD_CD = #{prodGradeCd}          /* 상품등급코드 */
            			</if>
            			<if test='prodCharge == "Y"'>
		        		AND P1.PROD_CHRG_YN = 'Y'       /* 유료 */
            			</if>
            			<if test='prodCharge == "N"'>
		        		AND P1.PROD_CHRG_YN = 'N'       /* 무료 */
            			</if>
						ORDER BY LP.EXPO_ORD_ALWAYS_YN DESC, LP.EXPO_ORD, LP.EXPO_ORD_SUB
					) T_PROD
				) R_PROD
				WHERE RNUM BETWEEN #{offset} AND (#{offset}+#{count}-1)
			) F_PROD LEFT OUTER JOIN TB_DP_TENANT_PROD_STATS ST
		ON F_PROD.PROD_ID = ST.PROD_ID
		AND F_PROD.TENANT_ID = ST.TENANT_ID
    </select>
    
    <!--운영자 추천 앱상품 조회 메인-->
    <select id="selectSubMenuAppList" parameterType="FeatureCategoryAppReq" resultType="FeatureCategoryAppDTO">
        /* FeatureCategoryMapper.xml, selectSubMenuAppList, SAC : 서영배 , 2014-01-16 */
		SELECT
			F_PROD.*
			, NVL(ST.DWLD_CNT, 0) AS DWLD_CNT
			, NVL(ST.PRCHS_CNT, 0) AS PRCHS_CNT
			, NVL(
				( 
					CASE WHEN ( ST.AVG_EVLU_SCORE <![CDATA[>]]> 0 AND ST.AVG_EVLU_SCORE <![CDATA[<]]> 1 ) THEN 1
                    	WHEN ST.AVG_EVLU_SCORE > 5 THEN 5
                    	ELSE ROUND( ST.AVG_EVLU_SCORE , 1 )
                    END ) 
                  , 0 ) AS AVG_EVLU_SCORE
		FROM (
				SELECT
					R_PROD.*
				FROM (
					SELECT
						T_PROD.*
						, ROWNUM AS RNUM
					FROM (
						SELECT
							COUNT(*) OVER () AS TOTAL_COUNT
							, TP.TENANT_ID
							, MN.TOP_MENU_ID
							, (SELECT MENU_NM FROM TB_DP_MENU_CATEGORY_DESC WHERE MENU_ID = MN.UP_MENU_ID AND LANG_CD = #{langCd}) TOP_MENU_NM
							, MN.MENU_ID
							, (SELECT MENU_NM FROM TB_DP_MENU_CATEGORY_DESC WHERE MENU_ID = MN.MENU_ID AND LANG_CD = #{langCd}) MENU_NM
							, P1.PROD_ID
							, AP.AID
							, PS.PROD_NM
							, PS.PROD_BASE_DESC
							, TR.PROD_AMT
							, P1.PROD_GRD_CD
							, AP.PART_PARENT_CLSF_CD
							, P1.DRM_YN
							, SC.APK_PKG_NM
							, SC.APK_VER
							, SC.FILE_SIZE
							, AP.VER_MAJOR
							, AP.VER_MINOR
							, PI.FILE_PATH
							, PI.FILE_NM
						FROM TB_DP_LIST_PROD LP
						    , TB_DP_MENU_CATEGORY_PROD_MAPG MP
						    , TB_DP_MENU_CATEGORY MN
						    , TB_DP_PROD P1
						    , TB_DP_PROD_DESC PS
						    , TB_DP_TENANT_PROD TP 
						    , TB_DP_TENANT_PROD_PRICE TR
						    , TB_DP_SUB_CONTENTS SC
						    , TB_DP_APP_PROD AP
						    , TB_DP_PROD_IMG PI
						    , TB_DP_SPRT_DEVICE DV
						    , TB_CM_DEVICE CD
						WHERE LP.TENANT_ID = #{tenantId}
						AND LP.LIST_ID = #{listId}
						AND LP.PROD_ID = P1.PROD_ID
						AND P1.PROD_ID = PS.PROD_ID
						AND PS.LANG_CD = #{langCd}
						<if test='menuId != null and menuId != ""'>
						AND MN.MENU_ID = #{menuId}
						</if>
						AND MN.MENU_ID = MP.MENU_ID
						AND MP.PROD_ID = P1.PROD_ID
						AND TP.PROD_ID = P1.PROD_ID
						AND TP.TENANT_ID = LP.TENANT_ID
						AND TP.PROD_ID = LP.PROD_ID
						AND TP.PROD_STATUS_CD = 'PD000403'
						AND TP.EXPO_YN = 'Y'
						AND P1.PROD_ID = SC.PROD_ID
						AND P1.PROD_ID = AP.PROD_ID
						AND TP.PROD_ID = TR.PROD_ID
						AND TP.TENANT_ID = TR.TENANT_ID
						AND SYSDATE BETWEEN TR.APPLY_START_DT AND TR.APPLY_END_DT
						AND PI.PROD_ID = P1.PROD_ID
						AND PI.IMG_CD = 'DP000103'
						AND SC.PROD_ID = DV.PROD_ID
						AND SC.SUB_CONTENTS_ID = DV.SUB_CONTENTS_ID
						AND DV.DEVICE_MODEL_CD = CD.DEVICE_MODEL_CD
						AND CD.DEVICE_MODEL_CD = #{deviceModelCd}
						AND TO_CHAR(LP.STD_DT, 'YYYYMMDDHH24MISS') = #{stdDt}
		                AND SYSDATE BETWEEN LP.EXPO_START_DT AND LP.EXPO_END_DT
						<if test='prodGradeCd != null and prodGradeCd != ""'>
		        		AND P1.PROD_GRD_CD = #{prodGradeCd}          /* 상품등급코드 */
            			</if>
            			<if test='prodCharge == "Y"'>
		        		AND P1.PROD_CHRG_YN = 'Y'       /* 유료 */
            			</if>
            			<if test='prodCharge == "N"'>
		        		AND P1.PROD_CHRG_YN = 'N'       /* 무료 */
            			</if>
						ORDER BY LP.EXPO_ORD_ALWAYS_YN DESC, LP.EXPO_ORD, LP.EXPO_ORD_SUB
					) T_PROD
				) R_PROD
				WHERE RNUM BETWEEN #{offset} AND (#{offset}+#{count}-1)
			) F_PROD LEFT OUTER JOIN TB_DP_TENANT_PROD_STATS ST
		ON F_PROD.PROD_ID = ST.PROD_ID
		AND F_PROD.TENANT_ID = ST.TENANT_ID
    </select>
    
    <!--운영자 추천 앱상품 조회-->
    <select id="selectCategoryAppListDummy" parameterType="FeatureCategoryAppReq" resultType="FeatureCategoryAppDTO">
       /* FeatureCategoryMapper.xml, selectCategoryAppListDummy, SAC : 서영배 , 2014-01-03 */
        SELECT
			PROD.*
			, NVL(ST.DWLD_CNT, 0) DWLD_CNT
			, NVL(ST.PRCHS_CNT, 0) PRCHS_CNT
		FROM (
			SELECT 
				COUNT(*) OVER () AS TOTAL_COUNT
				, LP.TENANT_ID
				, MN.UP_MENU_ID AS TOP_MENU_ID
				, (SELECT MENU_NM FROM TB_DP_MENU_CATEGORY_DESC WHERE MENU_ID = MN.UP_MENU_ID AND LANG_CD = 'ko') TOP_MENU_NM
				, MN.MENU_ID
				, (SELECT MENU_NM FROM TB_DP_MENU_CATEGORY_DESC WHERE MENU_ID = MN.MENU_ID AND LANG_CD = 'ko') MENU_NM
				, DP.PROD_ID
				, AP.AID
				, PS.PROD_NM
				, PS.PROD_BASE_DESC
				, PR.PROD_AMT
				, DECODE( DP.PROD_GRD_CD
				        , 'PD004401', 0
				        , 'PD004402', 1
				        , 'PD004403', 2
				        , 'PD004404', 4 ) AS PROD_GRD_CD
				, DECODE( AP.PART_PARENT_CLSF_CD, 'PD012301', 'iab', NULL ) AS PART_PARENT_CLSF_CD
				, DECODE( DP.DRM_YN, 'Y', 'drm', NULL ) AS DRM_YN
				, SC.APK_PKG_NM
				, SC.APK_VER
				, SC.FILE_SIZE AS APK_FILE_SIZE
				, AP.VER_MAJOR||'.'||AP.VER_MINOR AS PROD_VER
				, PI.FILE_PATH || PI.FILE_NM AS FILE_PATH
			FROM 
				TB_DP_LIST_PROD LP,
				TB_DP_PROD DP,
				TB_DP_TENANT_PROD_PRICE PR,
				TB_DP_MENU_CATEGORY_PROD_MAPG MP, 
				TB_DP_APP_PROD AP,
				TB_DP_TENANT_PROD TP, 
				TB_DP_PROD_DESC PS,
				TB_DP_SUB_CONTENTS SC,
				TB_DP_PROD_IMG PI,
				TB_DP_SPRT_DEVICE DV,
				TB_DP_MENU_CATEGORY MN
			WHERE LP.LIST_ID = 'ADM000000013'
			AND DP.PROD_ID = LP.PROD_ID
			AND DP.PROD_ID = PR.PROD_ID
			AND MP.PROD_ID = DP.PROD_ID
			AND DP.PROD_ID = AP.PROD_ID
			AND DP.PROD_ID = TP.PROD_ID
			AND DP.PROD_ID = PS.PROD_ID
			AND DP.PROD_ID = SC.PROD_ID
			AND DP.PROD_ID = PI.PROD_ID
			AND SC.SUB_CONTENTS_ID = DV.SUB_CONTENTS_ID 
			AND SC.PROD_ID = DV.PROD_ID 
			AND MN.MENU_ID = MP.MENU_ID
			AND PI.IMG_CD = 'DP000101'
			AND DV.DEVICE_MODEL_CD = 'SCH-W940'
			AND ROWNUM <![CDATA[<=]]> #{count}
		) PROD LEFT OUTER JOIN TB_DP_TENANT_PROD_STATS ST
		ON PROD.PROD_ID = ST.PROD_ID
		AND PROD.TENANT_ID = ST.TENANT_ID
    </select>
    
    <!--운영자 추천 만화/이북 리스트 조회-->
    <select id="selectCategoryEpubRecomList" parameterType="FeatureCategoryEpubReq" resultType="FeatureCategoryEpubDTO">
        /* FeatureCategoryMapper.xml, selectCategoryEpubRecomList, SAC : JJI , 2014-01-22 */
        SELECT B.TOP_MENU_ID
             , B.MENU_ID
             , B.MENU_NM
             , B.META_CLSF_CD
             , B.PROD_ID
             , B.PROD_NM
             , B.PROD_BASE_DESC
             , B.PROD_AMT
             , B.PROD_NET_AMT
             , B.PROD_GRD_CD
             , B.ARTIST1_NM
             , B.ARTIST2_NM
             , B.ARTIST3_NM
             , B.CHNL_COMP_NM
             , B.ISSUE_DAY
             , B.BOOK_PAGE_CNT
             , B.BOOK_TYPE
             , B.BOOK_COUNT
             , B.SUPPORT_STORE
             , B.SUPPORT_PLAY
             , B.BOOK_STATUS
             , B.TOTAL_COUNT
             , NVL(C.PATICPERS_CNT, 0) AS PATICPERS_CNT    /* 참여자수 */
             , NVL(C.PRCHS_CNT, 0) AS PRCHS_CNT            /* 구매수 */
             <![CDATA[
             , NVL((CASE WHEN (C.AVG_EVLU_SCORE > 0 AND C.AVG_EVLU_SCORE < 1) THEN 1
                          WHEN C.AVG_EVLU_SCORE > 5 THEN 5
                          ELSE ROUND(C.AVG_EVLU_SCORE, 1) END), 0) AS AVG_EVLU_SCORE
             ]]>
          FROM (SELECT COUNT(*) OVER () AS TOTAL_COUNT
                     , ROWNUM AS RNUM
                     , A.*
                  FROM (SELECT A.*
						  FROM (SELECT G.TOP_MENU_ID
						             , G.MENU_ID
						             , L.MENU_NM
						             , E.META_CLSF_CD
						             , B.PROD_ID --채널아이디
						             , K.PROD_NM 
						               || NVL2(I.BOOK_CLSF_CD
						                      , I.CHAPTER || DECODE(I.BOOK_CLSF_CD
						                      , 'DP004301', '권'
						                      , 'DP004302', '회'
						                      , 'DP004303', '호', '' )
						               , '') AS PROD_NM
						             , K.PROD_BASE_DESC
						             , J.PROD_AMT
						             , J.PROD_NET_AMT
						             , E.PROD_GRD_CD  
						             , K.ARTIST1_NM
						             , K.ARTIST2_NM
						             , K.ARTIST3_NM
						             , M.CHNL_COMP_NM
						             , I.ISSUE_DAY
						             , M.BOOK_PAGE_CNT
						             , ( CASE WHEN N.META_CLSF_CD IN ('CT20', 'CT21') THEN 'serial' ELSE '' END ) AS BOOK_TYPE
						             , ( CASE WHEN N.META_CLSF_CD IN ('CT20', 'CT21') THEN (NVL(M.EPSD_CNT, 0) + NVL(M.STRM_EPSD_CNT, 0) ) END ) AS BOOK_COUNT
						             , ( CASE WHEN NVL(I.EPSD_CNT, 0) > 0 THEN 'store' ELSE '' END ) AS SUPPORT_STORE
						             , ( CASE WHEN NVL(I.STRM_EPSD_CNT, 0) > 0 THEN 'play' ELSE '' END ) AS SUPPORT_PLAY
						             , ( CASE WHEN N.META_CLSF_CD IN ('CT20', 'CT21') THEN DECODE( I.COMPT_YN, 'Y', 'completed', 'continue' ) ELSE '' END ) AS BOOK_STATUS
						             , ROW_NUMBER( ) OVER ( PARTITION BY N.PROD_ID
						                                    ORDER BY DECODE( I.BOOK_CLSF_CD, I.BOOK_CLSF_CD, 1, 2 )
						                                                   , TO_NUMBER( REGEXP_REPLACE( I.CHAPTER, '[^[:digit:]]') ) DESC
						                                                   , NVL( E.USE_PERIOD_UNIT_CD , 'PD00310' ) DESC
						                                                   , E.REG_DT DESC
						                                  ) AS NO
						             , B.EXPO_ORD_ALWAYS_YN
						             , B.EXPO_ORD
						             , B.EXPO_ORD_SUB
						          FROM TB_DP_LIST A
						             , TB_DP_LIST_PROD B
						             , TB_DP_TENANT_PROD C  /* 채널 */
						             , TB_DP_PROD_RSHP D
						             , TB_DP_PROD E  /* 에피소드 */
						             , (SELECT SD.PROD_ID
						                  FROM TB_DP_SPRT_DEVICE SD
						                     , TB_CM_DEVICE CD
						                 WHERE SD.DEVICE_MODEL_CD = CD.DEVICE_MODEL_CD
						                   AND SD.DEVICE_MODEL_CD = #{deviceModelCd}
		                                   <if test='topMenuId == "DP13"'>
		                                   AND CD.EBOOK_SPRT_YN = 'Y'
		                                   </if>
		                                   <if test='topMenuId == "DP14"'>
		                                   AND CD.COMIC_SPRT_YN = 'Y'
		                                   </if>
						               ) F
						             , TB_DP_MENU_CATEGORY G
						             , TB_DP_MENU_CATEGORY_PROD_MAPG H
						             , TB_DP_MULTIMDA_PROD I  /* 에피소드 */
						             , TB_DP_TENANT_PROD_PRICE J
						             , TB_DP_PROD_DESC K
						             , TB_DP_MENU_CATEGORY_DESC L
						             , TB_DP_MULTIMDA_PROD M  /* 채널 */
						             , TB_DP_PROD N  /* 채널 */
						         WHERE A.LIST_ID = B.LIST_ID
						           AND A.LIST_ID = #{listId}
						           AND A.EXPO_YN = 'Y'
						           AND B.EXPO_YN = 'Y'
						           AND SYSDATE BETWEEN B.EXPO_START_DT AND B.EXPO_END_DT
						           AND TO_CHAR(B.STD_DT, 'YYYYMMDDHH24MISS') = #{stdDt}
						           AND B.TENANT_ID = #{tenantId}
						           AND B.PROD_ID = C.PROD_ID
						           AND C.EXPO_YN = 'Y'
						           AND C.PROD_STATUS_CD = 'PD000403'
						           AND B.TENANT_ID = C.TENANT_ID
						           AND B.PROD_ID = D.PROD_ID
						           AND D.PROD_RSHP_CD = 'DP010802'
						           AND D.PART_PROD_ID = E.PROD_ID
						           AND E.TOP_MENU_ID = #{topMenuId}
						           <if test='prodGradeCd != null and prodGradeCd != ""'>
		                           AND E.PROD_GRD_CD = #{prodGradeCd}          /* 상품등급코드 */
		                           </if>
		                           <if test='prodCharge == "Y"'>
		                           AND E.PROD_CHRG_YN = 'Y'       /* 유료 */
		                           </if>
		                           <if test='prodCharge == "N"'>
		                           AND E.PROD_CHRG_YN = 'N'       /* 무료 */
		                           </if>
						           AND E.CONTENTS_TYPE_CD = 'PD002502'
						           AND E.PROD_ID = F.PROD_ID
						           AND B.MENU_ID = G.MENU_ID
						           AND G.USE_YN = 'Y'
						           AND G.MENU_ID = H.MENU_ID
						           AND H.USE_YN = 'Y'
						           AND H.PROD_ID = I.PROD_ID
						           AND H.PROD_ID = E.PROD_ID
						           AND I.PROD_ID = J.PROD_ID
						           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN TO_CHAR(J.APPLY_START_DT, 'YYYYMMDDHH24MISS') AND TO_CHAR(J.APPLY_END_DT, 'YYYYMMDDHH24MISS')
						           AND J.TENANT_ID = B.TENANT_ID
						           AND B.PROD_ID = K.PROD_ID
						           AND K.LANG_CD = #{langCd}
						           AND L.MENU_ID = G.MENU_ID
						           AND L.LANG_CD = K.LANG_CD
						           AND M.PROD_ID = B.PROD_ID
						           AND M.PROD_ID = N.PROD_ID
						           AND N.CONTENTS_TYPE_CD = 'PD002501'
						           AND E.TOP_MENU_ID = N.TOP_MENU_ID
						           <if test='topMenuId == "DP13"'>
						           AND E.META_CLSF_CD IN ('CT19', 'CT20')
						              <if test='filteredBy == "ebook+normal"'>  /* 이북 일반 */
						           AND G.MENU_ID NOT IN (SELECT MENU_ID
                                                           FROM TB_DP_MENU_CATEGORY
                                                          WHERE (MENU_ID LIKE 'DP13004%'
                                                                 OR MENU_ID  IN ('DP13027002', 'DP13027008', 'DP13027009', 'DP13027010' )
                                                                )
                                                         )
						              </if>
						              <if test='filteredBy == "ebook+gener"'>  /* 이북 장르 */
						           AND G.MENU_ID IN (SELECT MENU_ID
                                                       FROM TB_DP_MENU_CATEGORY
                                                      WHERE (MENU_ID LIKE 'DP13004%'
                                                             OR MENU_ID  IN ('DP13027002', 'DP13027008', 'DP13027009', 'DP13027010' )
                                                            )
                                                     )  
						              </if>
						           </if>
						       ) A
						 WHERE NO = 1
						 ORDER BY EXPO_ORD_ALWAYS_YN DESC, EXPO_ORD, EXPO_ORD_SUB 
					) A
				 ) B
				 , TB_DP_TENANT_PROD_STATS C
			   --, TB_DP_PROD_IMG
          WHERE B.PROD_ID = C.PROD_ID(+)
            AND RNUM BETWEEN #{offset} AND (#{offset}+#{count}-1)
          ORDER BY RNUM
    </select>
    
</mapper>