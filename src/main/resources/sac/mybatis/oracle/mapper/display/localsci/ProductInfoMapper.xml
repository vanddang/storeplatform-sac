<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ProductInfo">
	<!-- 상품별 서비스 그룹 코드 조회-->
	<resultMap id="retMap" type="Map">
        <result property="topMenuId" column="top_menu_id" />
	    <result property="upMenuId" column="up_menu_id" />
	    <result property="menuId" column="menu_id" />
	    <result property="menuNm" column="menu_nm" />
	    <result property="prodId" column="prod_id" />
	    <result property="aid" column="aid" />
	    <result property="prodNm" column="prod_nm" />
	    <result property="prodBaseDesc" column="prod_base_desc" />
	    <result property="prodGrdCd" column="prod_grd_cd" />
	    <result property="partParentClsfCd" column="part_parent_clsf_cd" />
	    <result property="drmYn" column="drm_yn" />
	    <result property="contentsTypeCd" column="contents_type_cd" />
	    <result property="prodVer" column="prod_ver" />
	    <result property="pkgNm" column="pkg_nm" />
	    <result property="pkgVerCd" column="pkg_ver_cd" />
	    <result property="filePath" column="file_path" />
	    <result property="phoneSprtYn" column="phone_sprt_yn" />
    </resultMap>
    
	<select id="selectProductInfoList" resultType="ProductBasicInfo">
		SELECT /* ProductInfoMapper.selectProductInfoList, 상품별 서비스 그룹코드 조회, 오승민/인크로스, 2014-03-10 */
           PROD_ID,SVC_GRP_CD,SVC_TYPE_CD,CONTENTS_TYPE_CD,META_CLSF_CD,TOP_MENU_ID,PROD_ID AS PART_PROD_ID
      FROM TB_DP_PROD
      <if test = "list !=null">
      WHERE PROD_ID IN  
           <foreach collection="list" item="item" index="index" open="(" separator="," close=")"> 
                #{item}
           </foreach>
      </if>
       <if test = "list != null">  
            ORDER BY instr
            <foreach collection="list" item="item" index="index" open="(" separator="||" close=",PROD_ID)"> 
                #{item}
            </foreach>
         </if>
    </select>
    
    <select id="getAppMetaInfo" parameterType="Map" resultType="ProductInfo">
        SELECT /* ProductInfoMapper.getAppMetaInfo, APP상품 메타조회, 오승민/인크로스, 2014-03-10 */
                TB.TOP_MENU_ID
              , TB.UP_MENU_ID
              , TB.MENU_ID
              , TB.MENU_NM
              , TB.PART_PROD_ID
              , TB.AID
              , TB.PROD_NM
              , TB.PROD_BASE_DESC 
              , TB.PROD_GRD_CD
              , DECODE( NVL( TB.PROD_CLSF_CD, 'PD000601' )
								            , 'PD000601', 'paid'
								            , 'PD000602', 'library'
								            , 'PD000603', 'vm'
								            , 'PD000604', 'free'
								            , 'PD000605', 'paid-rss'
								            , 'PD000606', 'free-rss' )  AS PROD_CLSF_CD
              , DECODE( TB.PART_PARENT_CLSF_CD, 'PD012301', 'Y', 'N' ) AS IAB_YN
              , TB.DRM_YN
              , TB.CONTENTS_TYPE_CD
              , TB.VER_MAJOR || '.' || TB.VER_MINOR AS PROD_VER
              , TB.USE_PERIOD
              , TB.USE_PERIOD_UNIT_CD
              , (SELECT MENU_NM
                   FROM TB_DP_MENU_CATEGORY_DESC
                  WHERE MENU_ID = TB.TOP_MENU_ID
                    AND LANG_CD = #{lang}
                    AND ROWNUM = 1) AS TOP_MENU_NM
              , (SELECT DECODE (COUNT(1), 0, 'N', 'Y') FROM TB_DP_SPRT_DEVICE WHERE DEVICE_MODEL_CD = #{deviceModelNo} AND PROD_ID = TB.PROD_ID) AS PHONE_SPRT_YN
              , (SELECT CONTENTS.APK_PKG_NM || ',' || CONTENTS.APK_VER FROM 
                        TB_DP_SPRT_DEVICE DEVICE,TB_DP_SUB_CONTENTS CONTENTS
                   WHERE TB.PROD_ID = DEVICE.PROD_ID
                     AND DEVICE.PROD_ID = CONTENTS.PROD_ID
                     AND DEVICE.SUB_CONTENTS_ID = CONTENTS.SUB_CONTENTS_ID
                     AND DEVICE.DEVICE_MODEL_CD = #{deviceModelNo} ) AS APK_INFO
              , TB.PROD_ID
              , TB.PARENT_PROD_NM
              , TB.PART_PARENT_CLSF_CD
              , TB.PROD_CASE
              , TB.PROD_KIND
              , TB.CID
              , TB.PROD_STATUS_CD
              , TB.PLAT_CLSF_CD
              , TB.EXPO_SELLER_EMAIL
              , TB.EXPO_SELLER_NM
              , TB.EXPO_SELLER_TELNO
              , TB.SELLER_MBR_NO
              , TB.CASE_REF_CD AS SEED_CASE_REF_CD
              , (CASE
		           WHEN TB.PART_PARENT_CLSF_CD = 'PD012302'
		           THEN
		              (SELECT FILE_PATH
		                 FROM TB_DP_PROD_IMG IMG
		                WHERE     IMG.PROD_ID = TB.PROD_ID
		                      AND IMG.EXPO_ORD = 1
		                      AND IMG.LANG_CD = 'ko'
		                      AND IMG.IMG_CD = #{imageCd})
		           ELSE
		              (SELECT FILE_PATH
		                 FROM TB_DP_PROD_IMG IMG
		                WHERE     IMG.PROD_ID = TB.PART_PROD_ID
		                      AND IMG.EXPO_ORD = 1
		                      AND IMG.LANG_CD = #{lang}
		                      AND IMG.IMG_CD = #{imageCd})
		            END) AS FILE_PATH
          FROM (SELECT  A.TOP_MENU_ID
                      , A.UP_MENU_ID
                      , A.MENU_ID
                      , B.PROD_ID AS PART_PROD_ID
                      , C.MENU_NM
                      , C.MENU_DESC
                      , D.PROD_CHRG_YN
                      , D.PROD_GRD_CD
                      , D.DRM_YN
                      , D.REG_DT
                      , D.USE_PERIOD
                      , D.USE_PERIOD_UNIT_CD
                      , D.CONTENTS_TYPE_CD
                      , D.EXPO_SELLER_EMAIL
                      , D.EXPO_SELLER_NM
                      , D.EXPO_SELLER_TELNO
                      , D.SELLER_MBR_NO
                      , D.CID
                      , E.AID
                      , E.VER_MAJOR
                      , E.VER_MINOR
                      , E.PART_PARENT_CLSF_CD
                      , E.PROD_CLSF_CD
                      , E.PROD_CASE
                      , E.PROD_KIND
                      , E.PLAT_CLSF_CD
                      , F.PROD_NM
                      , F.PROD_BASE_DESC
                      , RSHP.PROD_ID
                      , DESC2.PROD_NM AS PARENT_PROD_NM
                      , (CASE WHEN  E.PART_PARENT_CLSF_CD = 'PD012302' THEN
                                    E.SALE_STATUS_INFO
                             ELSE  TENANT.PROD_STATUS_CD
                             END) AS PROD_STATUS_CD
                      , SMAP.CASE_REF_CD
                  FROM  TB_DP_MENU_CATEGORY           A
                      , TB_DP_MENU_CATEGORY_PROD_MAPG B
                      , TB_DP_MENU_CATEGORY_DESC      C
                      , TB_DP_PROD                    D
                      , TB_DP_APP_PROD                E
                      , TB_DP_PROD_DESC               F
                      , TB_DP_PROD_DESC               DESC2
                      , TB_DP_PROD_RSHP               RSHP
                      , TB_DP_TENANT_PROD             TENANT
                      , TB_DP_SEED_MAPP               SMAP
                 WHERE  A.MENU_ID = B.MENU_ID
                   AND  A.MENU_ID = C.MENU_ID
                   AND  B.PROD_ID = D.PROD_ID
                   AND  B.PROD_ID = E.PROD_ID
                   AND  B.PROD_ID = F.PROD_ID
                   AND  B.PROD_ID = TENANT.PROD_ID
                   AND  SMAP.PROD_ID(+) = E.PROD_ID
                   AND  TENANT.TENANT_ID = #{tenantId}
                   AND  C.LANG_CD = #{lang}                /* ko : 한국어 */
                   <if test='productBasicInfo.svcGrpCd != null'>
                   AND  D.SVC_GRP_CD = #{productBasicInfo.svcGrpCd}       /* DP000201 : 애플리캐이션 */
                   </if>
                   AND  F.LANG_CD = #{lang}                /* ko : 한국어 */
                   -----------------------------------------------------------------------------
                   -- INPUT PARAMETER
                   -----------------------------------------------------------------------------
                   AND  B.PROD_ID = #{productBasicInfo.prodId}        /* 상품ID */
                   AND  D.PROD_ID = RSHP.PART_PROD_ID
                   AND  RSHP.PROD_ID = DESC2.PROD_ID
                   AND RSHP.PROD_RSHP_CD = (
                             CASE WHEN  E.PART_PARENT_CLSF_CD = 'PD012302' THEN
                                        #{inAppRshpCd}
                                  ELSE  #{rshpCd} 
                             END)
                   AND B.BASE_YN = 'Y'
       ) TB
    </select>
    <select id="getVODMetaInfo" parameterType="Map" resultType="ProductInfo">
	        SELECT  /* ProductInfoMapper.getVODMetaInfo, VOD상품메타조회, 오승민/인크로스, 2014-03-10 */
			         A.MENU_ID
			       , A.UP_MENU_ID
			       , A.TOP_MENU_ID
			       , I.PROD_ID
			       , I.PART_PROD_ID
			       , C.MENU_NM
			       , C.MENU_DESC
			       , D.PROD_GRD_CD
			       , D.META_CLSF_CD
			       , D.CONTENTS_TYPE_CD
			       , D.EXPO_SELLER_EMAIL
			       , D.EXPO_SELLER_NM
			       , D.EXPO_SELLER_TELNO
			       , D.USE_PERIOD
			       , D.USE_PERIOD_UNIT_CD
			       , D.SELLER_MBR_NO
			       , D.CID
			       , E.COMPT_YN
			       , E.VOD_TITL_NM
			       , E.STRM_EPSD_CNT
			       , E.EPSD_CNT
			       , E.ISSUE_DAY
			       , E.CHNL_COMP_NM
			       , E.AGENCY_NM
			       , E.HDV_YN
			       , E.HDCP_YN
			       , E.REG_DT
			       , E.PLAY_TM
			       , E.CHAPTER
			       , E.POSS_LEND_CLSF_CD
			       , E.DOLBY_SPRT_YN
			       , 'paid' as PROD_CLSF_CD
			       , F.PROD_NM
			       , F.ARTIST1_NM
			       , F.ARTIST2_NM
			       , F.PROD_BASE_DESC
			       , D.DRM_YN
			       , E.OUTSD_CONTENTS_ID
			       , (SELECT DECODE (COUNT(1), 0, 'N', 'Y') 
			            FROM TB_DP_SPRT_DEVICE A
			           WHERE (A.DEVICE_MODEL_CD = #{deviceModelNo} or A.DEVICE_MODEL_CD = #{dpAnyPhone4mm}) 
			              AND A.PROD_ID = I.PART_PROD_ID 
			              AND (CASE WHEN NVL(D.DRM_YN, 'N') = 'Y' AND #{supportDevice.videoDrmSprtYn} = 'N' THEN 0
	                           ELSE 
	                                CASE WHEN #{supportDevice.sdVideoSprtYn} = 'Y' THEN 1 
	                                ELSE 0
	                                END
	                           END) = 1
			              ) AS PHONE_SPRT_YN
			       , (SELECT PROD_STATUS_CD FROM TB_DP_TENANT_PROD TENANT1 WHERE I.PROD_ID = TENANT1.PROD_ID AND TENANT1.TENANT_ID = #{tenantId} AND TENANT1.EXPO_YN ='Y') as chnlProdStatusCd
			       , TENANT.PROD_STATUS_CD
			  <![CDATA[
			  , ( CASE WHEN E.EPSD_CNT   >   0 THEN 'Y' END ) AS SUPPORT_STORE
			 ]]>
			  <![CDATA[
			  , ( CASE WHEN E.STRM_EPSD_CNT   >   0 THEN 'Y' END ) AS SUPPORT_PLAY
			 ]]>
			   ,(SELECT MENU_NM
			       FROM TB_DP_MENU_CATEGORY_DESC
			      WHERE MENU_ID = A.TOP_MENU_ID
			        AND LANG_CD = 'ko'
			        AND ROWNUM = 1) AS TOP_MENU_NM
			    ,( SELECT CONCAT(FILE_PATH,FILE_NM) FROM TB_DP_PROD_IMG IMG WHERE IMG.PROD_ID = I.PROD_ID  AND  IMG.EXPO_ORD = 1 AND  IMG.LANG_CD = #{lang} AND  IMG.IMG_CD = #{imageCd}) AS FILE_PATH
			    FROM  TB_DP_MENU_CATEGORY           A
			        , TB_DP_MENU_CATEGORY_PROD_MAPG B
			        , TB_DP_MENU_CATEGORY_DESC      C
			        , TB_DP_PROD                    D
			        , TB_DP_VOD_PROD                E
			        , TB_DP_PROD_DESC               F
			        , TB_DP_PROD_RSHP               I
			        , TB_DP_TENANT_PROD             TENANT
			   WHERE A.MENU_ID = B.MENU_ID
			     AND A.MENU_ID = C.MENU_ID
			     AND B.PROD_ID = D.PROD_ID
			     AND B.PROD_ID = E.PROD_ID
			     AND B.PROD_ID = F.PROD_ID
			     AND B.PROD_ID = I.PART_PROD_ID
			     AND B.PROD_ID = TENANT.PROD_ID
			     AND TENANT.TENANT_ID = #{tenantId}
			     AND B.BASE_YN = 'Y'
			     AND C.LANG_CD = #{lang}                      /* ko : 한국어 */
			     AND D.SVC_GRP_CD = 'DP000203'             /* DP000203 : 멀티미디어 */
			     AND D.CONTENTS_TYPE_CD = 'PD002502'       /* PD002501 : 채널타입 */
			     AND F.LANG_CD = #{lang}                      /* ko : 한국어 */
			     AND I.PART_PROD_ID = #{productBasicInfo.partProdId}
			     AND I.PROD_RSHP_CD = #{rshpCd}
	</select>
	
	<select id="getMusicMetaInfo" parameterType="Map" resultType="ProductInfo">
       SELECT /* ProductInfoMapper.getMusicMetaInfo, Music상품 메타조회, 오승민/인크로스, 2014-03-10 */
             CP.PROD_ID 
            , CP.PART_PROD_ID
            , C.MENU_ID
            , CD.MENU_NM
            , CD.MENU_DESC
            , C.TOP_MENU_ID
            ,(SELECT MENU_NM
               FROM TB_DP_MENU_CATEGORY_DESC
              WHERE MENU_ID = C.TOP_MENU_ID
                AND LANG_CD = 'ko'
                AND ROWNUM = 1) AS TOP_MENU_NM
            , PD.PROD_NM
            , PD.PROD_DTL_DESC
            , PD.PROD_BASE_DESC
            , P.PROD_GRD_CD
            , P.EXPO_SELLER_EMAIL
            , P.EXPO_SELLER_NM
            , P.EXPO_SELLER_TELNO
            , P.SELLER_MBR_NO
            , P.META_CLSF_CD
            , 'paid' as PROD_CLSF_CD
            , P.USE_PERIOD
            , P.USE_PERIOD_UNIT_CD
            , PD.ARTIST1_NM  AS  ARTIST_NM
            , PD.ARTIST2_NM
            , PD.ARTIST3_NM   AS ALBUM                     
            ,(SELECT CHNL_COMP_NM FROM TB_DP_MUSIC_PROD WHERE PROD_ID = CP.PROD_ID) as PUBLISHER
            , MP.AGENCY_NM    AS AGENCY
            , MP.ISSUE_DAY
            , 'Y' AS MP3_SPRT_YN
            , MP.BELL_SPRT_YN
            , MP.COLORRING_SPRT_YN
            , P.CID
            , (SELECT DECODE (COUNT(1), 0, 'N', 'Y') 
                    FROM TB_DP_SPRT_DEVICE A
                   WHERE (A.DEVICE_MODEL_CD = #{deviceModelNo} or A.DEVICE_MODEL_CD = #{dpAnyPhone4mm}) 
                      AND A.PROD_ID = CP.PART_PROD_ID 
                      AND (
                      CASE WHEN #{productBasicInfo.metaClsfCd} = 'CT25' THEN
                           CASE WHEN #{supportDevice.musicSprtYn} = 'Y' THEN 1
                           ELSE 0
                           END
                      ELSE 1
                      END
                      ) = 1
            ) AS PHONE_SPRT_YN
            , MP.OUTSD_CONTENTS_ID AS SONG_ID
            , TENANT.PROD_STATUS_CD
            ,( SELECT CONCAT(FILE_PATH,FILE_NM) FROM TB_DP_PROD_IMG IMG WHERE IMG.PROD_ID = CP.PROD_ID  AND  IMG.EXPO_ORD = 1 AND  IMG.LANG_CD = #{lang} AND  IMG.IMG_CD = #{imageCd}) AS FILE_PATH
            FROM 
                  TB_DP_MENU_CATEGORY_PROD_MAPG CPM
                , TB_DP_MENU_CATEGORY C
                , TB_DP_MENU_CATEGORY_DESC CD 
                , TB_DP_MUSIC_PROD MP
                , TB_DP_PROD P
                , TB_DP_PROD_DESC PD
                , TB_DP_PROD_RSHP CP
                , TB_DP_TENANT_PROD  TENANT
        WHERE  C.MENU_ID = CPM.MENU_ID
          AND CD.MENU_ID = C.MENU_ID
          AND CPM.PROD_ID = CP.PART_PROD_ID
          AND MP.PROD_ID = CP.PART_PROD_ID
          AND P.PROD_ID = CP.PART_PROD_ID
          AND P.PROD_ID = PD.PROD_ID
          AND P.PROD_ID = TENANT.PROD_ID
          AND TENANT.TENANT_ID = #{tenantId}
       -----------------------------------------------------------------------------
       -- 차트 정보 조건절 END
       ----------------------------------------------------------------------------- 
          AND P.CONTENTS_TYPE_CD = 'PD002502'  -- 에피소드
       -----------------------------------------------------------------------------
       -- INPUT PARAMETER
       ----------------------------------------------------------------------------- 
          AND CP.PART_PROD_ID = #{productBasicInfo.partProdId}
          AND PD.LANG_CD = #{lang}
          AND CD.LANG_CD = #{lang}
          AND CP.PROD_RSHP_CD = #{rshpCd}
          AND CPM.BASE_YN = 'Y'
    </select>
    
    <select id="getRingBellMetaInfo" parameterType="Map" resultType="ProductInfo">
       SELECT /* ProductInfoMapper.getRingBellMetaInfo, Ring/Bell상품 메타조회, 오승민/인크로스, 2014-05-19 */
             CP.PROD_ID 
            , CP.PART_PROD_ID
            , C.MENU_ID
            , CD.MENU_NM
            , CD.MENU_DESC
            , C.TOP_MENU_ID
            ,(SELECT MENU_NM
               FROM TB_DP_MENU_CATEGORY_DESC
              WHERE MENU_ID = C.TOP_MENU_ID
                AND LANG_CD = 'ko'
                AND ROWNUM = 1) AS TOP_MENU_NM
            , PD.PROD_NM AS PARENT_PROD_NM
            , PD1.PROD_NM 
            , PD.PROD_DTL_DESC
            , PD.PROD_BASE_DESC
            , P.PROD_GRD_CD
            , P.EXPO_SELLER_EMAIL
            , P.EXPO_SELLER_NM
            , P.EXPO_SELLER_TELNO
            , P.SELLER_MBR_NO
            , (CASE WHEN P1.META_CLSF_CD IN ('CT30','CT31') THEN 'colorRing'
                    WHEN P1.META_CLSF_CD IN ('CT32','CT33') THEN 'bell'
                    ELSE null
                    END 
              ) as RING_TYPE
            , (CASE WHEN P1.META_CLSF_CD IN ('CT30','CT32') THEN 'normal'
                    WHEN P1.META_CLSF_CD IN ('CT31','CT33') THEN 'long'
                    ELSE null
                    END 
              ) as QUALITY
            , P.META_CLSF_CD
            , 'paid' as PROD_CLSF_CD
            , P.USE_PERIOD
            , P.USE_PERIOD_UNIT_CD
            , P.CID
            , PD1.ARTIST1_NM  AS  ARTIST_NM
            , PD1.ARTIST2_NM
            , PD1.ARTIST3_NM   AS ALBUM 
            , MP.CHNL_COMP_NM as PUBLISHER
            , MP.AGENCY_NM    AS AGENCY
            , MP.ISSUE_DAY
            , 'Y' AS MP3_SPRT_YN
            , 'Y' PHONE_SPRT_YN
            , MP.OUTSD_CONTENTS_ID AS SONG_ID
            , TENANT.PROD_STATUS_CD AS CHNL_PROD_STATUS_CD
            , TENANT1.PROD_STATUS_CD
            ,( SELECT CONCAT(FILE_PATH,FILE_NM) FROM TB_DP_PROD_IMG IMG WHERE IMG.PROD_ID = CP.PROD_ID  AND  IMG.EXPO_ORD = 1 AND  IMG.LANG_CD = #{lang} AND  IMG.IMG_CD = #{imageCd}) AS FILE_PATH
            FROM 
                  TB_DP_MENU_CATEGORY_PROD_MAPG CPM
                , TB_DP_MENU_CATEGORY C
                , TB_DP_MENU_CATEGORY_DESC CD 
                , TB_DP_MUSIC_PROD MP
                , TB_DP_PROD P
                , TB_DP_PROD_DESC PD
                , TB_DP_PROD_RSHP CP
                , TB_DP_TENANT_PROD  TENANT
                , TB_DP_PROD P1
                , TB_DP_PROD_DESC PD1
                , TB_DP_TENANT_PROD  TENANT1
        WHERE  C.MENU_ID = CPM.MENU_ID
          AND CD.MENU_ID = C.MENU_ID
          AND CPM.PROD_ID  = CP.PROD_ID 
          AND MP.PROD_ID = CP.PROD_ID
          AND P.PROD_ID = CP.PROD_ID
          AND P.PROD_ID = PD.PROD_ID
          AND P.PROD_ID = TENANT.PROD_ID
          AND CP.PART_PROD_ID = P1.PROD_ID
          AND P1.PROD_ID = PD1.PROD_ID
          AND P1.PROD_ID = TENANT1.PROD_ID
          AND CP.PART_PROD_ID = P1.PROD_ID
          AND TENANT.TENANT_ID = #{tenantId}
          AND TENANT1.TENANT_ID = #{tenantId}
       -----------------------------------------------------------------------------
       -- 차트 정보 조건절 END
       ----------------------------------------------------------------------------- 
          AND P.CONTENTS_TYPE_CD = 'PD002501'  -- 채널
       -----------------------------------------------------------------------------
       -- INPUT PARAMETER
       ----------------------------------------------------------------------------- 
          AND CP.PART_PROD_ID = #{productBasicInfo.partProdId}
          AND PD.LANG_CD = #{lang}
          AND PD1.LANG_CD = #{lang}
          AND CD.LANG_CD = #{lang}
          AND CP.PROD_RSHP_CD = #{rshpCd}
          AND CPM.BASE_YN = 'Y'
    </select>
    <select id="getEbookComicMetaInfo" parameterType="Map" resultType="ProductInfo">
        SELECT TA.*
      , ( NVL(
              (SELECT CONCAT (FILE_PATH, FILE_NM)
                              FROM TB_DP_PROD_IMG IMG
                             WHERE     IMG.PROD_ID =  TA.PART_PROD_ID
                                   AND IMG.EXPO_ORD = 1
                                   AND IMG.LANG_CD = #{lang}
                                   AND IMG.IMG_CD = #{imageCd}),
              (SELECT CONCAT (FILE_PATH, FILE_NM)
                              FROM TB_DP_PROD_IMG IMG
                             WHERE     IMG.PROD_ID =  TA.PROD_ID
                                   AND IMG.EXPO_ORD = 1
                                   AND IMG.LANG_CD = #{lang}
                                   AND IMG.IMG_CD = #{imageCd})
                )
         ) AS FILE_PATH                            
        FROM(
	        SELECT /* ProductInfoMapper.getEbookComicMetaInfo, ebook/Comic 상품메타 조회, 오승민/인크로스, 2014-03-10 */
	               A.UP_MENU_ID
	             , A.TOP_MENU_ID   
	             , (SELECT MENU_NM
			          FROM TB_DP_MENU_CATEGORY_DESC
			         WHERE MENU_ID = A.TOP_MENU_ID
			           AND LANG_CD = #{lang}
			           AND ROWNUM = 1) AS TOP_MENU_NM                                                          
	             , A.MENU_ID
	             , I.PROD_ID
	             , I.PART_PROD_ID                                     
	             , C.MENU_NM
	             , C.MENU_DESC
	             , D.PROD_GRD_CD
	             , D.META_CLSF_CD
	             , D.CONTENTS_TYPE_CD
	             , D.SELLER_MBR_NO
	             , D.EXPO_SELLER_EMAIL
	             , D.EXPO_SELLER_NM
	             , D.EXPO_SELLER_TELNO
	             , D.DRM_YN
	             , D.USE_PERIOD
	             , D.USE_PERIOD_UNIT_CD
	             , D.CID
	             , E.COMPT_YN
	             , E.STRM_EPSD_CNT
	             , E.ISSUE_DAY
	             ,(SELECT CHNL_COMP_NM FROM TB_DP_EBOOK_PROD WHERE PROD_ID = I.PROD_ID) as PUBLISHER
                 , E.EPSD_CNT
	             , E.CHAPTER
	             , E.BOOK_PAGE_CNT
	             , E.BOOK_CLSF_CD
	             , E.POSS_LEND_CLSF_CD
	             , 'paid' as PROD_CLSF_CD
	             , F.PROD_NM
	             , F.ARTIST1_NM as AUTHOR
	             , F.ARTIST2_NM as PAINTER
	             , F.ARTIST3_NM as TRANSLATOR
	             , F.PROD_BASE_DESC
	             , F.PROD_DTL_DESC
	             , E.OUTSD_CONTENTS_ID
	             , ( CASE WHEN D.META_CLSF_CD IN ( 'CT20', 'CT21' ) OR E.BOOK_CLSF_CD = 'DP004302' THEN 'serial' END ) AS BOOK_TYPE
			     , ( CASE WHEN D.META_CLSF_CD IN ( 'CT20', 'CT21' ) THEN ( E.EPSD_CNT + E.STRM_EPSD_CNT ) END ) AS BOOK_COUNT
			     , ( CASE WHEN D.META_CLSF_CD IN ( 'CT20', 'CT21' ) THEN DECODE( CE.COMPT_YN, 'Y', 'completed', 'continue' ) END ) AS BOOK_STATUS
	             ,  (SELECT DECODE (COUNT(1), 0, 'N', 'Y') 
	                    FROM TB_DP_SPRT_DEVICE A
	                   WHERE (A.DEVICE_MODEL_CD = #{deviceModelNo} or A.DEVICE_MODEL_CD = #{dpAnyPhone4mm}) 
	                      AND A.PROD_ID = I.PART_PROD_ID 
	                      AND (
	                      CASE WHEN #{productBasicInfo.topMenuId} = 'DP13' THEN
		                       CASE WHEN #{supportDevice.ebookSprtYn} = 'Y' THEN 1 
		                       ELSE 0 
		                       END
	                           WHEN #{productBasicInfo.topMenuId} = 'DP14' THEN
	                           CASE WHEN #{supportDevice.comicSprtYn} = 'Y' THEN 1 
	                           ELSE 0 
	                           END
	                      ELSE 1
	                      END   
	                      ) = 1
	                ) AS PHONE_SPRT_YN
	             , (SELECT PROD_STATUS_CD FROM TB_DP_TENANT_PROD TENANT1 WHERE I.PROD_ID = TENANT1.PROD_ID AND TENANT1.TENANT_ID = #{tenantId} AND TENANT1.EXPO_YN ='Y') as chnlProdStatusCd
	             , TENANT.PROD_STATUS_CD
	             , SUBCONTENTS.PROD_VER AS BOOK_VERSION
	             , SUBCONTENTS.SUB_CONTENTS_ID AS SCID
				 , CE.BOOK_CONTENTS_CNT
               	 , CE.SERIES_CONTENTS_CNT
               	 , CE.MGZIN_CONTENTS_CNT
	         FROM  TB_DP_MENU_CATEGORY           A
	             , TB_DP_MENU_CATEGORY_PROD_MAPG B
	             , TB_DP_MENU_CATEGORY_DESC      C
	             , TB_DP_PROD                    D
	             , TB_DP_EBOOK_PROD              E
	             , TB_DP_PROD_DESC               F
	             , TB_DP_PROD_RSHP               I
	             , TB_DP_TENANT_PROD             TENANT
	             , TB_DP_SUB_CONTENTS            SUBCONTENTS 
	             , TB_DP_EBOOK_PROD              CE
	        WHERE A.MENU_ID = B.MENU_ID
	          AND A.MENU_ID = C.MENU_ID
	          AND B.PROD_ID = D.PROD_ID
	          AND B.PROD_ID = E.PROD_ID
	          AND B.PROD_ID = F.PROD_ID
	          AND I.PROD_ID = CE.PROD_ID
	          AND B.PROD_ID = TENANT.PROD_ID
	          AND B.PROD_ID = SUBCONTENTS.PROD_ID
	          AND TENANT.TENANT_ID = #{tenantId}
	          AND B.PROD_ID = I.PART_PROD_ID
	          AND C.LANG_CD = #{lang}                      /* ko : 한국어 */
	          AND D.SVC_GRP_CD = 'DP000203'             /* DP000203 : 멀티미디어 */
	          AND D.CONTENTS_TYPE_CD = 'PD002502'      /* PD002502 : 에피소드 */     
	          AND F.LANG_CD = #{lang}                      /* ko : 한국어 */
	          -----------------------------------------------------------------------------
	          -- INPUT PARAMETER
	          ----------------------------------------------------------------------------- 
	          AND I.PART_PROD_ID = #{productBasicInfo.partProdId}   -- 에피소드 상품 ID 조회
	          AND I.PROD_RSHP_CD = #{rshpCd}
	          AND B.BASE_YN = 'Y'
	     ) TA
    </select>
    <select id="getShoppingMetaInfo" parameterType="Map" resultType="ProductInfo">
           SELECT  /* ProductInfoMapper.xml, getShoppingMetaInfo,에피소드ID 이용 상품조회(쇼핑) , 김형식/SK플래닛, 2014-01-07 */
                KK.*
           FROM (
                  SELECT 
                         H.PROD_ID                   
                        ,H.PART_PROD_ID  
                        ,CASE WHEN N.PROD_ID IS NOT NULL THEN M.PROD_NM ELSE C.CATALOG_NM  END PROD_NM     
                        ,'thumbnail' AS fileType   
                        ,PI.FILE_PATH || PI.FILE_NM AS FILE_PATH                 
                        ,J.TOP_MENU_ID 
                        ,(SELECT MENU_NM
                            FROM TB_DP_MENU_CATEGORY_DESC
                           WHERE MENU_ID = J.TOP_MENU_ID
                             AND LANG_CD = #{lang}
                             AND ROWNUM = 1
                         ) AS TOP_MENU_NM
                        ,D.MENU_ID
                        ,F.MENU_NM                         
                        ,J.META_CLSF_CD
                        ,J.REG_DT   
                        ,J.SELLER_MBR_NO 
                        ,J.EXPO_SELLER_NM 
                        ,J.EXPO_SELLER_TELNO 
                        ,J.EXPO_SELLER_EMAIL 
                        ,'' AS prodClsfCd 
                        ,J.PROD_GRD_CD
                        ,J.USE_PERIOD_UNIT_CD
                        ,J.USE_PERIOD
                        ,J.DRM_YN
                        ,CASE
                               WHEN (
                                    SELECT COUNT(*) 
                                      FROM TB_DP_SPRT_DEVICE 
                                     WHERE PROD_ID = I.PROD_ID 
                                       AND (DEVICE_MODEL_CD = #{deviceModelNo} or DEVICE_MODEL_CD = #{dpAnyPhone4mm} )
                                       AND 'Y' = #{supportDevice.sclShpgSprtYn}
                                    ) > 0
                               THEN 'Y'
                               ELSE 'N'
                          END AS PHONE_SPRT_YN     
                        ,B.CATALOG_ID
                        ,A.BRAND_ID
                        ,A.BRAND_NM    
                        ,CASE WHEN N.PROD_ID IS NOT NULL THEN 'special:Tstore' ELSE 'shoppingStore' END couponType
                        ,N.CPN_ID AS couponId
                        ,(CASE WHEN I.PROD_CASE_CD='DP006301' THEN 'giftcard' 
                               WHEN I.PROD_CASE_CD='DP006302' THEN 'exchange' 
                               WHEN I.PROD_CASE_CD='DP006303' THEN 'delivery' 
                          END) AS PROD_CASE_CD     
                        ,J.CID
                        ,(SELECT PROD_STATUS_CD FROM TB_DP_TENANT_PROD WHERE PROD_ID = H.PROD_ID AND EXPO_YN ='Y' AND TENANT_ID = #{tenantId}  AND ROWNUM =1) chnlProdStatusCd
                        ,K.PROD_STATUS_CD
                        ,OPT.OPT1_NM
                        ,OPT.OPT2_NM   
                        ,I.B2B_PROD_YN          
                        ,I.COUPON_SEND_TYPE                                                                                                                
                  FROM 
                          TB_DP_SHPG_BRAND A
                         ,TB_DP_SHPG_CATALOG B
                         ,TB_DP_SHPG_CATALOG_DESC C
                         ,TB_DP_MENU_SHPG_MAPG D
                         ,TB_DP_MENU_CATEGORY E
                         ,TB_DP_MENU_CATEGORY_DESC F 
                         ,TB_DP_PROD_CATALOG_MAPG G 
                         ,TB_DP_PROD_RSHP H
                         ,TB_DP_SHPG_PROD I
                         ,TB_DP_PROD J
                         ,TB_DP_TENANT_PROD K
                         ,TB_DP_TENANT_PROD_PRICE L
                         ,TB_DP_PROD_DESC M
                         ,(
                           
                          SELECT * 
                          FROM ( 
	                           SELECT 
	                                 B1.PROD_ID
	                               , B1.CPN_ID
	                           FROM  TB_DP_PROD_RSHP A1
	                                ,TB_DP_SPRC_PROD B1
	                           WHERE 1=1
	                             AND A1.PART_PROD_ID = B1.PROD_ID
	                             <if test="productBasicInfo.partProdId != null ">
	                             AND B1.PROD_ID  = #{productBasicInfo.partProdId}
	                             </if>                             
	                             AND B1.EXPO_YN ='Y'
	                             AND B1.CPN_ID IS NOT NULL
	                             ORDER BY  B1.SPRC_APPLY_END_DT DESC
                           ) WHERE ROWNUM =1                         
                          )N                         
                         ,TB_DP_PROD_IMG PI
                         ,TB_DP_PROD_OPT OPT
                WHERE 1=1
                AND A.BRAND_ID = B.BRAND_ID
                AND B.CATALOG_ID = C.CATALOG_ID
                AND C.CATALOG_ID = D.CATALOG_ID     
                AND D.MENU_ID = E.MENU_ID
                AND D.MENU_ID = F.MENU_ID
                AND B.CATALOG_ID = G.CATALOG_ID
                AND G.PROD_ID = H.PROD_ID
                AND H.PROD_ID <![CDATA[ <> ]]> H.PART_PROD_ID
                AND H.PART_PROD_ID = I.PROD_ID
                AND I.PROD_ID = J.PROD_ID
                AND I.PROD_ID = K.PROD_ID
                AND I.PROD_ID = L.PROD_ID
                AND I.PROD_ID = M.PROD_ID
                AND K.TENANT_ID = L.TENANT_ID
                AND C.CATALOG_ID = PI.PROD_ID(+)
                AND PI.IMG_CD(+) = #{imageCd}
                AND K.TENANT_ID = #{tenantId}       /* INPUT 테넌트ID */
                AND PI.EXPO_ORD ='1'           
                AND I.PROD_ID = N.PROD_ID(+)   
                AND I.PROD_ID = OPT.EPSD_PROD_ID(+)     
                AND H.PROD_RSHP_CD =#{prodRshpCd}    /*채널-에피소드 상품 관계*/ 
                AND C.LANG_CD= #{lang}          /* ko : 한국어 */
                AND F.LANG_CD= #{lang}          /* ko : 한국어 */
                AND M.LANG_CD =#{lang}          /* ko : 한국어 */
                AND D.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                AND D.USE_YN ='Y'                 /* Y : 기본(기본여부) */
                AND E.USE_YN='Y'                  /* Y : 기본(기본여부) */
                AND G.BASE_YN='Y'                 /* Y : 기본(기본여부) */
                AND G.USE_YN ='Y'                  /* Y : 기본(기본여부) */
                AND K.EXPO_YN = 'Y'                /* Y : 노출(노출여부) */
                AND I.PROD_ID = #{productBasicInfo.partProdId}        /* 상품ID */
           ) KK
    </select>
    
    <select id="getFreePassMetaInfo" parameterType="Map" resultType="ProductInfo">
		  SELECT   /* ProductInfoMapper.xml, getFreePassMetaInfo,에피소드ID 이용 상품조회(정액권) , 김형식/SK플래닛, 2014-01-07 */
		        IV.* 
		        ,'freepass' as couponType
		        ,'thumbnail' AS fileType 
		        , CONCAT(NVL(TIG.FILE_PATH, '') , NVL(TIG.FILE_NM, '')) AS FILE_PATH
		    FROM (
		        SELECT  
                      PD.PROD_ID
                    , PD.PROD_ID as PART_PROD_ID
                    , DC.PROD_NM
                    , PD.TOP_MENU_ID
                    , (SELECT MENU_DESC FROM TB_DP_MENU_CATEGORY_DESC WHERE MENU_ID = PD.TOP_MENU_ID AND LANG_CD = DC.LANG_CD) AS TOP_MENU_NM
                    , '' as MENU_ID
                    , '' as MENU_NM
                    , PD.META_CLSF_CD
                    , PD.REG_DT  
                    , PD.SELLER_MBR_NO 
                    , PD.EXPO_SELLER_EMAIL
                    , PD.EXPO_SELLER_NM
                    , PD.EXPO_SELLER_TELNO   
                    , (CASE
                      WHEN PD.META_CLSF_CD IN ('CT14', 'CT15','CT16') THEN '회'
                      ELSE ''
                      END ) AS CHAPTER_UNIT  
                    , PD.PROD_CHRG_YN
                    , '' as CHAPTER
                    , PD.PROD_GRD_CD
                    , '' as POSS_LEND_CLSF_CD
                    , PD.USE_PERIOD_UNIT_CD
                    , PD.USE_PERIOD
                    , PD.DRM_YN 
                    ,CASE
                         WHEN ( 
                               SELECT COUNT(*) 
                                 FROM  TB_DP_SPRT_DEVICE SP
                                WHERE  1=1
                                  AND  SP.PROD_ID = PD.PROD_ID 
                                  AND  'Y' = CASE 
                                       WHEN CM.CMPX_PROD_CLSF_CD IN ('OR004301','OR004302') THEN #{supportDevice.vodFixisttSprtYn}
                                       WHEN CM.CMPX_PROD_CLSF_CD IN ('OR004303','OR004304') THEN
                                            CASE WHEN PD.TOP_MENU_ID='DP13' THEN #{supportDevice.ebookSprtYn}
                                                 WHEN PD.TOP_MENU_ID='DP14' THEN #{supportDevice.comicSprtYn}
                                            ELSE 'Y' END
                                       ELSE 'Y' END
                                  AND (SP.DEVICE_MODEL_CD = #{deviceModelNo} or SP.DEVICE_MODEL_CD = #{dpAnyPhone4mm})
                               )> 0
                         THEN 'Y'
                         ELSE 'N'
                     END AS PHONE_SPRT_YN
                    , DC.LANG_CD
                    , PD.CID
                    , '' chnlProdStatusCd
                    , TP.PROD_STATUS_CD
                    , CM.AUTO_APPR_YN
                    ,(CASE WHEN CM.CMPX_PROD_CLSF_CD='OR004301' THEN 'movieFreepass'  -- 영화 자동결제
                           WHEN CM.CMPX_PROD_CLSF_CD='OR004302' THEN 'seriesFreepass' -- 시리즈 1회결제
                           WHEN CM.CMPX_PROD_CLSF_CD='OR004303' THEN 'seriesFreepass/ebook' -- 전권 소장 
                           WHEN CM.CMPX_PROD_CLSF_CD='OR004304' THEN 'rentalFreepass/ebook' -- 전권 대여
                           WHEN CM.CMPX_PROD_CLSF_CD='OR004305' THEN 'gameCash' -- 게임 캐쉬  
                      END) AS KIND                       
                    , CM.CMPX_PROD_CLSF_CD AS PLAN_TYPE     
		        FROM 
		              TB_DP_PROD PD
		            , TB_DP_CMPX_PROD CM
		            , TB_DP_PROD_DESC DC
		            , TB_DP_TENANT_PROD TP
		            , TB_DP_TENANT_PROD_PRICE PR
		        WHERE PD.PROD_ID = #{productBasicInfo.partProdId}
		        AND PD.PROD_ID = CM.PROD_ID
		        AND PD.PROD_ID = DC.PROD_ID
		        AND PD.PROD_ID = TP.PROD_ID
		        AND PD.PROD_ID = PR.PROD_ID
		        AND DC.LANG_CD = #{lang}
		        AND TP.TENANT_ID = #{tenantId}
		        AND TP.TENANT_ID = PR.TENANT_ID
		    ) IV  LEFT OUTER JOIN TB_DP_PROD_IMG TIG
               ON TIG.LANG_CD = IV.LANG_CD 
               AND IV.PROD_ID = TIG.PROD_ID 
               AND TIG.IMG_CD = (
                    CASE WHEN IV.PLAN_TYPE IN ('OR004301','OR004302','OR004305') THEN  #{imageCd}
                         WHEN IV.PLAN_TYPE IN ('OR004303','OR004304') THEN  #{ebookImageCd}
                    END
                    )
               
              
    </select>
    <!--정액권 ID를 이용 채널 상품 조회-->
    <select id="getMapgProdIdList" parameterType="Map" resultType="MapgProdMeta">
       /* ProductInfoMapper.xml, getMapgProdIdList ,정액권 ID를 이용 채널 상품 조회 , 김형식/SK플래닛, 2014-01-07 */
        SELECT  A.PART_PROD_ID AS PROD_ID
               ,B.META_CLSF_CD
               ,C.MENU_ID
               ,D.MENU_NM
          FROM TB_DP_FIXRATE_PROD_MAPG A
               ,TB_DP_PROD B
               ,TB_DP_MENU_CATEGORY_PROD_MAPG C
               ,TB_DP_MENU_CATEGORY_DESC D
         WHERE 1=1  
           AND A.PROD_ID =#{productBasicInfo.partProdId}
           AND A.PART_PROD_ID = B.PROD_ID
           AND B.PROD_ID =C.PROD_ID
           AND C.MENU_ID =D.MENU_ID
           AND C.BASE_YN='Y'
           AND C.USE_YN='Y'
           AND D.LANG_CD=#{lang}     
    </select>    
    
</mapper>
