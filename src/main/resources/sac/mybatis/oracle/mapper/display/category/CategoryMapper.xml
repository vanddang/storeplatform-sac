<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Category">
    <!-- 일반 카테고리 앱 상품 조회 -->
    <select id="selectCategoryAppList" parameterType="CategoryAppSacReq" resultType="ProductBasicInfo">
		SELECT  /* CategoryMapper.XML, selectCategoryAppList, Tae hee Lee, 2014-01-14 */
                KA.TOTAL_COUNT
              , KA.RNUM
              , KA.TOP_MENU_ID
              , KA.MENU_ID
              , KA.PROD_ID
          FROM (SELECT JA.*
                  FROM (SELECT ROW_NUMBER() OVER(ORDER BY NVL(IB.PRCHS_CNT, 0) DESC, IA.REG_DT DESC) AS RNUM
                             , IA.*
                             , IB.PRCHS_CNT
                             , IB.AVG_EVLU_SCORE
                             , IB.PATICPERS_CNT
                          FROM (SELECT  COUNT(B.PROD_ID) OVER() AS TOTAL_COUNT
                                      , A.MENU_ID
                                      , A.TOP_MENU_ID
                                      , B.PROD_ID
                                      , D.PROD_CHRG_YN
                                      , D.PROD_GRD_CD
                                      , D.DRM_YN
                                      , D.REG_DT
                                      , G.TENANT_ID
                                      , I.SUB_CONTENTS_ID
                                  FROM  TB_DP_MENU_CATEGORY           A
                                      , TB_DP_MENU_CATEGORY_PROD_MAPG B
                                      , TB_DP_PROD                    D
                                      , TB_DP_TENANT_PROD             G
                                      , TB_DP_SPRT_DEVICE             I
                                 WHERE  A.MENU_ID = B.MENU_ID
                                   AND  B.PROD_ID = D.PROD_ID
                                   AND  B.PROD_ID = G.PROD_ID
                                   AND  B.PROD_ID = I.PROD_ID
                                   AND  A.USE_YN = 'Y'                       /* Y : 사용 (사용여부) */
                                   AND  B.USE_YN = 'Y'                       /* Y : 사용 (사용여부) */
                                   AND  D.SVC_GRP_CD = 'DP000201'            /* DP000201 : 애플리캐이션 */
                                   AND  G.PROD_STATUS_CD = 'PD000403'        /* PD000403 : 판매중 */
                                   AND  G.EXPO_YN = 'Y'                      /* Y : 노출 (노출여부) */
                                   AND  A.MENU_ID = #{menuId}                /* 메뉴ID */
                                   AND  G.TENANT_ID = #{tenantId}            /* 테넌트ID */
                                   AND  I.DEVICE_MODEL_CD = #{deviceModelCd} /* 단말모델코드 */
                                 <if test='prodCharge != "A"'>
                                   AND  D.PROD_CHRG_YN = #{prodCharge}       /* 상품유료여부 */
                                 </if>
                                 <if test="arrayProdGradeCd != null">
                                    AND D.PROD_GRD_CD IN
                                      <foreach collection="arrayProdGradeCd" item="prodGradeCd" separator="," open="(" close=")">
                                        #{prodGradeCd}
                                      </foreach>
                                  </if>
                               )                        IA
                              , TB_DP_TENANT_PROD_STATS IB
                         WHERE  IA.TENANT_ID = IB.TENANT_ID(+)
                           AND  IA.PROD_ID = IB.PROD_ID(+)
                       ) JA
                 WHERE JA.RNUM BETWEEN #{offset} AND #{count}
               ) KA
    </select>
    
    <!-- 일반 카테고리 이북/코믹 상품 조회 -->
    <select id="selectCategoryEbookComicList" parameterType="CategoryEbookComicSacReq" resultType="ProductBasicInfo">
        SELECT  /* CategoryMapper.xml, selectCategoryEbookComicList, 홍지호, 2014-01-28 */
                LA.TOTAL_COUNT
              , LA.RNUM
              , LA.TOP_MENU_ID
              , LA.MENU_ID
              , LA.PROD_ID
              , LA.PART_PROD_ID
              , LA.META_CLSF_CD
              , LA.CONTENTS_TYPE_CD
          FROM (
                SELECT KA.*
                  FROM 
                       (
                        SELECT JA.*, ROW_NUMBER() OVER(ORDER BY JA.UPD_DT DESC, JA.PROD_NM) AS RNUM
                          FROM 
                               (
                                SELECT IA.*, COUNT(IA.PROD_ID) OVER() AS TOTAL_COUNT
                                  FROM 
                                       (
                                        SELECT ROW_NUMBER( ) OVER ( PARTITION BY D.PROD_ID
                                                                        ORDER BY  DECODE( K.BOOK_CLSF_CD, E.BOOK_CLSF_CD, 1, 2 )
                                                                                , TO_NUMBER( REGEXP_REPLACE( K.CHAPTER, '[^[:digit:]]') ) DESC
                                                                                , NVL( J.USE_PERIOD_UNIT_CD, 'PD00310' ) DESC
                                                                                , J.UPD_DT DESC ) AS RN         
                                             , A.TOP_MENU_ID
                                             , A.MENU_ID
                                             , D.PROD_ID
                                             , I.PART_PROD_ID                                     
                                             , D.UPD_DT
                                             , D.META_CLSF_CD
                                             , D.CONTENTS_TYPE_CD
                                             , F.PROD_NM
                                          FROM TB_DP_MENU_CATEGORY      A
                                             , TB_DP_MENU_CATEGORY_PROD_MAPG B
                                             , TB_DP_PROD               D /* 채널 상품 */
                                             , UV_TB_DP_MULTIMDA_PROD   E /* 채널 상품 */
                                             , TB_DP_PROD_DESC          F
                                             , TB_DP_TENANT_PROD        G
                                             , TB_DP_PROD_RSHP          I
                                             , TB_DP_PROD               J /* 에피소드 상품 */
                                             , UV_TB_DP_MULTIMDA_PROD   K /* 에피소드 상품 */
                                             , TB_DP_SPRT_DEVICE        L
                                         WHERE A.MENU_ID = B.MENU_ID
                                           AND B.PROD_ID = D.PROD_ID
                                           AND D.PROD_ID = E.PROD_ID
                                           AND D.PROD_ID = F.PROD_ID
                                           AND D.PROD_ID = G.PROD_ID
                                           AND G.TENANT_ID = #{tenantId}             /* header param : tenantId */
                                           AND D.PROD_ID = I.PROD_ID
                                           AND I.PROD_RSHP_CD = 'DP010802'           /* DP010802 : 채널-에피소드 상품 관계 */
                                           AND I.PART_PROD_ID = J.PROD_ID
                                           AND I.PART_PROD_ID = K.PROD_ID
                                           AND I.PART_PROD_ID = L.PROD_ID
                                           AND A.USE_YN = 'Y'                        /* Y : 사용 (사용여부) */
                                           AND B.USE_YN = 'Y'                        /* Y : 사용 (사용여부) */
                                           AND D.SVC_GRP_CD = 'DP000203'             /* DP000203 : 멀티미디어 */
                                           AND D.CONTENTS_TYPE_CD = 'PD002501'       /* PD002501 : 채널타입 */
                                           AND F.LANG_CD = #{langCd}                 /* 언어 코드 */
                                           AND G.PROD_STATUS_CD = 'PD000403'         /* PD000403 : 판매중 */
                                           AND G.EXPO_YN = 'Y'                       /* Y : 노출 (노출여부) */
                                           AND J.CONTENTS_TYPE_CD = 'PD002502'       /* PD002502 : 에피소드 */
                                           AND (L.DEVICE_MODEL_CD = #{deviceModelCd} OR L.DEVICE_MODEL_CD = 'ANY-PHONE-4MM') /* header param : 단말모델코드 */
                                           AND A.TOP_MENU_ID = #{topMenuId}          /* 탑메뉴ID */
                                           AND A.MENU_ID = #{menuId}                 /* 메뉴ID */
                                         <if test="arrayProdGradeCd != null">
                                           AND D.PROD_GRD_CD IN
                                           <foreach collection="arrayProdGradeCd" item="prodGradeCd" separator="," open="(" close=")">
                                             #{prodGradeCd}
                                           </foreach>
                                         </if>
                                         <if test='filteredBy == "recent+complete"'>
                                           AND E.COMPT_YN = 'Y'
                                         </if>  
                               ) IA
                                 WHERE IA.RN = 1
                               ) JA
                       ) KA
                 WHERE KA.RNUM BETWEEN #{offset} AND #{count}
               ) LA
    </select>
    
</mapper>